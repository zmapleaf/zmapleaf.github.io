<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="远">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="远">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="远">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>远</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">远</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/13/2D Visualization笔记(X2) OxyPlot(三)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/13/2D Visualization笔记(X2) OxyPlot(三)/" itemprop="url">2D Visualization笔记(X2) OxyPlot(三)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-13T09:35:51+08:00">
                2018-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>除了前面两篇笔记中提到的使用PlotView和PlotModel, OxyPlot.WPF还支持直接在XAML中绑定数据, 使用的是Plot控件, Plot和PlotView一样, 都继承自PlotBase<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Window</span> <span class="attr">x:Class</span>=<span class="string">"WpfApplication2.MainWindow"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns</span>=<span class="string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:x</span>=<span class="string">"http://schemas.microsoft.com/winfx/2006/xaml"</span> <span class="attr">xmlns:oxy</span>=<span class="string">"http://oxyplot.org/wpf"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:local</span>=<span class="string">"clr-namespace:WpfApplication2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">Title</span>=<span class="string">"Example 2 (WPF)"</span> <span class="attr">Height</span>=<span class="string">"350"</span> <span class="attr">Width</span>=<span class="string">"525"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Window.DataContext</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">local:MainViewModel</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Window.DataContext</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">oxy:Plot</span> <span class="attr">Title</span>=<span class="string">"&#123;Binding Title&#125;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">oxy:Plot.Series</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">oxy:LineSeries</span> <span class="attr">ItemsSource</span>=<span class="string">"&#123;Binding Points&#125;"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">oxy:Plot.Series</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">oxy:Plot</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Window</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WpfApplication2</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line">    <span class="keyword">using</span> OxyPlot;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MainViewModel</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainViewModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.Title = <span class="string">"Example 2"</span>;</span><br><span class="line">            <span class="keyword">this</span>.Points = <span class="keyword">new</span> List&lt;DataPoint&gt;</span><br><span class="line">                              &#123;</span><br><span class="line">                                  <span class="keyword">new</span> DataPoint(<span class="number">0</span>, <span class="number">4</span>),</span><br><span class="line">                                  <span class="keyword">new</span> DataPoint(<span class="number">10</span>, <span class="number">13</span>),</span><br><span class="line">                                  <span class="keyword">new</span> DataPoint(<span class="number">20</span>, <span class="number">15</span>),</span><br><span class="line">                                  <span class="keyword">new</span> DataPoint(<span class="number">30</span>, <span class="number">16</span>),</span><br><span class="line">                                  <span class="keyword">new</span> DataPoint(<span class="number">40</span>, <span class="number">12</span>),</span><br><span class="line">                                  <span class="keyword">new</span> DataPoint(<span class="number">50</span>, <span class="number">12</span>)</span><br><span class="line">                              &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Title &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> IList&lt;DataPoint&gt; Points &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>oxy:Plot.Series和oxy:LineSeries直接放在XAML中? Series和LineSeries不是在OxyPlot(Portable)中吗?</p>
<p>答案是这里的Series和LineSeries都继承自ItemControl类, 位于OxyPlot.WPF中, 是一个控件<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">Series</span> : <span class="title">ItemsControl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// This is a WPF wrapper of OxyPlot.LineSeries</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="title">public</span> <span class="title">class</span> <span class="title">LineSeries</span> : <span class="title">DataPointSeries</span></span><br></pre></td></tr></table></figure></p>
<p>从LineSeries的注释可以看出, 它是对OxyPlot.LineSeries的一个封装. 再来看Plot类, 它的实现逻辑和PlotView不一样<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Plot</span> : <span class="title">PlotBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> The internal model.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> PlotModel internalModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Initializes a new instance of the <span class="doctag">&lt;see cref="Plot" /&gt;</span> class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Plot</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.series = <span class="keyword">new</span> ObservableCollection&lt;Series&gt;();</span><br><span class="line">        <span class="keyword">this</span>.axes = <span class="keyword">new</span> ObservableCollection&lt;Axis&gt;();</span><br><span class="line">        <span class="keyword">this</span>.annotations = <span class="keyword">new</span> ObservableCollection&lt;Annotation&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.series.CollectionChanged += <span class="keyword">this</span>.OnSeriesChanged;</span><br><span class="line">        <span class="keyword">this</span>.axes.CollectionChanged += <span class="keyword">this</span>.OnAxesChanged;</span><br><span class="line">        <span class="keyword">this</span>.annotations.CollectionChanged += <span class="keyword">this</span>.OnAnnotationsChanged;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.defaultController = <span class="keyword">new</span> PlotController();</span><br><span class="line">        <span class="keyword">this</span>.internalModel = <span class="keyword">new</span> PlotModel();</span><br><span class="line">        ((IPlotModel)<span class="keyword">this</span>.internalModel).AttachPlotView(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Called when series is changed.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="sender"&gt;</span>The sender.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="e"&gt;</span>The <span class="doctag">&lt;see cref="System.Collections.Specialized.NotifyCollectionChangedEventArgs" /&gt;</span> instance containing the event data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnSeriesChanged</span>(<span class="params"><span class="keyword">object</span> sender, NotifyCollectionChangedEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.SyncLogicalTree(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Synchronizes the logical tree.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="e"&gt;</span>The <span class="doctag">&lt;see cref="System.Collections.Specialized.NotifyCollectionChangedEventArgs" /&gt;</span> instance containing the event data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SyncLogicalTree</span>(<span class="params">NotifyCollectionChangedEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// In order to get DataContext and binding to work with the series, axes and annotations</span></span><br><span class="line">        <span class="comment">// we add the items to the logical tree</span></span><br><span class="line">        <span class="keyword">if</span> (e.NewItems != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> e.NewItems)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.AddLogicalChild(item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e.OldItems != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> e.OldItems)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.RemoveLogicalChild(item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Updates the model. If Model==<span class="doctag">&lt;c&gt;</span>null<span class="doctag">&lt;/c&gt;</span>, an internal model will be created. The ActualModel.Update will be called (updates all series data).</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="updateData"&gt;</span>if set to <span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> , all data collections will be updated.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UpdateModel</span>(<span class="params"><span class="keyword">bool</span> updateData = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.SynchronizeProperties();</span><br><span class="line">        <span class="keyword">this</span>.SynchronizeSeries();</span><br><span class="line">        <span class="keyword">this</span>.SynchronizeAxes();</span><br><span class="line">        <span class="keyword">this</span>.SynchronizeAnnotations();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">base</span>.UpdateModel(updateData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Called when the visual appearance is changed.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnAppearanceChanged</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.InvalidatePlot(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Called when the visual appearance is changed.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="d"&gt;</span>The d.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="e"&gt;</span>The <span class="doctag">&lt;see cref="System.Windows.DependencyPropertyChangedEventArgs" /&gt;</span> instance containing the event data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AppearanceChanged</span>(<span class="params">DependencyObject d, DependencyPropertyChangedEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ((Plot)d).OnAppearanceChanged();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Synchronizes the series in the internal model.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SynchronizeSeries</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.internalModel.Series.Clear();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> s <span class="keyword">in</span> <span class="keyword">this</span>.Series)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.internalModel.Series.Add(s.CreateModel());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Synchronize properties in the internal Plot model</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SynchronizeProperties</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> m = <span class="keyword">this</span>.internalModel;</span><br><span class="line"></span><br><span class="line">        m.PlotType = <span class="keyword">this</span>.PlotType;</span><br><span class="line"></span><br><span class="line">        m.PlotMargins = <span class="keyword">this</span>.PlotMargins.ToOxyThickness();</span><br><span class="line">        m.Padding = <span class="keyword">this</span>.Padding.ToOxyThickness();</span><br><span class="line">        m.TitlePadding = <span class="keyword">this</span>.TitlePadding;</span><br><span class="line"></span><br><span class="line">        m.Culture = <span class="keyword">this</span>.Culture;</span><br><span class="line"></span><br><span class="line">        m.DefaultColors = <span class="keyword">this</span>.DefaultColors.Select(c =&gt; c.ToOxyColor()).ToArray();</span><br><span class="line">        m.DefaultFont = <span class="keyword">this</span>.DefaultFont;</span><br><span class="line">        m.DefaultFontSize = <span class="keyword">this</span>.DefaultFontSize;</span><br><span class="line"></span><br><span class="line">        m.Title = <span class="keyword">this</span>.Title;</span><br><span class="line">        m.TitleColor = <span class="keyword">this</span>.TitleColor.ToOxyColor();</span><br><span class="line">        m.TitleFont = <span class="keyword">this</span>.TitleFont;</span><br><span class="line">        m.TitleFontSize = <span class="keyword">this</span>.TitleFontSize;</span><br><span class="line">        m.TitleFontWeight = <span class="keyword">this</span>.TitleFontWeight.ToOpenTypeWeight();</span><br><span class="line">        m.TitleToolTip = <span class="keyword">this</span>.TitleToolTip;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>绘制的逻辑是这样的: XAML中增加了LineSeries, 触发OnSeriesChanged, 更新LogicTree, 再触发AppearanceChanged, 调用InvalidatePlot. 该方法是在PlotBase中定义的, 用了模板模式. Plot类重写了父类的UpdateModel. 多了Synchronize的步骤.</p>
<p>但WPF中的Series和LineSeries中并没有Render的代码, Render的逻辑还是在PlotModel中. SynchronizeProperties的作用就是将WPF中的属性同步给PlotModel, 然后由PlotModel绘制. 绘制在哪里, 绘制在PlotBase的Canvas上.</p>
<p>由于PlotBase继承自Control类, 而Control类在WPF是设计为无外观控件, 一般会从generic.xaml中获取默认的控件模板. WPF中有一个专用的OnApplyTemplate()方法, 如果需要在模板中查找元素并关联事件处理程序或添加数据绑定表达式, 应重写该方法. 详见WPF编程宝典18.3创建无外观控件一节. 这里PlotBase在OnApplyTemplate()中添加了绘制的纸和笔</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> When overridden in a derived class, is invoked whenever application code or internal processes (such as a rebuilding layout pass)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> call <span class="doctag">&lt;see cref="M:System.Windows.Controls.Control.ApplyTemplate" /&gt;</span> . In simplest terms, this means the method is called </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> just before a UI element displays in an application. For more information, see Remarks.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnApplyTemplate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">base</span>.OnApplyTemplate();</span><br><span class="line">    <span class="keyword">this</span>.grid = <span class="keyword">this</span>.GetTemplateChild(PartGrid) <span class="keyword">as</span> Grid;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.grid == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.canvas = <span class="keyword">new</span> Canvas();</span><br><span class="line">    <span class="keyword">this</span>.grid.Children.Add(<span class="keyword">this</span>.canvas);</span><br><span class="line">    <span class="keyword">this</span>.canvas.UpdateLayout();</span><br><span class="line">    <span class="keyword">this</span>.renderContext = <span class="keyword">new</span> CanvasRenderContext(<span class="keyword">this</span>.canvas);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.overlays = <span class="keyword">new</span> Canvas();</span><br><span class="line">    <span class="keyword">this</span>.grid.Children.Add(<span class="keyword">this</span>.overlays);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.zoomControl = <span class="keyword">new</span> ContentControl();</span><br><span class="line">    <span class="keyword">this</span>.overlays.Children.Add(<span class="keyword">this</span>.zoomControl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add additional grid on top of everthing else to fix issue of mouse events getting lost</span></span><br><span class="line">    <span class="comment">// it must be added last so it covers all other controls</span></span><br><span class="line">    <span class="keyword">var</span> mouseGrid = <span class="keyword">new</span> Grid();</span><br><span class="line">    mouseGrid.Background = Brushes.Transparent; <span class="comment">// background must be set for hit test to work</span></span><br><span class="line">    <span class="keyword">this</span>.grid.Children.Add(mouseGrid); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/11/2D Visualization笔记(X2) OxyPlot(二)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/11/2D Visualization笔记(X2) OxyPlot(二)/" itemprop="url">2D Visualization笔记(X2) OxyPlot(二)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-11T17:06:51+08:00">
                2018-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇笔记中出现了Model和View, 如果加上交互, 又是如何? 基类PlotBase继承自Control, 所以它能监听键盘和鼠标事件, 并且进行了重载. 它委托给PlotController来进行事件处理.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Invoked when an unhandled MouseDown attached event reaches an element in its route that is derived from this class. Implement this method to add class handling for this event.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="e"&gt;</span>The <span class="doctag">&lt;see cref="T:System.Windows.Input.MouseButtonEventArgs" /&gt;</span> that contains the event data. This event data reports details about the mouse button that was pressed and the handled state.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnMouseDown</span>(<span class="params">MouseButtonEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">base</span>.OnMouseDown(e);</span><br><span class="line">    <span class="keyword">if</span> (e.Handled)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.Focus();</span><br><span class="line">    <span class="keyword">this</span>.CaptureMouse();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// store the mouse down point, check it when mouse button is released to determine if the context menu should be shown</span></span><br><span class="line">    <span class="keyword">this</span>.mouseDownPoint = e.GetPosition(<span class="keyword">this</span>).ToScreenPoint();</span><br><span class="line"></span><br><span class="line">    e.Handled = <span class="keyword">this</span>.ActualController.HandleMouseDown(<span class="keyword">this</span>, e.ToMouseDownEventArgs(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Invoked when an unhandled MouseMove attached event reaches an element in its route that is derived from this class. Implement this method to add class handling for this event.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="e"&gt;</span>The <span class="doctag">&lt;see cref="T:System.Windows.Input.MouseEventArgs" /&gt;</span> that contains the event data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnMouseMove</span>(<span class="params">MouseEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">base</span>.OnMouseMove(e);</span><br><span class="line">    <span class="keyword">if</span> (e.Handled)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    e.Handled = <span class="keyword">this</span>.ActualController.HandleMouseMove(<span class="keyword">this</span>, e.ToMouseEventArgs(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在PlotController的基类ControllerBase中找到HandleMouseDown, 发现它又调用了PlotModel的HandleMouseDown方法. 如果PlotModel处理完了, 则返回. 如果PlotModel没有处理, 则下面进一步调用HandleCommand.为什么这样设计, 因为<strong>交互可能是针对整个PlotView(缩放,移动等), 也可能是针对其中的某一个PlotElement.而PlotElement位于PlotModel中</strong>.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Handles mouse down events.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="view"&gt;</span>The plot view.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="args"&gt;</span>The <span class="doctag">&lt;see cref="OxyMouseEventArgs" /&gt;</span> instance containing the event data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> if the event was handled.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleMouseDown</span>(<span class="params">IView view, OxyMouseDownEventArgs args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">lock</span> (<span class="keyword">this</span>.GetSyncRoot(view))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (view.ActualModel != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            view.ActualModel.HandleMouseDown(<span class="keyword">this</span>, args);</span><br><span class="line">            <span class="keyword">if</span> (args.Handled)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> command = <span class="keyword">this</span>.GetCommand(<span class="keyword">new</span> OxyMouseDownGesture(args.ChangedButton, args.ModifierKeys, args.ClickCount));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.HandleCommand(command, view, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Command是在PlotController的构造方法中绑定的<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PlotController</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Zoom rectangle bindings: MMB / control RMB / control+alt LMB</span></span><br><span class="line">    <span class="keyword">this</span>.BindMouseDown(OxyMouseButton.Middle, PlotCommands.ZoomRectangle);</span><br><span class="line">    <span class="keyword">this</span>.BindMouseDown(OxyMouseButton.Right, OxyModifierKeys.Control, PlotCommands.ZoomRectangle);</span><br><span class="line">    <span class="keyword">this</span>.BindMouseDown(OxyMouseButton.Left, OxyModifierKeys.Control | OxyModifierKeys.Alt, PlotCommands.ZoomRectangle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset bindings: Same as zoom rectangle, but double click / A key</span></span><br><span class="line">    <span class="keyword">this</span>.BindMouseDown(OxyMouseButton.Middle, OxyModifierKeys.None, <span class="number">2</span>, PlotCommands.ResetAt);</span><br><span class="line">    <span class="keyword">this</span>.BindMouseDown(OxyMouseButton.Right, OxyModifierKeys.Control, <span class="number">2</span>, PlotCommands.ResetAt);</span><br><span class="line">    <span class="keyword">this</span>.BindMouseDown(OxyMouseButton.Left, OxyModifierKeys.Control | OxyModifierKeys.Alt, <span class="number">2</span>, PlotCommands.ResetAt);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PlotModel的HandleMouseDown方法是在基类Model中. 该方法, 先测试MouseDown的地方, 有没有PlotElement, 如果有的话, 需要继续往下传. 类似WPF中的路由事件.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Handles the mouse down event.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="sender"&gt;</span>The sender.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="e"&gt;</span>The <span class="doctag">&lt;see cref="OxyPlot.OxyMouseEventArgs" /&gt;</span> instance containing the event data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">HandleMouseDown</span>(<span class="params"><span class="keyword">object</span> sender, OxyMouseDownEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> args = <span class="keyword">new</span> HitTestArguments(e.Position, MouseHitTolerance);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> result <span class="keyword">in</span> <span class="keyword">this</span>.HitTest(args))</span><br><span class="line">    &#123;</span><br><span class="line">        e.HitTestResult = result;</span><br><span class="line">        result.Element.OnMouseDown(e);</span><br><span class="line">        <span class="keyword">if</span> (e.Handled)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.currentMouseEventElement = result.Element;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!e.Handled)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.OnMouseDown(sender, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Raises the <span class="doctag">&lt;see cref="MouseDown" /&gt;</span> event.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="sender"&gt;</span>The sender.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="e"&gt;</span>The <span class="doctag">&lt;see cref="OxyMouseEventArgs" /&gt;</span> instance containing the event data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseDown</span>(<span class="params"><span class="keyword">object</span> sender, OxyMouseDownEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> handler = <span class="keyword">this</span>.MouseDown;</span><br><span class="line">    <span class="keyword">if</span> (handler != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        handler(sender, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Occurs when a mouse button is pressed down on the model.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">event</span> EventHandler&lt;OxyMouseDownEventArgs&gt; MouseDown;</span><br></pre></td></tr></table></figure></p>
<p>看几个例子</p>
<p>例子1: 用鼠标划线, 该交互是针对整个PlotModel的.<br><img src="/img/oxyplot-3.png" alt=""><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Example(<span class="meta-string">"PlotModel mouse events"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PlotModel <span class="title">MouseEvents</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> model = <span class="keyword">new</span> PlotModel &#123; Title = <span class="string">"Mouse events"</span>, Subtitle = <span class="string">"Left click and drag"</span> &#125;;</span><br><span class="line">    <span class="keyword">var</span> yaxis = <span class="keyword">new</span> LinearAxis &#123; Position = AxisPosition.Left, Minimum = <span class="number">-1</span>, Maximum = <span class="number">1</span> &#125;;</span><br><span class="line">    <span class="keyword">var</span> xaxis = <span class="keyword">new</span> LinearAxis &#123; Position = AxisPosition.Bottom, Minimum = <span class="number">-1</span>, Maximum = <span class="number">1</span> &#125;;</span><br><span class="line">    model.Axes.Add(yaxis);</span><br><span class="line">    model.Axes.Add(xaxis);</span><br><span class="line"></span><br><span class="line">    LineSeries s1 = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Subscribe to the mouse down event on the line series</span></span><br><span class="line">    model.MouseDown += (s, e) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// only handle the left mouse button (right button can still be used to pan)</span></span><br><span class="line">        <span class="keyword">if</span> (e.ChangedButton == OxyMouseButton.Left)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Add a line series</span></span><br><span class="line">            s1 = <span class="keyword">new</span> LineSeries</span><br><span class="line">            &#123;</span><br><span class="line">                Title = <span class="string">"LineSeries"</span> + (model.Series.Count + <span class="number">1</span>),</span><br><span class="line">                MarkerType = MarkerType.None,</span><br><span class="line">                StrokeThickness = <span class="number">2</span></span><br><span class="line">            &#125;;</span><br><span class="line">            s1.Points.Add(xaxis.InverseTransform(e.Position.X, e.Position.Y, yaxis));</span><br><span class="line">            model.Series.Add(s1);</span><br><span class="line">            model.InvalidatePlot(<span class="literal">false</span>);</span><br><span class="line">            e.Handled = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    model.MouseMove += (s, e) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (s1 != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            s1.Points.Add(xaxis.InverseTransform(e.Position.X, e.Position.Y, yaxis));</span><br><span class="line">            model.InvalidatePlot(<span class="literal">false</span>);</span><br><span class="line">            e.Handled = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    model.MouseUp += (s, e) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (s1 != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            s1 = <span class="literal">null</span>;</span><br><span class="line">            e.Handled = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> model;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意到model.InvalidatePlot(false);<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Invalidates the plot.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="updateData"&gt;</span>Updates all data sources if set to <span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span>.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InvalidatePlot</span>(<span class="params"><span class="keyword">bool</span> updateData</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> plotView = <span class="keyword">this</span>.PlotView;</span><br><span class="line">    <span class="keyword">if</span> (plotView == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    plotView.InvalidatePlot(updateData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>例子2: 该交互针对的是PlotElement<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Example(<span class="meta-string">"MouseDown event and HitTestResult"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PlotModel <span class="title">MouseDownEventHitTestResult</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> model = <span class="keyword">new</span> PlotModel &#123; Title = <span class="string">"MouseDown HitTestResult"</span>, Subtitle = <span class="string">"Reports the index of the nearest point."</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> s1 = <span class="keyword">new</span> LineSeries();</span><br><span class="line">    s1.Points.Add(<span class="keyword">new</span> DataPoint(<span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">    s1.Points.Add(<span class="keyword">new</span> DataPoint(<span class="number">10</span>, <span class="number">40</span>));</span><br><span class="line">    s1.Points.Add(<span class="keyword">new</span> DataPoint(<span class="number">40</span>, <span class="number">20</span>));</span><br><span class="line">    s1.Points.Add(<span class="keyword">new</span> DataPoint(<span class="number">60</span>, <span class="number">30</span>));</span><br><span class="line">    model.Series.Add(s1);</span><br><span class="line">    s1.MouseDown += (s, e) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            model.Subtitle = <span class="string">"Index of nearest point in LineSeries: "</span> + Math.Round(e.HitTestResult.Index);</span><br><span class="line">            model.InvalidatePlot(<span class="literal">false</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> s2 = <span class="keyword">new</span> ScatterSeries();</span><br><span class="line">    s2.Points.Add(<span class="keyword">new</span> ScatterPoint(<span class="number">0</span>, <span class="number">15</span>));</span><br><span class="line">    s2.Points.Add(<span class="keyword">new</span> ScatterPoint(<span class="number">10</span>, <span class="number">45</span>));</span><br><span class="line">    s2.Points.Add(<span class="keyword">new</span> ScatterPoint(<span class="number">40</span>, <span class="number">25</span>));</span><br><span class="line">    s2.Points.Add(<span class="keyword">new</span> ScatterPoint(<span class="number">60</span>, <span class="number">35</span>));</span><br><span class="line">    model.Series.Add(s2);</span><br><span class="line">    s2.MouseDown += (s, e) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            model.Subtitle = <span class="string">"Index of nearest point in ScatterSeries: "</span> + (<span class="keyword">int</span>)e.HitTestResult.Index;</span><br><span class="line">            model.InvalidatePlot(<span class="literal">false</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果PlotModel和PlotElement都没有进行事件监听处理, 那么交互是针对PlotView的<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomPlotController</span> : <span class="title">PlotController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomPlotController</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.UnbindAll();</span><br><span class="line">        <span class="keyword">this</span>.BindKeyDown(OxyKey.Left, PlotCommands.PanRight);</span><br><span class="line">        <span class="keyword">this</span>.BindKeyDown(OxyKey.Right, PlotCommands.PanLeft);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MainViewModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Initializes a new instance of the <span class="doctag">&lt;see cref="MainViewModel" /&gt;</span> class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainViewModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Set the Model property, the INotifyPropertyChanged event will make the WPF Plot control update its content</span></span><br><span class="line">        <span class="keyword">this</span>.Model = CreatePlotModel(<span class="string">"Custom PlotController"</span>, <span class="string">"Supports left/right keys only"</span>);</span><br><span class="line">        <span class="keyword">this</span>.Controller = <span class="keyword">new</span> CustomPlotController();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.Model1 = CreatePlotModel(<span class="string">"Default controller"</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">this</span>.Model2 = CreatePlotModel(<span class="string">"Default controller"</span>, <span class="string">"UnbindAll()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">oxy:PlotView</span> <span class="attr">Model</span>=<span class="string">"&#123;Binding Model&#125;"</span> <span class="attr">Controller</span>=<span class="string">"&#123;Binding Controller&#125;"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>这种设计方式基本上是一个比较标准的MVC<br><img src="/img/mvc.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/11/2D Visualization笔记(X2) OxyPlot(一)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/11/2D Visualization笔记(X2) OxyPlot(一)/" itemprop="url">2D Visualization笔记(X2) OxyPlot(一)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-11T14:34:51+08:00">
                2018-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>OxyPlot is a cross-platform plotting library for .NET(<a href="http://www.oxyplot.org/)" target="_blank" rel="noopener">http://www.oxyplot.org/)</a>.<br><img src="/img/oxyplot.png" alt=""><br>有简单的文档(<a href="http://docs.oxyplot.org/en/latest/common-tasks/refresh-plot.html)" target="_blank" rel="noopener">http://docs.oxyplot.org/en/latest/common-tasks/refresh-plot.html)</a>. 这里以OxyPlot.WPF为例.</p>
<p>用词</p>
<p><strong>Plot</strong>:<br>Also called a graph or chart</p>
<p><strong>Plot model</strong>:<br>A model represents the contents of a plot</p>
<p><strong>Plot controller</strong>:<br>Handles user input</p>
<p><strong>Plot view</strong>:<br>The custom control that displays the plot model and communicates with the plot controller</p>
<p><strong>Plot element</strong>: An element of the plot model that can be displayed (e.g. a series, annotation or axis)</p>
<p><strong>Axis</strong>:<br>A plot element that displays an axis</p>
<p><strong>Series</strong>:<br>A plot element that displays data</p>
<p><strong>Annotation</strong>:<br>Displays content that is not a series. Annotations are not included in the legend and not used by the tracker</p>
<p><strong>Plot area</strong>:<br>The area where the series are displayed</p>
<p><strong>Legend</strong>:<br>Displays the titles and symbol of the series.</p>
<p><strong>Tracker</strong>:<br>When the user hovers or clicks on a series, the tracker shows the actual values at that point</p>
<hr>
<p>OxyPlot分为OxyPlot(Portable)和OxyPlot.Wpf两部分. OxyPlot(Portable)暴露IPlotView接口, OxyPlot.Wpf中的PlotBase继承Control, 同时实现IPlotView. 其他和平台无关的类, 都位于OxyPlot(Portable)中, 例如PlotModel和IPlotModel, IPlotController和PlotController.</p>
<p>先看入门样例(<a href="http://docs.oxyplot.org/en/latest/getting-started/hello-wpf.html)" target="_blank" rel="noopener">http://docs.oxyplot.org/en/latest/getting-started/hello-wpf.html)</a>:</p>
<h4 id="创建ViewModel"><a href="#创建ViewModel" class="headerlink" title="创建ViewModel"></a>创建ViewModel</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WpfApplication1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> OxyPlot;</span><br><span class="line">    <span class="keyword">using</span> OxyPlot.Series;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MainViewModel</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainViewModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.MyModel = <span class="keyword">new</span> PlotModel &#123; Title = <span class="string">"Example 1"</span> &#125;;</span><br><span class="line">            <span class="keyword">this</span>.MyModel.Series.Add(<span class="keyword">new</span> FunctionSeries(Math.Cos, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0.1</span>, <span class="string">"cos(x)"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> PlotModel MyModel &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建View"><a href="#创建View" class="headerlink" title="创建View"></a>创建View</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;Window x:Class=<span class="string">"WpfApplication1.MainWindow"</span></span><br><span class="line">        xmlns=<span class="string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span><br><span class="line">        xmlns:x=<span class="string">"http://schemas.microsoft.com/winfx/2006/xaml"</span> xmlns:oxy=<span class="string">"http://oxyplot.org/wpf"</span></span><br><span class="line">        xmlns:local=<span class="string">"clr-namespace:WpfApplication1"</span></span><br><span class="line">        Title=<span class="string">"Example 1 (WPF)"</span> Height=<span class="string">"350"</span> Width=<span class="string">"525"</span>&gt;</span><br><span class="line">    &lt;Window.DataContext&gt;</span><br><span class="line">        &lt;local:MainViewModel/&gt;</span><br><span class="line">    &lt;/Window.DataContext&gt;</span><br><span class="line">    &lt;Grid&gt;</span><br><span class="line">        &lt;oxy:PlotView Model=<span class="string">"&#123;Binding MyModel&#125;"</span>/&gt;</span><br><span class="line">    &lt;/Grid&gt;</span><br><span class="line">&lt;/Window&gt;</span><br></pre></td></tr></table></figure>
<p>运行得到下图<img src="/img/oxyplot-2.png" alt=""><br>先看PlotView的部分代码<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Identifies the <span class="doctag">&lt;see cref="Model"/&gt;</span> dependency property.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty ModelProperty =</span><br><span class="line">    DependencyProperty.Register(<span class="string">"Model"</span>, <span class="keyword">typeof</span>(PlotModel), <span class="keyword">typeof</span>(PlotView), <span class="keyword">new</span> PropertyMetadata(<span class="literal">null</span>, ModelChanged));</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Called when the model is changed.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="d"&gt;</span>The sender.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="e"&gt;</span>The <span class="doctag">&lt;see cref="System.Windows.DependencyPropertyChangedEventArgs" /&gt;</span> instance containing the event data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ModelChanged</span>(<span class="params">DependencyObject d, DependencyPropertyChangedEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ((PlotView)d).OnModelChanged();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Called when the model is changed.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnModelChanged</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">lock</span> (<span class="keyword">this</span>.modelLock)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.currentModel != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ((IPlotModel)<span class="keyword">this</span>.currentModel).AttachPlotView(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.currentModel = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.Model != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ((IPlotModel)<span class="keyword">this</span>.Model).AttachPlotView(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">this</span>.currentModel = <span class="keyword">this</span>.Model;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.InvalidatePlot();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当面Model的值发生变化时, 会调用ModelChanged方法, 进而调用this.InvalidatePlot方法绘图. 这里另外一个地方也很重要: AttachPlotView(this). 将PlotView关联到PlotModel中.</p>
<p>InvalidatePlot方法是在父类PlotBase中定义的, 这个方法至关重要.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Invalidate the PlotView (not blocking the UI thread)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="updateData"&gt;</span>The update Data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InvalidatePlot</span>(<span class="params"><span class="keyword">bool</span> updateData = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.ActualWidth &lt;= <span class="number">0</span> || <span class="keyword">this</span>.ActualHeight &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.UpdateModel(updateData);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Interlocked.CompareExchange(<span class="keyword">ref</span> <span class="keyword">this</span>.isPlotInvalidated, <span class="number">1</span>, <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Invalidate the arrange state for the element.</span></span><br><span class="line">        <span class="comment">// After the invalidation, the element will have its layout updated,</span></span><br><span class="line">        <span class="comment">// which will occur asynchronously unless subsequently forced by UpdateLayout.</span></span><br><span class="line">        <span class="keyword">this</span>.BeginInvoke(<span class="keyword">this</span>.InvalidateArrange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Updates the model.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="updateData"&gt;</span>The update Data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">UpdateModel</span>(<span class="params"><span class="keyword">bool</span> updateData = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.ActualModel != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ((IPlotModel)<span class="keyword">this</span>.ActualModel).Update(updateData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第一步更新PlotModel, 第二步异步调用InvalidateArrange进行绘制. InvalidateArrange是Control的方法, 最终调用的ArrangeOverride方法<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Provides the behavior for the Arrange pass of Silverlight layout. Classes can override this method to define their own Arrange pass behavior.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="finalSize"&gt;</span>The final area within the parent that this object should use to arrange itself and its children.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>The actual size that is used after the element is arranged in layout.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Size <span class="title">ArrangeOverride</span>(<span class="params">Size finalSize</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.ActualWidth &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.ActualHeight &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Interlocked.CompareExchange(<span class="keyword">ref</span> <span class="keyword">this</span>.isPlotInvalidated, <span class="number">0</span>, <span class="number">1</span>) == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.UpdateVisuals();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">base</span>.ArrangeOverride(finalSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Updates the visuals.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateVisuals</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.canvas == <span class="literal">null</span> || <span class="keyword">this</span>.renderContext == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.isVisibleToUserCache)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clear the canvas</span></span><br><span class="line">    <span class="keyword">this</span>.canvas.Children.Clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.ActualModel != <span class="literal">null</span> &amp;&amp; <span class="keyword">this</span>.ActualModel.Background.IsVisible())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.canvas.Background = <span class="keyword">this</span>.ActualModel.Background.ToBrush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.canvas.Background = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.ActualModel != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.DisconnectCanvasWhileUpdating)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> profile... not sure if this makes any difference</span></span><br><span class="line">            <span class="keyword">int</span> idx = <span class="keyword">this</span>.grid.Children.IndexOf(<span class="keyword">this</span>.canvas);</span><br><span class="line">            <span class="keyword">if</span> (idx != <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.grid.Children.RemoveAt(idx);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ((IPlotModel)<span class="keyword">this</span>.ActualModel).Render(<span class="keyword">this</span>.renderContext, <span class="keyword">this</span>.canvas.ActualWidth, <span class="keyword">this</span>.canvas.ActualHeight);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// reinsert the canvas again</span></span><br><span class="line">            <span class="keyword">if</span> (idx != <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.grid.Children.Insert(idx, <span class="keyword">this</span>.canvas);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ((IPlotModel)<span class="keyword">this</span>.ActualModel).Render(<span class="keyword">this</span>.renderContext, <span class="keyword">this</span>.canvas.ActualWidth, <span class="keyword">this</span>.canvas.ActualHeight);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在UpdateVisual方法中, 看到了Render方法. 该方法是在PlotModel中定义的. <strong>也就是说PlotView不关心具体的绘制逻辑, 它只提供绘图的纸和笔(RenderContext, 在WPF中,该RenderContext就是Canvas). 然后由PlotModel负责整个绘制逻辑. PlotModel由各种PlotElement组成, 各种PlotElement有自己的绘图逻辑. 于是PlotModel把从PlotView中拿到的纸和笔, 再交给具体的PlotElement, 由他们自己去绘制</strong>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Renders the plot with the specified rendering context.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="rc"&gt;</span>The rendering context.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="width"&gt;</span>The width.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="height"&gt;</span>The height.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="keyword">void</span> IPlotModel.Render(IRenderContext rc, <span class="keyword">double</span> width, <span class="keyword">double</span> height)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.RenderOverride(rc, width, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Renders the plot with the specified rendering context.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="rc"&gt;</span>The rendering context.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="width"&gt;</span>The width.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="height"&gt;</span>The height.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">RenderOverride</span>(<span class="params">IRenderContext rc, <span class="keyword">double</span> width, <span class="keyword">double</span> height</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">this</span>.RenderBackgrounds(rc);</span><br><span class="line">        <span class="keyword">this</span>.RenderAnnotations(rc, AnnotationLayer.BelowAxes);</span><br><span class="line">        <span class="keyword">this</span>.RenderAxes(rc, AxisLayer.BelowSeries);</span><br><span class="line">        <span class="keyword">this</span>.RenderAnnotations(rc, AnnotationLayer.BelowSeries);</span><br><span class="line">        <span class="keyword">this</span>.RenderSeries(rc);</span><br><span class="line">        <span class="keyword">this</span>.RenderAnnotations(rc, AnnotationLayer.AboveSeries);</span><br><span class="line">        <span class="keyword">this</span>.RenderTitle(rc);</span><br><span class="line">        <span class="keyword">this</span>.RenderBox(rc);</span><br><span class="line">        <span class="keyword">this</span>.RenderAxes(rc, AxisLayer.AboveSeries);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.IsLegendVisible)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.RenderLegends(rc, <span class="keyword">this</span>.LegendArea);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Renders the series.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="rc"&gt;</span>The render context.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RenderSeries</span>(<span class="params">IRenderContext rc</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> s <span class="keyword">in</span> <span class="keyword">this</span>.Series.Where(s =&gt; s.IsVisible))</span><br><span class="line">        &#123;</span><br><span class="line">            rc.SetToolTip(s.ToolTip);</span><br><span class="line">            s.Render(rc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rc.SetToolTip(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">``` </span><br><span class="line">以LineSeries为例</span><br><span class="line">```CSharp</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Renders the series on the specified rendering context.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="rc"&gt;</span>The rendering context.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Render</span>(<span class="params">IRenderContext rc</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> actualPoints = <span class="keyword">this</span>.ActualPoints;</span><br><span class="line">        <span class="keyword">if</span> (actualPoints == <span class="literal">null</span> || actualPoints.Count == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.VerifyAxes();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> clippingRect = <span class="keyword">this</span>.GetClippingRect();</span><br><span class="line">        rc.SetClip(clippingRect);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.RenderPoints(rc, clippingRect, actualPoints);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.LabelFormatString != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// render point labels (not optimized for performance)</span></span><br><span class="line">            <span class="keyword">this</span>.RenderPointLabels(rc, clippingRect);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rc.ResetClip();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.LineLegendPosition != LineLegendPosition.None &amp;&amp; !<span class="keyword">string</span>.IsNullOrEmpty(<span class="keyword">this</span>.Title))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// renders a legend on the line</span></span><br><span class="line">            <span class="keyword">this</span>.RenderLegendOnLine(rc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/07/WCF笔记(X5) 并发管理 /">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/07/WCF笔记(X5) 并发管理 /" itemprop="url">WCF笔记(X5) 并发管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-07T19:41:51+08:00">
                2018-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇笔记中提到了ConcurrencyMode, WCF中的并发指的是同一个服务实例上下文同时处理多个服务调用请求. 这里再进一步介绍一下ConcurrencyMode, 特别是ConcurrencyMode与InstanceContextMode之间的关系</p>
<p>WCF并发框架解决的是如何有效地处理被分发到同一个服务实例上下文的多个服务调用请求. 这些并行的调用请求可能来自不同的客户端(服务代理), 也可能来自相同的客户端.</p>
<h3 id="Instance-Management-and-Concurrency"><a href="#Instance-Management-and-Concurrency" class="headerlink" title="Instance Management and Concurrency"></a>Instance Management and Concurrency</h3><p>Service-instance thread safety is closely related to the service instancing mode. A per-call service instance is thread-safe by definition, because each call gets its own dedicated instance. That instance is accessible only by its assigned worker thread, and because no other threads will be accessing it, it has no need for synchronization. 对实例资源不需要同步</p>
<p>However, a per-call service is typically state-aware. The state store can be an inmemory resource such as static dictionary, and it can be subject to multithreaded access because the service can sustain concurrent calls, whether from the same client or from multiple clients. Consequently, you must synchronize access to the state store. 对静态资源仍然需要同步</p>
<p>A per-session service always requires concurrency management and synchronization, because the client may use the same proxy and yet dispatch calls to the service on multiple client-side threads. 在同一个Client端发起多个线程, 但使用的是同一个Proxy. 这种情况下, 调用的是同一个Service Instance. 所以需要同步; 如果每个线程都new一个Porxy, 那么它们调用的是不同的Service Instance, 不需要对实例资源进行同步.</p>
<p>A singleton service is even more susceptible(敏感) to concurrent access, and must support synchronized access. The singleton has some inmemory state that all clients implicitly share. On top of the possibility of the client dispatching calls on multiple threads, as with a per-session service, a singleton may simply have multiple clients in different execution contexts, each using its own thread to call the service. All of these calls will enter the singleton on different threads from the I/O completion thread pool—hence the need for synchronization. 单例模式下, 即使是不同的Proxy, 调用的都是同一个Service Instance. 需要同步.</p>
<p>CurrentMode有以下三种<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ConcurrencyMode</span><br><span class="line">&#123;</span><br><span class="line">    Single,<span class="comment">//默认加锁</span></span><br><span class="line">    Reentrant, <span class="comment">//可重入</span></span><br><span class="line">    Multiple</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="ConcurrencyMode-Single"><a href="#ConcurrencyMode-Single" class="headerlink" title="ConcurrencyMode.Single"></a>ConcurrencyMode.Single</h4><p>When the service is configured with ConcurrencyMode.Single, WCF will provide automatic synchronization to the service context and disallow concurrent calls by associating the context containing the service instance with a synchronization lock. Every call coming into the service must first try to acquire the lock. If the lock is unowned, the caller will be allowed in. Once the operation returns, WCF will unlock the lock, thus allowing in another caller.</p>
<p>The important thing is that only one caller at a time is ever allowed. If there are multiple concurrent callers while the lock is locked, the callers are all placed in a queue and are served out of the queue in order. If a call times out while blocked, WCF will remove the caller from the queue and the client will get a TimeoutException. </p>
<p>Because the default concurrency mode is synchronized access, the susceptible instancing modes of per-session and singleton are also synchronized by default. Note that even calls to a per-call service instance are synchronized by default.</p>
<h4 id="ConcurrencyMode-Multiple"><a href="#ConcurrencyMode-Multiple" class="headerlink" title="ConcurrencyMode.Multiple"></a>ConcurrencyMode.Multiple</h4><p>When the service is configured with ConcurrencyMode.Multiple, WCF will stay out of the way and will not synchronize access to the service instance in any way. <strong>ConcurrencyMode.Multiple simply means that the service instance is not associated with any synchronization lock, so concurrent calls are allowed on the service instance</strong>. Put differently, when a service instance is configured with ConcurrencyMode.Multiple WCF will not queue up the client messages and dispatch them to the service instance as soon as they arrive.</p>
<p>Multiple选项不提供任何同步措施, 需要手动同步, 例如:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ServiceContract(SessionMode = SessionMode.Required)</span>]</span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">ServiceBehavior(ConcurrencyMode = ConcurrencyMode.Multiple)</span>]</span><br><span class="line"><span class="keyword">class</span> <span class="title">MyService</span> : <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span>[] m_Numbers;</span><br><span class="line">	List&lt;<span class="keyword">string</span>&gt; m_Names;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="keyword">lock</span>(<span class="keyword">this</span>)</span><br><span class="line">		&#123;</span><br><span class="line">		...</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>While this code is thread-safe, you actually gain little from the use of ConcurrencyMode.Multiple: the net effect in terms of synchronization is similar to using ConcurrencyMode.Single, yet you have increased the overall code complexity and reliance on developers’ discipline. <strong>In general, you should avoid ConcurrencyMode.Multiple</strong>. However, there are cases where ConcurrencyMode.Multiple is useful.</p>
<h4 id="ConcurrencyMode-Reentrant"><a href="#ConcurrencyMode-Reentrant" class="headerlink" title="ConcurrencyMode.Reentrant"></a>ConcurrencyMode.Reentrant</h4><p>The ConcurrencyMode.Reentrant value is a refinement of the ConcurrencyMode.Single value. <strong>Similarly to ConcurrencyMode.Single, ConcurrencyMode.Reentrantassociates the service instance with a synchronization lock</strong>, so that concurrent calls on the same instance are never allowed. However, if the reentrant service calls out to another service or a callback, and that call chain (or causality) somehow winds its way back to the service instance 如下图所示, WCF silently releases the synchronization lock that is associated with the instance.it is allowed to reenter the service instance.<br><img src="/img/wcf-call-reentrancy.png" alt=""></p>
<p>ConcurrencyMode.Reentrant is designed to avoid the potential deadlock of reentrancy.</p>
<p>A service configured with ConcurrencyMode.Multiple is by definition also reentrant, because no lock is held during the callout.However, unlike a reentrant service, which is inherently threadsafe, a service configured with ConcurrencyMode.Multiple must provide for its own synchronization (for example, by locking the instance during every call, as explained previously). It is up to the developer of such a service to decide if it should release the lock before calling out to avoid a reentrancy deadlock. <strong>ConcurrencyMode.Multiple本身也是可重入的</strong></p>
<p>可重入不是说两个线程可以并发调用该方法, 它仍然是single模式, 后一个会等前一个执行完之后再进入<br>可重入是说, 在方法内部调用其他Service或者回调, 当Service或者回调返回时, 仍然能够回到该Context中. 如果不能返回, 就是死锁.</p>
<p>上一篇笔记中提到, 即使Callback中加了ConcurrencyMode.Reentrant, 仍有可能发生死锁.</p>
<h3 id="Instances-and-Concurrent-Access"><a href="#Instances-and-Concurrent-Access" class="headerlink" title="Instances and Concurrent Access"></a>Instances and Concurrent Access</h3><p>Using the same proxy, a single client can issue multiple concurrent calls to a service. The client can use multiple threads to invoke calls on the service, or it can issue oneway calls in rapid succession on the same thread. In both of these cases, whether the calls from the same client are processed concurrently is the product of the service’s configured instancing mode, the service’s concurrency mode, and the configured delivery mode (that is, the transport session). The following discussion applies equally to request-reply and one-way calls.</p>
<h4 id="Per-Call-Services"><a href="#Per-Call-Services" class="headerlink" title="Per-Call Services"></a>Per-Call Services</h4><p>In the case of a per-call service, if there is no transport-level session, concurrent processing of calls is allowed. Calls are dispatched as they arrive, each to a new instance, and execute concurrently. This is the case regardless of the service concurrency mode.</p>
<p>If the service is configured with ConcurrencyMode.Single, concurrent processing of the pending calls is not allowed, and the calls are dispatched one at a time. </p>
<p>If the service is configured with ConcurrencyMode.Multiple, concurrent processing is allowed. Calls are dispatched as they arrive, each to a new instance, and execute concurrently. it is a good idea to configure a per-call service with Concurrency Mode.Multiple—the instance itself will still be thread-safe (so you will not incur the synchronization liability), yet you will allow concurrent calls from the same client</p>
<p>When the service is configured with ConcurrencyMode.Reentrant, if the service does not call out, it behaves similarly to a service configured with ConcurrencyMode.Single. If the service does call out, the next call is allowed in, and the returning call has to negotiate the lock like all other pending calls</p>
<h4 id="Sessionful-and-Singleton-Services"><a href="#Sessionful-and-Singleton-Services" class="headerlink" title="Sessionful and Singleton Services"></a>Sessionful and Singleton Services</h4><p>In the case of a sessionful or a singleton service, the configured concurrency mode alone governs the concurrent execution of pending calls. If the service is configured with ConcurrencyMode.Single, calls will be dispatched to the service instance one at a time, and pending calls will be placed in a queue. You should avoid lengthy processing of calls, because it may risk call timeouts.</p>
<p>If the service instance is configured with ConcurrencyMode.Multiple, concurrent processing of calls from the same client is allowed. Calls will be executed by the service instance as fast as they come off the channel (up to the throttle limit). Of course, as is always the case with a stateful unsynchronized service instance, you must synchronize access to the service instance or risk state corruption.</p>
<p>If the service instance is configured with ConcurrencyMode.Reentrant, it behaves just as it would with ConcurrencyMode.Single. However, if the service calls out, the next call is allowed to execute. You must follow the guidelines discussed previously regarding programming in a reentrant environment.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/06/WCF笔记(X4) 双工通信/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/06/WCF笔记(X4) 双工通信/" itemprop="url">WCF笔记(X4) 双工通信</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-06T17:41:51+08:00">
                2018-05-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>WCF的整体结构如下图所示<br><img src="/img/wcf-arch.png" alt=""></p>
<p>图上展示的是Client调用Service的过程. 在前面的笔记中已经提到, 调用过程也可以反向进行, 从Service回调Client, 这就是WCF中的双工通信.原先的Service和Client将发生对调，Service成为Client，Client成为Service。</p>
<p>WCF支持3种消息交换模式： 1. Request/Reply (请求/回复); 2. One-Way(单向); 3. Duplex(双工). 前面两种是基本的消息交换模式, 可以用OperationContract描述, Duplex可以看成是前两种基本消息交换模式的组合.</p>
<p>1.Request/Reply 默认方式</p>
<p>As the name implies, in these operations, the client issues a request in the form of a message and blocks until it gets the reply message. <strong>If the service does not respond within a default timeout of one minute, the client will get a TimeoutException</strong>. Request-reply is the <strong>default</strong> operation mode. Programming against request-reply operations is simple enough and resembles programming using the classic client/server model. The returned response message containing the results or returned values is converted to normal method return values. In addition, the proxy will throw an exception on the client side if there are any communication or service-side exceptions</p>
<p>2.One-Way<br>One-Way 这种方式在调用方法后会立即返回。需要注意的是 One-Way 不能用在非void，或者包含 out/ref 参数的方法上，会导致抛出 InvalidOperationException 异常。 </p>
<p>There are cases when an operation has no return value, and the client does not care about the success or failure of the invocation. To support this sort of fire-and-forget invocation, WCF offers one-way operations: once the client issues the call, WCF generates a request message, but no correlated reply message will ever return to the client. As a result, one-way operations cannot return values, and any exceptions thrown<br>on the service side will not make their way to the client.</p>
<p>Ideally, when the client calls a one-way method, it should be blocked only for the briefest moment required to dispatch the call. However, in reality, one-way calls do not equate to asynchronous calls. When one-way calls reach the service, they may not be dispatched all at once but may instead be buffered on the service side to be dispatched one at a time, according to the service’s configured concurrency mode behavior. The<br>number of messages the service can buffer (be they one-way or request-reply operations) is a product of the configured channel and reliability mode. If the number of messages exceeds the buffer’s capacity, the client will be blocked even if it has issued a one-way call. However, once the call is deposited in the buffer, the client will be unblocked and can continue executing while the service processes the operation in<br>the background. 假如one-way call到达Service但没有立即被Dispatch, 而是在缓存队列中, 这是client会被阻塞</p>
<p>It’s also wrong to equate one-way calls with concurrent calls. If the client uses the same proxy yet utilizes multiple threads to invoke one-way calls, the calls may or may not execute concurrently on the service, and the exact nature of the interaction will be determined by the service concurrency management mode and the transport session (see Chapter 8 for more on this subject).All of the WCF bindings support one-way operations.</p>
<p>3.Duplex  </p>
<p>WCF supports allowing a service to call back to its clients. During a callback, in many respects the tables are turned: the service is the client, and the client becomes the service (see Figure 5-1). Callback operations can be used in a variety of scenarios and applications, but they are especially useful when it comes to events, or notifying the client(s) that some event has happened on the service side.</p>
<p>Not all bindings support callback operations. Only bidirectional-capable bindings support callback operations. For example, because of its connectionless nature, HTTP cannot be used for callbacks, and therefore you cannot use callbacks over the BasicHttpBinding or the WSHttpBinding. The only two commonly used bindings that offer callbacks are the NetTcpBinding and the NetNamedPipeBinding, because by their very nature, the TCP and the IPC protocols support duplex communication.</p>
<p>一个服务契约若要定义回调，必须专门定义一个用于回调的契约。一个服务契约最多包含一个回调契约，一个服务契约一旦定义了回调契约那客户端必须支持这个回调。那如何为一个服务契约定义回调呢？使用ServiceContract特性的CallBackContract特性，代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title">IMyContractCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">OperationContract</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnCallback</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">ServiceContract(CallbackContract = typeof(IMyContractCallback))</span>]</span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">OperationContract</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">DoSomething</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Client-Callback-Setup"><a href="#Client-Callback-Setup" class="headerlink" title="Client Callback Setup"></a>Client Callback Setup</h3><p>It is up to the client to host the callback object and expose a callback endpoint. Recall from Chapter 1 that the innermost execution scope of the service instance is the instance context. The InstanceContext class provides a constructor that takes the service instance to the host:</p>
<p>All the client needs to do to host a callback object is instantiate the callback object and construct a context around it:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">MyCallback</span> : <span class="title">IMyContractCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnCallback</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line">IMyContractCallback callback = <span class="keyword">new</span> MyCallback();</span><br><span class="line">InstanceContext context = <span class="keyword">new</span> InstanceContext(callback);</span><br><span class="line"></span><br><span class="line">MyContractClient proxy = <span class="keyword">new</span> MyContractClient(context);</span><br><span class="line">proxy.DoSomething();</span><br></pre></td></tr></table></figure></p>
<h3 id="Service-Side-Callback-Invocation"><a href="#Service-Side-Callback-Invocation" class="headerlink" title="Service-Side Callback Invocation"></a>Service-Side Callback Invocation</h3><p>The client-side callback endpoint reference is passed along with every call the client makes to the service, and it is part of the incoming message. The OperationContext class provides the service with easy access to the callback reference via the generic method GetCallbackChannel<t>()</t></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ServiceBehavior(InstanceContextMode = InstanceContextMode.PerCall)</span>]</span><br><span class="line"><span class="keyword">class</span> <span class="title">MyService</span> : <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> List&lt;IMyContractCallback&gt; m_Callbacks = <span class="keyword">new</span> List&lt;IMyContractCallback&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoSomething</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IMyContractCallback callback = OperationContext.Current.GetCallbackChannel&lt;IMyContractCallback&gt;();</span><br><span class="line">        <span class="keyword">if</span>(m_Callbacks.Contains(callback) == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_Callbacks.Add(callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CallClients</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Action&lt;IMyContractCallback&gt; invoke = callback =&gt; callback.OnCallback();</span><br><span class="line">        m_Callbacks.ForEach (invoke);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Callback-reentrancy"><a href="#Callback-reentrancy" class="headerlink" title="Callback reentrancy"></a>Callback reentrancy</h4><p>The service may also want to invoke the callback reference that’s passed in (or a saved copy of it) during the execution of a contract operation. However, such invocations are disallowed by default. The reason is the default service concurrency management.<strong>By default, the service class is configured for single-threaded access</strong>: the service instance context is associated with a lock, and only one thread at a time can own the<br>lock and access the service instance inside that context. <strong>Calling out to the client during an operation call requires blocking the service thread and invoking the callback. The problem is that processing the reply message from the client on the same channel once the callback returns requires reentering the same context and negotiating ownership of the same lock, which will result in a deadlock</strong>. Note that the service may still invoke callbacks to other clients or call other services; <strong>it is the callback to its calling client that will cause the deadlock</strong></p>
<p>To prevent such a deadlock, if the single-threaded service instance tries to call back to its client, WCF will throw an InvalidOperationException. There are three possible solutions. <strong>The first</strong> is to configure the service for multithreaded access. Callbacks to the calling client will then be allowed because the service instance will not be associated with a lock; however, this will increase the burden on the service developer, because of the need to provide synchronization for the service. <strong>The second</strong> solution is to configure the service for reentrancy. When configured for reentrancy, the service instance context is still associated with a lock, and only single-threaded access is allowed. However, if the service is calling back to its client, WCF will silently release the lock first. you can set the concurrency behavior to either multithreaded or reentrant using the Concurrency Mode property of the ServiceBehavior attribute:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ConcurrencyMode</span><br><span class="line">&#123;</span><br><span class="line">    Single, <span class="comment">//Default</span></span><br><span class="line">    Reentrant,</span><br><span class="line">    Multiple</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ServiceContract(CallbackContract = typeof(IMyContractCallback))</span>]</span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">OperationContract</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">DoSomething</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyContractCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">OperationContract</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnCallback</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">ServiceBehavior(ConcurrencyMode = ConcurrencyMode.Reentrant)</span>]</span><br><span class="line"><span class="keyword">class</span> <span class="title">MyService</span> : <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoSomething</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IMyContractCallback callback = OperationContext.Current.GetCallbackChannel&lt;IMyContractCallback&gt;();</span><br><span class="line">        callback.OnCallback();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>The third</strong> solution that allows the service to safely call back to the calling client is to configure the callback contract operations as one-way operations. Doing so will enable the service to call back even when the concurrency mode is set to singlethreaded, because there will not be any reply message to contend for the lock.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Example 5-8. One-way callbacks are allowed by default</span></span><br><span class="line">[<span class="meta">ServiceContract(CallbackContract = typeof(IMyContractCallback))</span>]</span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">OperationContract</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">DoSomething</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyContractCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">OperationContract(IsOneWay = true)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnCallback</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">MyService</span> : <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoSomething</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IMyContractCallback callback = OperationContext.Current.GetCallbackChannel&lt;IMyContractCallback&gt;();</span><br><span class="line">        callback.OnCallback();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Callbacks-and-the-UI-Synchronization-Context"><a href="#Callbacks-and-the-UI-Synchronization-Context" class="headerlink" title="Callbacks and the UI Synchronization Context"></a>Callbacks and the UI Synchronization Context</h4><p>Configuring the callback for affinity to the UI thread may trigger a deadlock. Suppose a Windows Forms client establishes an affinity between a callback object (or even itself) and the UI synchronization context, and then calls a service, passing the callback reference. The service is configured for reentrancy, and it calls back to the client.</p>
<p>A deadlock now occurs because the callback to the client needs to execute on the UI thread, and that thread is blocked waiting for the service call to return. For example,Example 8-22 has the potential for this deadlock. Configuring the callback as a oneway operation will not resolve the problem here, because the one-way call still needs to be marshaled first to the UI thread. The only way to resolve the deadlock in this case is to turn off using the UI synchronization context by the callback, and to manually and asynchronously marshal the update to the form using its synchronization context. Example 8-24 demonstrates using this technique.</p>
<p>Thread Affinity (线程亲和性) 和 marshal(封送), 这两个概念是一块儿的</p>
<p>Whenever an affinity to a particular thread or threads is expected, the service cannot simply execute the call on the incoming WCF worker thread. Instead, the service must marshal the call to the correct thread(s) required by the resource that it accesses.</p>
<p>marshal指的是A线程中向B线程发送一个调用请求, 例如工作线程marshal(封送)到UI线程</p>
<p>UseSynchronizationContext的运用</p>
<p>If the thread that is opening the host has a synchronization context and UseSynchronizationContext is true, WCF will establish an affinity between that synchronization context and all of the instances of the service that is hosted by that host. WCF will automatically marshal all of the incoming calls to the service’s synchronization context.</p>
<p>The default value of UseSynchronizationContext is true,</p>
<p>The classic use of UseSynchronizationContext is to enable the service to update UI controls and windows directly. WCF greatly simplifies UI updates by providing an affinity between all of the service instances from a particular host and a specific UI thread.</p>
<p>Whenever you use hosting on the UI thread, deadlocks are possible. For example, the following setup is guaranteed to result with a deadlock: A Windows Forms application is hosting a service with UseSynchronizationContext set to true, and UI thread affinity is established. The Windows Forms application then calls the service over one of its endpoints. The call to the service blocks the UI thread, while WCF posts a message to the UI thread to invoke the service. That message is never processed, because of the blocking UI thread—hence, the deadlock.</p>
<p>UseSynchronizationContext 默认为true, 那么UI线程调用服务, 服务回调默认也发生在UI线程中.<br>假如调用不是request-reply, 那么会出现死锁: UI线程等待服务结束调用(堵塞), 服务结束调用, 需要回调返回, 而回调又需要UI线程, 所以死循环了</p>
<p>一个解决方法是UseSynchronizationContext 设为false, 那么回调就会发生在work thread中, 然后再从work thread封送到UI线程, 假如需要操作UI控件的话</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Example 8-22 </span></span><br><span class="line"><span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MyForm</span> : <span class="title">Form</span>,<span class="title">IMyContractCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    MyContractClient m_Proxy;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyForm</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        InitializeComponent();</span><br><span class="line">        m_Proxy = <span class="keyword">new</span> MyContractClient(<span class="keyword">new</span> InstanceContext(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Called as a result of a UI event</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnCallService</span>(<span class="params"><span class="keyword">object</span> sender,EventArgs args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Proxy.MyMethod(); <span class="comment">//Affinity established here</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//This method always runs on the UI thread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnCallback</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//No need for synchronization and marshaling</span></span><br><span class="line">        Text = <span class="string">"Some Callback"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnClose</span>(<span class="params"><span class="keyword">object</span> sender,EventArgs args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Proxy.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Example 8-24. Avoiding a callback deadlock on the UI thread</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span>// Client Side <span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span></span></span><br><span class="line">[<span class="meta">CallbackBehavior(UseSynchronizationContext = false)</span>]</span><br><span class="line"><span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MyForm</span> : <span class="title">Form</span>,<span class="title">IMyContractCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    SynchronizationContext m_Context;</span><br><span class="line">    MyContractClient m_Proxy;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyForm</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        InitializeComponent();</span><br><span class="line">        m_Context = SynchronizationContext.Current;</span><br><span class="line">        m_Proxy = <span class="keyword">new</span> MyContractClient(<span class="keyword">new</span> InstanceContext(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CallService</span>(<span class="params"><span class="keyword">object</span> sender,EventArgs args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Proxy.MyMethod();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Callback runs on worker threads</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnCallback</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        SendOrPostCallback setText = _=&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            Text = <span class="string">"Manually marshaling to UI thread"</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        m_Context.Post(setText,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnClose</span>(<span class="params"><span class="keyword">object</span> sender,EventArgs args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Proxy.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span>// Service Side <span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span></span></span><br><span class="line">[<span class="meta">ServiceContract(CallbackContract = typeof(IMyContractCallback))</span>]</span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">OperationContract</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyContractCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">OperationContract</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnCallback</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">ServiceBehavior(ConcurrencyMode = ConcurrencyMode.Reentrant)</span>]</span><br><span class="line"><span class="keyword">class</span> <span class="title">MyService</span> : <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IMyContractCallback callback = OperationContext.Current.GetCallbackChannel&lt;IMyContractCallback&gt;();</span><br><span class="line">        callback.OnCallback();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WCF解决死锁的策略<br>WCF resolves service call deadlocks by eventually timing out the call and throwing a TimeoutException</p>
<p>参考:<br>Writing Smart Clients by Using Windows Communication Foundation(<a href="https://msdn.microsoft.com/en-us/library/cc294424.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/cc294424.aspx</a>)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/06/WCF笔记(X3) 实例管理/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/06/WCF笔记(X3) 实例管理/" itemprop="url">WCF笔记(X3) 实例管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-06T16:41:51+08:00">
                2018-05-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前面提到了Client通过Proxy或者Channel将服务调用转发给Service Instance(服务实例). 接下来的一个问题是, 假如有多个Client同时调用服务, Client与Service Instance之间是多对多的关系, 还是多对一的关系, 亦或其他关系?<br>回答这个问题之前, 先看WCF中服务寄宿的结构<br><img src="/img/wcf-host-arch.png" alt=""></p>
<blockquote>
<p>Each service host instance has zero or more contexts. The context is the innermost execution scope of the service instance.A context is associated with zero or one service instance, meaning it could also be<br>empty (i.e., not associated with any service instance). It is the combined work of the service host and the context that exposes a native CLR type as a service. After the message is passed through the channels, the host maps that message to a new or existing context (and the object instance inside) and lets it process the call.</p>
</blockquote>
<p>WCF支持以下三种实例上下文模式<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> InstanceContextMode</span><br><span class="line">&#123;</span><br><span class="line">	PerCall,<span class="comment">//单调</span></span><br><span class="line">	PerSession, <span class="comment">//会话, 默认</span></span><br><span class="line">	Single <span class="comment">//单例</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The enum is correctly called <strong>InstanceContextMode</strong> rather than <strong>InstanceMode</strong> because it actually controls the instantiation mode of the context hosting the instance, rather than that of the instance itself. By default, however, the instance and its context are treated as a single unit, so the enum does control the life of the instance as well</p>
<h4 id="PerCall模式"><a href="#PerCall模式" class="headerlink" title="PerCall模式"></a>PerCall模式</h4><p>PerCall字面上就是每一次服务调用. 不管服务调用是否来自相同的客户端, host这边总是创建一个全新的实例上下文来处理每一个请求.</p>
<p><img src="/img/wcf-percall.png" alt=""></p>
<ol>
<li>The client calls the proxy and the proxy forwards the call to the service.</li>
<li>WCF creates a new context with a new service instance and calls the method on<br>it.</li>
<li>When the method call returns, if the object implements IDisposable, WCF calls<br>IDisposable.Dispose() on it. WCF then destroys the context.</li>
<li>The client calls the proxy and the proxy forwards the call to the service.</li>
<li>WCF creates an object and calls the method on it.</li>
</ol>
<h4 id="PerCall模式的好处"><a href="#PerCall模式的好处" class="headerlink" title="PerCall模式的好处"></a>PerCall模式的好处</h4><blockquote>
<p>In the classic client/server programming model, using languages such as C++ or C#, every client gets its own dedicated server object. The fundamental problem with this approach is that it doesn’t scale well. Imagine an application that has to serve many clients. Typically, these clients create the objects they need when the client application starts and dispose of them when the client application shuts down. What impedes<br>scalability with the client/server model is that the client applications can hold onto objects for long periods of time, while actually using them for only a fraction of that time. Those objects may hold expensive or scarce resources, such as database connections, communication ports, or files. If you allocate an object for each client, you will tie up such crucial and/or limited resources for long periods, and you will eventually run out of resources.</p>
</blockquote>
<blockquote>
<p>A better activation model is to allocate an object for a client only while a call is in progress from the client to the service. That way, you have to create and maintain in memory only as many objects as there are concurrent calls, not as many objects as there are outstanding clients. My personal experience indicates that in a typical Enterprise system, especially one that involves users, at most 1% of all clients make concurrent calls (in a high-load Enterprise system, that figure rises to 3%). Thus, if your system can concurrently sustain 100 expensive service instances, it can still typically serve as many as 10,000 outstanding clients. This is precisely the benefit the per-call instance activation mode offers</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span>/ Service Code <span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span></span></span><br><span class="line">[<span class="meta">ServiceContract</span>]</span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">OperationContract</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">ServiceBehavior(InstanceContextMode = InstanceContextMode.PerCall)</span>]</span><br><span class="line"><span class="keyword">class</span> <span class="title">MyService</span> : <span class="title">IMyContract</span>,<span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> m_Counter = <span class="number">0</span>;</span><br><span class="line">    MyService()</span><br><span class="line">    &#123;</span><br><span class="line">        Trace.WriteLine(<span class="string">"MyService.MyService()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Counter++;</span><br><span class="line">        Trace.WriteLine(<span class="string">"Counter = "</span> + m_Counter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Trace.WriteLine(<span class="string">"MyService.Dispose()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span>/ Client Code <span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span></span></span><br><span class="line">MyContractClient proxy = <span class="keyword">new</span> MyContractClient();</span><br><span class="line">proxy.MyMethod();</span><br><span class="line">proxy.MyMethod();</span><br><span class="line">proxy.Close();</span><br><span class="line"><span class="comment">//Possible output</span></span><br><span class="line">MyService.MyService()</span><br><span class="line">Counter = <span class="number">1</span></span><br><span class="line">MyService.Dispose()</span><br><span class="line">MyService.MyService()</span><br><span class="line">Counter = <span class="number">1</span></span><br><span class="line">MyService.Dispose()</span><br></pre></td></tr></table></figure>
<h4 id="PerSesssion模式"><a href="#PerSesssion模式" class="headerlink" title="PerSesssion模式"></a>PerSesssion模式</h4><p>All bindings support configuring the contract on the endpoint with Session<br>Mode.Allowed. When the SessionMode property is configured with this value, transport sessions are allowed, but not enforced. The exact resulting behavior is a product of the service configuration and the binding used. </p>
<p>If the service is configured for percall activation, it still behaves as per-call service,<br>Whenthe service is configured for per-session activation, it will behave as a per-session service only if the binding used maintains a transport-level session. For example, the BasicHttpBinding can never have a transport-level session, due to the connectionless nature of the HTTP protocol. The WSHttpBinding without Message security and without reliable messaging will also not maintain a transport-level session. In both of these cases, although the service is configured with InstanceContextMode.PerSession and the contract with SessionMode.Allowed, the service will behave as a percall service.</p>
<p>However, if you use the WSHttpBinding with Message security (its default configuration) or with reliable messaging, or if you use the NetTcpBinding or the NetNamedPipeBinding, the service will behave as a per-session service.</p>
<p>When designing a sessionful contract, I recommend explicitly using SessionMode.Required and not relying on the default of SessionMode.Allowed<br>SessionMode.NotAllowed disallows the use of a transport-level session, which precludes(排除) an application-level session. Regardless of the service configuration, when this value is used, the service will always behave as a per-call service.</p>
<p>WCF can maintain a logical session between a client and a particular service instance. When the client creates a new proxy to a service configured as a sessionful service, the client gets a new dedicated(专用的) service instance that is independent of all other instances of the same service.<br>That instance will typically remain in service until the client no longer needs it. This activation mode (sometimes also referred to as the privatesession mode) is very much like the classic client/server model: each private session uniquely binds a proxy and its set of client- and service-side channels to a particular service instance, or more specifically, to its context. It follows that a transport session is required for the private-session instantiation mode, as discussed later in this section.<br>Because the service instance remains in memory throughout the session, it can maintain state in memory, and the programming model is very much like that of the classic client/server model. Consequently, it suffers from the same scalability and transaction issues as the classic client/server model. A service configured for private sessions cannot typically support more than a few dozen (or perhaps up to one or two hundred) outstanding clients, due to the cost associated with each such dedicated service instance.<br>The client session is per service endpoint per proxy. If the client creates another proxy to the same or a different endpoint, that second proxy will be associated with a new instance and session.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span>/ Service Code <span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span></span></span><br><span class="line">[<span class="meta">ServiceContract(SessionMode = SessionMode.Required)</span>]</span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">OperationContract</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title">MyService</span> : <span class="title">IMyContract</span>,<span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> m_Counter = <span class="number">0</span>;</span><br><span class="line">    MyService()</span><br><span class="line">    &#123;</span><br><span class="line">        Trace.WriteLine(<span class="string">"MyService.MyService()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Counter++;</span><br><span class="line">        Trace.WriteLine(<span class="string">"Counter = "</span> + m_Counter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Trace.WriteLine(<span class="string">"MyService.Dispose()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span>/ Client Code <span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span></span></span><br><span class="line">MyContractClient proxy = <span class="keyword">new</span> MyContractClient();</span><br><span class="line">proxy.MyMethod();</span><br><span class="line">proxy.MyMethod();</span><br><span class="line">proxy.Close();</span><br><span class="line"><span class="comment">//Output</span></span><br><span class="line">MyService.MyService()</span><br><span class="line">Counter = <span class="number">1</span></span><br><span class="line">Counter = <span class="number">2</span></span><br><span class="line">MyService.Dispose()</span><br></pre></td></tr></table></figure>
<p>Every session has a unique ID that both the client and the service can obtain. The session ID is largely in the form of a GUID, and it can be used for logging and diagnostics. The service can access the session ID via the operation call context, which is a set of properties (including the session ID) that are used for callbacks, message headers, transaction management, security, host access, and access to the object represent‐<br>ing the execution context itself. </p>
<h4 id="Single模式"><a href="#Single模式" class="headerlink" title="Single模式"></a>Single模式</h4><p>The singleton service is the ultimate shareable service. When you configure a service as a singleton, all clients are independently connected to the same single well-known instance context and implicitly to the same instance inside, regardless of which endpoint of the service they connect to. The singleton is created exactly once, when the host is created, and lives forever: it is disposed of only when the host shuts down.</p>
<p>If the contract the client consumes has a session, during the call the singleton will have the same session ID as the client (binding permitting), but closing the client proxy will terminate only the transport session, not the singleton context and the instance inside</p>
<p>If the singleton service supports contracts without a session, those contracts will not be per-call: they too will be connected to the same instance. By its very nature, the singleton is shared, and each client should simply create its own proxy or proxies to it.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span>/ Service Code <span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span></span></span><br><span class="line">[<span class="meta">ServiceContract(SessionMode = SessionMode.Required)</span>]</span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">OperationContract</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">ServiceContract(SessionMode = SessionMode.NotAllowed)</span>]</span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyOtherContract</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">OperationContract</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">MyOtherMethod</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line">[<span class="meta">ServiceBehavior(InstanceContextMode=InstanceContextMode.Single)</span>]</span><br><span class="line"><span class="keyword">class</span> <span class="title">MySingleton</span> : <span class="title">IMyContract</span>,<span class="title">IMyOtherContract</span>,<span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> m_Counter = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MySingleton</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Trace.WriteLine(<span class="string">"MySingleton.MySingleton()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Counter++;</span><br><span class="line">        Trace.WriteLine(<span class="string">"Counter = "</span> + m_Counter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MyOtherMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        m_Counter++;</span><br><span class="line">        Trace.WriteLine(<span class="string">"Counter = "</span> + m_Counter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Trace.WriteLine(<span class="string">"Singleton.Dispose()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span>/ Client Code <span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span><span class="doctag">///</span></span></span><br><span class="line">MyContractClient proxy1 = <span class="keyword">new</span> MyContractClient();</span><br><span class="line">proxy1.MyMethod();</span><br><span class="line">proxy1.Close();</span><br><span class="line">MyOtherContractClient proxy2 = <span class="keyword">new</span> MyOtherContractClient();</span><br><span class="line">proxy2.MyOtherMethod();</span><br><span class="line">proxy2.Close();</span><br><span class="line"><span class="comment">//Output</span></span><br><span class="line">MySingleton.MySingleton()</span><br><span class="line">Counter = <span class="number">1</span></span><br><span class="line">Counter = <span class="number">2</span></span><br></pre></td></tr></table></figure>
<h4 id="PerCall-PerSession-Single之间怎么选择"><a href="#PerCall-PerSession-Single之间怎么选择" class="headerlink" title="PerCall, PerSession, Single之间怎么选择"></a>PerCall, PerSession, Single之间怎么选择</h4><ul>
<li>Per-Call: 最通用; 适用于无状态</li>
<li>Per-Session: 经典的C/S模式, 需要保存一些会话数据</li>
<li>Singleton: 日志服务</li>
</ul>
<p>Per-Call与Per-Session的区别 (<a href="https://stackoverflow.com/questions/15104960/persession-vs-percall" target="_blank" rel="noopener">https://stackoverflow.com/questions/15104960/persession-vs-percall</a>)</p>
<p>In my opinion, to take a decision consider these two points</p>
<ol>
<li>For going with InstanceContextMode.PerSession - If your users have some session values stored on the WCF service on the server.</li>
<li>For going with InstanceContextMode.PerCall - If your users have nothing stored in session on the WCF service on the server i.e. WCF service requires No per user settings required to store in memory. Requires scalability.<br>Some points regarding When-And-Why,</li>
</ol>
<p>InstanceContextMode.PerCall</p>
<ul>
<li>If your service is stateless and scalable, i.e. benefits are similar to HTTP as it is also stateless.</li>
<li>If service has light-weight initialization code (or none at all).</li>
<li>If your service is single threaded.</li>
<li>Example scenario: For any 1000 client requests in a given time period in a PerCall situation, there will only be 100 objects instantiated for 100 active calls. Secondly if server were to crash then in PerCall situation the only errors that would occur would be to the 100 actual requests that were in progress (assuming fast failover). The other 900 clients could be routed to another server on their next call.</li>
</ul>
<p>InstanceContextMode.PerSession</p>
<ul>
<li>If your service has to maintain some state between calls from the same client.</li>
<li>If your service has light-weight initialization code (or none at all). Even though you are only getting a new instance for each client proxy, you still want to be careful about having expensive initialization code in a constructor.</li>
<li>Example scenario: For any 1000 client requests in a given time period in a PerSessionsituation you may have 1000 objects instantiated on the server but only 100 are actually activein call at any moment. And thus instantiated PerSession objects could be a waste of resources and may impact the ability to serve requests under load. Secondly if server were to crash then in PerSession all 1000 clients who have a session on that server would lose their session and be unable to complete their work.</li>
</ul>
<p>Reference links:</p>
<ol>
<li>MSDN - WCF Instancing, Concurrency, and Throttling</li>
<li>SO - Per-Call vs Per-Session</li>
<li>MSDN - Using Sessions in WCF context</li>
</ol>
<p>Choosing a Singleton</p>
<p>The singleton service is the sworn enemy of scalability. The reason has to do with singleton state synchronization, rather than the cost of that single instance. Having a singleton implies that the singleton has some valuable state that you wish to share across multiple clients. The problem is that if the singleton’s state is mutable and multiple clients connect to the singleton, they may all do so concurrently, and the incoming client calls will be on multiple worker threads. The singleton must therefore synchronize access to its state to avoid state corruption. This, in turn, means that only one client at a time can access the singleton. This constraint may degrade throughput, responsiveness, and availability to the point that the singleton is unusable in a decentsized system. For example, if an operation on a singleton takes one-tenth of a second, the singleton can service only 10 clients per second. If there are many more clients(say 20 or 100), the system’s performance will be inadequate.</p>
<p>In general, you should use a singleton only if it maps well to a natural singleton in the application domain. <strong>A natural singleton is a resource that is, by its very nature, single and unique. Examples of natural singletons are a global logbook to which all services should log their activities</strong>, a single communication port, or a single mechanical motor. Avoid using a singleton if there is even the slightest chance that the business logic will allow more than one such service in the future (for example, adding another motor or a second communication port). The reason is clear: if your clients all depend on implicitly being connected to the well-known instance and more than one service instance is available, the clients will suddenly need to have a way to bind to the correct instance. This can have severe implications for the application’s programming model. Because of these limitations, <strong>I recommend that you avoid singletons in the general case and find ways to share the state of the singleton instead of the singleton instance itself.</strong> That said, there are cases when using a singleton is acceptable, as mentioned earlier.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/06/WCF笔记(X2) 基本使用/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/06/WCF笔记(X2) 基本使用/" itemprop="url">WCF笔记(X2) 基本使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-06T12:21:51+08:00">
                2018-05-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇介绍了WCF的基本概念, 这一篇介绍WCF的基本使用方法.</p>
<blockquote>
<p>Every service is associated with an <strong>address(地址)</strong> that defines where the service is, a <strong>binding(绑定)</strong> that defines how to communicate with the service, and a <strong>contract(契约)</strong> that defines what the service does.</p>
</blockquote>
<p>简称ABC三要素, 这三个要素合起来叫做Endpoint.</p>
<p><img src="/img/wcf-endpoint-abc.jpeg" alt=""></p>
<h4 id="Address"><a href="#Address" class="headerlink" title="Address"></a>Address</h4><p>WCF支持多种不同的传输协议, sample address如下:</p>
<ul>
<li><a href="http://localhost:8001/MyService" target="_blank" rel="noopener">http://localhost:8001/MyService</a></li>
<li>net.tcp://localhost:8002/MyService</li>
<li>net.pipe://localhost/MyPipe</li>
<li>net.msmq://localhost/MyQueue</li>
<li>ws://localhost/MyService</li>
<li>soap.udp://localhost:8081/MyService</li>
</ul>
<h4 id="Binding"><a href="#Binding" class="headerlink" title="Binding"></a>Binding</h4><p>对传输协议, 消息编码, 通信模式, 可靠性, 安全性, 事务等等的配置则是放在binding中, WCF提供了诸如NetTcpBinding, NetNamedPipeBinding, WSHttpBinding等常用的binding</p>
<h4 id="Contract"><a href="#Contract" class="headerlink" title="Contract"></a>Contract</h4><p>WCF中定义了4类Contract.最常用的2类是Service contracts和Data contracts. 其中Data contracts表示在调用服务操作时传递的数据, 例如参数和返回值.在Service contracts内部, 还需要在方法上添加OperationContract, 表示该Service公开的操作.</p>
<p>Service的实现类可以支持多个Service接口, 例如<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ServiceContract</span>]</span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyContract</span></span><br><span class="line">&#123;</span><br><span class="line">	[<span class="meta">OperationContract</span>]</span><br><span class="line">	<span class="function"><span class="keyword">string</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">ServiceContract</span>]</span><br><span class="line"><span class="keyword">interface</span> <span class="title">IMyOtherContract</span></span><br><span class="line">&#123;</span><br><span class="line">	[<span class="meta">OperationContract</span>]</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">MyOtherMethod</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">MyService</span> : <span class="title">IMyContract</span>,<span class="title">IMyOtherContract</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">MyMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;...&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MyOtherMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Logically, the endpoint is the service’s interface and is analogous to a CLR or COM interface</p>
</blockquote>
<p>所以这里MyService至少暴露了2个Endpoint.</p>
<blockquote>
<p>Every service must expose at least one business endpoint, and each endpoint has<br>exactly one contract. All endpoints on a service have <strong>unique</strong> addresses, and a single<br>service can expose multiple endpoints. <strong>These endpoints can use the same or different<br>bindings and can expose the same or different contracts</strong>. There is absolutely no relationship between the various endpoints a service provides.</p>
</blockquote>
<p>Endpoint可以设置在配置文件中<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span> = <span class="string">"MyService"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">endpoint</span></span></span><br><span class="line"><span class="tag">	<span class="attr">address</span> = <span class="string">"http://localhost:8000/MyService"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">binding</span> = <span class="string">"wsHttpBinding"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">contract</span> = <span class="string">"IMyContract"</span></span></span><br><span class="line"><span class="tag">	/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">endpoint</span></span></span><br><span class="line"><span class="tag">	<span class="attr">address</span> = <span class="string">"net.tcp://localhost:8001/MyService"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">binding</span> = <span class="string">"netTcpBinding"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">contract</span> = <span class="string">"IMyContract"</span></span></span><br><span class="line"><span class="tag">	/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">endpoint</span></span></span><br><span class="line"><span class="tag">	<span class="attr">address</span> = <span class="string">"net.tcp://localhost:8002/MyService"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">binding</span> = <span class="string">"netTcpBinding"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">contract</span> = <span class="string">"IMyOtherContract"</span></span></span><br><span class="line"><span class="tag">	/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>也可以用代码的方式设置<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example 1-9. Service-side programmatic endpoint confguration</span></span><br><span class="line">ServiceHost host = <span class="keyword">new</span> ServiceHost(<span class="keyword">typeof</span>(MyService));</span><br><span class="line">Binding wsBinding = <span class="keyword">new</span> WSHttpBinding();</span><br><span class="line">Binding tcpBinding = <span class="keyword">new</span> NetTcpBinding();</span><br><span class="line">host.AddServiceEndpoint(<span class="keyword">typeof</span>(IMyContract),wsBinding,</span><br><span class="line"><span class="string">"http://localhost:8000/MyService"</span>);</span><br><span class="line">host.AddServiceEndpoint(<span class="keyword">typeof</span>(IMyContract),tcpBinding,</span><br><span class="line"><span class="string">"net.tcp://localhost:8001/MyService"</span>);</span><br><span class="line">host.AddServiceEndpoint(<span class="keyword">typeof</span>(IMyOtherContract),tcpBinding,</span><br><span class="line"><span class="string">"net.tcp://localhost:8002/MyService"</span>);</span><br><span class="line">host.Open();</span><br></pre></td></tr></table></figure></p>
<p>Service这边设置好了Endpoint, 下一步就是公开元数据了. 一种比较简单的方式是HTTP-GET, 可以在Endpoint配置文件中指定. 然后, 启动Service进程, 打开浏览器, 输入网址, 得到<br><img src="/img/wcf-metadata.png" alt=""></p>
<p>图上写明了如何使用工具生成Service在本地环境中的Proxy, 和使用Proxy的方式. Proxy对应的是Service Class的其中一个Endpoint</p>
<p><img src="/img/wcf-endpoint-proxy.jpeg" alt=""></p>
<p>除了SvcUtil.exe工具, 还可以用Visual Studio生成Proxy, 详见Programming WCF Service 4th P60</p>
<p>Client这边使用Proxy, 也需要配置文件, 或者直接在程序中配置<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">WSHttpBinding wsBinding = <span class="keyword">new</span> WSHttpBinding();</span><br><span class="line">wsBinding.SendTimeout = TimeSpan.FromMinutes(<span class="number">5</span>);</span><br><span class="line">wsBinding.TransactionFlow = <span class="literal">true</span>; </span><br><span class="line"></span><br><span class="line">EndpointAddress endpointAddress = <span class="keyword">new</span> EndpointAddress(<span class="string">"http://localhost:8000/MyService"</span>);</span><br><span class="line">MyContractClient proxy = <span class="keyword">new</span> MyContractClient(wsBinding,endpointAddress);</span><br><span class="line">proxy.MyMethod();</span><br><span class="line">proxy.Close();</span><br></pre></td></tr></table></figure></p>
<p>以上就是WCF的基本使用方式, 官方有一个Tutorial(<a href="https://docs.microsoft.com/en-us/dotnet/framework/wcf/getting-started-tutorial)指导一步一步怎么做" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/dotnet/framework/wcf/getting-started-tutorial)指导一步一步怎么做</a>.</p>
<p>另外也可以不生成Proxy, 直接使用Channel进行Service的调用, 这样更加方便.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Binding binding = <span class="keyword">new</span> NetTcpBinding();</span><br><span class="line">EndpointAddress address = <span class="keyword">new</span> EndpointAddress(<span class="string">"net.tcp://localhost:8000"</span>);</span><br><span class="line">IMyContract proxy = ChannelFactory&lt;IMyContract&gt;.CreateChannel(binding,address);</span><br><span class="line"><span class="keyword">using</span>(proxy <span class="keyword">as</span> IDisposable)</span><br><span class="line">&#123;</span><br><span class="line">	proxy.MyMethod();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Using proxies is simple, and it’s the right approach in many situations. It’s not the only choice, however. Beneath the veneer a proxy provides, the client’s communication with a service is handled by one or more channels. If desired, a client can work directly with these channels (as can a service). Using WCF’s ChannelFactory class, the developer can create whatever channels are required, then invoke their services directly. Doing this gives the developer more control, but also introduces somewhat more complexity.</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/04/WCF笔记(X1) 基本概念/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/04/WCF笔记(X1) 基本概念/" itemprop="url">WCF笔记(X1) 基本概念</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-04T16:44:51+08:00">
                2018-05-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>WCF(Windows Communication Foundation)和WPF一样复杂, 这里仅记录一下WCF的基本知识.</p>
<h3 id="面向服务架构"><a href="#面向服务架构" class="headerlink" title="面向服务架构"></a>面向服务架构</h3><p>WCF是微软目前的分布式通信框架(.Net3.0和WPF一起推出, 现是.Net4.5版本). 在接触WCF之前, 只知道Communication的双方, 一个叫Client, 一个叫Server. 在WCF中, Server换成了Service. 语义上来讲, 都和<strong>服务</strong>相关, 但Server和Service并不等同.</p>
<p>为什么叫Service, 这和面向服务架构(SOA, Service-Oriented Architecture)有关. WCF的Wiki是这样描述的:</p>
<blockquote>
<p>WCF is a tool often used to implement and deploy a service-oriented architecture (SOA). It is designed using service-oriented architecture principles to support distributed computing whereservices have remote consumers. <strong>Clients can consume multiple services; services can be consumed by multiple clients</strong>. Services are loosely coupled to each other. Services typically have a WSDL interface (Web Services Description Language) that any WCF client can use to consume the service, regardless of which platform the service is hosted on. WCF implements many advanced Web services (WS) standards such as WS-Addressing, WS-ReliableMessaging and WS-Security.</p>
</blockquote>
<p>顺便说一下, 目前兴起一种叫做微服务的架构方式, 是从SOA发展而来. SOA的提出是在企业应用, 而微服务架构是从互联网应用兴起的. 企业应用, 不要被企业两个字吓住, 如果不是交易系统的话，并发量都不是很大的. 而互联网应用的用户规模和并发量相比企业应用就大很多.</p>
<p>SOA中的服务(Services)就是公开的一组功能的集合. 从软件设计的角度考虑, 软件设计思想经历了从函数发展到对象，从对象发展到组件，再从组件发展到服务的几次变迁.</p>
<p>消费服务的一方叫做Client. Client与Service通过一种SOAP(简单对象访问模型)的消息进行通信, SOAP是一种XML格式. 和具体的传输协议无关.</p>
<p>这样Client和Service就分离开来了. WCF的Client可以与非WCF的Service交互. WCF的Service也可以与非WCF的Client交互.如此, 就做到分布式和松耦合.</p>
<p>Client与Service之间, 并不是原始的类似Socket那样收发消息,而是通过RPC的方式进行交互.既然是RPC的方式, 那么Client需要引用Service的相关功能. 怎么做到呢?</p>
<p>Service通过公开元数据(metadata)的方式公开服务.一个非WCF的Client可以将元数据导入到本地环境中, 生成本地的类型数据. 类似的, WCF的Client也可以导入非WCF的Service的元数据, 然后以本地CLR类与接口的方式进行调用.</p>
<p>具体来讲, 在WCF中, Client使用proxy将服务调用转发给Service. proxy是Service在本地环境中的代理, 接口和Service一样. proxy是通过Service公开的元数据生成的(借助相关工具).</p>
<p>WCF不仅允许Client和Service跨机器交互<br><img src="/img/wcf-different-machine.png" alt=""><br>也允许Client和Service在同一机器上交互<br><img src="/img/wcf-same-machine.png" alt=""></p>
<h3 id="WCF架构"><a href="#WCF架构" class="headerlink" title="WCF架构"></a>WCF架构</h3><p>不仅限于简单的通信, WCF还提供了对可靠性、事务性、并发管理、安全性等技术的支持.它们依赖基于拦截(interception)机制的WCF体系架构. </p>
<p>这部分引用<em>Programming WCF Service 4th P76</em></p>
<blockquote>
<p>The interception starts when the proxy serializes the <strong>call stack frame</strong> to a<br>message and sends the message down a chain of <strong>channels</strong>. The channel is merely an<br>interceptor whose purpose is to perform a specific task. Each client-side channel does<br>pre-call processing of the message. The exact structure and composition of the chain<br>depend mostly on the binding. For example, one of the channels may be responsible<br>for encoding the message (binary, text, or MTOM), another for passing the security<br>call context, another for propagating the client transaction, another for managing the<br>reliable session, another for encrypting the message body (if so configured), and so<br>on. The last channel on the client side is the transport channel, which sends the mes‐<br>sage over the configured transport to the host.</p>
</blockquote>
<p>具体有哪些Channel, 依赖于需求和配置.<br><img src="/img/wcf-channel-stack.jpeg" alt=""></p>
<blockquote>
<p>On the host side, the message goes through another chain of channels that perform<br>host-side pre-call processing of the message. The first channel on the host side is the<br>transport channel, which receives the message from the transport. Subsequent chan‐<br>nels perform various tasks, such as decryption of the message body, decoding of the<br>message, joining the propagated transaction, setting the security principal, managing<br>the session, and activating the service instance. The last channel on the host side<br>passes the message to the dispatcher. <strong>The dispatcher converts the message to a stack<br>frame and calls the service instance</strong>. </p>
</blockquote>
<p><img src="/img/wcf-channel-stack-2.jpeg" alt=""></p>
<blockquote>
<p>The service has no way of knowing that it was not called by a local client. In fact, it<br>was called by a local client—the <strong>dispatcher</strong>. </p>
</blockquote>
<blockquote>
<p>The service instance executes the call and returns control to the dispatcher, which<br>then converts the returned values and error information (if any) into a return mes‐<br>sage. The process is then reversed: the dispatcher passes the message through the<br>host-side channels to perform post-call processing, such as managing the transaction,<br>deactivating the instance, encoding the reply, encrypting it, and so on. The returned<br>message then goes to the transport channel, which sends it to the client-side channels<br>for client-side post-call processing. This process in turn consists of tasks such as<br>decryption, decoding, committing or aborting the transaction, and so on. <strong>The last<br>channel passes the message to the proxy, which converts the returned message to a<br>stack frame and returns control to the client</strong>.</p>
</blockquote>
<p>参考:</p>
<ol>
<li>Programming WCF Service 4th</li>
<li>understanding-wcf-bindings-and-channel-stack(<a href="http://www.c-sharpcorner.com/UploadFile/81a718/understanding-wcf-bindings-and-channel-stack/" target="_blank" rel="noopener">http://www.c-sharpcorner.com/UploadFile/81a718/understanding-wcf-bindings-and-channel-stack/</a>)</li>
<li>Introducing Windows Communication Foundation in .NET Framework 4 (<a href="https://msdn.microsoft.com/en-us/library/ee958158.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/ee958158.aspx</a>)</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/28/Paint.Net笔记(X4) Effect/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/28/Paint.Net笔记(X4) Effect/" itemprop="url">Paint.Net笔记(X4) Effect</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-28T17:43:51+08:00">
                2018-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇讲菜单项中的Action 与 HistoryFunction. 两者之间的区别, 暂时还不甚了然. 先放一放, 这一篇整理一下Paint.Net中的Effect</p>
<p>Effect是以Plugin的方式提供的, 可以使用单独的dll, 放在特定的目录下. 程序启动时, 会自动加载.但Paint.Net并不是插件结构. 和SharpDevelop不同, SharpDevelop中界面的UI也是以Plugin的方式提供的.</p>
<p>Effect滤镜的主要逻辑在EffectMenuBase.cs中<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">EffectMenuItem_Click</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (AppWorkspace.ActiveDocumentWorkspace == <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>; </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	PdnMenuItem pmi = (PdnMenuItem)sender;</span><br><span class="line">	Type effectType = (Type)pmi.Tag;</span><br><span class="line"></span><br><span class="line">	RunEffect(effectType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RunEffect</span>(<span class="params">Type effectType</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> oldDirtyValue = AppWorkspace.ActiveDocumentWorkspace.Document.Dirty;</span><br><span class="line">	<span class="keyword">bool</span> resetDirtyValue = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	AppWorkspace.Update(); <span class="comment">// make sure the window is done 'closing'</span></span><br><span class="line">	AppWorkspace.Widgets.StatusBarProgress.ResetProgressStatusBar();</span><br><span class="line">	DocumentWorkspace activeDW = AppWorkspace.ActiveDocumentWorkspace;</span><br><span class="line"></span><br><span class="line">	PdnRegion selectedRegion; <span class="comment">//选择区域，滤镜是应用于整幅图像，还是一个选择区域。下图就是只应用于一个选择区域</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (activeDW.Selection.IsEmpty)</span><br><span class="line">	&#123;</span><br><span class="line">		selectedRegion = <span class="keyword">new</span> PdnRegion(activeDW.Document.Bounds);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		selectedRegion = activeDW.Selection.CreateRegion();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/paintdotnet-effect.png" alt=""></p>
<p>这里Effect通过EffectFlags.Configurable分为2类（有没有参数配置，可以调整参数）</p>
<p>第一类（没有参数配置）：<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(effect.CheckForEffectFlags(EffectFlags.Configurable)))</span><br><span class="line">&#123;</span><br><span class="line">	Surface copy = activeDW.BorrowScratchSurface(<span class="keyword">this</span>.GetType() + <span class="string">".RunEffect() using scratch surface for non-configurable rendering"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">using</span> (<span class="keyword">new</span> WaitCursorChanger(AppWorkspace))</span><br><span class="line">		&#123;</span><br><span class="line">			copy.CopySurface(layer.Surface);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		EffectEnvironmentParameters eep = <span class="keyword">new</span> EffectEnvironmentParameters(</span><br><span class="line">			AppWorkspace.AppEnvironment.PrimaryColor,</span><br><span class="line">			AppWorkspace.AppEnvironment.SecondaryColor,</span><br><span class="line">			AppWorkspace.AppEnvironment.PenInfo.Width,</span><br><span class="line">			selectedRegion,</span><br><span class="line">			copy);</span><br><span class="line"></span><br><span class="line">		effect.EnvironmentParameters = eep;</span><br><span class="line"></span><br><span class="line">		DoEffect(effect, <span class="literal">null</span>, selectedRegion, selectedRegion, copy, <span class="keyword">out</span> exception);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">finally</span></span><br><span class="line">	&#123;</span><br><span class="line">		activeDW.ReturnScratchSurface(copy);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第二类（有参数配置）:有参数配置，就需要一个调整参数的对话框，例如上图中的高斯模糊. 先是创建一个EffectConfigDialog<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">using</span> (EffectConfigDialog configDialog = effect.CreateConfigDialog())</span><br><span class="line">&#123;</span><br><span class="line">	configDialog.Opacity = <span class="number">0.9</span>;</span><br><span class="line">	configDialog.Effect = effect;</span><br><span class="line">	configDialog.EffectSourceSurface = originalSurface;</span><br><span class="line">	configDialog.Selection = selectedRegion;</span><br><span class="line"></span><br><span class="line">	BackgroundEffectRenderer ber = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	EventHandler eh =</span><br><span class="line">		<span class="keyword">delegate</span>(<span class="keyword">object</span> sender, EventArgs e)</span><br><span class="line">		&#123;</span><br><span class="line">			EffectConfigDialog ecf = (EffectConfigDialog)sender;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (ber != <span class="literal">null</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				AppWorkspace.Widgets.StatusBarProgress.ResetProgressStatusBarAsync();</span><br><span class="line"></span><br><span class="line">				<span class="keyword">try</span></span><br><span class="line">				&#123;</span><br><span class="line">					ber.Start();</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">catch</span> (Exception ex)</span><br><span class="line">				&#123;</span><br><span class="line">					exception = ex;</span><br><span class="line">					ecf.Close();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">	configDialog.EffectTokenChanged += eh;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如何创建EffectConfigDialog应该是Paint.Net中最有技巧性的东西了，真是大开眼界</p>
<p>翻看了不少代码，大致明白了是怎么回事。因为Effect在Paint.Net中是以plugin的形式存在，假如Effect有参数可以调整，那么在什么地方去调整参数呢？想像一下，我们需要有一个参数的Dialog。在没有源码的情况下，如何创建这个Dialog。以高斯模糊为例，只要该Effect提供参数，由Paint.Net帮你创建EffectConfigDialog </p>
<p>Paint.Net在框架中提供了一种参数与Control的一一对应，然后根据参数列表，创建一个一个的Control，然后用一个Panel将这些Control添加进来。再提供一个参数变更引发的事件。<br>这些参数用一个叫做EffectConfigToken的类封装起来(具体是PropertyCollection)</p>
<p>以高斯模糊为例<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">GaussianBlurEffect</span></span><br><span class="line">    : <span class="title">InternalPropertyBasedEffect</span></span><br><span class="line"></span><br><span class="line"><span class="title">public</span> <span class="title">abstract</span> <span class="title">class</span> <span class="title">InternalPropertyBasedEffect</span></span><br><span class="line">    : <span class="title">PropertyBasedEffect</span></span><br><span class="line"></span><br><span class="line"><span class="title">public</span> <span class="title">abstract</span> <span class="title">class</span> <span class="title">PropertyBasedEffect</span></span><br><span class="line">    : Effect&lt;PropertyBasedEffectConfigToken&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">PropertyBasedEffectConfigToken</span></span><br><span class="line">    : <span class="title">EffectConfigToken</span></span><br></pre></td></tr></table></figure></p>
<p>其中<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">PropertyBasedEffectConfigDialog</span></span><br><span class="line">    : EffectConfigDialog&lt;PropertyBasedEffect, PropertyBasedEffectConfigToken&gt;</span><br></pre></td></tr></table></figure></p>
<p>AmountEffectConfigDialog.cs<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">amountUpDown_ValueChanged</span>(<span class="params"><span class="keyword">object</span> sender, System.EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (amountTrackBar.Value != (<span class="keyword">int</span>)amountUpDown.Value)</span><br><span class="line">    &#123;</span><br><span class="line">        amountTrackBar.Value = (<span class="keyword">int</span>)amountUpDown.Value;</span><br><span class="line">        FinishTokenUpdate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FinishTokenUpdate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    InitTokenFromDialog();</span><br><span class="line">    OnEffectTokenChanged();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnEffectTokenChanged</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (EffectTokenChanged != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        EffectTokenChanged(<span class="keyword">this</span>, EventArgs.Empty);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>扫描有多少个Effect，这部分是以插件的形式出现的，加载后出现在菜单项中<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> EffectsCollection <span class="title">GatherEffects</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    List&lt;Assembly&gt; assemblies = <span class="keyword">new</span> List&lt;Assembly&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// PaintDotNet.Effects.dll</span></span><br><span class="line">    assemblies.Add(Assembly.GetAssembly(<span class="keyword">typeof</span>(Effect)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TARGETDIR\Effects\*.dll</span></span><br><span class="line">    <span class="keyword">string</span> homeDir = PdnInfo.GetApplicationDir();</span><br><span class="line">    <span class="keyword">string</span> effectsDir = Path.Combine(homeDir, InvariantStrings.EffectsSubDir);</span><br><span class="line">    <span class="keyword">bool</span> dirExists;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        dirExists = Directory.Exists(effectsDir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">catch</span></span><br><span class="line">    &#123;</span><br><span class="line">        dirExists = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dirExists)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">string</span> fileSpec = <span class="string">"*"</span> + InvariantStrings.DllExtension;</span><br><span class="line">        <span class="keyword">string</span>[] filePaths = Directory.GetFiles(effectsDir, fileSpec);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">string</span> filePath <span class="keyword">in</span> filePaths)</span><br><span class="line">        &#123;</span><br><span class="line">            Assembly pluginAssembly = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                pluginAssembly = Assembly.LoadFrom(filePath);</span><br><span class="line">                assemblies.Add(pluginAssembly);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Tracing.Ping(<span class="string">"Exception while loading "</span> + filePath + <span class="string">": "</span> + ex.ToString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EffectsCollection ec = <span class="keyword">new</span> EffectsCollection(assemblies);</span><br><span class="line">    <span class="keyword">return</span> ec;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/28/Paint.Net笔记(X3) Action & HistoryFunction/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/28/Paint.Net笔记(X3) Action & HistoryFunction/" itemprop="url">Paint.Net笔记(X3) Action 与 HistoryFunction</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-28T17:25:51+08:00">
                2018-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇介绍了ToolForm的操作机制, 这一篇看一下菜单项的操作.</p>
<p>看ImageMenus.cs会发现如下代码<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MenuImageCrop_Click</span>(<span class="params"><span class="keyword">object</span> sender, System.EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (AppWorkspace.ActiveDocumentWorkspace != <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!AppWorkspace.ActiveDocumentWorkspace.Selection.IsEmpty)</span><br><span class="line">		&#123;</span><br><span class="line">			AppWorkspace.ActiveDocumentWorkspace.ExecuteFunction(<span class="keyword">new</span> CropToSelectionFunction());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MenuImageResize_Click</span>(<span class="params"><span class="keyword">object</span> sender, System.EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (AppWorkspace.ActiveDocumentWorkspace != <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		AppWorkspace.ActiveDocumentWorkspace.PerformAction(<span class="keyword">new</span> ResizeAction());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>有些菜单项是ExecuteFunction, 有些菜单项是PerformAction. 各种Action和Function如下图所示<br><img src="/img/paintdotnet-actions.png" alt="">)<br><img src="/img/paintdotnet-functions.png" alt="">)<br>ResizeAction继承DocumentWorkspaceAction, CropToSelectionFunction继承HistoryFunctiont</p>
<p>另外AppWorkspace也能执行Action<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MenuFileOpen_Click</span>(<span class="params"><span class="keyword">object</span> sender, System.EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	AppWorkspace.PerformAction(<span class="keyword">new</span> OpenFileAction());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>OpenFileAction继承AppWorkspaceAction, 另外有些Action不继承其他类.</p>
<p>它们之间的区别是什么?</p>
<p>DocumentWorkspaceAction与AppWorkspaceAction的区别, 一个是作用的对象不同, 另一个是DocumentWorkspaceAction还能够撤销(命令模式+备忘录模式). 如下所示</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">internal</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">AppWorkspaceAction</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">PerformAction</span>(<span class="params">AppWorkspace appWorkspace</span>)</span>;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">AppWorkspaceAction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           SystemLayer.Tracing.LogFeature(<span class="string">"AWAction("</span> + GetType().Name + <span class="string">")"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> Provides a way to do a tool-less action that operates on the DocumentWorkspace.</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> DocumentActions must NOT touch directly the History -- they should return history </span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> actions that can undo what they have already done. These history actions will</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> then be placed in to the history by whomever invoked the DocumentAction.</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> If the action does not affect the Document, it should return null from its</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> PerformAction method.</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> DocumentActions should ONLY mutate the DocumentWorkspace and any contained</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> objects.</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="keyword">internal</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">DocumentWorkspaceAction</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">private</span> ActionFlags actionFlags;</span><br><span class="line">       <span class="keyword">public</span> ActionFlags ActionFlags</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">get</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">this</span>.actionFlags;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> Implement this to provide an action. You must return a HistoryMemento so that you</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> can be undone. However, you should return null if you didn't do anything that</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> affected the document.</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>A HistoryMemento object that will be placed onto the HistoryStack.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> HistoryMemento <span class="title">PerformAction</span>(<span class="params">DocumentWorkspace documentWorkspace</span>)</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> Initializes an instance of a class dervied from DocumentAction.</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="documentWorkspace"&gt;</span>The DocumentWorkspace to interact with.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="actionFlags"&gt;</span>Flags that describe action behavior or requirements.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">DocumentWorkspaceAction</span>(<span class="params">ActionFlags actionFlags</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           <span class="keyword">this</span>.actionFlags = actionFlags;</span><br><span class="line">           SystemLayer.Tracing.LogFeature(<span class="string">"DWAction("</span> + GetType().Name + <span class="string">")"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>那HistoryFunction呢? HistoryFunction与DocumentWorkspaceAction有什么不同<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> HistoryMemento <span class="title">Execute</span>(<span class="params">IHistoryWorkspace historyWorkspace</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> HistoryMemento <span class="title">OnExecute</span>(<span class="params">IHistoryWorkspace historyWorkspace</span>)</span>;</span><br></pre></td></tr></table></figure></p>
<p>从前面2张图片对比, 从名称上看, HistoryFunction貌似更多在和layer和selection打交道.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zmapleaf</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">66</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zmapleaf</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
