<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="编程,">










<meta name="description" content="前面2篇笔记提到Game.Tick是在系统Idle状态下被调用的, Idle状态比我们想象的要多的多的多, 而MonoGame默认的帧率是60FPS, 所以在Game.Tick内部还需要对时间进行精确控制. 看过不少资料, 在这方面介绍最好的, 还是XNA的官方文档, 简洁明了. https://msdn.microsoft.com/en-us/library/bb203873.aspx,  Ga">
<meta name="keywords" content="编程">
<meta property="og:type" content="article">
<meta property="og:title" content="MonoGame笔记(七)Game Loop Timing">
<meta property="og:url" content="http://yoursite.com/2017/12/05/MonoGame笔记(七)GameLoop/index.html">
<meta property="og:site_name" content="远">
<meta property="og:description" content="前面2篇笔记提到Game.Tick是在系统Idle状态下被调用的, Idle状态比我们想象的要多的多的多, 而MonoGame默认的帧率是60FPS, 所以在Game.Tick内部还需要对时间进行精确控制. 看过不少资料, 在这方面介绍最好的, 还是XNA的官方文档, 简洁明了. https://msdn.microsoft.com/en-us/library/bb203873.aspx,  Ga">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2017-12-06T07:12:27.268Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MonoGame笔记(七)Game Loop Timing">
<meta name="twitter:description" content="前面2篇笔记提到Game.Tick是在系统Idle状态下被调用的, Idle状态比我们想象的要多的多的多, 而MonoGame默认的帧率是60FPS, 所以在Game.Tick内部还需要对时间进行精确控制. 看过不少资料, 在这方面介绍最好的, 还是XNA的官方文档, 简洁明了. https://msdn.microsoft.com/en-us/library/bb203873.aspx,  Ga">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/12/05/MonoGame笔记(七)GameLoop/">





  <title>MonoGame笔记(七)Game Loop Timing | 远</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">远</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/05/MonoGame笔记(七)GameLoop/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MonoGame笔记(七)Game Loop Timing</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-05T11:17:37+08:00">
                2017-12-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>前面2篇笔记提到Game.Tick是在系统Idle状态下被调用的, Idle状态比我们想象的要多的多的多, 而MonoGame默认的帧率是60FPS, 所以在Game.Tick内部还需要对时间进行精确控制. 看过不少资料, 在这方面介绍最好的, 还是XNA的官方文档, 简洁明了. <a href="https://msdn.microsoft.com/en-us/library/bb203873.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/bb203873.aspx</a>, </p>
<h4 id="Game-Loop-Timing"><a href="#Game-Loop-Timing" class="headerlink" title="Game Loop Timing"></a>Game Loop Timing</h4><p>A Game is either <strong>fixed step</strong> or <strong>variable step</strong>, <strong>defaulting</strong> to fixed step. The type of step determines how often <strong>Update</strong> will be called and affects how you need to represent time-based procedures such as <strong>movement</strong> and <strong>animation</strong>.</p>
<p>这一段话包含很多信息. 首先Game Loop Timing有两类: fixed step和variable step, 默认是fixed step(60FPS). 它影响的是<strong>Update</strong>方法被调用的频率, 而不是<strong>Draw</strong>. 在编写<strong>位置</strong>与<strong>动画</strong>相关的代码时, 需要注意. 一个小人往前走, 它既有行走的动画, 同时它的位置也在改变.</p>
<h4 id="Fixed-Step-Game-Loops"><a href="#Fixed-Step-Game-Loops" class="headerlink" title="Fixed-Step Game Loops"></a>Fixed-Step Game Loops</h4><p>A fixed-step Game tries to call its Update method on the fixed interval specified in <strong>TargetElapsedTime</strong>. Setting <strong>Game.IsFixedTimeStep</strong> to true causes aGame to use a fixed-step game loop. A new XNA project uses a fixed-step game loop with a default TargetElapsedTime of 1/60th of a second.</p>
<p>1.设置Game.IsFixedTimeStep为true<br>2.设置帧率TargetElapsedTime</p>
<p>In a fixed-step game loop, Game calls Update once the TargetElapsedTime has elapsed. After Update is called, if it is not time to call Update again,Game calls Draw. After Draw is called, if it is not time to call Update again, Game idles until it is time to call Update.</p>
<p>在fixed-step下, 每隔TargetElapsedTime(假设1/60秒)调用一次Update. 假如一次Update所用的时间小于1/60秒, 那么就继续调用Draw方法. 假如Update+Draw加起来的时间还是小于1/60秒, 那么就等在那里(wait/idle), 直到1/60秒用完, 开始下一个1/60秒. </p>
<p>If Update takes too long to process, Game sets <strong>IsRunningSlowly</strong> to true and calls Update again, without calling Draw in between. When an update runs longer than the TargetElapsedTime, Game responds by calling Update extra times and dropping the frames associated with those updates to catch up. This ensures that Update will have been called the expected number of times when the game loop catches up from a slowdown. You can check the value of IsRunningSlowly in your Update if you want to detect dropped frames and shorten your Update processing to compensate. You can reset the elapsed times by calling ResetElapsedTime.</p>
<p>如果调用Update方法用了很长时间, Game会将IsRunningSlowly设置为True, 并且再次调用Update方法(可能多次), 跳过Draw.每次Update方法调用所花的时间并不一样(有些地方要进行大量的物理碰撞和AI计算), 可以在Update方法内部对IsRunningSlowly进行判断, 如果为真, 则简化某些计算, 这样就可以缩短Update的调用时间. 这部分需要结合代码去理解.</p>
<p>When your game pauses in the debugger, Game will not make extra calls to Update when the game resumes.</p>
<h4 id="Variable-Step-Game-Loops-更推荐用这个"><a href="#Variable-Step-Game-Loops-更推荐用这个" class="headerlink" title="Variable-Step Game Loops(更推荐用这个)"></a>Variable-Step Game Loops(更推荐用这个)</h4><p>A variable-step game calls its Update and Draw methods in a continuous loop without regard to the TargetElapsedTime. Setting Game.IsFixedTimeStepto false causes a Game to use a variable-step game loop.</p>
<p>在variable-step方式下, 调用完Update就接着调用Draw, 之后又是Update, 往复循环, 和TargetElapsedTime无关.</p>
<h4 id="Animation-and-Timing"><a href="#Animation-and-Timing" class="headerlink" title="Animation and Timing"></a>Animation and Timing</h4><p>For operations that require precise timing, such as animation, the type of game loop your game uses (fixed-step or variable-step) is important.</p>
<p>Using a fixed step allows game logic to use the TargetElapsedTime as its basic unit of time and assume that Update will be called at that interval. Using a variable step requires the game logic and animation code to be based on ElapsedGameTime to ensure smooth gameplay. Because the Update method is called immediately after the previous frame is drawn, the time between calls to Update can vary. Without taking the time between calls into account, the game would seem to speed up and slow down. The time elapsed between calls to the Update method is available in the Update method’s gameTime parameter. You can reset the elapsed times by calling ResetElapsedTime.</p>
<p>在fixed step方式下, 可以使用TargetElapsedTime进行计算; 在variable step方式下, 则使用ElapsedGameTime, 这个值是变化的.</p>
<p>When using a variable-step game loop, you should express rates—such as the distance a sprite moves—in game units per millisecond (ms). The amount a sprite moves in any given update can then be calculated as the rate of the sprite times the elapsed time. Using this approach to calculate the distance the sprite moved ensures that the sprite will move consistently if the speed of the game or computer varies.</p>
<p>在variable step方式下, 应该使用速率(rate) * ElapsedGameTime来计算距离. 这样在性能好的与性能不好的机器上, 都能有流畅连续的移动</p>
<p>上面的介绍大致有了一些概念, 具体还是要看Game.Tick()代码实现</p>
<p>MSDN Game.Tick</p>
<ul>
<li>Updates the game’s clock and calls Update and Draw.</li>
<li>In a fixed-step game, Tick calls Update only after a target time interval has elapsed.</li>
<li>In a variable-step game, Update is called every time Tick is called.</li>
</ul>
<p>以下是MonoGame的实现<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Tick</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> This code is very sensitive and can break very badly</span></span><br><span class="line">    <span class="comment">// with even what looks like a safe change.  Be sure to test </span></span><br><span class="line">    <span class="comment">// any change fully in both the fixed and variable timestep </span></span><br><span class="line">    <span class="comment">// modes across multiple devices and platforms.</span></span><br><span class="line"></span><br><span class="line">RetryTick:</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Advance the accumulated elapsed time.</span></span><br><span class="line">    <span class="keyword">var</span> currentTicks = _gameTimer.Elapsed.Ticks;</span><br><span class="line">    _accumulatedElapsedTime += TimeSpan.FromTicks(currentTicks - _previousTicks);</span><br><span class="line">    _previousTicks = currentTicks;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we're in the fixed timestep mode and not enough time has elapsed</span></span><br><span class="line">    <span class="comment">// to perform an update we sleep off the the remaining time to save battery</span></span><br><span class="line">    <span class="comment">// life and/or release CPU time to other threads and processes.</span></span><br><span class="line">    <span class="keyword">if</span> (IsFixedTimeStep &amp;&amp; _accumulatedElapsedTime &lt; TargetElapsedTime)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> sleepTime = (<span class="keyword">int</span>)(TargetElapsedTime - _accumulatedElapsedTime).TotalMilliseconds;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> While sleep can be inaccurate in general it is </span></span><br><span class="line">        <span class="comment">// accurate enough for frame limiting purposes if some</span></span><br><span class="line">        <span class="comment">// fluctuation is an acceptable result.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WINRT</span></span><br><span class="line">        Task.Delay(sleepTime).Wait();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        System.Threading.Thread.Sleep(sleepTime);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">goto</span> RetryTick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not allow any update to take longer than our maximum.</span></span><br><span class="line">    <span class="keyword">if</span> (_accumulatedElapsedTime &gt; _maxElapsedTime)</span><br><span class="line">        _accumulatedElapsedTime = _maxElapsedTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IsFixedTimeStep)</span><br><span class="line">    &#123;</span><br><span class="line">        _gameTime.ElapsedGameTime = TargetElapsedTime;</span><br><span class="line">        <span class="keyword">var</span> stepCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Perform as many full fixed length time steps as we can.</span></span><br><span class="line">        <span class="keyword">while</span> (_accumulatedElapsedTime &gt;= TargetElapsedTime)</span><br><span class="line">        &#123;</span><br><span class="line">            _gameTime.TotalGameTime += TargetElapsedTime;</span><br><span class="line">            _accumulatedElapsedTime -= TargetElapsedTime;</span><br><span class="line">            ++stepCount;</span><br><span class="line"></span><br><span class="line">            DoUpdate(_gameTime);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Every update after the first accumulates lag</span></span><br><span class="line">        _updateFrameLag += Math.Max(<span class="number">0</span>, stepCount - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//If we think we are running slowly, wait until the lag clears before resetting it</span></span><br><span class="line">        <span class="keyword">if</span> (_gameTime.IsRunningSlowly)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_updateFrameLag == <span class="number">0</span>)</span><br><span class="line">                _gameTime.IsRunningSlowly = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (_updateFrameLag &gt;= <span class="number">5</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//If we lag more than 5 frames, start thinking we are running slowly</span></span><br><span class="line">            _gameTime.IsRunningSlowly = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Every time we just do one update and one draw, then we are not running slowly, so decrease the lag</span></span><br><span class="line">        <span class="keyword">if</span> (stepCount == <span class="number">1</span> &amp;&amp; _updateFrameLag &gt; <span class="number">0</span>)</span><br><span class="line">            _updateFrameLag--;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Draw needs to know the total elapsed time</span></span><br><span class="line">        <span class="comment">// that occured for the fixed length updates.</span></span><br><span class="line">        _gameTime.ElapsedGameTime = TimeSpan.FromTicks(TargetElapsedTime.Ticks * stepCount);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Perform a single variable length update.</span></span><br><span class="line">        _gameTime.ElapsedGameTime = _accumulatedElapsedTime;</span><br><span class="line">        _gameTime.TotalGameTime += _accumulatedElapsedTime;</span><br><span class="line">        _accumulatedElapsedTime = TimeSpan.Zero;</span><br><span class="line"></span><br><span class="line">        DoUpdate(_gameTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw unless the update suppressed it.</span></span><br><span class="line">    <span class="keyword">if</span> (_suppressDraw)</span><br><span class="line">        _suppressDraw = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        DoDraw(_gameTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Tick中的顺序是wait-&gt;Update-&gt;Draw, 在fixed-step模式下, 分为2种情况:</p>
<ol>
<li><p>流畅. _accumulatedElapsedTime为上一次执行Tick到这一次执行Tick的TimeSpan. _accumulatedElapsedTime小于TargetElapsedTime, 则用Sleep将剩下的时间补足. 回到Tick的第一行代码, 此时_accumulatedElapsedTime约等于TargetElapsedTime, 往下执行Update方法和Draw方法.</p>
</li>
<li><p>卡顿. _accumulatedElapsedTime为上一次执行Tick到这一次执行Tick的TimeSpan, _accumulatedElapsedTime大于TargetElapsedTime, _accumulatedElapsedTime最大可以为1秒2帧(_maxElapsedTime), 是默认1秒60帧的30倍. 此时不需要Sleep, 直接进入While循环</p>
</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Perform as many full fixed length time steps as we can.</span></span><br><span class="line"><span class="keyword">while</span> (_accumulatedElapsedTime &gt;= TargetElapsedTime)</span><br><span class="line">&#123;</span><br><span class="line">    _gameTime.TotalGameTime += TargetElapsedTime;</span><br><span class="line">    _accumulatedElapsedTime -= TargetElapsedTime;</span><br><span class="line">    ++stepCount;</span><br><span class="line"></span><br><span class="line">    DoUpdate(_gameTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DoUpdate会在While里面最多连续调用30次. 为什么要这么做, 它是怎么能Catch Up from slow down的? 我想, 这里有一个很重要的假设: 这一次Tick调用Update所花费的时间是正常的(假设1/60秒). 上一次Tick调用Update所花费的时间是不正常的(假设1/2秒). 对于Game来说, 上一次的Tick所花费的时间相当于正常情况下的30倍, 即相当于正常情况下的30个Update所需要的时间.30个Update可以做很多事情. 连续30个Update之后, 再调用Draw, 画面上就会出现跳跃. 这应该就是所谓的<em>跳帧</em>, 虽然画面不连续, 但还是赶上了其他人的步伐. </p>
<p>为什么有这样一个假设(这一次Tick的Update是正常开销). 因为如果这一次的Update依旧开销很大, 那么永远都无法catch up. </p>
<p>那正常开销, 就能赶上来吗? while循环中的30个Update()叠加所用的时间不也是很大的开销么?<br>可以这样想, 虽然默认是1/60帧, 这是为了和显示器的刷新频率对应, 本身Update所占的时间可能都在1/600秒(随便举个数字), 1/60帧中的大部分都在Idle. 只要将多次调用Update的时间, 挪到Idle里面, 少Sleep即可</p>
<p>注: 这里有一个疑惑点<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Draw unless the update suppressed it. 注释有问题</span></span><br><span class="line"><span class="keyword">if</span> (_suppressDraw)</span><br><span class="line">    _suppressDraw = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    DoDraw(_gameTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>_suppressDraw为true是在Exit中被调用设置, 并没有在其他地方看到. 所以一次Tick当中, Draw是一定会被调用的, 除非是Exit.</p>
<p>XNA 4.0 Refresh中的实现:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Microsoft.Xna.Framework.Game</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Tick</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.ShouldExit)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>.isActive)</span><br><span class="line">	&#123;</span><br><span class="line">		Thread.Sleep((<span class="keyword">int</span>)<span class="keyword">this</span>.inactiveSleepTime.TotalMilliseconds);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">this</span>.clock.Step();</span><br><span class="line">	<span class="keyword">bool</span> flag = <span class="literal">true</span>;</span><br><span class="line">	TimeSpan timeSpan = <span class="keyword">this</span>.clock.ElapsedAdjustedTime;</span><br><span class="line">	<span class="keyword">if</span> (timeSpan &lt; TimeSpan.Zero)</span><br><span class="line">	&#123;</span><br><span class="line">		timeSpan = TimeSpan.Zero;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.forceElapsedTimeToZero)</span><br><span class="line">	&#123;</span><br><span class="line">		timeSpan = TimeSpan.Zero;</span><br><span class="line">		<span class="keyword">this</span>.forceElapsedTimeToZero = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (timeSpan &gt; <span class="keyword">this</span>.maximumElapsedTime)</span><br><span class="line">	&#123;</span><br><span class="line">		timeSpan = <span class="keyword">this</span>.maximumElapsedTime;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.isFixedTimeStep)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Math.Abs(timeSpan.Ticks - <span class="keyword">this</span>.targetElapsedTime.Ticks) &lt; <span class="keyword">this</span>.targetElapsedTime.Ticks &gt;&gt; <span class="number">6</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			timeSpan = <span class="keyword">this</span>.targetElapsedTime;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.accumulatedElapsedGameTime += timeSpan;</span><br><span class="line">		<span class="keyword">long</span> num = <span class="keyword">this</span>.accumulatedElapsedGameTime.Ticks / <span class="keyword">this</span>.targetElapsedTime.Ticks;</span><br><span class="line">		<span class="keyword">this</span>.accumulatedElapsedGameTime = TimeSpan.FromTicks(<span class="keyword">this</span>.accumulatedElapsedGameTime.Ticks % <span class="keyword">this</span>.targetElapsedTime.Ticks);</span><br><span class="line">		<span class="keyword">this</span>.lastFrameElapsedGameTime = TimeSpan.Zero;</span><br><span class="line">		<span class="keyword">if</span> (num == <span class="number">0L</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		TimeSpan timeSpan2 = <span class="keyword">this</span>.targetElapsedTime;</span><br><span class="line">		<span class="keyword">if</span> (num &gt; <span class="number">1L</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">this</span>.updatesSinceRunningSlowly2 = <span class="keyword">this</span>.updatesSinceRunningSlowly1;</span><br><span class="line">			<span class="keyword">this</span>.updatesSinceRunningSlowly1 = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.updatesSinceRunningSlowly1 &lt; <span class="number">2147483647</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.updatesSinceRunningSlowly1++;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.updatesSinceRunningSlowly2 &lt; <span class="number">2147483647</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.updatesSinceRunningSlowly2++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.drawRunningSlowly = (<span class="keyword">this</span>.updatesSinceRunningSlowly2 &lt; <span class="number">20</span>);</span><br><span class="line">		<span class="keyword">while</span> (num &gt; <span class="number">0L</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.ShouldExit)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			num -= <span class="number">1L</span>;</span><br><span class="line">			<span class="keyword">try</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.gameTime.ElapsedGameTime = timeSpan2;</span><br><span class="line">				<span class="keyword">this</span>.gameTime.TotalGameTime = <span class="keyword">this</span>.totalGameTime;</span><br><span class="line">				<span class="keyword">this</span>.gameTime.IsRunningSlowly = <span class="keyword">this</span>.drawRunningSlowly;</span><br><span class="line">				<span class="keyword">this</span>.Update(<span class="keyword">this</span>.gameTime);</span><br><span class="line">				flag &amp;= <span class="keyword">this</span>.suppressDraw;</span><br><span class="line">				<span class="keyword">this</span>.suppressDraw = <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.lastFrameElapsedGameTime += timeSpan2;</span><br><span class="line">				<span class="keyword">this</span>.totalGameTime += timeSpan2;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		TimeSpan t = timeSpan;</span><br><span class="line">		<span class="keyword">this</span>.drawRunningSlowly = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">this</span>.updatesSinceRunningSlowly1 = <span class="number">2147483647</span>;</span><br><span class="line">		<span class="keyword">this</span>.updatesSinceRunningSlowly2 = <span class="number">2147483647</span>;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.ShouldExit)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">try</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.gameTime.ElapsedGameTime = (<span class="keyword">this</span>.lastFrameElapsedGameTime = t);</span><br><span class="line">				<span class="keyword">this</span>.gameTime.TotalGameTime = <span class="keyword">this</span>.totalGameTime;</span><br><span class="line">				<span class="keyword">this</span>.gameTime.IsRunningSlowly = <span class="literal">false</span>;</span><br><span class="line">				<span class="keyword">this</span>.Update(<span class="keyword">this</span>.gameTime);</span><br><span class="line">				flag &amp;= <span class="keyword">this</span>.suppressDraw;</span><br><span class="line">				<span class="keyword">this</span>.suppressDraw = <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.totalGameTime += t;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!flag)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>.DrawFrame();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/编程/" rel="tag"># 编程</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/04/MonoGame笔记(六)Game与GUI的差异/" rel="next" title="MonoGame笔记(六)Game与GUI的差异">
                <i class="fa fa-chevron-left"></i> MonoGame笔记(六)Game与GUI的差异
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/07/MonoGame笔记(八)Fixed step or variable step/" rel="prev" title="MonoGame笔记(八)Fixed step or variable step">
                MonoGame笔记(八)Fixed step or variable step <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zmapleaf</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">66</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#Game-Loop-Timing"><span class="nav-number">1.</span> <span class="nav-text">Game Loop Timing</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Fixed-Step-Game-Loops"><span class="nav-number">2.</span> <span class="nav-text">Fixed-Step Game Loops</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Variable-Step-Game-Loops-更推荐用这个"><span class="nav-number">3.</span> <span class="nav-text">Variable-Step Game Loops(更推荐用这个)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Animation-and-Timing"><span class="nav-number">4.</span> <span class="nav-text">Animation and Timing</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zmapleaf</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
