<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="远">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="远">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="远">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/">





  <title>远</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">远</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/22/P&P笔记(X1) Exception Handle (一)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/22/P&P笔记(X1) Exception Handle (一)/" itemprop="url">P&P笔记(X1) Exception Handle (一)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-22T13:19:37+08:00">
                2018-04-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这一篇主要整理Exception的机制.</p>
<h2 id="什么是Exception以及Exception-Handle"><a href="#什么是Exception以及Exception-Handle" class="headerlink" title="什么是Exception以及Exception Handle"></a>什么是Exception以及Exception Handle</h2><p>回答这个问题, 下面这段讲Exception与Assert区别的文字, 从另一个角度解释了什么是异常. 有醍醐灌顶, 正本清源的感觉.</p>
<h3 id="Exception与Assert的区别"><a href="#Exception与Assert的区别" class="headerlink" title="Exception与Assert的区别"></a>Exception与Assert的区别</h3><p>链接<a href="https://docs.microsoft.com/en-us/cpp/cpp/errors-and-exception-handling-modern-cpp" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/cpp/cpp/errors-and-exception-handling-modern-cpp</a> </p>
<blockquote>
<p>Exceptions and asserts are two distinct mechanisms for detecting run-time errors in a program. Use asserts to test for conditions during development that should never be true if all your code is correct. There is no point in handling such an error by using an exception <strong>because the error indicates that something in the code has to be fixed(是代码本身出了问题)</strong>, and doesn’t represent a condition that the program has to recover from at run time. An assert stops execution at the statement so that you can inspect the program state in the debugger; an exception continues execution from the first appropriate catch handler. <strong>Use exceptions to check error conditions that might occur at run time even if your code is correct</strong>, for example, “file not found” or “out of memory.” You might want to recover from these conditions, even if the recovery just outputs a message to a log and ends the program. <strong>Always check arguments to public functions by using exceptions</strong>. Even if your function is error-free, you might not have complete control over arguments that a user might pass to it.</p>
</blockquote>
<p>再看C# in a nutshell中怎么说</p>
<blockquote>
<p>An assertion is something that, if violated, indicates a bug in the current method’s code.<br>Throwing an exception based on argument validation indicates a bug in the caller’s code.</p>
</blockquote>
<p>例如一个复杂的算法内部在进行下一个计算时, 上一个计算得到的值必须符合某个范围. 如果在范围外, 则表示该算法的计算步骤有误, 这种情况下, 使用的是断言. 断言判断的是程序本身的逻辑问题.异常, 就像链接中所说的那样, 程序本身没有问题. 是运行时的问题, 例如输入, 网络异常, 读写异常等等. 有些异常可以恢复, 例如FileNotFoundException; 有些异常不能恢复, 例如StackOverflowException. 异常处理的做法是, 对于可恢复的异常, 根据程序上下文, 恢复程序的正常执行; 对于那些不可恢复的异常, 则记录日志, 再次抛出异常, 终止程序执行. </p>
<h2 id="throw还是不throw"><a href="#throw还是不throw" class="headerlink" title="throw还是不throw"></a>throw还是不throw</h2><p>对于函数设计而言, 什么情况下需要抛出异常, 什么情况下不抛出异常, 可以用if来替代.</p>
<p>一种说法是尽量少throw, 例如</p>
<p><em>Best Practices - Exception Handling in C# .NET</em><br><a href="https://www.c-sharpcorner.com/UploadFile/84c85b/best-practices-exception-handling-in-C-Sharp-net/" target="_blank" rel="noopener">https://www.c-sharpcorner.com/UploadFile/84c85b/best-practices-exception-handling-in-C-Sharp-net/</a><br>中提到2点</p>
<ol>
<li>Do Not Throw Exceptions to Control Application Flow</li>
<li>Use Validation Code to Reduce Unnecessary Exceptions</li>
</ol>
<p>像除以0这种, 用if判断即可, 不要throw exception.</p>
<p>另一种说法是<strong>Always check arguments to public functions by using exceptions</strong><br>看List<t>的源码发现很多throw exception<br><a href="https://referencesource.microsoft.com/#mscorlib/system/collections/generic/list.cs,cf7f4095e4de7646" target="_blank" rel="noopener">https://referencesource.microsoft.com/#mscorlib/system/collections/generic/list.cs,cf7f4095e4de7646</a></t></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">List</span>(<span class="params"><span class="keyword">int</span> capacity</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (capacity &lt; <span class="number">0</span>) ThrowHelper.ThrowArgumentOutOfRangeException(ExceptionArgument.capacity, ExceptionResource.ArgumentOutOfRange_NeedNonNegNum);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">List</span>(<span class="params">IEnumerable&lt;T&gt; collection</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (collection == <span class="literal">null</span>)</span><br><span class="line">        ThrowHelper.ThrowArgumentNullException(ExceptionArgument.collection);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">FindAll</span>(<span class="params">Predicate&lt;T&gt; match</span>)</span> &#123; </span><br><span class="line">    <span class="keyword">if</span>( match == <span class="literal">null</span>) &#123;</span><br><span class="line">        ThrowHelper.ThrowArgumentNullException(ExceptionArgument.match);</span><br><span class="line">    &#125;</span><br><span class="line">    Contract.EndContractBlock();</span><br><span class="line"></span><br><span class="line">    List&lt;T&gt; list = <span class="keyword">new</span> List&lt;T&gt;(); </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; _size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(match(_items[i])) &#123;</span><br><span class="line">            list.Add(_items[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该如何选择?</p>
<p>其实仔细看一下上述List<t>的方法, 可以发现一些线索.像构造方法这种, 如果输入参数有误, 是没有办法通过if来规避的, 只能抛出异常; 再看FindAll方法, API的设计是需要返回一个列表. 假如match为null时不抛出异常, 那么是return null还是return new list<t>()呢? return new List<t>的话, 即使match不是null, 也有可能返回. 即所有的item都不匹配. return null的话, 从API的设计角度, 是不恰当的. 调用者调用List的FindAll方法, 不应该返回null. 当不知道返回什么时, throw exception是一个更好的选择, throw new exception可以当做返回值, 编译器不会报错. 而且List<t>属于底层库. 它没有程序上下文, 也不需要去recover. 直接像上层抛出异常即可.</t></t></t></t></p>
<p>再例如:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;People&gt; <span class="title">GetAllCustomersByAge</span>(<span class="params"><span class="keyword">int</span> age</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (age &lt; <span class="number">18</span> || age &gt; <span class="number">150</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">"Age must be between 18 and 150."</span>, <span class="keyword">nameof</span>(age));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>虽然这是上层逻辑, 但该方法内部缺少恢复的程序上下文, 抛出异常是合适的.</p>
<p>现在再来讨论可以不抛出异常的情况.<br><a href="https://github.com/dotnet/training-tutorials/blob/master/content/csharp/getting-started/exceptions.md" target="_blank" rel="noopener">https://github.com/dotnet/training-tutorials/blob/master/content/csharp/getting-started/exceptions.md</a><br>该链接中有这样一段文字和示例:</p>
<p>When to Avoid Throwing and Catching</p>
<blockquote>
<p>It is important that you only throw exceptions when it’s appropriate, when your code is in an unintended(没预料到的) situation. If the situation seems likely(预料到的), but requires taking a certain action, just handle it using normal application flow control elements like if statements.</p>
</blockquote>
<blockquote>
<p>A rule of thumb for determining if you need to throw an exception is if you encounter a situation in a method that <strong>doesn’t allow you to return a valid result. In that case, an exception may be the best solution, or you may need to reconsider what your method is returning.</strong> The following two examples demonstrate two ways to deal with a method failing to perform its intended task:</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetMemberBirthday</span>(<span class="params"><span class="keyword">int</span> memberId, DateTime birthday</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Member member = _memberList.SingleOrDefault(m =&gt; m.Id == memberId);</span><br><span class="line">    <span class="keyword">if</span> (member == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MemberNotFoundException(id);</span><br><span class="line">    &#125;</span><br><span class="line">    member.Birthday = birthday;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没有找到member是一种<strong>预料之中</strong>的情况, 这种情况下, 可以更改API的设计, 来避免抛出异常</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">SetMemberBirthday</span>(<span class="params"><span class="keyword">int</span> memberId, DateTime birthday</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Member member = _memberList.SingleOrDefault(m =&gt; m.Id == memberId);</span><br><span class="line">    <span class="keyword">if</span> (member == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Logger.LogWarning(<span class="string">$"SetMemberBirthday Error: Member <span class="subst">&#123;memberId&#125;</span> not found. Birthday not set <span class="subst">&#123;birthday&#125;</span>."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// false tells the caller that the operation failed.</span></span><br><span class="line">    &#125;</span><br><span class="line">    member.Birthday = birthday;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过以上的描述, 可以体会下面的结论:</p>
<ol>
<li>异常用在unintended situation中. 什么样算是unintended, 这需要程序员自己界定. 这是一个难点.</li>
<li>如果是intended situation, 可以通过更改API的接口设计(返回值)来避免抛出异常. </li>
<li>像List的FindAll方法, 它的接口意图是明确的. 它的返回值没法更改. 这种不知道返回什么的情况下, 用<br>throw exception是最合适的选择.</li>
</ol>
<p>上面提到的是API的设计, 更上一层, 在类的设计层面去避免异常. 下面摘自Best practices for exceptions<br><a href="https://docs.microsoft.com/en-us/dotnet/standard/exceptions/best-practices-for-exceptions" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/dotnet/standard/exceptions/best-practices-for-exceptions</a></p>
<p>Handle common conditions without throwing exceptions</p>
<blockquote>
<p>For conditions that are likely to occur but might trigger an exception, consider handling them in a way that will avoid the exception. For example, if you try to close a connection that is already closed, you’ll get an InvalidOperationException. You can avoid that by using an if statement to check the connection state before trying to close it.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (conn.State != ConnectionState.Closed)</span><br><span class="line">&#123;</span><br><span class="line">    conn.Close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>conn类提供了State属性, 用来判断; 如果没有改属性, 则需要捕获异常<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    conn.Close();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (InvalidOperationException ex)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(ex.GetType().FullName);</span><br><span class="line">    Console.WriteLine(ex.Message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The method to choose depends on how often you expect the event to occur.</p>
<ul>
<li><p>Use exception handling if the event doesn’t occur very often, that is, if the event is truly exceptional and indicates an error (such as an unexpected end-of-file). When you use exception handling, less code is executed in normal conditions.</p>
</li>
<li><p>Check for error conditions in code if the event happens routinely and could be considered part of normal execution. When you check for common error conditions, less code is executed because you avoid exceptions.</p>
</li>
</ul>
<blockquote>
<p><strong>Design classes so that exceptions can be avoided</strong>. A class can provide methods or properties that enable you to avoid making a call that would trigger an exception. For example, a FileStream class provides methods that help determine whether the end of the file has been reached. These can be used to avoid the exception that is thrown if you read past the end of the file. </p>
</blockquote>
<h2 id="swallow还是rethrow"><a href="#swallow还是rethrow" class="headerlink" title="swallow还是rethrow"></a>swallow还是rethrow</h2><p>对于下层调用抛出的异常, 是吞掉呢? 还是向上propagate. 这个主要看当前这一层, 有没有足够的程序上下文, 来进行恢复. 如果没有那样的能力, 只能rethrow exception. 下面这段文字摘自MSDN, 讲的非常明了.</p>
<p><a href="https://docs.microsoft.com/en-us/cpp/cpp/how-to-design-for-exception-safety" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/cpp/cpp/how-to-design-for-exception-safety</a></p>
<blockquote>
<p>Basic Techniques<br>A robust exception-handling policy requires careful thought and should be part of the design process. In general, most exceptions are detected and thrown at <strong>the lower layers</strong> of a software module, but typically these layers do not have enough context to handle the error or expose a message to end users. In <strong>the middle layers</strong>, functions can catch and rethrow an exception when they have to inspect the exception object, or they have additional useful information to provide for the upper layer that ultimately catches the exception. A function should catch and “swallow” an exception only if it is able to completely recover from it. In many cases, the correct behavior in the middle layers is to let an exception propagate up the call stack. Even at <strong>the highest layer</strong>, it might be appropriate to let an unhandled exception terminate a program if the exception leaves the program in a state in which its correctness cannot be guaranteed.<br>No matter how a function handles an exception, to help guarantee that it is “exception-safe,” it must be designed according to the following basic rules.</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/08/DesignPattern笔记(三)Iterator/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/08/DesignPattern笔记(三)Iterator/" itemprop="url">DesignPattern笔记(三)Iterator</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-08T10:53:37+08:00">
                2018-01-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://en.wikipedia.org/wiki/Iterator_pattern" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Iterator_pattern</a></p>
<p><img src="/img/designpattern-iterator-1.jpg" alt=""><br>参考C#中的IEnumerable和IEnumerator接口, 以string为例(代码摘自C# 5.0 in a nutshell第4章和第7章相关章节)<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> s = <span class="string">"Hello"</span>;</span><br><span class="line"><span class="comment">// Because string implements IEnumerable, we can call GetEnumerator():</span></span><br><span class="line">IEnumerator rator = s.GetEnumerator();</span><br><span class="line"><span class="keyword">while</span> (rator.MoveNext())</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> c = (<span class="keyword">char</span>) rator.Current;</span><br><span class="line">	Console.Write (c + <span class="string">"."</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Output: H.e.l.l.o.</span></span><br></pre></td></tr></table></figure></p>
<p>IEnumerable接口等同于Aggregate接口<br>IEnumerator接口等同于Iterator接口<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEnumerable</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">IEnumerator <span class="title">GetEnumerator</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEnumerator</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">MoveNext</span>(<span class="params"></span>)</span>;</span><br><span class="line">	<span class="keyword">object</span> Current &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>GetEnumerator方法等同于CreateInterator方法<br>string实现IEnumerable<char>接口. CharEnumerator实现IEnumerator, IEnumerator<char>接口(<a href="http://referencesource.microsoft.com/#mscorlib/system/charenumerator.cs,a6b81e2669b87db5" target="_blank" rel="noopener">http://referencesource.microsoft.com/#mscorlib/system/charenumerator.cs,a6b81e2669b87db5</a>)</char></char></p>
<p>这是C# 1.0. 之后用法上引入了foreach, 实现上引入了yield return. </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/05/DesignPattern笔记(二)Strategy/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/05/DesignPattern笔记(二)Strategy/" itemprop="url">DesignPattern笔记(二)Strategy</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-05T14:40:37+08:00">
                2018-01-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://en.wikipedia.org/wiki/Strategy_pattern" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Strategy_pattern</a></p>
<p><img src="/img/designpattern-strategy-1.jpg" alt=""><br>参考C#中的IComparer<t> 接口, 此接口用于 List<t>.Sort 和 List<t>.BinarySearch 方法(<a href="https://msdn.microsoft.com/zh-cn/library/8ehhxeaf(v=vs.110).aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/zh-cn/library/8ehhxeaf(v=vs.110).aspx</a>)<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Sort</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">	IComparer&lt;T&gt; comparer</span></span></span><br><span class="line"><span class="function"><span class="params"></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">BinarySearch</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">	T item,</span></span></span><br><span class="line"><span class="function"><span class="params">	IComparer&lt;T&gt; comparer</span></span></span><br><span class="line"><span class="function"><span class="params"></span>)</span></span><br></pre></td></tr></table></figure></t></t></t></p>
<p>IComparer&lt;T&gt;就扮演了Strategy接口的角色, Context则是List&lt;T&gt;</p>
<p>下面是官方示例代码(<a href="https://msdn.microsoft.com/en-us/library/234b841s(v=vs.110).aspx)" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/234b841s(v=vs.110).aspx)</a>:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line">public class DinoComparer: IComparer&lt;string&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">Compare</span>(<span class="params"><span class="keyword">string</span> x, <span class="keyword">string</span> y</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (y == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// If x is null and y is null, they're</span></span><br><span class="line">                <span class="comment">// equal. </span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// If x is null and y is not null, y</span></span><br><span class="line">                <span class="comment">// is greater. </span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// If x is not null...</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="keyword">if</span> (y == <span class="literal">null</span>)</span><br><span class="line">                <span class="comment">// ...and y is null, x is greater.</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// ...and y is not null, compare the </span></span><br><span class="line">                <span class="comment">// lengths of the two strings.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">int</span> retval = x.Length.CompareTo(y.Length);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (retval != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// If the strings are not of equal length,</span></span><br><span class="line">                    <span class="comment">// the longer string is greater.</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="keyword">return</span> retval;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// If the strings are of equal length,</span></span><br><span class="line">                    <span class="comment">// sort them with ordinary string comparison.</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="keyword">return</span> x.CompareTo(y);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Example</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        List&lt;<span class="keyword">string</span>&gt; dinosaurs = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">        dinosaurs.Add(<span class="string">"Pachycephalosaurus"</span>);</span><br><span class="line">        dinosaurs.Add(<span class="string">"Amargasaurus"</span>);</span><br><span class="line">        dinosaurs.Add(<span class="string">"Mamenchisaurus"</span>);</span><br><span class="line">        dinosaurs.Add(<span class="string">"Deinonychus"</span>);</span><br><span class="line">        Display(dinosaurs);</span><br><span class="line"></span><br><span class="line">        DinoComparer dc = <span class="keyword">new</span> DinoComparer();</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">"\nSort with alternate comparer:"</span>);</span><br><span class="line">        dinosaurs.Sort(dc);</span><br><span class="line">        Display(dinosaurs);</span><br><span class="line"></span><br><span class="line">        SearchAndInsert(dinosaurs, <span class="string">"Coelophysis"</span>, dc);</span><br><span class="line">        Display(dinosaurs);</span><br><span class="line"></span><br><span class="line">        SearchAndInsert(dinosaurs, <span class="string">"Oviraptor"</span>, dc);</span><br><span class="line">        Display(dinosaurs);</span><br><span class="line"></span><br><span class="line">        SearchAndInsert(dinosaurs, <span class="string">"Tyrannosaur"</span>, dc);</span><br><span class="line">        Display(dinosaurs);</span><br><span class="line"></span><br><span class="line">        SearchAndInsert(dinosaurs, <span class="literal">null</span>, dc);</span><br><span class="line">        Display(dinosaurs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SearchAndInsert</span>(<span class="params">List&lt;<span class="keyword">string</span>&gt; list, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">string</span> insert, DinoComparer dc</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">"\nBinarySearch and Insert \"&#123;0&#125;\":"</span>, insert);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> index = list.BinarySearch(insert, dc);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            list.Insert(~index, insert);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Display</span>(<span class="params">List&lt;<span class="keyword">string</span>&gt; list</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine();</span><br><span class="line">        <span class="keyword">foreach</span>( <span class="keyword">string</span> s <span class="keyword">in</span> list )</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This code example produces the following output:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Pachycephalosaurus</span></span><br><span class="line"><span class="comment">Amargasaurus</span></span><br><span class="line"><span class="comment">Mamenchisaurus</span></span><br><span class="line"><span class="comment">Deinonychus</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Sort with alternate comparer:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Deinonychus</span></span><br><span class="line"><span class="comment">Amargasaurus</span></span><br><span class="line"><span class="comment">Mamenchisaurus</span></span><br><span class="line"><span class="comment">Pachycephalosaurus</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">BinarySearch and Insert "Coelophysis":</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Coelophysis</span></span><br><span class="line"><span class="comment">Deinonychus</span></span><br><span class="line"><span class="comment">Amargasaurus</span></span><br><span class="line"><span class="comment">Mamenchisaurus</span></span><br><span class="line"><span class="comment">Pachycephalosaurus</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">BinarySearch and Insert "Oviraptor":</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Oviraptor</span></span><br><span class="line"><span class="comment">Coelophysis</span></span><br><span class="line"><span class="comment">Deinonychus</span></span><br><span class="line"><span class="comment">Amargasaurus</span></span><br><span class="line"><span class="comment">Mamenchisaurus</span></span><br><span class="line"><span class="comment">Pachycephalosaurus</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">BinarySearch and Insert "Tyrannosaur":</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Oviraptor</span></span><br><span class="line"><span class="comment">Coelophysis</span></span><br><span class="line"><span class="comment">Deinonychus</span></span><br><span class="line"><span class="comment">Tyrannosaur</span></span><br><span class="line"><span class="comment">Amargasaurus</span></span><br><span class="line"><span class="comment">Mamenchisaurus</span></span><br><span class="line"><span class="comment">Pachycephalosaurus</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">BinarySearch and Insert "":</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Oviraptor</span></span><br><span class="line"><span class="comment">Coelophysis</span></span><br><span class="line"><span class="comment">Deinonychus</span></span><br><span class="line"><span class="comment">Tyrannosaur</span></span><br><span class="line"><span class="comment">Amargasaurus</span></span><br><span class="line"><span class="comment">Mamenchisaurus</span></span><br><span class="line"><span class="comment">Pachycephalosaurus</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure></p>
<p>另外在数值求解库的设计中也会遇到策略模式, 例如线性方程组的求解有多种方法.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/04/DesignPattern笔记(一)Adapter/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/04/DesignPattern笔记(一)Adapter/" itemprop="url">DesignPattern笔记(一)Adapter</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-04T11:32:37+08:00">
                2018-01-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://en.wikipedia.org/wiki/Adapter_pattern" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Adapter_pattern</a></p>
<p><img src="/img/designpattern-adapter-1.jpg" alt=""><br>Client使用的是接口. 参考JDK中的LinkedList(<a href="https://docs.oracle.com/javase/7/docs/api/java/util/LinkedList.html)" target="_blank" rel="noopener">https://docs.oracle.com/javase/7/docs/api/java/util/LinkedList.html)</a>. LinkedList类实现了java.util.Queue接口, 使用offer和poll入队出队<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestQueue</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Queue&lt;String&gt; queue = <span class="keyword">new</span> LinkedList&lt;String&gt;();</span><br><span class="line">        queue.offer(<span class="string">"Hello"</span>);</span><br><span class="line">        queue.offer(<span class="string">"World!"</span>);</span><br><span class="line">        System.out.println(queue.size());</span><br><span class="line">        String str;</span><br><span class="line">        <span class="keyword">while</span>((str=queue.poll())!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            System.out.print(str);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.println(queue.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>LinkedList另外实现了其他接口Deque&lt;E&gt;, List&lt;E&gt;等.<br>Java是单继承, 可以认为是用其他接口的方法实现Queue接口, 也属于Class Adapter.</p>
<p>wiki中另外两幅图<br><img src="/img/designpattern-adapter-class-adapter.png" alt=""><br><img src="/img/designpattern-adapter-object-adapter.png" alt=""><br>Client直接使用Adapter类. 参考JDK中的MouseAdapter(<a href="https://docs.oracle.com/javase/7/docs/api/java/awt/event/MouseAdapter.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/7/docs/api/java/awt/event/MouseAdapter.html</a>)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MouseAdapter</span> <span class="keyword">extends</span> <span class="title">Object</span></span></span><br><span class="line"><span class="class"><span class="keyword">implements</span> <span class="title">MouseListener</span>, <span class="title">MouseWheelListener</span>, <span class="title">MouseMotionListener</span></span></span><br></pre></td></tr></table></figure></p>
<p>使用方式如下(<a href="http://www.yiibai.com/swing/swing_mouseadapter.html" target="_blank" rel="noopener">http://www.yiibai.com/swing/swing_mouseadapter.html</a>)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">JLabel msglabel </span><br><span class="line">= <span class="keyword">new</span> JLabel(<span class="string">"Welcome to TutorialsPoint SWING Tutorial."</span></span><br><span class="line">,JLabel.CENTER);</span><br><span class="line"></span><br><span class="line">msglabel.addMouseListener(<span class="keyword">new</span> MouseAdapter()&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mouseClicked</span><span class="params">(MouseEvent e)</span> </span>&#123;</span><br><span class="line">        statusLabel.setText(<span class="string">"Mouse Clicked: ("</span></span><br><span class="line">        +e.getX()+<span class="string">", "</span>+e.getY() +<span class="string">")"</span>);</span><br><span class="line">    &#125;                </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>MouseAdapter有方法体, 但里面为空. 如果单独实现MouseListener, MouseWheelListener等接口, 那么必须实现所有的方法. 有了MouseAdapter, 在子类中就可以只关心那些需要的事件处理方法.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/25/MonoGame笔记(X6)Game State Management(三)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/25/MonoGame笔记(X6)Game State Management(三)/" itemprop="url">MonoGame笔记(X6)Game State Management (三)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-25T16:32:37+08:00">
                2017-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇笔记中介绍了主菜单进入游戏再到退出游戏的大致流程. 接下来看一下ScreenManager的Update方法和Draw方法<br>Draw方法比较简单, 如果是Hidden状态, 则不绘制. Update方法复杂一点,它是用List当做Stack, 也是自顶向下更新. 而Draw如上一篇笔记所说, 是自底向上绘制. </p>
<p>Update方法中的两个变量: otherScreenHasFocus, coveredByOtherScreen比较关键. 并且这两个变量会传递给GameScreen的Update方法.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Allows each screen to run logic.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Read the keyboard and gamepad.</span></span><br><span class="line">    input.Update();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make a copy of the master screen list, to avoid confusion if</span></span><br><span class="line">    <span class="comment">// the process of updating one screen adds or removes others.</span></span><br><span class="line">    screensToUpdate.Clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (GameScreen screen <span class="keyword">in</span> screens)</span><br><span class="line">        screensToUpdate.Add(screen);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> otherScreenHasFocus = !Game.IsActive;</span><br><span class="line">    <span class="keyword">bool</span> coveredByOtherScreen = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Loop as long as there are screens waiting to be updated.</span></span><br><span class="line">    <span class="keyword">while</span> (screensToUpdate.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Pop the topmost screen off the waiting list.</span></span><br><span class="line">        GameScreen screen = screensToUpdate[screensToUpdate.Count - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        screensToUpdate.RemoveAt(screensToUpdate.Count - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the screen.</span></span><br><span class="line">        screen.Update(gameTime, otherScreenHasFocus, coveredByOtherScreen);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (screen.ScreenState == ScreenState.TransitionOn ||</span><br><span class="line">            screen.ScreenState == ScreenState.Active)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// If this is the first active screen we came across,</span></span><br><span class="line">            <span class="comment">// give it a chance to handle input.</span></span><br><span class="line">            <span class="keyword">if</span> (!otherScreenHasFocus)</span><br><span class="line">            &#123;</span><br><span class="line">                screen.HandleInput(input);</span><br><span class="line"></span><br><span class="line">                otherScreenHasFocus = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this is an active non-popup, inform any subsequent</span></span><br><span class="line">            <span class="comment">// screens that they are covered by it.</span></span><br><span class="line">            <span class="keyword">if</span> (!screen.IsPopup)</span><br><span class="line">                coveredByOtherScreen = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Print debug trace?</span></span><br><span class="line">    <span class="keyword">if</span> (traceEnabled)</span><br><span class="line">        TraceScreens();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Tells each screen to draw itself.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Draw</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (GameScreen screen <span class="keyword">in</span> screens)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (screen.ScreenState == ScreenState.Hidden)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        screen.Draw(gameTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>otherScreenHasFocus用来控制输入焦点;只有最顶上的那个GameScreen可以接收输入, 之后的GameScreen都不能接收输入.</p>
<p>coveredByOtherScreen用来控制是否绘制该GameScreen. 例如游戏画面被主菜单盖住, GamePlayScreen就不需要再被绘制. 前提是盖住的那个GameScreen不是Popup弹窗. MessageBoxScreen属于Popup弹窗. </p>
<p>GameScreen的Update方法对coveredByOtherScreen进行判断. 如果为真, 该GameScreen就需要淡出, 直至完全隐藏.<br>淡出时仍旧需要绘制.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Allows the screen to run logic, such as updating the transition position.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Unlike HandleInput, this method is called regardless of whether the screen</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> is active, hidden, or in the middle of a transition.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime, <span class="keyword">bool</span> otherScreenHasFocus,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">bool</span> coveredByOtherScreen</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.otherScreenHasFocus = otherScreenHasFocus;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isExiting)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// If the screen is going away to die, it should transition off.</span></span><br><span class="line">        screenState = ScreenState.TransitionOff;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!UpdateTransition(gameTime, transitionOffTime, <span class="number">1</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// When the transition finishes, remove the screen.</span></span><br><span class="line">            ScreenManager.RemoveScreen(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (coveredByOtherScreen)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// If the screen is covered by another, it should transition off.</span></span><br><span class="line">        <span class="keyword">if</span> (UpdateTransition(gameTime, transitionOffTime, <span class="number">1</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Still busy transitioning.</span></span><br><span class="line">            screenState = ScreenState.TransitionOff;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Transition finished!</span></span><br><span class="line">            screenState = ScreenState.Hidden;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Otherwise the screen should transition on and become active.</span></span><br><span class="line">        <span class="keyword">if</span> (UpdateTransition(gameTime, transitionOnTime, <span class="number">-1</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Still busy transitioning.</span></span><br><span class="line">            screenState = ScreenState.TransitionOn;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Transition finished!</span></span><br><span class="line">            screenState = ScreenState.Active;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这种做法还是很巧妙的. 顶上GameScreen借助这种方式”通知”下面的GameScreen. 而且, 顶上的GameScreen如果是TransitionOn淡入, 底下的GameScreen就得到TransitionOff淡出的”通知”, 两者一前一后几乎同时发生, 视觉效果不错.</p>
<p>接下来看看MenuScreen与MenuEntry的关系.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Updates the menu.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime, <span class="keyword">bool</span> otherScreenHasFocus,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               <span class="keyword">bool</span> coveredByOtherScreen</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">base</span>.Update(gameTime, otherScreenHasFocus, coveredByOtherScreen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update each nested MenuEntry object.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; menuEntries.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">bool</span> isSelected = IsActive &amp;&amp; (i == selectedEntry);</span><br><span class="line"></span><br><span class="line">        menuEntries[i].Update(<span class="keyword">this</span>, isSelected, gameTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MenuEntry有自己的Update和Draw方法. MenuEntry自己控制Selected与Unselected时的状态效果. MenuEntry还暴露了一个Selected事件, 供MenuScreen监听. 但MenuEntry是否被选中, 是在MenuScreen的HandleInput中进行判断. 不是在MenuEntry内部. selectedEntry是由MenuScreen控制的, 具体有多少个Entry只有MenuScreen知晓</p>
<p>方向键移动, Enter键选择<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Responds to user input, changing the selected entry and accepting</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> or cancelling the menu.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">HandleInput</span>(<span class="params">InputState input</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Move to the previous menu entry?</span></span><br><span class="line">    <span class="keyword">if</span> (input.IsMenuUp(ControllingPlayer))</span><br><span class="line">    &#123;</span><br><span class="line">        selectedEntry--;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (selectedEntry &lt; <span class="number">0</span>)</span><br><span class="line">            selectedEntry = menuEntries.Count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Move to the next menu entry?</span></span><br><span class="line">    <span class="keyword">if</span> (input.IsMenuDown(ControllingPlayer))</span><br><span class="line">    &#123;</span><br><span class="line">        selectedEntry++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (selectedEntry &gt;= menuEntries.Count)</span><br><span class="line">            selectedEntry = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Accept or cancel the menu? We pass in our ControllingPlayer, which may</span></span><br><span class="line">    <span class="comment">// either be null (to accept input from any player) or a specific index.</span></span><br><span class="line">    <span class="comment">// If we pass a null controlling player, the InputState helper returns to</span></span><br><span class="line">    <span class="comment">// us which player actually provided the input. We pass that through to</span></span><br><span class="line">    <span class="comment">// OnSelectEntry and OnCancel, so they can tell which player triggered them.</span></span><br><span class="line">    PlayerIndex playerIndex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input.IsMenuSelect(ControllingPlayer, <span class="keyword">out</span> playerIndex))</span><br><span class="line">    &#123;</span><br><span class="line">        OnSelectEntry(selectedEntry, playerIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (input.IsMenuCancel(ControllingPlayer, <span class="keyword">out</span> playerIndex))</span><br><span class="line">    &#123;</span><br><span class="line">        OnCancel(playerIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Handler for when the user has chosen a menu entry.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnSelectEntry</span>(<span class="params"><span class="keyword">int</span> entryIndex, PlayerIndex playerIndex</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    menuEntries[entryIndex].OnSelectEntry(playerIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MenuEntry<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Method for raising the Selected event.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">internal</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnSelectEntry</span>(<span class="params">PlayerIndex playerIndex</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Selected != <span class="literal">null</span>)</span><br><span class="line">        Selected(<span class="keyword">this</span>, <span class="keyword">new</span> PlayerIndexEventArgs(playerIndex));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其他</p>
<p>BackgroundScreen的LoadContent<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Loads graphics content for this screen. The background texture is quite</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> big, so we use our own local ContentManager to load it. This allows us</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> to unload before going from the menus into the game itself, wheras if we</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> used the shared ContentManager provided by the Game class, the content</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> would remain loaded forever.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">LoadContent</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (content == <span class="literal">null</span>)</span><br><span class="line">        content = <span class="keyword">new</span> ContentManager(ScreenManager.Game.Services, <span class="string">"Content"</span>);</span><br><span class="line"></span><br><span class="line">    backgroundTexture = content.Load&lt;Texture2D&gt;(<span class="string">"background"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Updates the background screen. Unlike most screens, this should not</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> transition off even if it has been covered by another screen: it is</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> supposed to be covered, after all! This overload forces the</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> coveredByOtherScreen parameter to false in order to stop the base</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Update method wanting to transition off.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime, <span class="keyword">bool</span> otherScreenHasFocus,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               <span class="keyword">bool</span> coveredByOtherScreen</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">base</span>.Update(gameTime, otherScreenHasFocus, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/25/MonoGame笔记(X5)Game State Management(二)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/25/MonoGame笔记(X5)Game State Management(二)/" itemprop="url">MonoGame笔记(X5)Game State Management (二)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-25T15:13:37+08:00">
                2017-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇笔记中提到的进阶版, 官方有一个样例<a href="http://xbox.create.msdn.com/en-US/education/catalog/sample/game_state_management" target="_blank" rel="noopener">http://xbox.create.msdn.com/en-US/education/catalog/sample/game_state_management</a>, 是对该版本的一个加强, 实用程度和评价都很高, 非常具有参考价值. XNA官方样例中不少都是采用了这种方式, 例如RolePlayingGameStarterKit.</p>
<p>官方的介绍如下:</p>
<p>The ScreenManager class is a reusable component that maintains a <strong>stack</strong> of one or more GameScreen instances. It coordinates the transitions from one screen to another, and takes care of routing user input to whichever screen is on top of the stack.</p>
<p>Each screen class (<strong>including the actual gameplay, which is just another screen</strong>) derives from GameScreen. This provides Update, HandleInput, and Draw methods, plus some logic for managing the transition state. GameScreen doesn’t actually implement any transition rendering effects, however: it merely provides information such as “you are currently 30% of the way through transitioning off,” leaving it up to the derived screen classes to do something sensible with that information in their drawing code. This makes it easy for screens to implement different visual effects on top of the same underlying transition infrastructure.</p>
<p>这里提到的transitioning off是指淡出状态, transitioning on是淡入, 共有四种状态.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ScreenState</span><br><span class="line">&#123;</span><br><span class="line">    TransitionOn,</span><br><span class="line">    Active,</span><br><span class="line">    TransitionOff,</span><br><span class="line">    Hidden,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>类图和上一篇笔记中的类图结构差不多. 样例中有以下几种GameScreen, 是一个游戏当中必须的游戏界面. 其他各种和具体游戏相关的Screen见RolePlayingGameStarterKit</p>
<p>BackgroundScreen<br>GameplayScreen<br>LoadingScreen<br>MenuScreen (MenuEntry)<br>—–MainMenuScreen<br>—–OptionsMenuScreen<br>—–PauseMenuScreen<br>MessageBoxScreen  </p>
<h4 id="BackgroundScreen"><a href="#BackgroundScreen" class="headerlink" title="BackgroundScreen"></a>BackgroundScreen</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> The background screen sits behind all the other menu screens.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> It draws a background image that remains fixed in place regardless</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> of whatever transitions the screens on top of it may be doing.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 和菜单界面一起</span></span><br></pre></td></tr></table></figure>
<h4 id="GameplayScreen"><a href="#GameplayScreen" class="headerlink" title="GameplayScreen"></a>GameplayScreen</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> This screen implements the actual game logic. It is just a</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> placeholder to get the idea across: you'll probably want to</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> put some more interesting gameplay in here!</span></span><br></pre></td></tr></table></figure>
<h4 id="LoadingScreen"><a href="#LoadingScreen" class="headerlink" title="LoadingScreen"></a>LoadingScreen</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> The loading screen coordinates transitions between the menu system and the</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> game itself. Normally one screen will transition off at the same time as</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> the next screen is transitioning on, but for larger transitions that can</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> take a longer time to load their data, we want the menu system to be entirely</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> gone before we start loading the game. This is done as follows:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Tell all the existing screens to transition off.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - Activate a loading screen, which will transition on at the same time.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - The loading screen watches the state of the previous screens.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> - When it sees they have finished transitioning off, it activates the real</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>   next screen, which may take a long time to load its data. The loading</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>   screen will be the only thing displayed while this load is taking place.</span></span><br></pre></td></tr></table></figure>
<h4 id="MainMenuScreen"><a href="#MainMenuScreen" class="headerlink" title="MainMenuScreen"></a>MainMenuScreen</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> The main menu screen is the first thing displayed when the game starts up.</span></span><br></pre></td></tr></table></figure>
<h4 id="OptionsMenuScreen"><a href="#OptionsMenuScreen" class="headerlink" title="OptionsMenuScreen"></a>OptionsMenuScreen</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> The options screen is brought up over the top of the main menu</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> screen, and gives the user a chance to configure the game</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> in various hopefully useful ways.</span></span><br></pre></td></tr></table></figure>
<h4 id="PauseMenuScreen"><a href="#PauseMenuScreen" class="headerlink" title="PauseMenuScreen"></a>PauseMenuScreen</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> The pause menu comes up over the top of the game,</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> giving the player options to resume or quit.</span></span><br></pre></td></tr></table></figure>
<h4 id="MessageBoxScreen"><a href="#MessageBoxScreen" class="headerlink" title="MessageBoxScreen"></a>MessageBoxScreen</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> A popup message box screen, used to display "are you sure?"</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> confirmation messages.</span></span><br></pre></td></tr></table></figure>
<p>初始游戏启动时只有MainMenuScreen存在<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The main game constructor.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GameStateManagementGame</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the screen manager component.</span></span><br><span class="line">    screenManager = <span class="keyword">new</span> ScreenManager(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    Components.Add(screenManager);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Activate the first screens.</span></span><br><span class="line">    screenManager.AddScreen(<span class="keyword">new</span> BackgroundScreen(), <span class="literal">null</span>);</span><br><span class="line">    screenManager.AddScreen(<span class="keyword">new</span> MainMenuScreen(), <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方向键选择<strong>Play Game</strong>, 按下Enter键, 调用的是MainMenuScreen的<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Event handler for when the Play Game menu entry is selected.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlayGameMenuEntrySelected</span>(<span class="params"><span class="keyword">object</span> sender, PlayerIndexEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LoadingScreen.Load(ScreenManager, <span class="literal">true</span>, e.PlayerIndex,</span><br><span class="line">                       <span class="keyword">new</span> GameplayScreen());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>LoadingScreen的Load方法和Update方法. Update会等其他GameScreen都transitioning Off(淡出), 然后加载GamePlayScreen<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Activates the loading screen.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Load</span>(<span class="params">ScreenManager screenManager, <span class="keyword">bool</span> loadingIsSlow,</span></span></span><br><span class="line"><span class="function"><span class="params">                        PlayerIndex? controllingPlayer,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">params</span> GameScreen[] screensToLoad</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Tell all the current screens to transition off.</span></span><br><span class="line">    <span class="keyword">foreach</span> (GameScreen screen <span class="keyword">in</span> screenManager.GetScreens())</span><br><span class="line">        screen.ExitScreen();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create and activate the loading screen.</span></span><br><span class="line">    LoadingScreen loadingScreen = <span class="keyword">new</span> LoadingScreen(screenManager,</span><br><span class="line">                                                    loadingIsSlow,</span><br><span class="line">                                                    screensToLoad);</span><br><span class="line"></span><br><span class="line">    screenManager.AddScreen(loadingScreen, controllingPlayer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Updates the loading screen.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime, <span class="keyword">bool</span> otherScreenHasFocus,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               <span class="keyword">bool</span> coveredByOtherScreen</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">base</span>.Update(gameTime, otherScreenHasFocus, coveredByOtherScreen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If all the previous screens have finished transitioning</span></span><br><span class="line">    <span class="comment">// off, it is time to actually perform the load.</span></span><br><span class="line">    <span class="keyword">if</span> (otherScreensAreGone)</span><br><span class="line">    &#123;</span><br><span class="line">        ScreenManager.RemoveScreen(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (GameScreen screen <span class="keyword">in</span> screensToLoad)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (screen != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ScreenManager.AddScreen(screen, ControllingPlayer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Once the load has finished, we use ResetElapsedTime to tell</span></span><br><span class="line">        <span class="comment">// the  game timing mechanism that we have just finished a very</span></span><br><span class="line">        <span class="comment">// long frame, and that it should not try to catch up.</span></span><br><span class="line">        ScreenManager.Game.ResetElapsedTime();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ScreenManager的AddScreen方法内部会调用GamePlayScreen的LoadContent方法, 加载各类游戏资源.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Adds a new screen to the screen manager.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddScreen</span>(<span class="params">GameScreen screen, PlayerIndex? controllingPlayer</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    screen.ControllingPlayer = controllingPlayer;</span><br><span class="line">    screen.ScreenManager = <span class="keyword">this</span>;</span><br><span class="line">    screen.IsExiting = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we have a graphics device, tell the screen to load content.</span></span><br><span class="line">    <span class="keyword">if</span> (isInitialized)</span><br><span class="line">    &#123;</span><br><span class="line">        screen.LoadContent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    screens.Add(screen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update the TouchPanel to respond to gestures this screen is interested in</span></span><br><span class="line">    TouchPanel.EnabledGestures = screen.EnabledGestures;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>GamePlayScreen的LoadContent方法, 注意ResetElapsedTime用法<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Load graphics content for the game.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">LoadContent</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (content == <span class="literal">null</span>)</span><br><span class="line">        content = <span class="keyword">new</span> ContentManager(ScreenManager.Game.Services, <span class="string">"Content"</span>);</span><br><span class="line"></span><br><span class="line">    gameFont = content.Load&lt;SpriteFont&gt;(<span class="string">"gamefont"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A real game would probably have more content than this sample, so</span></span><br><span class="line">    <span class="comment">// it would take longer to load. We simulate that by delaying for a</span></span><br><span class="line">    <span class="comment">// while, giving you a chance to admire the beautiful loading screen.</span></span><br><span class="line">    Thread.Sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// once the load has finished, we use ResetElapsedTime to tell the game's</span></span><br><span class="line">    <span class="comment">// timing mechanism that we have just finished a very long frame, and that</span></span><br><span class="line">    <span class="comment">// it should not try to catch up.</span></span><br><span class="line">    ScreenManager.Game.ResetElapsedTime();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Game的ResetElapsedTime方法<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ResetElapsedTime</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Platform.ResetElapsedTime();</span><br><span class="line">    _gameTimer.Reset();</span><br><span class="line">    _gameTimer.Start();</span><br><span class="line">    _accumulatedElapsedTime = TimeSpan.Zero;</span><br><span class="line">    _gameTime.ElapsedGameTime = TimeSpan.Zero;</span><br><span class="line">    _previousTicks = <span class="number">0L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>至此, ScreenManager的Update方法会调用GamePlayScreen的Update方法, ScreenManager的Draw方法会调用GamePlayScreen的Draw方法.</p>
<p>GamePlayScreen的HandleInput方法中有对Escape键的轮询:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (input.IsPauseGame(ControllingPlayer) || gamePadDisconnected)</span><br><span class="line">&#123;</span><br><span class="line">    ScreenManager.AddScreen(<span class="keyword">new</span> PauseMenuScreen(), ControllingPlayer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PauseMenuScreen中选择退出游戏, 弹出一个MessageBoxScreen, 点击确定, 会调用ConfirmQuitMessageBoxAccepted方法, 确认退出游戏, 然后退回到主菜单界面.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Event handler for when the Quit Game menu entry is selected.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QuitGameMenuEntrySelected</span>(<span class="params"><span class="keyword">object</span> sender, PlayerIndexEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">string</span> message = <span class="string">"Are you sure you want to quit this game?"</span>;</span><br><span class="line"></span><br><span class="line">    MessageBoxScreen confirmQuitMessageBox = <span class="keyword">new</span> MessageBoxScreen(message);</span><br><span class="line"></span><br><span class="line">    confirmQuitMessageBox.Accepted += ConfirmQuitMessageBoxAccepted;</span><br><span class="line"></span><br><span class="line">    ScreenManager.AddScreen(confirmQuitMessageBox, ControllingPlayer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Event handler for when the user selects ok on the "are you sure</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> you want to quit" message box. This uses the loading screen to</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> transition from the game back to the main menu screen.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ConfirmQuitMessageBoxAccepted</span>(<span class="params"><span class="keyword">object</span> sender, PlayerIndexEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LoadingScreen.Load(ScreenManager, <span class="literal">false</span>, <span class="literal">null</span>, <span class="keyword">new</span> BackgroundScreen(),</span><br><span class="line">                                                   <span class="keyword">new</span> MainMenuScreen());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后点击MainMenuScreen的Exit菜单项, 关闭游戏<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Event handler for when the user selects ok on the "are you sure</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> you want to exit" message box.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ConfirmExitMessageBoxAccepted</span>(<span class="params"><span class="keyword">object</span> sender, PlayerIndexEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ScreenManager.Game.Exit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上是一个大致的过程, 从主菜单进入游戏, 然后从游戏中退出. 还有不少细节值得推敲, 见下一篇笔记.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/25/MonoGame笔记(X4)Game State Management(一)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/25/MonoGame笔记(X4)Game State Management(一)/" itemprop="url">MonoGame笔记(X4)Game State Management (一)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-25T14:06:37+08:00">
                2017-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Game State Management 是指管理主菜单界面, 游戏界面, 设置菜单界面, 游戏暂停界面等不同游戏状态之间的过渡与切换.</p>
<p>先看一个<strong>原始</strong>的版本: 使用goto, 联想到Flash中的gotoAndStop<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ScreenManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Screen Manager</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Keeps a list of available screens</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> so you can switch between them, </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> ie. jumping from the start screen to the game screen </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> http://www.david-amador.com/2010/01/xna-screen-manager/</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">SCREEN_MANAGER</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Protected Members</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">private</span> List&lt;Screen&gt; _screens = <span class="keyword">new</span> List&lt;Screen&gt;();</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">private</span> <span class="keyword">bool</span> _started = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">private</span> Screen _previous = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// Public Members</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">public</span> Screen ActiveScreen = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Add new Screen</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="screen"&gt;</span>New screen, name must be unique<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add_screen</span>(<span class="params">Screen screen</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (Screen scr <span class="keyword">in</span> _screens)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (scr.Name == screen.Name)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            _screens.Add(screen);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Go to screen</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="name"&gt;</span>Screen name<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">goto_screen</span>(<span class="params"><span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (Screen screen <span class="keyword">in</span> _screens)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (screen.Name == name)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// Shutsdown Previous Screen           </span></span><br><span class="line">                    _previous = ActiveScreen;</span><br><span class="line">                    <span class="keyword">if</span> (ActiveScreen != <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ActiveScreen.Shutdown();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// Inits New Screen</span></span><br><span class="line">                    ActiveScreen = screen;</span><br><span class="line">                    <span class="keyword">if</span> (_started) ActiveScreen.Init();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Updates Active Screen</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="elapsed"&gt;</span>GameTime<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_started == <span class="literal">false</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">if</span> (ActiveScreen!=<span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ActiveScreen.Update(gameTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Draw</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_started == <span class="literal">false</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">if</span> (ActiveScreen != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ActiveScreen.Draw(gameTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再看一个进阶的版本(<a href="http://blogs.msdn.com/b/etayrien/archive/2006/12/12/game-engine-structure.aspx" target="_blank" rel="noopener">http://blogs.msdn.com/b/etayrien/archive/2006/12/12/game-engine-structure.aspx</a>)<br><img src="/img/monogame-gamestatemanagement-1.png" alt=""><br>为什么使用Stack, 作者是这样说的:</p>
<p>so why a stack? Let’s say, for example, that when the user pauses the game, you just want to stop everything from updating, and put an image over the top of everything that says “Paused.” With a stack, that’s easy: you can just push a new PauseScreen onto the stack. When the user unpauses, pop the PauseScreen back off again. To implement the “everything still draws, but nothing updates” functionality, we’ll add two new properties to GameScreen. <strong>BlocksDraw</strong> says that no screens under this one can draw, and <strong>BlocksUpdate</strong> does the same thing for update.</p>
<p> 对于Update, GameScreenManager自顶向下遍历Stack中的GameScreens, 调用它们的Update方法, 直到遇到<strong>BlocksUpdate</strong>为true.</p>
<p> 对于Draw, 和Update有点不同. Draw本是自底向上绘制的, 先绘制下面的GameScreen, 再绘制上面的GameSreen. 而<strong>BlocksDraw</strong> 的意思是指, 当前GameScreen以下的GameScreen不绘制. 于是要先遍历一遍Stack中的GameScreens, 找到那些可见的GameScreen, 然后再对这些GameScreen以自底向上的方式进行绘制.</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">List&lt;GameScreen&gt; screensToDraw = new List&lt;GameScreen&gt;();</span><br><span class="line">foreach (GameScreen screen in ActiveGameScreens)</span><br><span class="line">&#123;</span><br><span class="line">    screensToDraw.Add( screen );</span><br><span class="line">    if (screen.BlocksDraw)</span><br><span class="line">        break;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for (int i = screensToDraw.Count - 1; i &lt;= 0; i--)</span><br><span class="line">&#123;</span><br><span class="line">    screensToDraw[i].Draw( gameTime );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 如何进行状态切换呢</p>
<p> We saw above how pause would work: PlayScreen watches for the pause key, and pushes on a new PauseScreen. PauseScreen watches for pause button, and pops itself off. GameScreenManager’s constructor takes a GameScreen for the startup screen</p>
<p> 注意这里的PlayScreen. 作者将游戏逻辑放在该GameScreen中. 也就是说游戏的GameScreen和各种菜单的GameScreen地位是等同的. XNA官方的样例RolePlayingGameStarterKit, 也是这样做的. 而在ZombieSmash中, 是将游戏状态先分为Playing和Menu, Menu下面再进一步细分</p>
 <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> GameModes : <span class="keyword">int</span></span><br><span class="line">&#123;</span><br><span class="line">    Menu = <span class="number">0</span>,</span><br><span class="line">    Playing = <span class="number">1</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> MenuMode : <span class="keyword">int</span></span><br><span class="line">&#123;</span><br><span class="line">    Main = <span class="number">0</span>,</span><br><span class="line">    Pause = <span class="number">1</span>,</span><br><span class="line">    Dead = <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> This is called when the game should draw itself.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="gameTime"&gt;</span>Provides a snapshot of timing values.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Draw</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    graphics.GraphicsDevice.Clear(Color.Black);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (gameMode)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> GameModes.Playing:</span><br><span class="line">            DrawGame();</span><br><span class="line">            hud.Draw();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GameModes.Menu:</span><br><span class="line">            <span class="keyword">if</span> (menu.menuMode == Menu.MenuMode.Pause ||</span><br><span class="line">                menu.menuMode == Menu.MenuMode.Dead)</span><br><span class="line">                DrawGame();</span><br><span class="line">            menu.Draw();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">base</span>.Draw(gameTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 当处于GameModes.Menu模式时, 显示主菜单时不显示游戏画面, 如果是暂停和死亡, 仍然会显示游戏画面.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/22/MonoGame笔记(X3)SpriteBatch Test/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/22/MonoGame笔记(X3)SpriteBatch Test/" itemprop="url">MonoGame笔记(X3)SpriteBatch Test</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-22T08:38:37+08:00">
                2017-12-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="SpriteBatch-Begin的Matrix参数"><a href="#SpriteBatch-Begin的Matrix参数" class="headerlink" title="SpriteBatch.Begin的Matrix参数"></a>SpriteBatch.Begin的Matrix参数</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spriteBatch.Begin(SpriteBlendMode.AlphaBlend, SpriteSortMode.FrontToBack,SaveStateMode.None,        Matrix.CreateTranslation(<span class="keyword">new</span> Vector3(<span class="number">10</span>, <span class="number">10</span>, <span class="number">0</span>)));</span><br><span class="line"></span><br><span class="line">spriteBatch.Draw(pic1, <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">0</span>),  <span class="literal">null</span>, Color.White, <span class="number">0.0f</span>, Vector2.Zero, <span class="number">1.0f</span>, SpriteEffects.None, <span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">spriteBatch.End();</span><br></pre></td></tr></table></figure>
<p>原本是将图片绘制在左上角的，但由于Matrix.CreateTranslation(new Vector3(10, 10, 0)，结果如下<br><img src="/img/monogame-spritebatch-test1.jpeg" alt=""></p>
<h4 id="SpriteBatch-Draw的origin参数"><a href="#SpriteBatch-Draw的origin参数" class="headerlink" title="SpriteBatch.Draw的origin参数"></a>SpriteBatch.Draw的origin参数</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spriteBatch.Draw(pic1, <span class="keyword">new</span> Vector2(GraphicsDevice.Viewport.Width / <span class="number">2</span>, GraphicsDevice.Viewport.Height / <span class="number">2</span>), <span class="literal">null</span>, Color.White, <span class="number">0.0f</span>, Vector2.Zero, <span class="number">1.0f</span>, SpriteEffects.None, <span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">spriteBatch.Draw(pic1, <span class="keyword">new</span> Vector2(GraphicsDevice.Viewport.Width / <span class="number">2</span>, GraphicsDevice.Viewport.Height / <span class="number">2</span>), <span class="literal">null</span>, Color.White, <span class="number">0.0f</span>, <span class="keyword">new</span> Vector2(<span class="number">100</span>, <span class="number">100</span>), <span class="number">1.0f</span>, SpriteEffects.None, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>两者的区别在于origin参数不同，一个是Vector2(0,0)，一个是Vector2(100,100)，结果如下<br><img src="/img/monogame-spritebatch-test2.jpeg" alt=""></p>
<p>从图中看出origin为(100,100)，其实是从屏幕中心向左上偏移(100,100)。所以也可以通过改变origin移动图片。在卷轴类地图中用到这种技术。下面在此基础上又添加了scale值，而且可以通过方向键改变origin</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> scale1 = <span class="number">0.5f</span>; </span><br><span class="line"><span class="keyword">float</span> scale2 = <span class="number">1.0f</span>; </span><br><span class="line">origin1 = Vector2.Zero; </span><br><span class="line">origin2 = Vector2.Zero; </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>) </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="comment">// Allows the game to exit </span></span><br><span class="line">    <span class="keyword">if</span> (GamePad.GetState(PlayerIndex.One).Buttons.Back == ButtonState.Pressed) </span><br><span class="line">        <span class="keyword">this</span>.Exit(); </span><br><span class="line">    <span class="keyword">if</span> (Keyboard.GetState().IsKeyDown(Keys.Left)) </span><br><span class="line">    &#123; </span><br><span class="line">        origin1 += <span class="keyword">new</span> Vector2(<span class="number">5</span>, <span class="number">0</span>) / scale1; </span><br><span class="line">        origin2 += <span class="keyword">new</span> Vector2(<span class="number">5</span>, <span class="number">0</span>) / scale2; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span> (Keyboard.GetState().IsKeyDown(Keys.Right)) </span><br><span class="line">    &#123; </span><br><span class="line">        origin1 -= <span class="keyword">new</span> Vector2(<span class="number">5</span>, <span class="number">0</span>) / scale1; </span><br><span class="line">        origin2 -= <span class="keyword">new</span> Vector2(<span class="number">5</span>, <span class="number">0</span>) / scale2; </span><br><span class="line"> </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span> (Keyboard.GetState().IsKeyDown(Keys.Up)) </span><br><span class="line">    &#123; </span><br><span class="line">        origin1 += <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">5</span>) / scale1; </span><br><span class="line">        origin2 += <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">5</span>) / scale2; </span><br><span class="line"> </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span> (Keyboard.GetState().IsKeyDown(Keys.Down)) </span><br><span class="line">    &#123; </span><br><span class="line">        origin1 -= <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">5</span>) / scale1; </span><br><span class="line">        origin2 -= <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">5</span>) / scale2; </span><br><span class="line"> </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Add your update logic here </span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">base</span>.Update(gameTime); </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Draw</span>(<span class="params">GameTime gameTime</span>) </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    GraphicsDevice.Clear(Color.CornflowerBlue); </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Add your drawing code here </span></span><br><span class="line">    spriteBatch.Begin(SpriteBlendMode.AlphaBlend, SpriteSortMode.FrontToBack, SaveStateMode.None); </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    spriteBatch.Draw(pic1, <span class="keyword">new</span> Vector2(GraphicsDevice.Viewport.Width / <span class="number">2</span>, GraphicsDevice.Viewport.Height / <span class="number">2</span> - <span class="number">50</span>),  </span><br><span class="line">        <span class="literal">null</span>, Color.White, <span class="number">0.0f</span>, origin1, scale1, SpriteEffects.None, <span class="number">0</span>); </span><br><span class="line"> </span><br><span class="line">    spriteBatch.Draw(pic1, <span class="keyword">new</span> Vector2(GraphicsDevice.Viewport.Width / <span class="number">2</span>, GraphicsDevice.Viewport.Height / <span class="number">2</span>), </span><br><span class="line">        <span class="literal">null</span>, Color.White, <span class="number">0.0f</span>, origin2, scale2, SpriteEffects.None, <span class="number">0</span>); </span><br><span class="line"> </span><br><span class="line">    spriteBatch.End(); </span><br><span class="line">    <span class="keyword">base</span>.Draw(gameTime); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意在Update方法中，origin1和origin2增量不同，这是因为scale除了会影响图片的尺寸，也会使origin按比例改变。<br>比如origin1 += new Vector2(100,100)， origin2 += new Vector2(100,100)，由于scale1为0.5，其实origin2改变的距离只有(50,50)，通过除以各自的比例，可以让两者移动的距离相同<br><img src="/img/monogame-spritebatch-test3.jpeg" alt=""></p>
<h4 id="SpriteBatch-Draw的layerDepth"><a href="#SpriteBatch-Draw的layerDepth" class="headerlink" title="SpriteBatch.Draw的layerDepth"></a>SpriteBatch.Draw的layerDepth</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spriteBatch.Begin(SpriteBlendMode.AlphaBlend, SpriteSortMode.FrontToBack, SaveStateMode.None);</span><br><span class="line"></span><br><span class="line">spriteBatch.Draw(pic1, <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">0</span>), <span class="literal">null</span>, Color.White, <span class="number">0.0f</span>, Vector2.Zero, <span class="number">1.0f</span>, SpriteEffects.None, <span class="number">0.5f</span>); </span><br><span class="line"></span><br><span class="line">spriteBatch.Draw(pic2, <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">0</span>), <span class="literal">null</span>, Color.White, <span class="number">0.0f</span>, Vector2.Zero, <span class="number">0.25f</span>, SpriteEffects.None, <span class="number">1.0f</span>); </span><br><span class="line"></span><br><span class="line">spriteBatch.End();</span><br></pre></td></tr></table></figure>
<p>SpriteSortMode为FrontToBack的情况下，是pic1先画，pic2后画，因为pic2图片尺寸大于pic1，所以pic2会完全覆盖pic1.结果如下<img src="/img/monogame-spritebatch-test4.jpeg" alt=""></p>
<p>如果改成<br>spriteBatch.Draw(pic1, new Vector2(0, 0),   null, Color.White, 0.0f, Vector2.Zero, 1.0f, SpriteEffects.None, 1.0f); 则变成<br><img src="/img/monogame-spritebatch-test4.jpeg" alt=""><br>虽然pic1和pic2的layerDepth是相等的，但从结果上来看是pic2先画，pic1后画。即使把SpriteSortMode改为BackToFront，结果不变。所以当两者的层深相等时，可以想象成后进先出的情况</p>
<h4 id="SpriteBatch-Winform实现"><a href="#SpriteBatch-Winform实现" class="headerlink" title="SpriteBatch Winform实现"></a>SpriteBatch Winform实现</h4><p>将texture的一部分(sRect)，以origin为中心缩放和旋转（或翻转flip)，然会绘制在画布的location位置。这里的重点是matrix的复合变换</p>
<p>SpriteBatch的Draw有一个color参数<br>ColorMatrix用于color tint</p>
<p>先绘制在temp上，对temp进行了color tint</p>
<p>xna中旋转是弧度，而gdi+中旋转是角度。</p>
<p>这里要注意的是以origin为中心，这里我将origin设置为sRect的中心，得到下面的points</p>
<p>这一步可以分成2步：<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1</span></span><br><span class="line">Point[] points = <span class="keyword">new</span> Point[] &#123;    </span><br><span class="line">    <span class="keyword">new</span> Point(<span class="number">0</span>, <span class="number">0</span>), </span><br><span class="line">    <span class="keyword">new</span> Point(temp.Width, <span class="number">0</span>),</span><br><span class="line">    <span class="keyword">new</span> Point(<span class="number">0</span>, temp.Height)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2  </span></span><br><span class="line">matrix.Translate（-temp.with/<span class="number">2</span>, -temp.height/<span class="number">2</span>);<span class="comment">//移回原点（0,0）</span></span><br><span class="line"></span><br><span class="line">变成：</span><br><span class="line">Point[] points = <span class="keyword">new</span> Point[] &#123;</span><br><span class="line">    <span class="keyword">new</span> Point(-temp.Width/<span class="number">2</span>, -temp.Height/<span class="number">2</span>), <span class="keyword">new</span> Point(temp.Width/<span class="number">2</span>, -temp.Height/<span class="number">2</span>),</span><br><span class="line">    <span class="keyword">new</span> Point(-temp.Width/<span class="number">2</span>, temp.Height/<span class="number">2</span>)</span><br><span class="line">&#125;;  <span class="comment">//这三个点构成一个以原点（0,0）为中心的矩形</span></span><br></pre></td></tr></table></figure>
<p>以origin为中心缩放和旋转，变成以原点为缩放和旋转，然后translate，再将变换应用到points上.</p>
<p><strong>旋转缩放最好以原点（0,0）来进行</strong><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawWithTransformation</span>(<span class="params">Bitmap texture, Vector2 location, Rectangle sRect,<span class="comment">/* Color color,*/</span> <span class="keyword">float</span> rotation, Vector2 origin, Vector2 scale, <span class="keyword">bool</span> flip, Graphics g</span>)</span></span><br><span class="line"><span class="function"></span>     &#123;</span><br><span class="line">         <span class="comment">//着色</span></span><br><span class="line">         Bitmap temp = <span class="keyword">new</span> Bitmap(sRect.Width, sRect.Height);</span><br><span class="line">         Graphics tempGraphics = Graphics.FromImage(temp);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">         <span class="comment">/*float[][] colorMatrixElements = &#123;</span></span><br><span class="line"><span class="comment">new float[] &#123;2,  0,  0,  0, 0&#125;,        // red scaling factor of 2</span></span><br><span class="line"><span class="comment">new float[] &#123;0,  1,  0,  0, 0&#125;,        // green scaling factor of 1</span></span><br><span class="line"><span class="comment">new float[] &#123;0,  0,  1,  0, 0&#125;,        // blue scaling factor of 1</span></span><br><span class="line"><span class="comment">new float[] &#123;0,  0,  0,  1, 0&#125;,        // alpha scaling factor of 1</span></span><br><span class="line"><span class="comment">new float[] &#123;.2f, .2f, .2f, 0, 1&#125;&#125;;    // three translations of 0.2*/</span></span><br><span class="line"> </span><br><span class="line">         <span class="keyword">float</span>[][] colorMatrixElements =</span><br><span class="line">         &#123;</span><br><span class="line">                 <span class="keyword">new</span> <span class="keyword">float</span>[] &#123;<span class="number">1</span>,  <span class="number">0</span>,  <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>&#125;,        <span class="comment">// red scaling factor of 2</span></span><br><span class="line">                 <span class="keyword">new</span> <span class="keyword">float</span>[] &#123;<span class="number">0</span>,  <span class="number">1</span>,  <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>&#125;,        <span class="comment">// green scaling factor of 1</span></span><br><span class="line">                 <span class="keyword">new</span> <span class="keyword">float</span>[] &#123;<span class="number">0</span>,  <span class="number">0</span>,  <span class="number">1</span>,  <span class="number">0</span>, <span class="number">0</span>&#125;,        <span class="comment">// blue scaling factor of 1</span></span><br><span class="line">                 <span class="keyword">new</span> <span class="keyword">float</span>[] &#123;<span class="number">0</span>,  <span class="number">0</span>,  <span class="number">0</span>,  <span class="number">1</span>, <span class="number">0</span>&#125;,        <span class="comment">// alpha scaling factor of 1</span></span><br><span class="line">                 <span class="keyword">new</span> <span class="keyword">float</span>[] &#123;<span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0</span>, <span class="number">1</span>&#125;&#125;;    <span class="comment">// three translations of 0.2*/</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">         <span class="comment">//float[][] cm = &#123;1.0f, 0.0f, 0.0f, 0.0f, 0.0f&#125;,</span></span><br><span class="line">         <span class="comment">//    cm[1]new float[]&#123;0.0f, 1.0f, 0.0f, 0.0f, 0.0f&#125;,</span></span><br><span class="line">         <span class="comment">//    cm[2]new float[]&#123;-0.0f, 0.0f, 1.0f, 0.0f, 0.0f&#125;,</span></span><br><span class="line">         <span class="comment">//    cm[3]new float[]&#123;0.0f, 0.0f, 0.0f, 1.0f, 0.0f&#125;,</span></span><br><span class="line">         <span class="comment">//    cm[4]new float[]&#123;0.75f, 0.0f, 0.0f, 0.0f, 1.0f&#125;&#125;;</span></span><br><span class="line"> </span><br><span class="line">         ColorMatrix colorMatrix = <span class="keyword">new</span> ColorMatrix(colorMatrixElements);</span><br><span class="line">         ImageAttributes imageAttributes = <span class="keyword">new</span> ImageAttributes();</span><br><span class="line">         imageAttributes.SetColorMatrix(</span><br><span class="line">                             colorMatrix,</span><br><span class="line">                             ColorMatrixFlag.Default,</span><br><span class="line">                             ColorAdjustType.Bitmap);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">         Rectangle tempRec = <span class="keyword">new</span> Rectangle(<span class="number">0</span>, <span class="number">0</span>, temp.Width, temp.Height);</span><br><span class="line">         tempGraphics.DrawImage(texture, tempRec, sRect.X, sRect.Y, sRect.Width, sRect.Height,</span><br><span class="line">             GraphicsUnit.Pixel, imageAttributes);</span><br><span class="line"> </span><br><span class="line">         Matrix matrix = <span class="keyword">new</span> Matrix();</span><br><span class="line">         matrix.Rotate(rotation * <span class="number">180</span> / <span class="number">3.1415926f</span>);</span><br><span class="line">         <span class="comment">//matrix.RotateAt(rotation*180/3.1415926f, new PointF((float)sRect.Width / 2f, 32f));</span></span><br><span class="line">         matrix.Scale((<span class="keyword">float</span>)scale.X, (<span class="keyword">float</span>)scale.Y, MatrixOrder.Append);</span><br><span class="line">         matrix.Translate((<span class="keyword">float</span>)location.X, (<span class="keyword">float</span>)location.Y, MatrixOrder.Append);</span><br><span class="line"> </span><br><span class="line">         <span class="keyword">if</span> (!flip) matrix.Scale(<span class="number">-1</span>, <span class="number">1</span>);</span><br><span class="line">         <span class="comment">//Point[] points = new Point[]&#123;new Point(0, 0), new Point(temp.Width, 0),</span></span><br><span class="line">             <span class="comment">//                                new Point(0, temp.Height)&#125;;</span></span><br><span class="line"> </span><br><span class="line">         Point[] points = <span class="keyword">new</span> Point[]</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="keyword">new</span> Point(-temp.Width/<span class="number">2</span>, -temp.Height/<span class="number">2</span>), <span class="keyword">new</span> Point(temp.Width/<span class="number">2</span>, -temp.Height/<span class="number">2</span>),</span><br><span class="line">             <span class="keyword">new</span> Point(-temp.Width/<span class="number">2</span>, temp.Height/<span class="number">2</span>)</span><br><span class="line">         &#125;;  </span><br><span class="line"> </span><br><span class="line">         matrix.TransformPoints(points);</span><br><span class="line">         g.DrawImage(temp, points, tempRec, GraphicsUnit.Pixel);<span class="comment">//图像的旋转和拉伸通常是通过在DrawImage中指定destPoints参数来实现，destPoints包含对新的坐标系定义的点的数据</span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/22/MonoGame笔记(X2)SpriteFont/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/22/MonoGame笔记(X2)SpriteFont/" itemprop="url">MonoGame笔记(X2)SpriteFont</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-22T07:57:37+08:00">
                2017-12-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>SpriteFont的使用如下(<a href="https://msdn.microsoft.com/en-us/library/bb447673.aspx)" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/bb447673.aspx)</a>:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">SpriteFont Font1;</span><br><span class="line">Vector2 FontPos;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">LoadContent</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Create a new SpriteBatch, which can be used to draw textures.</span></span><br><span class="line">    spriteBatch = <span class="keyword">new</span> SpriteBatch(GraphicsDevice);</span><br><span class="line">    Font1 = Content.Load&lt;SpriteFont&gt;(<span class="string">"Arial"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Load your game content here            </span></span><br><span class="line">    FontPos = <span class="keyword">new</span> Vector2(graphics.GraphicsDevice.Viewport.Width / <span class="number">2</span>,</span><br><span class="line">        graphics.GraphicsDevice.Viewport.Height / <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Draw</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GraphicsDevice.Clear(Color.CornflowerBlue);</span><br><span class="line"></span><br><span class="line">    spriteBatch.Begin();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw Hello World</span></span><br><span class="line">    <span class="keyword">string</span> output = <span class="string">"Hello World"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the center of the string</span></span><br><span class="line">    Vector2 FontOrigin = Font1.MeasureString(output) / <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// Draw the string</span></span><br><span class="line">    spriteBatch.DrawString(Font1, output, FontPos, Color.LightGreen,</span><br><span class="line">        <span class="number">0</span>, FontOrigin, <span class="number">1.0f</span>, SpriteEffects.None, <span class="number">0.5f</span>);</span><br><span class="line"></span><br><span class="line">    spriteBatch.End();</span><br><span class="line">    <span class="keyword">base</span>.Draw(gameTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Arial.spritefont这个资源文件就是用来描述被加载的Arial字体的各种属性<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">This file contains an xml description of a font, and will be read by the XNA</span></span><br><span class="line"><span class="comment">Framework Content Pipeline. Follow the comments to customize the appearance</span></span><br><span class="line"><span class="comment">of the font in your game, and to change the characters which are available to draw</span></span><br><span class="line"><span class="comment">with.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">XnaContent</span> <span class="attr">xmlns:Graphics</span>=<span class="string">"Microsoft.Xna.Framework.Content.Pipeline.Graphics"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Asset</span> <span class="attr">Type</span>=<span class="string">"Graphics:FontDescription"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    Modify this string to change the font that will be imported. Redistributable sample</span></span><br><span class="line"><span class="comment">    fonts are available at http://go.microsoft.com/fwlink/?LinkId=104778&amp;clcid=0x409.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">FontName</span>&gt;</span>Arial<span class="tag">&lt;/<span class="name">FontName</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    Size is a float value, measured in points. Modify this value to change</span></span><br><span class="line"><span class="comment">    the size of the font.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Size</span>&gt;</span>14<span class="tag">&lt;/<span class="name">Size</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    Spacing is a float value, measured in pixels. Modify this value to change</span></span><br><span class="line"><span class="comment">    the amount of spacing in between characters.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Spacing</span>&gt;</span>0<span class="tag">&lt;/<span class="name">Spacing</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    UseKerning controls the layout of the font. If this value is true, kerning information</span></span><br><span class="line"><span class="comment">    will be used when placing characters.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">UseKerning</span>&gt;</span>true<span class="tag">&lt;/<span class="name">UseKerning</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    Style controls the style of the font. Valid entries are "Regular", "Bold", "Italic",</span></span><br><span class="line"><span class="comment">    and "Bold, Italic", and are case sensitive.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Style</span>&gt;</span><span class="undefined">Bold</span><span class="tag">&lt;/<span class="name">Style</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    CharacterRegions control what letters are available in the font. Every</span></span><br><span class="line"><span class="comment">    character from Start to End will be built and made available for drawing. The</span></span><br><span class="line"><span class="comment">    default range is from 32, (ASCII space), to 126, ('~'), covering the basic Latin</span></span><br><span class="line"><span class="comment">    character set. The characters are ordered according to the Unicode standard.</span></span><br><span class="line"><span class="comment">    See the documentation for more information.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">CharacterRegions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">CharacterRegion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Start</span>&gt;</span>&amp;#32;<span class="tag">&lt;/<span class="name">Start</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">End</span>&gt;</span>&amp;#126;<span class="tag">&lt;/<span class="name">End</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">CharacterRegion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">CharacterRegions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Asset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">XnaContent</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>为什么叫SpriteFont呢? 因为Font是以Sprite的方式被绘制的.<strong>MonoGame笔记(二)SpriteBatch</strong>中提到了DrawString方法的实现<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DrawString</span>(<span class="params">SpriteFont spriteFont, <span class="keyword">string</span> text, Vector2 position, Color color</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (spriteFont == <span class="literal">null</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"spriteFont"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Vector2 p = position;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">char</span> c <span class="keyword">in</span> text)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">'\n'</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            p.Y += spriteFont.LineSpacing;</span><br><span class="line">            p.X = position.X;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (spriteFont.characterData.ContainsKey(c) == <span class="literal">false</span>) </span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        GlyphData g = spriteFont.characterData[c];</span><br><span class="line">        </span><br><span class="line">        SpriteBatchItem item = _batcher.CreateBatchItem();</span><br><span class="line">        </span><br><span class="line">        item.Depth = <span class="number">0.0f</span>;</span><br><span class="line">        item.TextureID = (<span class="keyword">int</span>) spriteFont._texture.ID;</span><br><span class="line"></span><br><span class="line">        Vector2 texCoordTL = spriteFont._texture.Image.GetTextureCoord ( g.Glyph.X, g.Glyph.Y );</span><br><span class="line">        Vector2 texCoordBR = spriteFont._texture.Image.GetTextureCoord ( g.Glyph.X+g.Glyph.Width, g.Glyph.Y+g.Glyph.Height );</span><br><span class="line"></span><br><span class="line">        item.Set</span><br><span class="line">            (</span><br><span class="line">                p.X,</span><br><span class="line">                p.Y+g.Cropping.Y,</span><br><span class="line">                g.Glyph.Width,</span><br><span class="line">                g.Glyph.Height,</span><br><span class="line">                color,</span><br><span class="line">                texCoordTL,</span><br><span class="line">                texCoordBR</span><br><span class="line">                );</span><br><span class="line">                </span><br><span class="line">        p.X += (g.Kerning.Y + g.Kerning.Z + spriteFont.Spacing);</span><br><span class="line">    &#125;			</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也可以使用中文字体<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">XnaContent</span> <span class="attr">xmlns:Graphics</span>=<span class="string">"Microsoft.Xna.Framework.Content.Pipeline.Graphics"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Asset</span> <span class="attr">Type</span>=<span class="string">"Graphics:FontDescription"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">FontName</span>&gt;</span>华文行楷<span class="tag">&lt;/<span class="name">FontName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Size</span>&gt;</span>30<span class="tag">&lt;/<span class="name">Size</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Spacing</span>&gt;</span>0<span class="tag">&lt;/<span class="name">Spacing</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">UseKerning</span>&gt;</span>true<span class="tag">&lt;/<span class="name">UseKerning</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Style</span>&gt;</span><span class="undefined">Regular</span><span class="tag">&lt;/<span class="name">Style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">CharacterRegions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">CharacterRegion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Start</span>&gt;</span>&amp;#19968;<span class="tag">&lt;/<span class="name">Start</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">End</span>&gt;</span>&amp;#40869;<span class="tag">&lt;/<span class="name">End</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">CharacterRegion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">CharacterRegions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Asset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">XnaContent</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>不过上述方式包含的汉字太多(2万多个), 一般只需要包含游戏中用到的汉字即可, 具体做法, 参考<a href="http://blog.csdn.net/jianxin160/article/details/6313518" target="_blank" rel="noopener">http://blog.csdn.net/jianxin160/article/details/6313518</a></p>
<p>但这些系统自带的字体中规中矩, 游戏中很多效果往往要用到图片字<br><img src="/img/monogame-bitmapfont.png" alt=""><br>这张图片必须包含一个alpha通道, 洋红色的地方不透明, 字体黑色背景透明.</p>
<p>添加该资源文件是的属性面板设置, 使用FontTextureProcessor<br><img src="/img/monogame-bitmapfont2.png" alt=""></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">public class FontTextureProcessor : ContentProcessor&lt;Texture2DContent, SpriteFontContent&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Glyph&gt; <span class="title">ExtractGlyphs</span>(<span class="params">PixelBitmapContent&lt;Color&gt; bitmap</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> glyphs = <span class="keyword">new</span> List&lt;Glyph&gt;(); </span><br><span class="line">        <span class="keyword">var</span> regions = <span class="keyword">new</span> List&lt;Rectangle&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; bitmap.Height; y++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; bitmap.Width; x++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (bitmap.GetPixel(x, y) != transparentPixel)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// if we don't have a region that has this pixel already</span></span><br><span class="line">                    <span class="keyword">var</span> re = regions.Find(r =&gt; &#123;</span><br><span class="line">                        <span class="keyword">return</span> r.Contains(x, y); </span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="keyword">if</span> (re == Rectangle.Empty)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// we have found the top, left of a image. </span></span><br><span class="line">                        <span class="comment">// we now need to scan for the 'bounds'</span></span><br><span class="line">                        <span class="keyword">int</span> top = y;</span><br><span class="line">                        <span class="keyword">int</span> bottom = y;</span><br><span class="line">                        <span class="keyword">int</span> left = x;</span><br><span class="line">                        <span class="keyword">int</span> right = x;</span><br><span class="line">                        <span class="keyword">while</span> (bitmap.GetPixel(right, bottom) != transparentPixel)</span><br><span class="line">                            right++;</span><br><span class="line">                        <span class="keyword">while</span> (bitmap.GetPixel(left, bottom) != transparentPixel)</span><br><span class="line">                            bottom++;</span><br><span class="line">                        <span class="comment">// we got a glyph :)</span></span><br><span class="line">                        regions.Add(<span class="keyword">new</span> Rectangle(left, top, right - left, bottom - top));</span><br><span class="line">                        x = right;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        x += re.Width;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; regions.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> rect = regions[i];</span><br><span class="line">            <span class="keyword">var</span> newBitmap = <span class="keyword">new</span> PixelBitmapContent&lt;Color&gt;(rect.Width, rect.Height);</span><br><span class="line">            BitmapContent.Copy(bitmap, rect, newBitmap, <span class="keyword">new</span> Rectangle(<span class="number">0</span>, <span class="number">0</span>, rect.Width, rect.Height));</span><br><span class="line">            <span class="keyword">var</span> glyph = <span class="keyword">new</span> Glyph(GetCharacterForIndex (i), newBitmap);</span><br><span class="line">            glyph.CharacterWidths.B = glyph.Bitmap.Width;</span><br><span class="line">            glyphs.Add(glyph);</span><br><span class="line">            <span class="comment">//newbitmap.Save (GetCharacterForIndex(i)+".png", System.Drawing.Imaging.ImageFormat.Png);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> glyphs ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ExtractGlyphs被Process调用, 返回一个SpriteFontContent. 如此, 仍就可以使用上面的SpriteFont类, Content Pipeline消除了*.spritefont和bitmapfont之间的差异.</p>
<p>详细可以参考<a href="https://blogs.msdn.microsoft.com/shawnhar/2007/04/26/bitmap-fonts-in-xna/" target="_blank" rel="noopener">https://blogs.msdn.microsoft.com/shawnhar/2007/04/26/bitmap-fonts-in-xna/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/21/MonoGame笔记(X1)Camera2D/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/21/MonoGame笔记(X1)Camera2D/" itemprop="url">MonoGame笔记(X1)Camera2D</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-21T10:25:37+08:00">
                2017-12-21
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>以前学习时一些零散的笔记, 新开一个系列.</p>
<p>不管是side-scrolling(横版卷轴)，还是tilemap，有一点是非常关键的，就是不同坐标系之间的变换。在三维中有一个视口变换。二维没有那么复杂，但原理差不多。Hero和地图上的tile(贴片)，它们的位置是地图坐标，地图就是它们所在的世界，所以也可以说是世界坐标。在游戏逻辑中，Hero位置的改变，碰撞检测都是以地图坐标（世界坐标）进行的. 而在窗口屏幕中绘制Sprite和tile时，是以屏幕坐标为参照系的。因此在Draw方法中，必须将Hero和tile的地图坐标变换成屏幕坐标，从而在屏幕的适当位置显示出来。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="comment">// Allows the game to exit  </span></span><br><span class="line">    <span class="keyword">if</span> (GamePad.GetState(PlayerIndex.One).Buttons.Back == ButtonState.Pressed)  </span><br><span class="line">        <span class="keyword">this</span>.Exit();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">float</span> elapsedTime = (<span class="keyword">float</span>)gameTime.ElapsedGameTime.TotalSeconds;</span><br><span class="line">    <span class="keyword">float</span> moveRate = <span class="number">20f</span>;</span><br><span class="line">    <span class="keyword">if</span> (hero!= <span class="literal">null</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        scroll += ((hero.Position - <span class="keyword">new</span> Vector2(screenSize.X / <span class="number">2f</span>, screenSize.Y / <span class="number">2f</span>)) - scroll) * elapsedTime * moveRate;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">float</span> xLim = map.GetXLim();  </span><br><span class="line">        <span class="keyword">float</span> yLim = map.GetYLim();  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (scroll.X &lt; <span class="number">0f</span>) scroll.X = <span class="number">0f</span>;  </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (scroll.X &gt; xLim) scroll.X = xLim;  </span><br><span class="line">        <span class="keyword">if</span> (scroll.Y &lt; <span class="number">0f</span>) scroll.Y = <span class="number">0f</span>;  </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (scroll.Y &gt; yLim) scroll.Y = yLim;  </span><br><span class="line">  </span><br><span class="line">        hero.DoInput();  </span><br><span class="line">        hero.Update(gameTime);  </span><br><span class="line">    &#125;   </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">base</span>.Update(gameTime);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>scroll表示游戏窗口与世界地图的相对位置, hero.Position表示hero的地图坐标, 如下图所示:<br><img src="/img/monogame-camera2d-1.png" alt=""></p>
<p>上面这段代码想要解决的一个设计场景是这样的: 以横版卷轴为例, 一开始屏幕位于地图最左侧, 此时Hero从屏幕左侧出生, 随后Hero往右移动. 当Hero未达到屏幕中间时, 屏幕是不会移动的. 当Hero达到屏幕中间, 此后屏幕和Hero一起往右移动, Hero始终占据屏幕的中心位置. 当屏幕达到地图最右侧时, 屏幕不再和Hero一起往右移动, Hero可以单独继续往右移动, 直到达到屏幕最右侧.</p>
<p>上面代码的关键是<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scroll += ((hero.Position - <span class="keyword">new</span> Vector2(screenSize.X / <span class="number">2f</span>, screenSize.Y / <span class="number">2f</span>)) - scroll)</span><br></pre></td></tr></table></figure></p>
<p>当未达到屏幕中间时, scroll会是一个负值, 如果是负值就会被重置为0, 屏幕停留在地图最左侧. 同理, 超出地图右侧.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (scroll.X &lt; <span class="number">0f</span>) scroll.X = <span class="number">0f</span>;</span><br></pre></td></tr></table></figure></p>
<p>那为什么要减去scroll呢？因为new Vector2(screenSize.X / 2f, screenSize.Y / 2f)是一个固定值，而hero.Position是一个不断变大的过程(往右移动), 假设前一帧移动后，hero.Position.x - screenSize.X = 10;这一帧移动后，hero.Position.x - screenSize.X = 20, 改变的是绝对值. 为了让不同性能的机子都能够流畅运行, scroll.x是以增量的形式增加的（scroll += ***）, 即相对值. 因此需要减去原来的scroll得到一个增量，再将这个增量加回到scroll上.</p>
<p>这部分代码可以抽象出一个<strong>Camera2D</strong>类. scroll就是Camera2D的地图坐标, 屏幕大小就是Camera2D的ViewPort</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Camera2D</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Vector2 position;<span class="comment">//世界坐标</span></span><br><span class="line">    <span class="keyword">public</span> Viewport viewPort;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Camera2D</span>(<span class="params">Vector2 position</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.position = position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Camera2D</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.position = Vector2.Zero;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Camera2D</span>(<span class="params">Viewport viewPort</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.viewPort = viewPort;</span><br><span class="line">        <span class="keyword">this</span>.position = Vector2.Zero;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Matrix TransformMatrix</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Matrix.CreateTranslation(<span class="keyword">new</span> Vector3(-position, <span class="number">0f</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 一般情况下, 使得Hero位于屏幕中间</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LockCameraToPlayer</span>(<span class="params">PlayerPosition playerPostion, Hero hero</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Hero本身使用的sprite图片也有大小, 加上Center.X;</span></span><br><span class="line">        position.X = playerPostion.Position.X + hero.Center.X</span><br><span class="line">                        - (viewPort.Width / <span class="number">2</span>);</span><br><span class="line">        position.Y = playerPostion.Position.Y + hero.Center.Y</span><br><span class="line">                        - (viewPort.Height / <span class="number">2</span>); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LockCameraToBound</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">/*position就是Camera的左上角位置，用viewport的坐标应该也能代替*/</span></span><br><span class="line">        position.X = MathHelper.Clamp(</span><br><span class="line">            position.X,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            TileEngine.tilemap.WidthInPixels - viewPort.Width);</span><br><span class="line">        position.Y = MathHelper.Clamp(</span><br><span class="line">            position.Y,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            TileEngine.tilemap.HeightInPixels - viewPort.Height);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/monogame-camera2d-2.png" alt=""><br>红色是视口，黑色是世界地图; 绿点是相机的Position（世界坐标）; 蓝点是物体的Position（世界坐标）</p>
<p>官方有一个Camera2D的样例(<a href="http://xbox.create.msdn.com/en-US/education/catalog/sample/tiled_sprites)" target="_blank" rel="noopener">http://xbox.create.msdn.com/en-US/education/catalog/sample/tiled_sprites)</a>, 支持rotation和zoom, 结构和上面介绍的有所不同</p>
<p>Although a game level might have tens of thousands of tiles in the game world, only those that are visible should be drawn. Otherwise, you see a severe performance hit for submitting more draw calls than are needed to render the scene. </p>
<p>To simplify interactions with the tiles in the game world, the sample provides a 2D Camera implementation. You will find a camera abstraction useful, particularly when <strong>rotating</strong> or <strong>zooming</strong> the world. This enables you to rapidly translate screen space to world space. </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">TiledSprites</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Camera2D</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> Fields</span></span><br><span class="line">        <span class="keyword">private</span> Vector2 positionValue;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> isMovingUsingScreenAxis;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> rotationValue;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> zoomValue;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> cameraChanged;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> Public Properties</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Get/Set the postion value of the camera</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> Vector2 Position</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (positionValue != <span class="keyword">value</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cameraChanged = <span class="literal">true</span>;</span><br><span class="line">                    positionValue = <span class="keyword">value</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> positionValue; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Get/Set the rotation value of the camera</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> Rotation</span><br><span class="line">        &#123;   </span><br><span class="line">            <span class="comment">//...同上</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Get/Set the zoom value of the camera</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> Zoom</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//...同上</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Gets whether or not the camera has been changed since the last</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> ResetChanged call</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> IsChanged</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> cameraChanged; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Set to TRUE to pan relative to the screen axis when</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> the camera is rotated.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> MoveUsingScreenAxis</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">set</span> &#123; isMovingUsingScreenAxis = <span class="keyword">value</span>; &#125;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> isMovingUsingScreenAxis; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> Constructor</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Create a new Camera2D</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Camera2D</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            zoomValue = <span class="number">1.0f</span>;</span><br><span class="line">            rotationValue = <span class="number">0.0f</span>;</span><br><span class="line">            positionValue = Vector2.Zero;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> Movement Methods</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Used to inform the camera that new values are updated by the application.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ResetChanged</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            cameraChanged = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Pan in the right direction.  Corrects for rotation if specified.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MoveRight</span>(<span class="params"><span class="keyword">ref</span> <span class="keyword">float</span> dist</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dist != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cameraChanged = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (isMovingUsingScreenAxis)</span><br><span class="line">                &#123;</span><br><span class="line">                    positionValue.X += (<span class="keyword">float</span>)Math.Cos(-rotationValue) * dist;</span><br><span class="line">                    positionValue.Y += (<span class="keyword">float</span>)Math.Sin(-rotationValue) * dist;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    positionValue.X += dist;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Pan in the left direction.  Corrects for rotation if specified.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MoveLeft</span>(<span class="params"><span class="keyword">ref</span> <span class="keyword">float</span> dist</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Pan in the up direction.  Corrects for rotation if specified.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MoveUp</span>(<span class="params"><span class="keyword">ref</span> <span class="keyword">float</span> dist</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Pan in the down direction.  Corrects for rotation if specified.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MoveDown</span>(<span class="params"><span class="keyword">ref</span> <span class="keyword">float</span> dist</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    HandleGamePadInput((<span class="keyword">float</span>)gameTime.ElapsedGameTime.TotalSeconds);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (camera.IsChanged)</span><br><span class="line">    &#123;</span><br><span class="line">        CameraChanged();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HandleKeyboardInput</span>(<span class="params"><span class="keyword">float</span> elapsed</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//check for camera movement</span></span><br><span class="line">    <span class="keyword">float</span> dX = ReadKeyboardAxis(currentKeyboardState, Keys.Left, Keys.Right) *</span><br><span class="line">        elapsed * MovementRate;</span><br><span class="line">    <span class="keyword">float</span> dY = ReadKeyboardAxis(currentKeyboardState, Keys.Down, Keys.Up) *</span><br><span class="line">        elapsed * MovementRate;</span><br><span class="line">    camera.MoveRight(<span class="keyword">ref</span> dX);</span><br><span class="line">    camera.MoveUp(<span class="keyword">ref</span> dY);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> This function is called when the camera's values have changed</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> and is used to update the properties of the tiles and animated sprite</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CameraChanged</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//set rotation</span></span><br><span class="line">    groundLayer.CameraRotation = detailLayer.CameraRotation =</span><br><span class="line">    cloudLayer.CameraRotation = rockLayer.CameraRotation =</span><br><span class="line">    animatedSprite.Rotation = camera.Rotation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//set zoom</span></span><br><span class="line">    groundLayer.CameraZoom = detailLayer.CameraZoom =</span><br><span class="line">    rockLayer.CameraZoom = camera.Zoom;</span><br><span class="line">    animatedSprite.ScaleValue = animatedSpriteScale * camera.Zoom;</span><br><span class="line">    cloudLayer.CameraZoom = camera.Zoom + <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//set position</span></span><br><span class="line">    groundLayer.CameraPosition = camera.Position;</span><br><span class="line">    detailLayer.CameraPosition = camera.Position;</span><br><span class="line">    rockLayer.CameraPosition = camera.Position;</span><br><span class="line">    <span class="comment">//to acheive a paralax effect（视差效果）, scale down cloud movement</span></span><br><span class="line">    cloudLayer.CameraPosition = camera.Position / <span class="number">3.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> This is called when the game should draw itself.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="gameTime"&gt;</span>Provides a snapshot of timing values.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Draw</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    groundLayer.Draw(spriteBatch);</span><br><span class="line">    detailLayer.Draw(spriteBatch);</span><br><span class="line">    rockLayer.Draw(spriteBatch);</span><br><span class="line"></span><br><span class="line">    animatedSprite.Draw(spriteBatch, Color.AntiqueWhite,</span><br><span class="line">        SpriteBlendMode.AlphaBlend);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//draw the clouds</span></span><br><span class="line">    cloudLayer.Draw(spriteBatch);</span><br><span class="line">    <span class="keyword">base</span>.Draw(gameTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zmapleaf</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">66</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zmapleaf</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
