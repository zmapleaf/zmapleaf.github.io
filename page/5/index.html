<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="远">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="远">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="远">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/5/">





  <title>远</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">远</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/04/MonoGame笔记(五)轮询/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/04/MonoGame笔记(五)轮询/" itemprop="url">MonoGame笔记(五)轮询</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-04T13:18:37+08:00">
                2017-12-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>笔记三和笔记四讲到MonoGame中的event driven input并不是真正意义的event driven, 只是在轮询的基础上采用了一种C# event的方式去封装. 然而Windows系统的确是事件驱动的. <strong>深入浅出MFC第一章Win32基本程序概念</strong>提到</p>
<blockquote>
<p>所有的GUI系统，包括UNIX的X Window 以及OS/2 的Presentation Manager，都像Windows那样，是以消息为基础的事件驱动系统。</p>
</blockquote>
<blockquote>
<p>以消息为基础, 以事件驱动之</p>
</blockquote>
<p>以鼠标和键盘为例, 由Windows系统捕捉到之后, 将该输入封装成消息(message)放入系统队列(system queue)中, 之后在主事件循环(main event loop)中获取它(PeekMessage), 再派发(dispatch)给窗口处理函数(WndProc)<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">WndProc(hwnd, msg, wParam, lParam)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">switch</span> (msg) &#123;</span><br><span class="line">    <span class="keyword">case</span> WM_CREATE: ...</span><br><span class="line">    <span class="keyword">case</span> WM_COMMAND: ...</span><br><span class="line">    <span class="keyword">case</span> WM_LBUTTONDOWN: ...</span><br><span class="line">    <span class="keyword">case</span> WM_KEYDOWN: ...</span><br><span class="line">    <span class="keyword">case</span> WM_PAINT: ...</span><br><span class="line">    <span class="keyword">case</span> WM_CLOSE: ...</span><br><span class="line">    <span class="keyword">case</span> WM_DESTROY: ...</span><br><span class="line">    <span class="keyword">default</span>: <span class="keyword">return</span> DefWindowProc(...);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>WM_LBUTTONDOWN和WM_KEYDOWN分支就是对鼠标和键盘的输入处理. 而XNA是在每一帧Update时去检测鼠标和键盘的输入状态, 即每一帧轮询输入设备的状态. 为何XNA是这样处理的, 二者之间有什么差异, XNA和上面提到GUI有什么区别?</p>
<p>这些问题的答案存在于MonoGame的<strong>主事件循环</strong>中.笔记一中提到WinFormsGameWindow的RunLoop<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">RunLoop</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// https://bugzilla.novell.com/show_bug.cgi?id=487896</span></span><br><span class="line">    <span class="comment">// Since there's existing bug from implementation with mono WinForms since 09'</span></span><br><span class="line">    <span class="comment">// Application.Idle is not working as intended</span></span><br><span class="line">    <span class="comment">// So we're just going to emulate Application.Run just like Microsoft implementation</span></span><br><span class="line">    _form.Show();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> nativeMsg = <span class="keyword">new</span> NativeMessage();</span><br><span class="line">    <span class="keyword">while</span> (_form != <span class="literal">null</span> &amp;&amp; _form.IsDisposed == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (PeekMessage(<span class="keyword">out</span> nativeMsg, IntPtr.Zero, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            Application.DoEvents();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nativeMsg.msg == WM_QUIT)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        UpdateWindows();</span><br><span class="line">        Game.Tick();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We need to remove the WM_QUIT message in the message </span></span><br><span class="line">    <span class="comment">// pump as it will keep us from restarting on this </span></span><br><span class="line">    <span class="comment">// same thread.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// This is critical for some NUnit runners which</span></span><br><span class="line">    <span class="comment">// typically will run all the tests on the same</span></span><br><span class="line">    <span class="comment">// process/thread.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> msg = <span class="keyword">new</span> NativeMessage();</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.msg == WM_QUIT)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        Thread.Sleep(<span class="number">100</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">while</span> (PeekMessage(<span class="keyword">out</span> msg, IntPtr.Zero, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从上面的代码中可以看到, 当PeekMessage为false, 表示没有消息, 系统处于空闲状态(Idle)时, 才会执行Game.Tick方法. 即Game的逻辑和渲染是在Idle时执行的.</p>
<p>这是MonoGame的处理方式, 可能其他的framework不是这样处理的.那可以看看它的原生版XNA的处理方式</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Game.cs </span></span><br><span class="line"><span class="comment">//host为GameHost</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.host.Idle += <span class="keyword">new</span> EventHandler&lt;EventArgs&gt;(<span class="keyword">this</span>.HostIdle);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HostIdle</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.Tick();<span class="comment">//重头戏</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Game调用host的Run方法, host的具体实现为WindowsGameHost, 它的Run方法如下<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//WindowsGameHost.cs</span></span><br><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.doneRun)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(Resources.NoMultipleRuns);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        Application.Idle += <span class="keyword">new</span> EventHandler(<span class="keyword">this</span>.ApplicationIdle);</span><br><span class="line">        Application.Run(<span class="keyword">this</span>.gameWindow.Form);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        Application.Idle -= <span class="keyword">new</span> EventHandler(<span class="keyword">this</span>.ApplicationIdle);</span><br><span class="line">        <span class="keyword">this</span>.doneRun = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">base</span>.OnExiting();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注册了Winform的Application的Idle事件, 当系统空闲时, 调用ApplicationIdle方法.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplicationIdle</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NativeMethods.Message message;</span><br><span class="line">    <span class="keyword">while</span> (!NativeMethods.PeekMessage(<span class="keyword">out</span> message, IntPtr.Zero, <span class="number">0u</span>, <span class="number">0u</span>, <span class="number">0u</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.exitRequested)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.gameWindow.Close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.RunOneFrame();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再看RunOneFrame方法<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">RunOneFrame</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.gameWindow.Tick();</span><br><span class="line">    <span class="keyword">base</span>.OnIdle();</span><br><span class="line">    <span class="keyword">if</span> (GamerServicesDispatcher.IsInitialized)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.gameWindow.IsGuideVisible = Guide.IsVisible;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>内部调用base.OnIdle. 而GameHost的Idle事件注册了Game的HostIdle, 而后者又调用了Tick方法.</p>
<p>其实从HostIdle顾名思义可以得出结论<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HostIdle</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.Tick();<span class="comment">//重头戏</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Game是在Host空闲的时候才调用Tick方法. Host顾名思义就是Game寄宿的载体.可以是Windows的Winform, 也可以Android的View, 等等等等.</p>
<p>或许还会有疑问, 那只是MonoGame(XNA)的做法, 其他game framework并不一定如此吧.</p>
<p>于是查了一本经典老书: Windows游戏编程大师技巧<br>第二章产生一个实时事件循环<br><img src="/img/monogame-windowsgameclassic-loop.png" alt=""></p>
<p>代码基于Win32平台, 没有framework封装, 已经接近底层了.</p>
<p>或许还有一丝存疑, 那是该书对Idle的运用, 将Game logic放在那里, 不一定都是这样吧. 那看一下非游戏编程的书是怎么描述Idle的运用的.</p>
<p><strong>深入浅出MFC第一章Win32基本程序概念</strong>专门有一节是<em>空闲时间的处理: OnIdle</em></p>
<blockquote>
<p>所谓空闲时间（idle time），是指「系统中没有任何消息等待处理」的时间。举个例子，没有任何程序使用定时器（timer，它会定时送来WM_TIMER），使用者也没有碰触键盘和鼠标或任何外围，那么，系统就处于所谓的空闲时间。空闲时间常常发生。不要认为你移动鼠标时产生一大堆的WM_MOUSEMOVE，事实上夹杂在每一个WM_MOUSEMOVE 之间就可能存在许多空闲时间。毕竟，计算机速度超乎想像。背景工作最适宜在空闲时间完成。传统的SDK 程序如果要处理空闲时间，可以以下列循环取代WinMain 中传统的消息循环：</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">    <span class="keyword">if</span> (PeekMessage(&amp;msg, NULL, <span class="number">0</span>, <span class="number">0</span>, PM_REMOVE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.message == WM_QUIT)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        TranslateMessage(&amp;msg);</span><br><span class="line">        DispatchMessage(&amp;msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        OnIdle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第６章的HelloMFC 将示范如何在MFC 程序中处理所谓的idle time</p>
</blockquote>
<p>那有一个疑问: 游戏是背景工作吗? 要解答这样疑问看一篇笔记.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/03/MonoGame笔记(四)XNA Simple GUI/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/03/MonoGame笔记(四)XNA Simple GUI/" itemprop="url">MonoGame笔记(四)XNA Simple GUI</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-03T17:20:37+08:00">
                2017-12-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇笔记介绍event driven input, 最后提到轮询与事件驱动. 这一篇先不讲这个. 上一篇提到btn.OnClick += ClickHandler. XNA没有提供GUI, 需要自己实现Button和其他控件. 有一个XNA Simple GUI,<a href="https://simplegui.codeplex.com/" target="_blank" rel="noopener">https://simplegui.codeplex.com/</a>,<br><img src="/img/monogame-xnasimplegui.png" alt=""><br> 可以大致了解一下XNA中GUI的实现方式.组合模式加控件树倒没有多少问题, 主要看它是如何实现btn.OnClick += ClickHandler的.</p>
<p> XNA Simple GUI的使用方式如下:<br> <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DGuiManager guiManager = <span class="keyword">new</span> DGuiManager(<span class="keyword">this</span>, spriteBatch);</span><br><span class="line"></span><br><span class="line">DForm form = <span class="keyword">new</span> DForm(guiManager, <span class="string">"MainForm"</span>, <span class="literal">null</span>);</span><br><span class="line">form.Size = <span class="keyword">new</span> Vector2(<span class="number">640</span>, <span class="number">480</span>);</span><br><span class="line">form.Position = <span class="keyword">new</span> Vector2(<span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">form.Initialize();</span><br><span class="line">guiManager.AddControl(form);</span><br><span class="line"></span><br><span class="line">DButton button = <span class="keyword">new</span> DButton (guiManager, <span class="number">5</span>, <span class="number">5</span>, <span class="string">"Button"</span>); <span class="comment">// Button at 5,5 with text "Button"</span></span><br><span class="line">button.Initialize();</span><br><span class="line">form.AddPanel(button);</span><br><span class="line"></span><br><span class="line">button.OnClick += <span class="keyword">new</span> ButtonEventHandler(handleClick); <span class="comment">// Register the click listener</span></span><br></pre></td></tr></table></figure></p>
<p>DGuiManager 内含一棵UI控件树DGuiSceneGraph, 所有的UI控件继承DPanel, DPanel继承DGuiSceneNode</p>
<p>class DGuiManager : DrawableGameComponent<br>class DGuiSceneGraph : DrawableGameComponent<br>class DGuiSceneNode : DrawableGameComponent</p>
<p>DGuiManager 的Update调用_sceneGraph.Update(gameTime), 后者调用UpdateRecursive(gameTime, rootNode);</p>
<p>DGuiManager 的Draw调用_sceneGraph.Draw(gameTime), 后者调用DrawRecursive(gameTime, rootNode);</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateRecursive</span>(<span class="params">GameTime time, DGuiSceneNode node</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//Update node</span></span><br><span class="line">    node.Update(time);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set update index, for height calculations</span></span><br><span class="line">    _updateIndex++;</span><br><span class="line">    node.UpdateIndex = _updateIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Update children recursively</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; node.Children.Count; i++) <span class="comment">// (SceneNode childNode in node.Children)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UpdateRecursive(time,node.Children[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DrawRecursive</span>(<span class="params">GameTime gameTime, DGuiSceneNode node</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//Draw</span></span><br><span class="line">    <span class="keyword">if</span> (node.Visible || node.AlwaysVisible)</span><br><span class="line">    &#123;</span><br><span class="line">        node.Draw(gameTime);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; node.Children.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            DrawRecursive(gameTime, node.Children[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Button的祖先如下:<br>DrawableGameComponent<br>DGuiSceneNode<br>DPanel<br>DButtonBase<br>DButton</p>
<p>DButton继承自DrawableGameComponent, 下面是Button的Update, 可以看到Button的OnClick仍旧是每帧轮询的方式. 当它检测到自己被点击时, 调用事件处理方法.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">以Button的Update为例, Button内没有Draw方法</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Allows the game to run logic such as updating the world,</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> checking for collisions, gathering input, and playing audio.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="gameTime"&gt;</span>Provides a snapshot of timing values.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MouseState ms = Mouse.GetState();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">base</span>.Update(gameTime);</span><br><span class="line"></span><br><span class="line">    Vector2 absPos = <span class="keyword">new</span> Vector2(AbsoluteTransform.X, AbsoluteTransform.Y);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Is mouse hovering over?</span></span><br><span class="line">    <span class="keyword">if</span> (Visible)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsMouseHoveringOver &amp;&amp; IsFocused)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Mouse click?</span></span><br><span class="line">            <span class="keyword">if</span> (ms.LeftButton == ButtonState.Pressed &amp;&amp; buttonState == DButtonState.Off)</span><br><span class="line">                OnLeftMouseDown(gameTime);<span class="comment">//事件</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ms.LeftButton == ButtonState.Released &amp;&amp; buttonState == DButtonState.On)</span><br><span class="line">            &#123;</span><br><span class="line">                OnLeftMouseUp(gameTime);</span><br><span class="line">                <span class="keyword">if</span> (OnClick != <span class="literal">null</span>)</span><br><span class="line">                    OnClick(gameTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// turn it off if the mouse hovers off it</span></span><br><span class="line">            <span class="keyword">if</span> (buttonState == DButtonState.On)</span><br><span class="line">                OnLeftMouseUp(gameTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">base</span>.Update(gameTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Button在调用Update的时候, 它得判断鼠标是点的它, 而不是点另一个按钮.<br>下面是Button的基类DPanel的Update方法中所做的判断<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Is mouse hovering over?</span></span><br><span class="line"><span class="keyword">if</span> (ms.X &gt; absPos.X &amp;&amp; ms.X &lt; (absPos.X + _size.X) &amp;&amp;</span><br><span class="line">    ms.Y &gt; absPos.Y &amp;&amp; ms.Y &lt; (absPos.Y + _size.Y))</span><br><span class="line">&#123;</span><br><span class="line">    _isMouseHoveringOver = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hoverEventsEnabled == <span class="literal">false</span>)</span><br><span class="line">        HoverEnter();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ms.LeftButton == ButtonState.Released)</span><br><span class="line">        _hasHoveredBeforeClick = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (_hasHoveredBeforeClick)</span><br><span class="line">    &#123;</span><br><span class="line">        _guiManager.FocusListEnqueue(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/03/MonoGame笔记(三)Event-driven Input/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/03/MonoGame笔记(三)Event-driven Input/" itemprop="url">MonoGame笔记(三)Event-driven Input</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-03T15:59:37+08:00">
                2017-12-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>XNA中Input的检测是放在Update方法中的, 也就是说每一帧都在轮询输入设备<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">KeyboardState keyboardState = Keyboard.GetState( );</span><br><span class="line"><span class="keyword">if</span> (keyboardState.IsKeyDown(Keys.Left))</span><br><span class="line">ringsPosition.X -= ringsSpeed;</span><br><span class="line"><span class="keyword">if</span> (keyboardState.IsKeyDown(Keys.Right))</span><br><span class="line">ringsPosition.X += ringsSpeed;</span><br><span class="line"><span class="keyword">if</span> (keyboardState.IsKeyDown(Keys.Up))</span><br><span class="line">ringsPosition.Y -= ringsSpeed;</span><br><span class="line"><span class="keyword">if</span> (keyboardState.IsKeyDown(Keys.Down))</span><br><span class="line">ringsPosition.Y += ringsSpeed;</span><br></pre></td></tr></table></figure></p>
<p>这种方式跟Flash或者U3D的使用经验不同, 也和WPF/Winform的开发方式不同.<br>后者的使用方式类似btn.OnClick += ClickHanlder/btn.addClickListener(ClickHandler)/<br>btn.addListener(Mouse.Click, ClickHandler)</p>
<p>GitHub上有一个MonoGame-EventDriven-Input项目<br><a href="https://github.com/ClassicThunder/MonoGame-EventDriven-Input" target="_blank" rel="noopener">https://github.com/ClassicThunder/MonoGame-EventDriven-Input</a></p>
<p>作者提到轮询方式的缺点:</p>
<blockquote>
<p>XNA has a rather severe limitation with regards to handling keyboard input. It is unable detect any keystrokes that occur between pollings. Because of this if your game is updating at the default 60 fps there are 0.017 seconds between polls can be too slow for individual characters of memorized sequences such as “ing”. This method also has the advantage of behaving consistently with other applications, the double click time, character repeat time, etc… are all controlled by your windows settings.</p>
</blockquote>
<blockquote>
<p>两帧之间的Input检测不到</p>
</blockquote>
<p>那它是如何做到Event-driven的? 以下是使用方式<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Input _eventDrivenInput;</span><br><span class="line">_eventDrivenInput = <span class="keyword">new</span> MonoGameInput(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">_eventDrivenInput.Update(gameTime);</span><br><span class="line"></span><br><span class="line">_eventDrivenInput.KeyDown += (sender, keyDown) =&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//Subscribe to the events </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Using the library is very simple. Simple create an instance of the MonoGameInput object, call Update in the Game.Update function, and then subscribe to the events.</p>
</blockquote>
<blockquote>
<p>在Game.Update中调用_eventDrivenInput.Update(gameTime);</p>
</blockquote>
<p>看MonoGameInput的Update<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">MonoGameInput</span> : <span class="title">Input</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> MonoGameMouseEvents _mouseEvents;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> MonoGameKeyboardEvents _monoGameKeyboardEvents;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> MonoGameTouchEvents _monoGameTouchEvents;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>) </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _mouseEvents.Update(gameTime);</span><br><span class="line">        _monoGameKeyboardEvents.Update(gameTime);</span><br><span class="line">        _monoGameTouchEvents.Update(gameTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再看MonoGameMouseEvents的Update</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">MonoGameMouseEvents</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">event</span> EventHandler&lt;MouseEventArgs&gt; ButtonReleased;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">event</span> EventHandler&lt;MouseEventArgs&gt; ButtonPressed;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">event</span> EventHandler&lt;MouseEventArgs&gt; ButtonDoubleClicked;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">event</span> EventHandler&lt;MouseEventArgs&gt; MouseMoved;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">event</span> EventHandler&lt;MouseEventArgs&gt; MouseWheelMoved;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MouseState _previous;</span><br><span class="line">    <span class="keyword">private</span> MonoGameMouseEventArgs _lastClick;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> current = Mouse.GetState();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check button press events.</span></span><br><span class="line">        <span class="keyword">if</span> (current.LeftButton == ButtonState.Pressed </span><br><span class="line">            &amp;&amp; _previous.LeftButton == ButtonState.Released) </span><br><span class="line">        &#123;</span><br><span class="line">            OnButtonPressed(<span class="keyword">this</span>, <span class="keyword">new</span> MonoGameMouseEventArgs(</span><br><span class="line">                current.X,</span><br><span class="line">                current.Y, </span><br><span class="line">                gameTime.TotalGameTime,</span><br><span class="line">                _previous, </span><br><span class="line">                current,</span><br><span class="line">                MouseButton.Left));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (current.MiddleButton == ButtonState.Pressed </span><br><span class="line">            &amp;&amp; _previous.MiddleButton == ButtonState.Released) </span><br><span class="line">        &#123;</span><br><span class="line">            OnButtonPressed(<span class="keyword">this</span>, <span class="keyword">new</span> MonoGameMouseEventArgs(</span><br><span class="line">                current.X,</span><br><span class="line">                current.Y, </span><br><span class="line">                gameTime.TotalGameTime,</span><br><span class="line">                _previous,</span><br><span class="line">                current,</span><br><span class="line">                MouseButton.Middle));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (current.RightButton == ButtonState.Pressed </span><br><span class="line">            &amp;&amp; _previous.RightButton == ButtonState.Released) </span><br><span class="line">        &#123;</span><br><span class="line">            OnButtonPressed(<span class="keyword">this</span>, <span class="keyword">new</span> MonoGameMouseEventArgs(</span><br><span class="line">                current.X, </span><br><span class="line">                current.Y, </span><br><span class="line">                gameTime.TotalGameTime,</span><br><span class="line">                _previous,</span><br><span class="line">                current, </span><br><span class="line">                MouseButton.Right));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (current.XButton1 == ButtonState.Pressed</span><br><span class="line">            &amp;&amp; _previous.XButton1 == ButtonState.Released) </span><br><span class="line">        &#123;</span><br><span class="line">            OnButtonPressed(<span class="keyword">this</span>, <span class="keyword">new</span> MonoGameMouseEventArgs(</span><br><span class="line">                current.X,</span><br><span class="line">                current.Y,</span><br><span class="line">                gameTime.TotalGameTime,</span><br><span class="line">                _previous, </span><br><span class="line">                current,</span><br><span class="line">                MouseButton.XButton1));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (current.XButton2 == ButtonState.Pressed</span><br><span class="line">            &amp;&amp; _previous.XButton2 == ButtonState.Released) </span><br><span class="line">        &#123;</span><br><span class="line">            OnButtonPressed(<span class="keyword">this</span>, <span class="keyword">new</span> MonoGameMouseEventArgs(</span><br><span class="line">                current.X,</span><br><span class="line">                current.Y, </span><br><span class="line">                gameTime.TotalGameTime,</span><br><span class="line">                _previous,</span><br><span class="line">                current,</span><br><span class="line">                MouseButton.XButton2));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check button releases.</span></span><br><span class="line">        <span class="keyword">if</span> (current.LeftButton == ButtonState.Released </span><br><span class="line">            &amp;&amp; _previous.LeftButton == ButtonState.Pressed) </span><br><span class="line">        &#123;</span><br><span class="line">            OnButtonReleased(<span class="keyword">this</span>, <span class="keyword">new</span> MonoGameMouseEventArgs(</span><br><span class="line">                current.X,</span><br><span class="line">                current.Y, </span><br><span class="line">                gameTime.TotalGameTime,</span><br><span class="line">                _previous,</span><br><span class="line">                current, </span><br><span class="line">                MouseButton.Left));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (current.MiddleButton == ButtonState.Released</span><br><span class="line">            &amp;&amp; _previous.MiddleButton == ButtonState.Pressed) </span><br><span class="line">        &#123;</span><br><span class="line">            OnButtonReleased(<span class="keyword">this</span>, <span class="keyword">new</span> MonoGameMouseEventArgs(</span><br><span class="line">                current.X, </span><br><span class="line">                current.Y, </span><br><span class="line">                gameTime.TotalGameTime,</span><br><span class="line">                _previous,</span><br><span class="line">                current,</span><br><span class="line">                MouseButton.Middle));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (current.RightButton == ButtonState.Released</span><br><span class="line">            &amp;&amp; _previous.RightButton == ButtonState.Pressed) </span><br><span class="line">        &#123;</span><br><span class="line">            OnButtonReleased(<span class="keyword">this</span>, <span class="keyword">new</span> MonoGameMouseEventArgs(</span><br><span class="line">                current.X, </span><br><span class="line">                current.Y, </span><br><span class="line">                gameTime.TotalGameTime, </span><br><span class="line">                _previous, </span><br><span class="line">                current, </span><br><span class="line">                MouseButton.Right));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (current.XButton1 == ButtonState.Released</span><br><span class="line">            &amp;&amp; _previous.XButton1 == ButtonState.Pressed) </span><br><span class="line">        &#123;</span><br><span class="line">            OnButtonReleased(<span class="keyword">this</span>, <span class="keyword">new</span> MonoGameMouseEventArgs(</span><br><span class="line">                current.X, </span><br><span class="line">                current.Y, </span><br><span class="line">                gameTime.TotalGameTime, </span><br><span class="line">                _previous, </span><br><span class="line">                current, </span><br><span class="line">                MouseButton.XButton1));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (current.XButton2 == ButtonState.Released</span><br><span class="line">            &amp;&amp; _previous.XButton2 == ButtonState.Pressed) </span><br><span class="line">        &#123;</span><br><span class="line">            OnButtonReleased(<span class="keyword">this</span>, <span class="keyword">new</span> MonoGameMouseEventArgs(</span><br><span class="line">                current.X, </span><br><span class="line">                current.Y, </span><br><span class="line">                gameTime.TotalGameTime, </span><br><span class="line">                _previous, </span><br><span class="line">                current, </span><br><span class="line">                MouseButton.XButton2));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check for any sort of mouse movement. If a button is down, it's a drag,</span></span><br><span class="line">        <span class="comment">// otherwise it's a move.</span></span><br><span class="line">        <span class="keyword">if</span> (_previous.X != current.X || _previous.Y != current.Y)</span><br><span class="line">        &#123;</span><br><span class="line">            OnMouseMoved(<span class="keyword">this</span>, <span class="keyword">new</span> MonoGameMouseEventArgs(</span><br><span class="line">                current.X, </span><br><span class="line">                current.Y, </span><br><span class="line">                gameTime.TotalGameTime, </span><br><span class="line">                _previous, </span><br><span class="line">                current));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handle mouse wheel events.</span></span><br><span class="line">        <span class="keyword">if</span> (_previous.ScrollWheelValue != current.ScrollWheelValue)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> <span class="keyword">value</span> = current.ScrollWheelValue / <span class="number">120</span>;</span><br><span class="line">            <span class="keyword">var</span> delta = (current.ScrollWheelValue - _previous.ScrollWheelValue) / <span class="number">120</span>;</span><br><span class="line">            OnMouseWheelMoved(<span class="keyword">this</span>, <span class="keyword">new</span> MonoGameMouseEventArgs(</span><br><span class="line">                current.X, </span><br><span class="line">                current.Y, </span><br><span class="line">                gameTime.TotalGameTime, </span><br><span class="line">                _previous, </span><br><span class="line">                current, </span><br><span class="line">                MouseButton.None, </span><br><span class="line">                <span class="keyword">value</span>, </span><br><span class="line">                delta));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _previous = current;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里仍旧是在Update中遍历Mouse的状态, 依旧是轮询的方式. 只是在使用方式了采取了一种类似<strong>event-driven</strong>的写法, 不是真正的event-driven吧, 不知道是不是我的理解错了.</p>
<p>那为什么在XNA中是轮询(Polling), 而不是事件驱动(Event Driven)?  其他引擎呢? 像Flash默认是事件监听来响应输入的. 后面的笔记会试图回答这些问题.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/02/MedicalImaging笔记(X1) FoDicom传输(三)ThreadPoolQueue/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/02/MedicalImaging笔记(X1) FoDicom传输(三)ThreadPoolQueue/" itemprop="url">MedicalImaging笔记(X1) FoDicom传输(三)ThreadPoolQueue介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-02T16:04:51+08:00">
                2017-12-02
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>网上找FoDicom资料时, 发现dicomservice早期版本用的是ThreadPoolQueue <a href="http://blog.csdn.net/zssureqh/article/details/50637387" target="_blank" rel="noopener">http://blog.csdn.net/zssureqh/article/details/50637387</a><br>Dicomservice目前使用的是C#5.0引入的async和await, 之前使用的是C# 4.0引入的Task, 再之前使用的是C#1.0的Begin/End(APM)<br>其中Task版本用到了TaskQueue, 内部调用Task.Run(() =&gt; this.ExecuteProc(group));<br>APM版本用到了ThreadPoolQueue, 内部调用ThreadPool.QueueUserWorkItem(ExecuteProc, group);</p>
<p>ThreadPoolQueue和TaskQueue的逻辑是一样的, 只是将ThreadPool替换为了Task, 只需要看ThreadPoolQueue</p>
<p>可以从旧版本的Dicomservice的EndReadPDU处开始看起<br>EndReadPDU表示结束读取收到的PDU包<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0x04</span>: <span class="comment">//PDataTF (带数据)</span></span><br><span class="line">        _processQueue.Queue(ProcessPDataTF, pdu);</span><br></pre></td></tr></table></figure></p>
<p>_processQueue为ThreadPoolQueue, 其他case都是ACSE(见之前的笔记), 直接调用OnReceiveAssociationAccept等方法处理</p>
<p>ProcessPDataTF方法内部:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (DicomMessage.IsRequest(_dimse.Type)) ThreadPool.QueueUserWorkItem(PerformDimseCallback, _dimse);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    _processQueue.Queue(</span><br><span class="line">        (_dimse <span class="keyword">as</span> DicomResponse).RequestMessageID,</span><br><span class="line">        PerformDimseCallback,</span><br><span class="line">        _dimse);</span><br></pre></td></tr></table></figure></p>
<p>如果_dimse是request, 则直接交由ThreadPool去执行<br>如果_dimse是response, 则放入ThreadPoolQueue中</p>
<p>看看ThreadPoolQueue的Queue方法做了什么<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Queue</span>(<span class="params">WaitCallback callback, <span class="keyword">object</span> state</span>)</span> &#123;</span><br><span class="line">    Queue(<span class="keyword">new</span> WorkItem &#123;</span><br><span class="line">        Group = DefaultGroup,</span><br><span class="line">        Callback = callback,</span><br><span class="line">        State = state</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Queue</span>(<span class="params">WorkItem item</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">lock</span> (_lock) &#123;</span><br><span class="line">        WorkGroup <span class="keyword">group</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!_groups.TryGetValue(item.Group, <span class="keyword">out</span> <span class="keyword">group</span>)) &#123;</span><br><span class="line">            <span class="keyword">group</span> = <span class="keyword">new</span> WorkGroup(item.Group);</span><br><span class="line">            _groups.Add(item.Group, <span class="keyword">group</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">lock</span> (<span class="keyword">group</span>.Lock)</span><br><span class="line">            <span class="keyword">group</span>.Items.Enqueue(item);</span><br><span class="line"></span><br><span class="line">        Execute(item.Group);<span class="comment">//按组来执行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">T groupKey</span>)</span> &#123;</span><br><span class="line">    WorkGroup <span class="keyword">group</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">lock</span> (_lock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!_groups.TryGetValue(groupKey, <span class="keyword">out</span> <span class="keyword">group</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">lock</span> (<span class="keyword">group</span>.Lock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">group</span>.Executing)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">group</span>.Items.Count == <span class="number">0</span> &amp;&amp; !<span class="keyword">group</span>.Key.Equals(DefaultGroup)) &#123;</span><br><span class="line">            _groups.Remove(groupKey);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">group</span>.Executing = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        ThreadPool.QueueUserWorkItem(ExecuteProc, <span class="keyword">group</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ExecuteProc: 内部最终执行<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (item.Action != <span class="literal">null</span>)</span><br><span class="line">        item.Action();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (item.Callback != <span class="literal">null</span>)</span><br><span class="line">        item.Callback(item.State);</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="comment">// log this somewhere?</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从代码中可以这样理解ThreadPoolQueue的Queue方法:</p>
<ol>
<li>将Item放入queue</li>
<li>如果当前queue没有执行, 则将该queue放入线程池中执行</li>
<li>如果当前queue正在执行, 则返回</li>
</ol>
<p>于是会出现这样一种情况: 多次调用Queue方法, 但此时queue在执行, 则item会在queue中累积</p>
<p>为何要这样做, 从fodicom自带的ThreadPoolQueueTest中可以看到<br>public void Queue_OrderOfExecutionForSameKey_ShouldBeFifo()</p>
<p>为何要这样设计, 对于response需要FIFO? 其中一点认识: C-Get和C-Move都是复合操作, 对于响应的顺序比较重要.<br><img src="/img/fodicom-cget.png" alt=""></p>
<p>文件链接:</p>
<p>TaskQueue.cs<br><a href="https://github.com/fo-dicom/fo-dicom/blob/b386e73e3b33c6de3bb7c4400464e0c2e010dbad/DICOM/Threading/TaskQueue.cs" target="_blank" rel="noopener">https://github.com/fo-dicom/fo-dicom/blob/b386e73e3b33c6de3bb7c4400464e0c2e010dbad/DICOM/Threading/TaskQueue.cs</a></p>
<p>TaskQueueTest.cs<br><a href="https://github.com/fo-dicom/fo-dicom/blob/b386e73e3b33c6de3bb7c4400464e0c2e010dbad/DICOM%20%5BUnit%20Tests%5D/Threading/TaskQueueTest.cs" target="_blank" rel="noopener">https://github.com/fo-dicom/fo-dicom/blob/b386e73e3b33c6de3bb7c4400464e0c2e010dbad/DICOM%20%5BUnit%20Tests%5D/Threading/TaskQueueTest.cs</a></p>
<p>ThreadPoolQueue.cs<br><a href="https://github.com/fo-dicom/fo-dicom/blob/12f4e225b250e3107d4ecb5f9404fa12e18a3dcd/DICOM/Threading/ThreadPoolQueue.cs" target="_blank" rel="noopener">https://github.com/fo-dicom/fo-dicom/blob/12f4e225b250e3107d4ecb5f9404fa12e18a3dcd/DICOM/Threading/ThreadPoolQueue.cs</a></p>
<p>ThreadPoolQueueTest.cs<br><a href="https://github.com/fo-dicom/fo-dicom/blob/12f4e225b250e3107d4ecb5f9404fa12e18a3dcd/DICOM%20%5BUnit%20Tests%5D/Threading/ThreadPoolQueueTest.cs" target="_blank" rel="noopener">https://github.com/fo-dicom/fo-dicom/blob/12f4e225b250e3107d4ecb5f9404fa12e18a3dcd/DICOM%20%5BUnit%20Tests%5D/Threading/ThreadPoolQueueTest.cs</a></p>
<p>DicomService.cs (使用ThreadPoolQueue)<br><a href="https://github.com/fo-dicom/fo-dicom/blob/12f4e225b250e3107d4ecb5f9404fa12e18a3dcd/DICOM/Network/DicomService.cs" target="_blank" rel="noopener">https://github.com/fo-dicom/fo-dicom/blob/12f4e225b250e3107d4ecb5f9404fa12e18a3dcd/DICOM/Network/DicomService.cs</a></p>
<p>下面是单元测试程序<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line">下面是单元测试程序:</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics.Contracts;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ThreadQueuePoolTest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Queue_OrderOfExecutionForSameKey_ShouldBeFifo();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Queue_OrderOfExecutionForSameKey_ShouldBeFifo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">string</span>[] expected = &#123; <span class="string">"Group 1: "</span>, <span class="string">"Group 2: "</span>, <span class="string">"Group 3: "</span> &#125;;</span><br><span class="line">            <span class="keyword">string</span>[] actual = &#123; <span class="string">"Group 1: "</span>, <span class="string">"Group 2: "</span>, <span class="string">"Group 3: "</span> &#125;;</span><br><span class="line">            <span class="keyword">bool</span>[] finished = &#123; <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span> &#125;;</span><br><span class="line">            <span class="keyword">var</span> handle = <span class="keyword">new</span> ManualResetEventSlim(<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">var</span> pool = <span class="keyword">new</span> ThreadPoolQueue&lt;<span class="keyword">int</span>&gt;(<span class="keyword">int</span>.MinValue);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">99</span>; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> <span class="keyword">group</span> = i % <span class="number">3</span>;</span><br><span class="line">                expected[<span class="keyword">group</span>] += <span class="keyword">string</span>.Format(<span class="string">"B&#123;0&#125;E&#123;0&#125; "</span>, i);</span><br><span class="line">                pool.Queue(</span><br><span class="line">                    <span class="keyword">group</span>,</span><br><span class="line">                    state =&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        actual[<span class="keyword">group</span>] += <span class="keyword">string</span>.Format(<span class="string">"B&#123;0&#125;"</span>, state);</span><br><span class="line">                        Thread.Sleep(<span class="number">1</span>);</span><br><span class="line">                        actual[<span class="keyword">group</span>] += <span class="keyword">string</span>.Format(<span class="string">"E&#123;0&#125; "</span>, state);</span><br><span class="line">                        Thread.Sleep(<span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">if</span> ((<span class="keyword">int</span>)state &gt; <span class="number">96</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            finished[<span class="keyword">group</span>] = <span class="literal">true</span>;</span><br><span class="line">                            <span class="keyword">if</span> (finished.All(f =&gt; f)) handle.Set();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    i);</span><br><span class="line">            &#125;</span><br><span class="line">            handle.Wait(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> expected)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(item);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">"\n"</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> actual)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(item);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Console.ReadLine();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class ThreadPoolQueue&lt;T&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">class</span> <span class="title">WorkItem</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> T Group;</span><br><span class="line">            <span class="keyword">public</span> Action Action;</span><br><span class="line">            <span class="keyword">public</span> System.Threading.WaitCallback Callback;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">object</span> State;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">class</span> <span class="title">WorkGroup</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> T Key;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">object</span> Lock = <span class="keyword">new</span> <span class="keyword">object</span>();</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">bool</span> Executing = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">public</span> Queue&lt;WorkItem&gt; Items = <span class="keyword">new</span> Queue&lt;WorkItem&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">WorkGroup</span>(<span class="params">T key</span>)</span></span><br><span class="line"><span class="function"></span>            &#123;</span><br><span class="line">                Key = key;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">object</span> _lock = <span class="keyword">new</span> <span class="keyword">object</span>();</span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;T, WorkGroup&gt; _groups;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolQueue</span>(<span class="params">T defaultGroup = <span class="keyword">default</span>(T</span>))</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            _groups = <span class="keyword">new</span> Dictionary&lt;T, WorkGroup&gt;();</span><br><span class="line">            Linger = <span class="number">200</span>;</span><br><span class="line">            DefaultGroup = defaultGroup;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Time in milliseconds (MS) to keep the WorkGroup alive after processing last item.<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Linger</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Value of key for default group.<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> T DefaultGroup</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Queue</span>(<span class="params">Action action</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Queue(<span class="keyword">new</span> WorkItem</span><br><span class="line">            &#123;</span><br><span class="line">                Group = DefaultGroup,</span><br><span class="line">                Action = action</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Queue</span>(<span class="params">WaitCallback callback</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Queue(<span class="keyword">new</span> WorkItem</span><br><span class="line">            &#123;</span><br><span class="line">                Group = DefaultGroup,</span><br><span class="line">                Callback = callback</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Queue</span>(<span class="params">WaitCallback callback, <span class="keyword">object</span> state</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Queue(<span class="keyword">new</span> WorkItem</span><br><span class="line">            &#123;</span><br><span class="line">                Group = DefaultGroup,</span><br><span class="line">                Callback = callback,</span><br><span class="line">                State = state</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Queue</span>(<span class="params">T <span class="keyword">group</span>, Action action</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Queue(<span class="keyword">new</span> WorkItem</span><br><span class="line">            &#123;</span><br><span class="line">                Group = <span class="keyword">group</span>,</span><br><span class="line">                Action = action</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Queue</span>(<span class="params">T <span class="keyword">group</span>, WaitCallback callback</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Queue(<span class="keyword">new</span> WorkItem</span><br><span class="line">            &#123;</span><br><span class="line">                Group = <span class="keyword">group</span>,</span><br><span class="line">                Callback = callback</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Queue</span>(<span class="params">T <span class="keyword">group</span>, WaitCallback callback, <span class="keyword">object</span> state</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Queue(<span class="keyword">new</span> WorkItem</span><br><span class="line">            &#123;</span><br><span class="line">                Group = <span class="keyword">group</span>,</span><br><span class="line">                Callback = callback,</span><br><span class="line">                State = state</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Queue</span>(<span class="params">WorkItem item</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (_lock)</span><br><span class="line">            &#123;</span><br><span class="line">                WorkGroup <span class="keyword">group</span> = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (!_groups.TryGetValue(item.Group, <span class="keyword">out</span> <span class="keyword">group</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">group</span> = <span class="keyword">new</span> WorkGroup(item.Group);</span><br><span class="line">                    _groups.Add(item.Group, <span class="keyword">group</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">lock</span> (<span class="keyword">group</span>.Lock)</span><br><span class="line">                    <span class="keyword">group</span>.Items.Enqueue(item);</span><br><span class="line"></span><br><span class="line">                Execute(item.Group);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">T groupKey</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            WorkGroup <span class="keyword">group</span> = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">lock</span> (_lock)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!_groups.TryGetValue(groupKey, <span class="keyword">out</span> <span class="keyword">group</span>))</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">lock</span> (<span class="keyword">group</span>.Lock)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">group</span>.Executing)</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">group</span>.Items.Count == <span class="number">0</span> &amp;&amp; !<span class="keyword">group</span>.Key.Equals(DefaultGroup))</span><br><span class="line">                &#123;</span><br><span class="line">                    _groups.Remove(groupKey);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">group</span>.Executing = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                ThreadPool.QueueUserWorkItem(ExecuteProc, <span class="keyword">group</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ExecuteProc</span>(<span class="params"><span class="keyword">object</span> state</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> <span class="keyword">group</span> = (WorkGroup)state;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                WorkItem item = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">bool</span> empty;</span><br><span class="line">                <span class="keyword">lock</span> (<span class="keyword">group</span>.Lock)</span><br><span class="line">                &#123;</span><br><span class="line">                    empty = <span class="keyword">group</span>.Items.Count == <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!empty)</span><br><span class="line">                        item = <span class="keyword">group</span>.Items.Dequeue();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (empty)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> linger = DateTime.Now.AddMilliseconds(Linger);</span><br><span class="line">                    <span class="keyword">while</span> (empty &amp;&amp; DateTime.Now &lt; linger)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Thread.Sleep(<span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">lock</span> (_lock)</span><br><span class="line">                        &#123;</span><br><span class="line">                            empty = <span class="keyword">group</span>.Items.Count == <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (!empty)</span><br><span class="line">                                item = <span class="keyword">group</span>.Items.Dequeue();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (empty)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">lock</span> (_lock)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">lock</span> (<span class="keyword">group</span>.Lock)</span><br><span class="line">                                <span class="keyword">group</span>.Executing = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (!<span class="keyword">group</span>.Key.Equals(DefaultGroup))</span><br><span class="line">                                _groups.Remove(<span class="keyword">group</span>.Key);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (item.Action != <span class="literal">null</span>)</span><br><span class="line">                        item.Action();</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (item.Callback != <span class="literal">null</span>)</span><br><span class="line">                        item.Callback(item.State);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// log this somewhere?</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/02/MedicalImaging笔记(X1) FoDicom传输(二)DicomService/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/02/MedicalImaging笔记(X1) FoDicom传输(二)DicomService/" itemprop="url">MedicalImaging笔记(X1) FoDicom传输(二)DICOMService</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-02T15:37:51+08:00">
                2017-12-02
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一个笔记最后提到SendRequest,  以下是SendRequest的序列图, 不是十分准确, 但可以有个大概的浏览.</p>
<p><img src="/img/fodicom-dicomservice.png" alt=""></p>
<p>序列图当中, SendNextMessage和DoSendMessage是DicomService中两个重要的方法.</p>
<p><strong>先看SendNextMessage方法</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SendNextMessage</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        DicomMessage msg;</span><br><span class="line">        <span class="keyword">lock</span> (_lock)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_sending)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_msgQueue.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (_pending.Count == <span class="number">0</span>) OnSendQueueEmpty();<span class="comment">//</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Association.MaxAsyncOpsInvoked &gt; <span class="number">0</span></span><br><span class="line">                &amp;&amp; _pending.Count(req =&gt; req.Type != DicomCommandField.CGetRequest)</span><br><span class="line">                &gt;= Association.MaxAsyncOpsInvoked)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _sending = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            msg = _msgQueue.Dequeue();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (msg <span class="keyword">is</span> DicomRequest)</span><br><span class="line">            &#123;</span><br><span class="line">                _pending.Add(msg <span class="keyword">as</span> DicomRequest);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DoSendMessage(msg);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">lock</span> (_lock) _sending = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>里面出现2个数据结构: Queue<code>&lt;DicomMessage</code>&gt; _msgQueue 与 List<code>&lt;DicomRequest</code>&gt; _pending;<br>当request得到response的时候, 该msg才会从_pending列表中删除,<br>若_msgQueue和_pending都为空时, 即传输队列为空时, 会调用OnSendQueueEmpty</p>
<p>OnSendQueueEmpty在DicomClient中override<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Action to perform when send queue is empty.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnSendQueueEmpty</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">lock</span> (<span class="keyword">this</span>.locker)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (LingerTask == <span class="literal">null</span> || LingerTask.IsCompleted)</span><br><span class="line">        &#123;</span><br><span class="line">            LingerTask = LingerAsync();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用了LingerAsync();</p>
<p>linger是逗留的意思, 例如逗留50ms之后释放链接<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">LingerAsync</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> disconnected = <span class="keyword">await</span> ListenForDisconnectAsync(client.Linger, <span class="literal">false</span>).ConfigureAwait(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (disconnected)</span><br><span class="line">        &#123;</span><br><span class="line">            SetComplete();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (IsSendQueueEmpty)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> DoSendAssociationReleaseRequestAsync().ConfigureAwait(<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>即在Client调用Send之后, 若一段时间内没有新的Request加入, 并且旧的request已经得到响应, 那么Client会释放与服务端的连接.</p>
<p><strong>再看DoSendMessage方法</strong><br>DoSendMessage方法代码比较多, 主要有3步</p>
<ol>
<li>构造Dimse (序列图中省略了)</li>
<li>构造PDataTFStream, 作为Dimse的成员; DicomService也是PDataTFStream构造方法的参数之一</li>
<li>调用PDataTFStream的FlushAsync方法</li>
</ol>
<p>PDataTFStream顾名思义是用来构造读写P-Data-TF, 它的两个方法:</p>
<ol>
<li>CreatePDVAsync</li>
<li>WritePDVAsync</li>
</ol>
<p>WritePDVAsync中调用DicomService的SendPDUAsync来真正发送PDU, 写到网络流中<br>为何SendPDUAsync是在DicomService, 而不是在PDataTFStream中<br>从代码中看出, SendPDUAsync还需要对PDU进行一些逻辑处理: 拥塞控制<br>_pduQueue中有最大容量限制</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">async</span> Task <span class="title">SendPDUAsync</span>(<span class="params">PDU pdu</span>)</span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="comment">// _pduQueueWatcher = new ManualResetEventSlim(true);</span></span><br><span class="line">    <span class="comment">// 第一次执行时不会阻塞, _pduQueueWatcher构造成Signaled状态</span></span><br><span class="line">    _pduQueueWatcher.Wait();<span class="comment">//阻塞, 等SendNextPDUAysnc完成的信号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">lock</span> (_lock)</span><br><span class="line">    &#123;</span><br><span class="line">        _pduQueue.Enqueue(pdu);</span><br><span class="line">        <span class="keyword">if</span> (_pduQueue.Count &gt;= MaximumPDUsInQueue) </span><br><span class="line">            _pduQueueWatcher.Reset();<span class="comment">//即使前面Wait通过, 这里也阻塞</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> SendNextPDUAsync().ConfigureAwait(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">SendNextPDUAsync</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!IsConnected) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        PDU pdu;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">lock</span> (_lock)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_writing) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_pduQueue.Count == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            _writing = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            pdu = _pduQueue.Dequeue();</span><br><span class="line">            <span class="keyword">if</span> (_pduQueue.Count &lt; MaximumPDUsInQueue) _pduQueueWatcher.Set();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Options.LogDataPDUs &amp;&amp; pdu <span class="keyword">is</span> PDataTF) Logger.Info(<span class="string">"&#123;logId&#125; -&gt; &#123;pdu&#125;"</span>, LogID, pdu);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> ms = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">        pdu.Write().WritePDU(ms);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> buffer = ms.ToArray();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> _network.AsStream().WriteAsync(buffer, <span class="number">0</span>, (<span class="keyword">int</span>)ms.Length).ConfigureAwait(<span class="literal">false</span>);</span><br><span class="line">&#125; Catch(...)</span><br><span class="line">        <span class="keyword">lock</span> (_lock) _writing = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pdu = _pduQueue.Dequeue();</span><br><span class="line"><span class="keyword">if</span> (_pduQueue.Count &lt; MaximumPDUsInQueue) _pduQueueWatcher.Set();</span><br></pre></td></tr></table></figure>
<h4 id="ManualResetEventSlim简介"><a href="#ManualResetEventSlim简介" class="headerlink" title="ManualResetEventSlim简介"></a>ManualResetEventSlim简介</h4><ul>
<li>A slimmed down version of ManualResetEvent.</li>
<li>Better performance than ManualResetEvent when wait times are expected to be very short</li>
<li>Wait和Reset的区别<br>_pduQueueWatcher = new ManualResetEventSlim(true);//Event is signaled<ul>
<li>第一次调用Wait, 通过; </li>
<li>第一次调用Reset, 阻塞; 将Event从Signaled重置为NonSignaled</li>
</ul>
</li>
</ul>
<p>以上介绍的是SendRequest的大致过程, DicomService中另一大块是接收消息, 下面三个方法是重点<br>ListenAndProcessPDUAsync<br>ProcessPDataTFAsync<br>PerformDimse  </p>
<p>具体见代码了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/02/MedicalImaging笔记(X1) FoDicom传输(一)Scp和Scu/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/02/MedicalImaging笔记(X1) FoDicom传输(一)Scp和Scu/" itemprop="url">MedicalImaging笔记(X1) FoDicom传输(一)Scp和Scu</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-02T13:49:51+08:00">
                2017-12-02
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="PACS-Components"><a href="#PACS-Components" class="headerlink" title="PACS Components"></a>PACS Components</h4><p>DICOM - Digital Imaging and Communication in Medicine<br>PACS - Picture Archiving and Communication System</p>
<p><img src="/img/fodicom-pacscomponents.png" alt=""></p>
<h4 id="Fodicom的Sample分析"><a href="#Fodicom的Sample分析" class="headerlink" title="Fodicom的Sample分析"></a>Fodicom的Sample分析</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Sample Project: C-Store SCP</span></span><br><span class="line"><span class="keyword">var</span> server = DicomServer.Create&lt;CStoreSCP&gt;(port);<span class="comment">//启动了监听</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Sample Project: ConsoleTest</span></span><br><span class="line"><span class="keyword">var</span> client = <span class="keyword">new</span> DicomClient();</span><br><span class="line">client.NegotiateAsyncOps();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">    client.AddRequest(<span class="keyword">new</span> DicomCEchoRequest());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">client.AddRequest(<span class="keyword">new</span> DicomCStoreRequest(<span class="string">@"test1.dcm"</span>));</span><br><span class="line">client.AddRequest(<span class="keyword">new</span> DicomCStoreRequest(<span class="string">@"test1.dcm"</span>) &#123;</span><br><span class="line">    OnResponseReceived = (DicomCStoreRequest req, DicomCStoreResponse rsp) =&gt; &#123;</span><br><span class="line">    Console.WriteLine(<span class="string">"&#123;0&#125;: &#123;1&#125;"</span>, req.SOPInstanceUID, rsp.Status);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">client.Send(<span class="string">"127.0.0.1"</span>, <span class="number">11112</span>, <span class="literal">false</span>, <span class="string">"SCU"</span>, <span class="string">"STORESCP"</span>); <span class="comment">// Client是在Send的时候才加入的ip地址和端口</span></span><br></pre></td></tr></table></figure>
<p>DicomServer和DicomClient的类图结构如下:<br><img src="/img/fodicom-dicomserverclient-uml.png" alt=""></p>
<p>Server端叫做Service Class Provider, Client端叫做Service Class User, 二者之间建立连接, 叫做Association</p>
<p>在DCMTK中, 传DICOM到工作站和PACS用的程序是store<strong>scp</strong>.exe和store<strong>scu</strong>.exe</p>
<p>二者之间通信分为3层:</p>
<ol>
<li>socket</li>
<li>Association(Accept,Release等, 术语叫做ACSE, Association Control Service Element)</li>
<li>Command(Find, Store等Command, 术语叫做DIMSE, DICOM Message Service Element)</li>
</ol>
<p>具体的收发包由DicomService完成, DicomService和IDicomService没有直接联系</p>
<h4 id="DicomServer的创建"><a href="#DicomServer的创建" class="headerlink" title="DicomServer的创建"></a>DicomServer的创建</h4><p>CStoreSCP就是类图中的T, T除了继承DicomService和IDicomServiceProvider的通用接口外, 还需要实现特有Service的接口. CStoreSCP的类图如下:<br><img src="/img/fodicom-cstore-uml.png" alt="">  </p>
<p>如此, DicomServer就能够提供Echo服务和Store服务; 需要说明的是CStoreSCP是样例中实现的, FoDicom本身没有提供;FoDicom只给出了DicomCEchoProvider的实现, 其他类型的服务只是给出了接口, 具体实现交由业务去做<br><img src="/img/fodicom-dicomcechoprovider-uml.png" alt="">  </p>
<h4 id="Client端"><a href="#Client端" class="headerlink" title="Client端"></a>Client端</h4><p>client.AddRequest(new DicomCEchoRequest());<br>client.AddRequest(new DicomCStoreRequest(@”test1.dcm”));  </p>
<p>DicomCEchoRequest和DicomCStoreRequest属于Command<br>DicomCEchoRequest和DicomCStoreRequest相关的类图如下:<br><img src="/img/fodicom-dicomrequest-uml.png" alt="">  </p>
<p>DicomMessage中包含Command和Dataset. DIMSE分为2类:<br>DIMSE-N: those services applicable to Normalized(普通的) SOP Instances<br>DIMSE-C: those services applicable to Composite(复合的) SOP Instances</p>
<p><img src="/img/fodicom-dimse.png" alt=""> </p>
<p> DIMSE-N服务其中一个应用是DICOM打印, 常用的是DIMSE-C服务.</p>
<h4 id="DIMSE-C服务介绍"><a href="#DIMSE-C服务介绍" class="headerlink" title="DIMSE-C服务介绍"></a>DIMSE-C服务介绍</h4><p> C-Echo: Ping</p>
<p><img src="/img/fodicom-cecho.png" alt=""> </p>
<p> C-Store: 传DICOM到PACS归档</p>
<p><img src="/img/fodicom-cstore.png" alt=""> </p>
<p>C-Find: 查询病人的信息<br><img src="/img/fodicom-cfind.png" alt=""> </p>
<p>C-Get: 获取病人的DICOM, C-Get blends C-Find and C-Store into a single service class<br><img src="/img/fodicom-cget.png" alt=""> </p>
<p>C-Move: 将一个PACS上的DICOM移动到另一个地方, 也是复合操作<br><img src="/img/fodicom-cmove.png" alt=""></p>
<p>除了C-Echo和C-Store有样例外, FoDicom没有提供其他几个SCP的具体实现;</p>
<p>C-Get SCP的实现参考:<br><a href="http://blog.csdn.net/zssureqh/article/details/50334735" target="_blank" rel="noopener">http://blog.csdn.net/zssureqh/article/details/50334735</a></p>
<p>C-FIND and C-MOVE SCP的实现参考:<br><a href="http://blog.csdn.net/zssureqh/article/details/41631563" target="_blank" rel="noopener">http://blog.csdn.net/zssureqh/article/details/41631563</a></p>
<h4 id="Client的Send方法"><a href="#Client的Send方法" class="headerlink" title="Client的Send方法"></a>Client的Send方法</h4><p>client.Send(“127.0.0.1”, 11112, false, “SCU”, “STORESCP”);</p>
<ol>
<li>构造NetworkStream </li>
<li>构造DicomAssociation</li>
<li>DoSendAsync(networkstream, dicomassociation)</li>
</ol>
<p>DoSendAsync是DicomClient的重点</p>
<ol>
<li>构造DicomServiceUser</li>
<li>SendRequest(request)</li>
</ol>
<h5 id="构造DicomServiceUser"><a href="#构造DicomServiceUser" class="headerlink" title="构造DicomServiceUser"></a>构造DicomServiceUser</h5><p>DicomServiceUser的构造方法中, 调用SendAssociationRequest(association), 进行与Server端的连接<br>SendAssociationRequest调用SendPDUAsync(new AAssociateRQ(Association));</p>
<p>这里出现<strong>PDU</strong>和<strong>AAssociateRQ</strong></p>
<p>PDU和AAssociateRQ的类图如下:<br><img src="/img/fodicom-pdu.png" alt=""> </p>
<p>AAssociateRQ是PDU的一种, PDU叫做Protocol Data Unit</p>
<ol>
<li>A-Associate-RQ PDU: requests DICOM association.</li>
<li>A-Associate-AC PDU: accepts DICOM association.(in response to A-Associate-RQ).</li>
<li>A-Associate-RJ PDU: rejects DICOM association. (in response to A-Associate-RQ).</li>
<li><strong>P-Data-TF</strong> PDU: transfers a block of DICOM data.</li>
<li>A-Release-RQ PDU: requests association termination (release).</li>
<li>A-Release-RP PDU: responds to an association termination request(release).</li>
<li>A-Abort PDU: aborts any invalid association</li>
</ol>
<p><strong>Use of Dicom PDUs</strong><br><img src="/img/fodicom-usepdu.png" alt=""> </p>
<p>其中P-Data-TF is diﬀerent from the other PDU types we just considered; it is the only type responsible for transmitting the actual data. P-Data-TF sends our DICOM objects, cut into chunks known as “Protocol Data Value” (PDV) items.  前面介绍的DIMSE是以P-Data-TF类型的PDU进行传输的</p>
<p>上面介绍的是<em>1.构造DicomServiceUser</em><br>接下来介绍<em>2. SendRequest(request)</em><br>SendRequest涉及到DicomService, 比较复杂, 见FODICOM传输笔记(二)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/01/MonoGame笔记(二)SpriteBatch/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/01/MonoGame笔记(二)SpriteBatch/" itemprop="url">MonoGame笔记(二)SpriteBatch</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-01T19:19:37+08:00">
                2017-12-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>SpriteBatch的Draw和DrawString<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Draw</span> (<span class="params">Texture2D texture, Rectangle rectangle, Color color</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (texture == <span class="literal">null</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"texture"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SpriteBatchItem item = _batcher.CreateBatchItem();</span><br><span class="line">    </span><br><span class="line">    item.Depth = <span class="number">0</span>;</span><br><span class="line">    item.TextureID = (<span class="keyword">int</span>) texture.ID;</span><br><span class="line">    </span><br><span class="line">    Vector2 texCoordTL = texture.Image.GetTextureCoord ( <span class="number">0</span>, <span class="number">0</span> );</span><br><span class="line">    Vector2 texCoordBR = texture.Image.GetTextureCoord ( texture.Image.ImageWidth, texture.Image.ImageHeight );</span><br><span class="line">    </span><br><span class="line">    item.Set</span><br><span class="line">        (</span><br><span class="line">            rectangle.X,</span><br><span class="line">            rectangle.Y,</span><br><span class="line">            rectangle.Width,</span><br><span class="line">            rectangle.Height,</span><br><span class="line">            color,</span><br><span class="line">            texCoordTL,</span><br><span class="line">            texCoordBR</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DrawString</span>(<span class="params">SpriteFont spriteFont, <span class="keyword">string</span> text, Vector2 position, Color color</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (spriteFont == <span class="literal">null</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"spriteFont"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Vector2 p = position;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">char</span> c <span class="keyword">in</span> text)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">'\n'</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            p.Y += spriteFont.LineSpacing;</span><br><span class="line">            p.X = position.X;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (spriteFont.characterData.ContainsKey(c) == <span class="literal">false</span>) </span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        GlyphData g = spriteFont.characterData[c];</span><br><span class="line">        </span><br><span class="line">        SpriteBatchItem item = _batcher.CreateBatchItem();</span><br><span class="line">        </span><br><span class="line">        item.Depth = <span class="number">0.0f</span>;</span><br><span class="line">        item.TextureID = (<span class="keyword">int</span>) spriteFont._texture.ID;</span><br><span class="line"></span><br><span class="line">        Vector2 texCoordTL = spriteFont._texture.Image.GetTextureCoord ( g.Glyph.X, g.Glyph.Y );</span><br><span class="line">        Vector2 texCoordBR = spriteFont._texture.Image.GetTextureCoord ( g.Glyph.X+g.Glyph.Width, g.Glyph.Y+g.Glyph.Height );</span><br><span class="line"></span><br><span class="line">        item.Set</span><br><span class="line">            (</span><br><span class="line">                p.X,</span><br><span class="line">                p.Y+g.Cropping.Y,</span><br><span class="line">                g.Glyph.Width,</span><br><span class="line">                g.Glyph.Height,</span><br><span class="line">                color,</span><br><span class="line">                texCoordTL,</span><br><span class="line">                texCoordBR</span><br><span class="line">                );</span><br><span class="line">                </span><br><span class="line">        p.X += (g.Kerning.Y + g.Kerning.Z + spriteFont.Spacing);</span><br><span class="line">    &#125;			</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SpriteBatchItem item = _batcher.CreateBatchItem();<br>其实是从对象”池”中取一个; 三者关系如下: SpriteBatchItem的结构可以参考<br><img src="/img/monogame-spritebatch.png" alt="">  </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">_batchItemList = <span class="keyword">new</span> SpriteBatchItem[InitialBatchSize];<span class="comment">//初始化</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> SpriteBatchItem <span class="title">CreateBatchItem</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_batchItemCount &gt;= _batchItemList.Length)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> oldSize = _batchItemList.Length;</span><br><span class="line">        <span class="keyword">var</span> newSize = oldSize + oldSize/<span class="number">2</span>; <span class="comment">// grow by x1.5</span></span><br><span class="line">        newSize = (newSize + <span class="number">63</span>) &amp; (~<span class="number">63</span>); <span class="comment">// grow in chunks of 64.</span></span><br><span class="line">        Array.Resize(<span class="keyword">ref</span> _batchItemList, newSize);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=oldSize; i&lt;newSize; i++)</span><br><span class="line">            _batchItemList[i]=<span class="keyword">new</span> SpriteBatchItem();</span><br><span class="line"></span><br><span class="line">        EnsureArrayCapacity(Math.Min(newSize, MaxBatchSize));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> item = _batchItemList[_batchItemCount++];</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>什么时候进行绘制呢?在调用End的时候<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">End</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">    _beginCalled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_sortMode != SpriteSortMode.Immediate)</span><br><span class="line">        Setup();</span><br><span class="line">    </span><br><span class="line">    _batcher.DrawBatch(_sortMode, _effect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DrawBatch其中一段代码<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> ( SpriteBatchItem item <span class="keyword">in</span> _batchItemList )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// if the texture changed, we need to flush and bind the new texture</span></span><br><span class="line">    <span class="keyword">if</span> ( item.TextureID != texID )</span><br><span class="line">    &#123;</span><br><span class="line">        FlushVertexArray( startIndex, index );</span><br><span class="line">        startIndex = index;</span><br><span class="line">        texID = item.TextureID;</span><br><span class="line">        GL.BindTexture ( All.Texture2D, texID );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// store the SpriteBatchItem data in our vertexArray</span></span><br><span class="line">    _vertexArray[index++] = item.vertexTL;</span><br><span class="line">    _vertexArray[index++] = item.vertexTR;</span><br><span class="line">    _vertexArray[index++] = item.vertexBL;</span><br><span class="line">    _vertexArray[index++] = item.vertexBR;</span><br><span class="line">    </span><br><span class="line">    _freeBatchItemQueue.Enqueue ( item );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FlushVertexArray</span> (<span class="params"> <span class="keyword">int</span> start, <span class="keyword">int</span> end </span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// draw stuff</span></span><br><span class="line">    <span class="keyword">if</span> ( start != end )</span><br><span class="line">        GL.DrawElements ( All.Triangles, (end-start)/<span class="number">2</span>*<span class="number">3</span>, All.UnsignedShort,(IntPtr)((<span class="keyword">uint</span>)_indexHandle.AddrOfPinnedObject()+(<span class="keyword">uint</span>)(start/<span class="number">2</span>*<span class="number">3</span>*<span class="keyword">sizeof</span>(<span class="keyword">short</span>))) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GL.DrawElements调用的是OpenTK</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/01/MonoGame笔记(一)入口/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/01/MonoGame笔记(一)入口/" itemprop="url">MonoGame笔记(一)入口</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-01T18:19:37+08:00">
                2017-12-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>入口<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">using</span> (Game1 game = <span class="keyword">new</span> Game1())</span><br><span class="line">        &#123;</span><br><span class="line">            game.Run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Game.Run()调用Platform.RunLoop()<br>internal GamePlatform Platform;<br>GamePlatform 是抽象类. 如果是Windows平台, 则是WinFormsGamePlatform<br>WinFormsGamePlatform的RunLoop</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">RunLoop</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _window.RunLoop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> WinFormsGameWindow _window;</span><br></pre></td></tr></table></figure>
<p>WinFormsGameWindow中有WinFormsGameForm<br>进入WinFormsGameWindow的RunLoop, 看到PeekMessage, 看到Game.Tick()</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">RunLoop</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// https://bugzilla.novell.com/show_bug.cgi?id=487896</span></span><br><span class="line">    <span class="comment">// Since there's existing bug from implementation with mono WinForms since 09'</span></span><br><span class="line">    <span class="comment">// Application.Idle is not working as intended</span></span><br><span class="line">    <span class="comment">// So we're just going to emulate Application.Run just like Microsoft implementation</span></span><br><span class="line">    _form.Show();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> nativeMsg = <span class="keyword">new</span> NativeMessage();</span><br><span class="line">    <span class="keyword">while</span> (_form != <span class="literal">null</span> &amp;&amp; _form.IsDisposed == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (PeekMessage(<span class="keyword">out</span> nativeMsg, IntPtr.Zero, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            Application.DoEvents();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nativeMsg.msg == WM_QUIT)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        UpdateWindows();</span><br><span class="line">        Game.Tick();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We need to remove the WM_QUIT message in the message </span></span><br><span class="line">    <span class="comment">// pump as it will keep us from restarting on this </span></span><br><span class="line">    <span class="comment">// same thread.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// This is critical for some NUnit runners which</span></span><br><span class="line">    <span class="comment">// typically will run all the tests on the same</span></span><br><span class="line">    <span class="comment">// process/thread.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> msg = <span class="keyword">new</span> NativeMessage();</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.msg == WM_QUIT)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        Thread.Sleep(<span class="number">100</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">while</span> (PeekMessage(<span class="keyword">out</span> msg, IntPtr.Zero, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到Game的Tick函数, 里面调用了DoUpdate和DoDraw<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Tick</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> This code is very sensitive and can break very badly</span></span><br><span class="line">            <span class="comment">// with even what looks like a safe change.  Be sure to test </span></span><br><span class="line">            <span class="comment">// any change fully in both the fixed and variable timestep </span></span><br><span class="line">            <span class="comment">// modes across multiple devices and platforms.</span></span><br><span class="line"></span><br><span class="line">        RetryTick:</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Advance the accumulated elapsed time.</span></span><br><span class="line">            <span class="keyword">var</span> currentTicks = _gameTimer.Elapsed.Ticks;</span><br><span class="line">            _accumulatedElapsedTime += TimeSpan.FromTicks(currentTicks - _previousTicks);</span><br><span class="line">            _previousTicks = currentTicks;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If we're in the fixed timestep mode and not enough time has elapsed</span></span><br><span class="line">            <span class="comment">// to perform an update we sleep off the the remaining time to save battery</span></span><br><span class="line">            <span class="comment">// life and/or release CPU time to other threads and processes.</span></span><br><span class="line">            <span class="keyword">if</span> (IsFixedTimeStep &amp;&amp; _accumulatedElapsedTime &lt; TargetElapsedTime)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> sleepTime = (<span class="keyword">int</span>)(TargetElapsedTime - _accumulatedElapsedTime).TotalMilliseconds;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// <span class="doctag">NOTE:</span> While sleep can be inaccurate in general it is </span></span><br><span class="line">                <span class="comment">// accurate enough for frame limiting purposes if some</span></span><br><span class="line">                <span class="comment">// fluctuation is an acceptable result.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WINRT</span></span><br><span class="line">                Task.Delay(sleepTime).Wait();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                System.Threading.Thread.Sleep(sleepTime);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                <span class="keyword">goto</span> RetryTick;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Do not allow any update to take longer than our maximum.</span></span><br><span class="line">            <span class="keyword">if</span> (_accumulatedElapsedTime &gt; _maxElapsedTime)</span><br><span class="line">                _accumulatedElapsedTime = _maxElapsedTime;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (IsFixedTimeStep)</span><br><span class="line">            &#123;</span><br><span class="line">                _gameTime.ElapsedGameTime = TargetElapsedTime;</span><br><span class="line">                <span class="keyword">var</span> stepCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Perform as many full fixed length time steps as we can.</span></span><br><span class="line">                <span class="keyword">while</span> (_accumulatedElapsedTime &gt;= TargetElapsedTime)</span><br><span class="line">                &#123;</span><br><span class="line">                    _gameTime.TotalGameTime += TargetElapsedTime;</span><br><span class="line">                    _accumulatedElapsedTime -= TargetElapsedTime;</span><br><span class="line">                    ++stepCount;</span><br><span class="line"></span><br><span class="line">                    DoUpdate(_gameTime);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//Every update after the first accumulates lag</span></span><br><span class="line">                _updateFrameLag += Math.Max(<span class="number">0</span>, stepCount - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//If we think we are running slowly, wait until the lag clears before resetting it</span></span><br><span class="line">                <span class="keyword">if</span> (_gameTime.IsRunningSlowly)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (_updateFrameLag == <span class="number">0</span>)</span><br><span class="line">                        _gameTime.IsRunningSlowly = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (_updateFrameLag &gt;= <span class="number">5</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//If we lag more than 5 frames, start thinking we are running slowly</span></span><br><span class="line">                    _gameTime.IsRunningSlowly = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//Every time we just do one update and one draw, then we are not running slowly, so decrease the lag</span></span><br><span class="line">                <span class="keyword">if</span> (stepCount == <span class="number">1</span> &amp;&amp; _updateFrameLag &gt; <span class="number">0</span>)</span><br><span class="line">                    _updateFrameLag--;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Draw needs to know the total elapsed time</span></span><br><span class="line">                <span class="comment">// that occured for the fixed length updates.</span></span><br><span class="line">                _gameTime.ElapsedGameTime = TimeSpan.FromTicks(TargetElapsedTime.Ticks * stepCount);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Perform a single variable length update.</span></span><br><span class="line">                _gameTime.ElapsedGameTime = _accumulatedElapsedTime;</span><br><span class="line">                _gameTime.TotalGameTime += _accumulatedElapsedTime;</span><br><span class="line">                _accumulatedElapsedTime = TimeSpan.Zero;</span><br><span class="line"></span><br><span class="line">                DoUpdate(_gameTime);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Draw unless the update suppressed it.</span></span><br><span class="line">            <span class="keyword">if</span> (_suppressDraw)</span><br><span class="line">                _suppressDraw = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                DoDraw(_gameTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>类层次结构如下:</p>
<p><img src="/img/monogame-entrance.png" alt=""></p>
<p>另外也查看了一下XNA中Game类的相关类结构<br>public Game.Run()调用private Game.RunGame(), 后者调用 this.host.StartGameLoop();</p>
<p>host是GameHost, GameHost是抽象类, 具体是WindowsGameHost;WindowsGameHost内有WindowsGameWindow, WindowsGameWindow内有WindowsGameForm</p>
<p>WindowGameHost的Run方法<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.doneRun)</span><br><span class="line">      &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(Resources.NoMultipleRuns);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span></span><br><span class="line">      &#123;</span><br><span class="line">            Application.Idle += <span class="keyword">new</span> EventHandler(<span class="keyword">this</span>.ApplicationIdle);</span><br><span class="line">            Application.Run(<span class="keyword">this</span>.gameWindow.Form);<span class="comment">//winform的形式</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span></span><br><span class="line">      &#123;</span><br><span class="line">            Application.Idle -= <span class="keyword">new</span> EventHandler(<span class="keyword">this</span>.ApplicationIdle);</span><br><span class="line">            <span class="keyword">this</span>.doneRun = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">base</span>.OnExiting();</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里XNA和MonoGame是一一对应的<br>GameHost = GamePlatform<br>WindowsGameHost = WinFormsGamePlatform<br>WindowsGameWindow = WinFormsGameWindow<br>WindowsGameForm = WinFormsGameForm   </p>
<p>Game实现了游戏的大体框架, 或者说模板. 用户只要继承Game类, 将实现逻辑放入相应的虚方法Update和Draw中, 就可以进行逻辑更新和图形绘制. 这两个虚方法由Game的Tick方法组合起来. 那么需要有一个地方调用Game的Tick方法, 这个地方就是Windows的消息循环</p>
<p>过程由Game.Run进入, 经过GamePlatform, 直至GameWindow的消息循环, 此处再调用Game.Tick, 饶了一圈回到Game. Game虽然是Facade, 里面什么都有, 但唯独少了一个心脏, 需要借助外力. 这种设计方式可以学习.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/04/2D Visualization笔记(X3) DynamicDataDisplay(sl)(七)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/04/2D Visualization笔记(X3) DynamicDataDisplay(sl)(七)/" itemprop="url">2D Visualization笔记(X3) DynamicDataDisplay(sl)(七)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-04T13:46:34+08:00">
                2017-02-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>官方<br><a href="http://research.microsoft.com/en-us/um/cambridge/groups/science/tools/d3/dynamicdatadisplay.htm" target="_blank" rel="noopener">http://research.microsoft.com/en-us/um/cambridge/groups/science/tools/d3/dynamicdatadisplay.htm</a></p>
<p>Tutorial<br><a href="http://research.microsoft.com/en-us/um/cambridge/projects/ddd/d3isdk/" target="_blank" rel="noopener">http://research.microsoft.com/en-us/um/cambridge/projects/ddd/d3isdk/</a></p>
<p>D3Overview 必读<br><a href="http://research.microsoft.com/en-us/um/cambridge/groups/science/tools/d3/D3Overview.pdf" target="_blank" rel="noopener">http://research.microsoft.com/en-us/um/cambridge/groups/science/tools/d3/D3Overview.pdf</a></p>
<p>Sliverlight版本: DynamicDataDisplay.2.0.907</p>
<p>Dynamic Data Display 的Sliverlight版本和Wpf版本中的代码不一样.</p>
<hr>
<h3 id="Dynamic-Markers-background-computations"><a href="#Dynamic-Markers-background-computations" class="headerlink" title="Dynamic Markers: background computations"></a>Dynamic Markers: background computations</h3><p>方式和笔记(三)一样<br><strong>xaml</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Copyright © 2010-2011 Microsoft Corporation, All Rights Reserved.</span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">UserControl</span> <span class="attr">x:Class</span>=<span class="string">"DynamicMarkerGraphSample.MainPage"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:x</span>=<span class="string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:d</span>=<span class="string">"http://schemas.microsoft.com/expression/blend/2008"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:mc</span>=<span class="string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:d3</span>=<span class="string">"clr-namespace:Microsoft.Research.DynamicDataDisplay;assembly=DynamicDataDisplay.Silverlight"</span>             </span></span><br><span class="line"><span class="tag">    <span class="attr">mc:Ignorable</span>=<span class="string">"d"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">d:DesignHeight</span>=<span class="string">"300"</span> <span class="attr">d:DesignWidth</span>=<span class="string">"400"</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">Grid</span> <span class="attr">x:Name</span>=<span class="string">"LayoutRoot"</span> <span class="attr">Background</span>=<span class="string">"White"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">d3:Chart</span> <span class="attr">Name</span>=<span class="string">"plotter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">d3:Chart.Title</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">TextBlock</span> <span class="attr">HorizontalAlignment</span>=<span class="string">"Center"</span> <span class="attr">FontSize</span>=<span class="string">"14"</span> <span class="attr">Margin</span>=<span class="string">"0,5,0,5"</span>&gt;</span>Background computations sample<span class="tag">&lt;/<span class="name">TextBlock</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">d3:Chart.Title</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">d3:CircleMarkerGraph</span> <span class="attr">Name</span>=<span class="string">"markers"</span> <span class="attr">Description</span>=<span class="string">"Sine graph"</span> <span class="attr">Color</span>=<span class="string">"Red"</span> <span class="attr">Size</span>=<span class="string">"5"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">d3:Chart</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">UserControl</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>cs</strong><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright © 2010-2011 Microsoft Corporation, All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Reactive.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Controls;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DynamicMarkerGraphSample</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MainPage</span> : <span class="title">UserControl</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">bool</span> isUnloaded = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> AutoResetEvent renderComplete = <span class="keyword">new</span> AutoResetEvent(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">private</span> Thread thread;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">double</span> phase = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">double</span>[] y = <span class="keyword">new</span> <span class="keyword">double</span>[N];</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainPage</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            InitializeComponent();</span><br><span class="line">            markers.MarkersBatchSize = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start computation thread when Page appears on the screen</span></span><br><span class="line">            Loaded += (s, e) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                thread = <span class="keyword">new</span> Thread(ModelRun);</span><br><span class="line">                isUnloaded = <span class="literal">false</span>;</span><br><span class="line">                thread.Start();</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Stop computation thread when Page is removed from the screen</span></span><br><span class="line">            Unloaded += (s, e) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                isUnloaded = <span class="literal">true</span>;</span><br><span class="line">                renderComplete.Set();</span><br><span class="line">                thread.Join();</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ModelRun</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">while</span> (!isUnloaded)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Data array is updated</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">                    y[i] = Math.Cos(i * Math.PI / <span class="number">50</span> + phase);</span><br><span class="line">                phase += <span class="number">0.1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Plot the computed array.</span></span><br><span class="line">                <span class="comment">// PlotY and Subscribe methods must be called from the UI dispatcher thread. </span></span><br><span class="line">                <span class="comment">// Unlike ConcurrentMarkerGraphSample here we wait for each frame to be rendered.</span></span><br><span class="line">                <span class="keyword">if</span> (!isUnloaded)</span><br><span class="line">                &#123;</span><br><span class="line">                    renderComplete.Reset();</span><br><span class="line">                    Dispatcher.BeginInvoke(PlotData);</span><br><span class="line">                    renderComplete.WaitOne();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PlotData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// To increase responsiveness of the UI HeatmapGraph objects prepare </span></span><br><span class="line">            <span class="comment">// images to be drawn in a background thread. The Plot method cancels</span></span><br><span class="line">            <span class="comment">// current incomplete images before starting a new one. This may result</span></span><br><span class="line">            <span class="comment">// in loss of certain or even all of the frames.</span></span><br><span class="line">            <span class="comment">// The following code shows how to wait until a certain data is actually drawn.</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">long</span> id = markers.PlotY(y); <span class="comment">// receive a unique operation identifier</span></span><br><span class="line">            markers.RenderCompletion <span class="comment">// an observable of completed and cancelled operations</span></span><br><span class="line">                .Where(rc =&gt; rc.TaskId == id) <span class="comment">// filter out an operation with the known id</span></span><br><span class="line">                .Subscribe(dummy =&gt; &#123; renderComplete.Set(); &#125;); <span class="comment">// signal when the id is observed</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<blockquote>
<p>This sample shows how to plot data that are computed in separated thread. Unlike ConcurrentMarkerGraphSample, in this sample  computational thread waits for each frame to be rendered. This is achieved by observing RenderCompletion event and signaling when render operation with specific ID is completed (see ‘PlotData’ method for details).</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/04/2D Visualization笔记(X3) DynamicDataDisplay(sl)(五)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/04/2D Visualization笔记(X3) DynamicDataDisplay(sl)(五)/" itemprop="url">2D Visualization笔记(X3) DynamicDataDisplay(sl)(五)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-04T13:35:35+08:00">
                2017-02-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>官方<br><a href="http://research.microsoft.com/en-us/um/cambridge/groups/science/tools/d3/dynamicdatadisplay.htm" target="_blank" rel="noopener">http://research.microsoft.com/en-us/um/cambridge/groups/science/tools/d3/dynamicdatadisplay.htm</a></p>
<p>Tutorial<br><a href="http://research.microsoft.com/en-us/um/cambridge/projects/ddd/d3isdk/" target="_blank" rel="noopener">http://research.microsoft.com/en-us/um/cambridge/projects/ddd/d3isdk/</a></p>
<p>D3Overview 必读<br><a href="http://research.microsoft.com/en-us/um/cambridge/groups/science/tools/d3/D3Overview.pdf" target="_blank" rel="noopener">http://research.microsoft.com/en-us/um/cambridge/groups/science/tools/d3/D3Overview.pdf</a></p>
<p>Sliverlight版本: DynamicDataDisplay.2.0.907</p>
<p>Dynamic Data Display 的Sliverlight版本和Wpf版本中的代码不一样.</p>
<hr>
<h3 id="Markers-Many-markers"><a href="#Markers-Many-markers" class="headerlink" title="Markers: Many markers"></a>Markers: Many markers</h3><p><strong>cs</strong><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright © 2010-2011 Microsoft Corporation, All Rights Reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Globalization;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Windows;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Controls;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Resources;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ManyMarkersSample</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MainPage</span> : <span class="title">UserControl</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainPage</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            InitializeComponent();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> y = LoadData();</span><br><span class="line">            <span class="keyword">var</span> x = Enumerable.Range(<span class="number">0</span>, y.Length).Select(p =&gt; (<span class="keyword">double</span>)p).ToArray();</span><br><span class="line"></span><br><span class="line">            markers.MarkersBatchSize = <span class="number">750</span>;</span><br><span class="line">            markers.Plot(x, y);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">double</span>[] <span class="title">LoadData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            List&lt;<span class="keyword">double</span>&gt; data = <span class="keyword">new</span> List&lt;<span class="keyword">double</span>&gt;(<span class="number">11000</span>);</span><br><span class="line">            StreamResourceInfo sri = Application.GetResourceStream(<span class="keyword">new</span> Uri(<span class="string">"r0001.csv"</span>, UriKind.Relative));</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> sr = <span class="keyword">new</span> StreamReader(sri.Stream))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> s = sr.ReadLine();</span><br><span class="line">                <span class="keyword">while</span> ((s = sr.ReadLine()) != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> d = <span class="keyword">double</span>.Parse(s, CultureInfo.InvariantCulture);</span><br><span class="line">                    data.Add(d);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> data.ToArray();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<blockquote>
<p>This sample renders 11000 markers. Note that markers appear on the screen gradually and quality of zoomed in/zoomed out image also increases gradually. This keeps the sample fully interactive even at the moments when rendering is in progress.</p>
</blockquote>
<p>MarkerGraph的继承关系<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">System.Object</span><br><span class="line">  System.Windows.DependencyObject</span><br><span class="line">    System.Windows.UIElement</span><br><span class="line">      System.Windows.FrameworkElement</span><br><span class="line">        System.Windows.Controls.Panel</span><br><span class="line">          Microsoft.Research.DynamicDataDisplay.PlotBase</span><br><span class="line">            Microsoft.Research.DynamicDataDisplay.MarkerGraph</span><br><span class="line">              Microsoft.Research.DynamicDataDisplay.BarGraph</span><br><span class="line">              Microsoft.Research.DynamicDataDisplay.CartesianMarkerGraph</span><br><span class="line">              Microsoft.Research.DynamicDataDisplay.VerticalIntervalGraph</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="Rendering-optimization"><a href="#Rendering-optimization" class="headerlink" title="Rendering optimization"></a>Rendering optimization</h3><blockquote>
<p>Silverlight has limited rendering performance and plotting more than a few thousands of elements takes signification amount of time which is enough to make application non-interactive. Scientific data sets often contain tens of thousands of data items. To overcome Silverlight limitation MarkerGraph uses <strong>bitmap caching</strong> and <strong>deferred rendering</strong>. You can see how it works in <strong>Many Markers sample</strong> in Interactive SDK. Markers appear on the screen in batches. <strong>Each new batch is rendered when application is idle</strong>, so when user navigated or interacts with UI in other manner markers rendering is suspended. When marker graph needs to be redrawn because of panning or zooming, all batches are instantly replaced with bitmaps which are translated and scaled according to user navigation. After that bitmaps are replaced with real markers batch by batch in application idle moments. You may see it clear when zooming in significantly. Markers became blurred because of bitmap scaling. Later, blurred markers are replaced with re-rendered ones which makes picture look sharp again</p>
</blockquote>
<blockquote>
<p>User can control this process using two properties. <strong>MarkerBatchSize</strong> controls size of marker batch rendered at a single pass. Larger values can cause poor application resposiveness for complex marker templates, small values will result in increase of marker graph update time.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">MarkerGraph</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> MarkerBatchSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// Dep. prop.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> MaxSnapshotSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// Dep. prop.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">Plot</span>(<span class="params"><span class="keyword">params</span> <span class="keyword">object</span>[] data</span>)</span>;</span><br><span class="line">    IObservable&lt;RenderCompletion&gt; RenderCompletion;</span><br><span class="line">    …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Marker graph rendering is restarted when data are changed. If data changes occur more frequently than application idle times when marker graph draws itself, most or even all of the data updates may be skipped and not shown. MarkerGraph provides technique to wait until current data is completely displayed. Plot method returns rendering task Id. When this task is either completed or skipped because new data arrives task id is observed on RenderCompletion subject. Using this technique, application can wait for markers complete draw before updating data. See ‘Background rendering’ sample in Interactive SDK</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zmapleaf</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">66</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zmapleaf</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
