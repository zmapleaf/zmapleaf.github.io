<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="远">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="远">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="远">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/">





  <title>远</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">远</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/21/MonoGame笔记(X1)Camera2D/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/21/MonoGame笔记(X1)Camera2D/" itemprop="url">MonoGame笔记(X1)Camera2D</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-21T10:25:37+08:00">
                2017-12-21
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>以前学习时一些零散的笔记, 新开一个系列.</p>
<p>不管是side-scrolling(横版卷轴)，还是tilemap，有一点是非常关键的，就是不同坐标系之间的变换。在三维中有一个视口变换。二维没有那么复杂，但原理差不多。Hero和地图上的tile(贴片)，它们的位置是地图坐标，地图就是它们所在的世界，所以也可以说是世界坐标。在游戏逻辑中，Hero位置的改变，碰撞检测都是以地图坐标（世界坐标）进行的. 而在窗口屏幕中绘制Sprite和tile时，是以屏幕坐标为参照系的。因此在Draw方法中，必须将Hero和tile的地图坐标变换成屏幕坐标，从而在屏幕的适当位置显示出来。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="comment">// Allows the game to exit  </span></span><br><span class="line">    <span class="keyword">if</span> (GamePad.GetState(PlayerIndex.One).Buttons.Back == ButtonState.Pressed)  </span><br><span class="line">        <span class="keyword">this</span>.Exit();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">float</span> elapsedTime = (<span class="keyword">float</span>)gameTime.ElapsedGameTime.TotalSeconds;</span><br><span class="line">    <span class="keyword">float</span> moveRate = <span class="number">20f</span>;</span><br><span class="line">    <span class="keyword">if</span> (hero!= <span class="literal">null</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        scroll += ((hero.Position - <span class="keyword">new</span> Vector2(screenSize.X / <span class="number">2f</span>, screenSize.Y / <span class="number">2f</span>)) - scroll) * elapsedTime * moveRate;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">float</span> xLim = map.GetXLim();  </span><br><span class="line">        <span class="keyword">float</span> yLim = map.GetYLim();  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (scroll.X &lt; <span class="number">0f</span>) scroll.X = <span class="number">0f</span>;  </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (scroll.X &gt; xLim) scroll.X = xLim;  </span><br><span class="line">        <span class="keyword">if</span> (scroll.Y &lt; <span class="number">0f</span>) scroll.Y = <span class="number">0f</span>;  </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (scroll.Y &gt; yLim) scroll.Y = yLim;  </span><br><span class="line">  </span><br><span class="line">        hero.DoInput();  </span><br><span class="line">        hero.Update(gameTime);  </span><br><span class="line">    &#125;   </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">base</span>.Update(gameTime);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>scroll表示游戏窗口与世界地图的相对位置, hero.Position表示hero的地图坐标, 如下图所示:<br><img src="/img/monogame-camera2d-1.png" alt=""></p>
<p>上面这段代码想要解决的一个设计场景是这样的: 以横版卷轴为例, 一开始屏幕位于地图最左侧, 此时Hero从屏幕左侧出生, 随后Hero往右移动. 当Hero未达到屏幕中间时, 屏幕是不会移动的. 当Hero达到屏幕中间, 此后屏幕和Hero一起往右移动, Hero始终占据屏幕的中心位置. 当屏幕达到地图最右侧时, 屏幕不再和Hero一起往右移动, Hero可以单独继续往右移动, 直到达到屏幕最右侧.</p>
<p>上面代码的关键是<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scroll += ((hero.Position - <span class="keyword">new</span> Vector2(screenSize.X / <span class="number">2f</span>, screenSize.Y / <span class="number">2f</span>)) - scroll)</span><br></pre></td></tr></table></figure></p>
<p>当未达到屏幕中间时, scroll会是一个负值, 如果是负值就会被重置为0, 屏幕停留在地图最左侧. 同理, 超出地图右侧.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (scroll.X &lt; <span class="number">0f</span>) scroll.X = <span class="number">0f</span>;</span><br></pre></td></tr></table></figure></p>
<p>那为什么要减去scroll呢？因为new Vector2(screenSize.X / 2f, screenSize.Y / 2f)是一个固定值，而hero.Position是一个不断变大的过程(往右移动), 假设前一帧移动后，hero.Position.x - screenSize.X = 10;这一帧移动后，hero.Position.x - screenSize.X = 20, 改变的是绝对值. 为了让不同性能的机子都能够流畅运行, scroll.x是以增量的形式增加的（scroll += ***）, 即相对值. 因此需要减去原来的scroll得到一个增量，再将这个增量加回到scroll上.</p>
<p>这部分代码可以抽象出一个<strong>Camera2D</strong>类. scroll就是Camera2D的地图坐标, 屏幕大小就是Camera2D的ViewPort</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Camera2D</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Vector2 position;<span class="comment">//世界坐标</span></span><br><span class="line">    <span class="keyword">public</span> Viewport viewPort;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Camera2D</span>(<span class="params">Vector2 position</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.position = position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Camera2D</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.position = Vector2.Zero;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Camera2D</span>(<span class="params">Viewport viewPort</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.viewPort = viewPort;</span><br><span class="line">        <span class="keyword">this</span>.position = Vector2.Zero;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Matrix TransformMatrix</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Matrix.CreateTranslation(<span class="keyword">new</span> Vector3(-position, <span class="number">0f</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 一般情况下, 使得Hero位于屏幕中间</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LockCameraToPlayer</span>(<span class="params">PlayerPosition playerPostion, Hero hero</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Hero本身使用的sprite图片也有大小, 加上Center.X;</span></span><br><span class="line">        position.X = playerPostion.Position.X + hero.Center.X</span><br><span class="line">                        - (viewPort.Width / <span class="number">2</span>);</span><br><span class="line">        position.Y = playerPostion.Position.Y + hero.Center.Y</span><br><span class="line">                        - (viewPort.Height / <span class="number">2</span>); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LockCameraToBound</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">/*position就是Camera的左上角位置，用viewport的坐标应该也能代替*/</span></span><br><span class="line">        position.X = MathHelper.Clamp(</span><br><span class="line">            position.X,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            TileEngine.tilemap.WidthInPixels - viewPort.Width);</span><br><span class="line">        position.Y = MathHelper.Clamp(</span><br><span class="line">            position.Y,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            TileEngine.tilemap.HeightInPixels - viewPort.Height);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/monogame-camera2d-2.png" alt=""><br>红色是视口，黑色是世界地图; 绿点是相机的Position（世界坐标）; 蓝点是物体的Position（世界坐标）</p>
<p>官方有一个Camera2D的样例(<a href="http://xbox.create.msdn.com/en-US/education/catalog/sample/tiled_sprites)" target="_blank" rel="noopener">http://xbox.create.msdn.com/en-US/education/catalog/sample/tiled_sprites)</a>, 支持rotation和zoom, 结构和上面介绍的有所不同</p>
<p>Although a game level might have tens of thousands of tiles in the game world, only those that are visible should be drawn. Otherwise, you see a severe performance hit for submitting more draw calls than are needed to render the scene. </p>
<p>To simplify interactions with the tiles in the game world, the sample provides a 2D Camera implementation. You will find a camera abstraction useful, particularly when <strong>rotating</strong> or <strong>zooming</strong> the world. This enables you to rapidly translate screen space to world space. </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">TiledSprites</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Camera2D</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> Fields</span></span><br><span class="line">        <span class="keyword">private</span> Vector2 positionValue;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> isMovingUsingScreenAxis;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> rotationValue;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> zoomValue;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> cameraChanged;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> Public Properties</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Get/Set the postion value of the camera</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> Vector2 Position</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (positionValue != <span class="keyword">value</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cameraChanged = <span class="literal">true</span>;</span><br><span class="line">                    positionValue = <span class="keyword">value</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> positionValue; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Get/Set the rotation value of the camera</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> Rotation</span><br><span class="line">        &#123;   </span><br><span class="line">            <span class="comment">//...同上</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Get/Set the zoom value of the camera</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> Zoom</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//...同上</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Gets whether or not the camera has been changed since the last</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> ResetChanged call</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> IsChanged</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> cameraChanged; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Set to TRUE to pan relative to the screen axis when</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> the camera is rotated.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> MoveUsingScreenAxis</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">set</span> &#123; isMovingUsingScreenAxis = <span class="keyword">value</span>; &#125;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> isMovingUsingScreenAxis; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> Constructor</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Create a new Camera2D</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Camera2D</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            zoomValue = <span class="number">1.0f</span>;</span><br><span class="line">            rotationValue = <span class="number">0.0f</span>;</span><br><span class="line">            positionValue = Vector2.Zero;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> Movement Methods</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Used to inform the camera that new values are updated by the application.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ResetChanged</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            cameraChanged = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Pan in the right direction.  Corrects for rotation if specified.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MoveRight</span>(<span class="params"><span class="keyword">ref</span> <span class="keyword">float</span> dist</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dist != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cameraChanged = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (isMovingUsingScreenAxis)</span><br><span class="line">                &#123;</span><br><span class="line">                    positionValue.X += (<span class="keyword">float</span>)Math.Cos(-rotationValue) * dist;</span><br><span class="line">                    positionValue.Y += (<span class="keyword">float</span>)Math.Sin(-rotationValue) * dist;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    positionValue.X += dist;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Pan in the left direction.  Corrects for rotation if specified.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MoveLeft</span>(<span class="params"><span class="keyword">ref</span> <span class="keyword">float</span> dist</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Pan in the up direction.  Corrects for rotation if specified.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MoveUp</span>(<span class="params"><span class="keyword">ref</span> <span class="keyword">float</span> dist</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Pan in the down direction.  Corrects for rotation if specified.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MoveDown</span>(<span class="params"><span class="keyword">ref</span> <span class="keyword">float</span> dist</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    HandleGamePadInput((<span class="keyword">float</span>)gameTime.ElapsedGameTime.TotalSeconds);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (camera.IsChanged)</span><br><span class="line">    &#123;</span><br><span class="line">        CameraChanged();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HandleKeyboardInput</span>(<span class="params"><span class="keyword">float</span> elapsed</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//check for camera movement</span></span><br><span class="line">    <span class="keyword">float</span> dX = ReadKeyboardAxis(currentKeyboardState, Keys.Left, Keys.Right) *</span><br><span class="line">        elapsed * MovementRate;</span><br><span class="line">    <span class="keyword">float</span> dY = ReadKeyboardAxis(currentKeyboardState, Keys.Down, Keys.Up) *</span><br><span class="line">        elapsed * MovementRate;</span><br><span class="line">    camera.MoveRight(<span class="keyword">ref</span> dX);</span><br><span class="line">    camera.MoveUp(<span class="keyword">ref</span> dY);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> This function is called when the camera's values have changed</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> and is used to update the properties of the tiles and animated sprite</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CameraChanged</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//set rotation</span></span><br><span class="line">    groundLayer.CameraRotation = detailLayer.CameraRotation =</span><br><span class="line">    cloudLayer.CameraRotation = rockLayer.CameraRotation =</span><br><span class="line">    animatedSprite.Rotation = camera.Rotation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//set zoom</span></span><br><span class="line">    groundLayer.CameraZoom = detailLayer.CameraZoom =</span><br><span class="line">    rockLayer.CameraZoom = camera.Zoom;</span><br><span class="line">    animatedSprite.ScaleValue = animatedSpriteScale * camera.Zoom;</span><br><span class="line">    cloudLayer.CameraZoom = camera.Zoom + <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//set position</span></span><br><span class="line">    groundLayer.CameraPosition = camera.Position;</span><br><span class="line">    detailLayer.CameraPosition = camera.Position;</span><br><span class="line">    rockLayer.CameraPosition = camera.Position;</span><br><span class="line">    <span class="comment">//to acheive a paralax effect（视差效果）, scale down cloud movement</span></span><br><span class="line">    cloudLayer.CameraPosition = camera.Position / <span class="number">3.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> This is called when the game should draw itself.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="gameTime"&gt;</span>Provides a snapshot of timing values.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Draw</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    groundLayer.Draw(spriteBatch);</span><br><span class="line">    detailLayer.Draw(spriteBatch);</span><br><span class="line">    rockLayer.Draw(spriteBatch);</span><br><span class="line"></span><br><span class="line">    animatedSprite.Draw(spriteBatch, Color.AntiqueWhite,</span><br><span class="line">        SpriteBlendMode.AlphaBlend);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//draw the clouds</span></span><br><span class="line">    cloudLayer.Draw(spriteBatch);</span><br><span class="line">    <span class="keyword">base</span>.Draw(gameTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/20/MonoGame笔记(十五)XML in the  Content Pipeline/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/20/MonoGame笔记(十五)XML in the  Content Pipeline/" itemprop="url">MonoGame笔记(十五)XML in the Content Pipeline</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-20T13:34:37+08:00">
                2017-12-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前几篇笔记都是以图形资源为例, 对于游戏程序员来说, 可能打交道更多的资源文件是配置文件或者说数据文件. 而XML一般是配置文件的首选, 无论在MonoGame, 还是Flash, 抑或Unity3D. 官方对XML在Content Pipeline中的介绍如下(<a href="https://msdn.microsoft.com/en-us/library/ff604981.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/ff604981.aspx</a>)</p>
<p>Game assets managed through the Content Pipeline include graphic items such as textures, models and meshes; sound files such as dialogue or music; and custom data that governs the behavior of the game.</p>
<p><strong>Data tables</strong>, for example, are custom data that might describe different characters’ attributes or the features of each level in the game. The content and format of this data is specific to the requirements of the game. Custom game data in the form of an XML file also can be loaded into your game through the standard features of the Content Pipeline.</p>
<p>When the Content Pipeline is used, the game does not have to parse the XML format in which the game data is originally stored. Data loaded by the game through ContentManager is read in deserialized form directly into a managed code object.</p>
<p>上面的介绍还是有些抽象. 看看官方的样例RolePlayingGameStarterkit中是怎么做的.<br>下图是英雄和NPC的数据配置<br><img src="/img/monogame-contentpipeline-xml-1.png" alt=""><br>以QuestNPCs目录下的Ayttas.xml为例<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">XnaContent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Asset</span> <span class="attr">Type</span>=<span class="string">"RolePlayingGameData.QuestNpc"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Name</span>&gt;</span>Ayttas<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">MapSprite</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">TextureName</span>&gt;</span>Characters\Villager2IdleRight<span class="tag">&lt;/<span class="name">TextureName</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">FrameDimensions</span>&gt;</span>92 120<span class="tag">&lt;/<span class="name">FrameDimensions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">FramesPerRow</span>&gt;</span>6<span class="tag">&lt;/<span class="name">FramesPerRow</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">SourceOffset</span>&gt;</span>46 89<span class="tag">&lt;/<span class="name">SourceOffset</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Animations</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">MapSprite</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">MapIdleAnimationInterval</span>&gt;</span>150<span class="tag">&lt;/<span class="name">MapIdleAnimationInterval</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">IntroductionDialogue</span>&gt;</span>Welcome to Apple Village!  Unfortunately, we're not in the best of shape right now because of these monstrosities.  But enjoy your stay anyway!  What choice is there, after all?<span class="tag">&lt;/<span class="name">IntroductionDialogue</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Asset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">XnaContent</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>其中和标签很关键, 前者表示该XML是一个Content, 后者表面是以哪个类去用该XML. 有了后者, 就可以用content.Load<questnpc>(@”Ayttas”);</questnpc></p>
<p>使用内置的XMLImporter作为Content Pipeline中的导入器<br><img src="/img/monogame-contentpipeline-xml-2.png" alt=""></p>
<p>XML中也可以是集合数据<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">XnaContent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Asset</span> <span class="attr">Type</span>=<span class="string">"System.Collections.Generic.List[XmlContentSampleShared.Sprite]"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Position</span>&gt;</span>100 100<span class="tag">&lt;/<span class="name">Position</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Rotation</span>&gt;</span>0<span class="tag">&lt;/<span class="name">Rotation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Scale</span>&gt;</span>.2 .2<span class="tag">&lt;/<span class="name">Scale</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextureAsset</span>&gt;</span>crate<span class="tag">&lt;/<span class="name">TextureAsset</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Position</span>&gt;</span>400 300<span class="tag">&lt;/<span class="name">Position</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Rotation</span>&gt;</span>0<span class="tag">&lt;/<span class="name">Rotation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Scale</span>&gt;</span>.2 .2<span class="tag">&lt;/<span class="name">Scale</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextureAsset</span>&gt;</span>crate<span class="tag">&lt;/<span class="name">TextureAsset</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Position</span>&gt;</span>500 20<span class="tag">&lt;/<span class="name">Position</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Rotation</span>&gt;</span>0<span class="tag">&lt;/<span class="name">Rotation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Scale</span>&gt;</span>.2 .2<span class="tag">&lt;/<span class="name">Scale</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextureAsset</span>&gt;</span>crate<span class="tag">&lt;/<span class="name">TextureAsset</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Asset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">XnaContent</span></span></span><br></pre></td></tr></table></figure></p>
<p>使用sprites = Content.Load&lt;List<sprite>&gt;(@”SpriteList”);</sprite></p>
<p>XNA是如何做到的? 其实XNA的Content Pipeline对XML有特殊照顾.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MonoGame - Copyright (C) The MonoGame Team</span></span><br><span class="line"><span class="comment">// This file is subject to the terms and conditions defined in</span></span><br><span class="line"><span class="comment">// file 'LICENSE.txt', which is part of this source code package.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Xml;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Content.Pipeline.Serialization.Intermediate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Microsoft.Xna.Framework.Content.Pipeline</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Implements an importer for reading intermediate XML files. This is a wrapper around IntermediateSerializer.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">ContentImporter(<span class="meta-string">".xml"</span>, DisplayName = <span class="meta-string">"Xml Importer - MonoGame"</span>, DefaultProcessor = <span class="meta-string">"PassThroughProcessor"</span>)</span>]</span><br><span class="line">    public class XmlImporter : ContentImporter&lt;object&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Called by the XNA Framework when importing an intermediate file to be used as a game </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> asset. This is the method called by the XNA Framework when an asset is to be imported </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> into an object that can be recognized by the Content Pipeline.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="filename"&gt;</span>Name of a game asset file.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="context"&gt;</span>Contains information for importing a game asset, such as a logger interface.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>The imported game asset.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">object</span> <span class="title">Import</span>(<span class="params"><span class="keyword">string</span> filename, ContentImporterContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> reader = XmlReader.Create(filename))</span><br><span class="line">                <span class="keyword">return</span> IntermediateSerializer.Deserialize&lt;<span class="keyword">object</span>&gt;(reader, filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>XmlImporter只是对IntermediateSerializer的一个简单封装. 关键在于IntermediateSerializer</p>
<blockquote>
<p>Provides methods for reading and writing XNA intermediate XML format.<br>上面那种带<xnacontent>标签的xml格式, 也叫做XNA intermediate XML format</xnacontent></p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Microsoft.Xna.Framework.Content.Pipeline.Serialization.Intermediate</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// The intermediate serializer implementation is based on testing XNA behavior and the following sources:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// http://msdn.microsoft.com/en-us/library/Microsoft.Xna.Framework.Content.Pipeline.Serialization.Intermediate.aspx</span></span><br><span class="line">    <span class="comment">// http://blogs.msdn.com/b/shawnhar/archive/2008/08/12/everything-you-ever-wanted-to-know-about-intermediateserializer.aspx</span></span><br><span class="line">    <span class="comment">// http://blogs.msdn.com/b/shawnhar/archive/2008/08/26/customizing-intermediateserializer-part-1.aspx</span></span><br><span class="line">    <span class="comment">// http://blogs.msdn.com/b/shawnhar/archive/2008/08/26/customizing-intermediateserializer-part-2.aspx</span></span><br><span class="line">    <span class="comment">// http://blogs.msdn.com/b/shawnhar/archive/2008/08/27/why-intermediateserializer-control-attributes-are-not-part-of-the-content-pipeline.aspx</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IntermediateSerializer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> T Deserialize&lt;T&gt;(XmlReader input, <span class="keyword">string</span> referenceRelocationPath)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> serializer = <span class="keyword">new</span> IntermediateSerializer();</span><br><span class="line">            <span class="keyword">var</span> reader = <span class="keyword">new</span> IntermediateReader(serializer, input, referenceRelocationPath);</span><br><span class="line">            <span class="keyword">var</span> asset = <span class="keyword">default</span>(T);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!reader.MoveToElement(<span class="string">"XnaContent"</span>))</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidContentException(<span class="keyword">string</span>.Format(<span class="string">"Could not find XnaContent element in '&#123;0&#125;'."</span>,</span><br><span class="line">                                                                    referenceRelocationPath));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Initialize the namespace lookups from</span></span><br><span class="line">                <span class="comment">// the attributes on the XnaContent element.</span></span><br><span class="line">                serializer.CreateNamespaceLookup(input);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Move past the XnaContent.</span></span><br><span class="line">                input.ReadStartElement();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Read the asset.</span></span><br><span class="line">                <span class="keyword">var</span> format = <span class="keyword">new</span> ContentSerializerAttribute &#123;ElementName = <span class="string">"Asset"</span>&#125;;</span><br><span class="line">                asset = reader.ReadObject&lt;T&gt;(format);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Process the shared resources and external references.</span></span><br><span class="line">                reader.ReadSharedResources();</span><br><span class="line">                reader.ReadExternalReferences();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Move past the closing XnaContent element.</span></span><br><span class="line">                input.ReadEndElement();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (XmlException xmlException)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> reader.NewInvalidContentException(xmlException, <span class="string">"An error occured parsing."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> asset;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里不具体分析IntermediateSerializer的实现, 可以猜测的是对各种类型的序列化和反序列化.<br>下图是Microsoft.Xna.Framework.Content.Pipeline.Serialization.Intermediate命名空间下的文件<br><img src="/img/monogame-contentpipeline-xml-3.png" alt=""><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MonoGame - Copyright (C) The MonoGame Team</span></span><br><span class="line"><span class="comment">// This file is subject to the terms and conditions defined in</span></span><br><span class="line"><span class="comment">// file 'LICENSE.txt', which is part of this source code package.</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Xml;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Microsoft.Xna.Framework.Content.Pipeline.Serialization.Intermediate</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ContentTypeSerializer</span>]</span><br><span class="line">    class Vector2Serializer : ElementSerializer&lt;Vector2&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Vector2Serializer</span>(<span class="params"></span>) :</span></span><br><span class="line"><span class="function">            <span class="title">base</span>(<span class="params"><span class="string">"Vector2"</span>, <span class="number">2</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">internal</span> <span class="keyword">override</span> Vector2 <span class="title">Deserialize</span>(<span class="params"><span class="keyword">string</span>[] inputs, <span class="keyword">ref</span> <span class="keyword">int</span> index</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Vector2( XmlConvert.ToSingle(inputs[index++]),</span><br><span class="line">                                XmlConvert.ToSingle(inputs[index++]));</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">internal</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Serialize</span>(<span class="params">Vector2 <span class="keyword">value</span>, List&lt;<span class="keyword">string</span>&gt; results</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            results.Add(XmlConvert.ToString(<span class="keyword">value</span>.X));</span><br><span class="line">            results.Add(XmlConvert.ToString(<span class="keyword">value</span>.Y));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>往上一层<br><img src="/img/monogame-contentpipeline-xml-4.png" alt=""><br>发现有一个Compiler, 进去一看<br><img src="/img/monogame-contentpipeline-xml-5.png" alt=""><br>可以对比下<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MonoGame - Copyright (C) The MonoGame Team</span></span><br><span class="line"><span class="comment">// This file is subject to the terms and conditions defined in</span></span><br><span class="line"><span class="comment">// file 'LICENSE.txt', which is part of this source code package.</span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> TOutput = Microsoft.Xna.Framework.Vector2;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Microsoft.Xna.Framework.Content.Pipeline.Serialization.Compiler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Writes the Vector2 value to the output.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">ContentTypeWriter</span>]</span><br><span class="line">    class Vector2Writer : BuiltInContentWriter&lt;TOutput&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Writes the value to the output.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="output"&gt;</span>The output writer object.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="value"&gt;</span>The value to write to the output.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">internal</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Write</span>(<span class="params">ContentWriter output, TOutput <span class="keyword">value</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            output.Write(<span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个Compiler文件夹下的Writer用于对Content Processor的输出进行序列化, 而Intermediate文件夹下的Serializer是用于XML Intermediate Format的序列化和反序列化. 所以说Content Pipeline对XML有特殊照顾</p>
<p>关于IntermediateSerializer, 推荐阅读XNA团队成员的系列文章:</p>
<p>Everything you ever wanted to know about IntermediateSerializer<br><a href="http://blogs.msdn.com/b/shawnhar/archive/2008/08/12/everything-you-ever-wanted-to-know-about-intermediateserializer.aspx" target="_blank" rel="noopener">http://blogs.msdn.com/b/shawnhar/archive/2008/08/12/everything-you-ever-wanted-to-know-about-intermediateserializer.aspx</a><br>讲了如何使用XNA intermediate XML format (XML中除了普通的数据, 还可以有shared resource和external resource)</p>
<p>IntermediateSerializer vs. XmlSerializer<br><a href="http://blogs.msdn.com/b/shawnhar/archive/2008/07/28/intermediateserializer-vs-xmlserializer.aspx" target="_blank" rel="noopener">http://blogs.msdn.com/b/shawnhar/archive/2008/07/28/intermediateserializer-vs-xmlserializer.aspx</a><br>讲了IntermediateSerializer的好处</p>
<p>XML and the Content Pipeline<br><a href="http://blogs.msdn.com/b/shawnhar/archive/2008/05/30/xml-and-the-content-pipeline.aspx" target="_blank" rel="noopener">http://blogs.msdn.com/b/shawnhar/archive/2008/05/30/xml-and-the-content-pipeline.aspx</a><br>讲了IntermediateSerializer的必要性</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/20/MonoGame笔记(十四)自定义Content Pipeline/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/20/MonoGame笔记(十四)自定义Content Pipeline/" itemprop="url">MonoGame笔记(十四)自定义Content Pipeline</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-20T09:31:37+08:00">
                2017-12-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>XNA内置的Importer和Processor已经很够满足大部分需求<br><img src="/img/monogame-contentpipeline-buildin-importer.png" alt=""><br><img src="/img/monogame-contentpipeline-buildin-processor.png" alt=""></p>
<p>关于自定义Content Pipeline, 官方的介绍最为简介明了<a href="https://msdn.microsoft.com/en-us/library/ff433775.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/ff433775.aspx</a></p>
<p>摘录如下:<br>自定义Content Pipeline有如下几种情形:</p>
<h4 id="1-Supporting-a-New-File-Format"><a href="#1-Supporting-a-New-File-Format" class="headerlink" title="1. Supporting a New File Format"></a>1. Supporting a New File Format</h4><p>In this example, a nonstandard file format contains information that can be represented by a standard Content DOM type.<br><img src="/img/monogame-contentpipeline-custom1.png" alt=""><br>As illustrated, only a custom importer that can read the nonstandard file format and output a Content DOM object (in this case, a TextureContent object) is required. The remainder of the Content Pipeline process can be performed by a standard content processor and content loader.</p>
<p>只需要增加一个自定义的Importer.<br>官方样例:ObjImpoter(<a href="http://xbox.create.msdn.com/en-us/education/catalog/sample/custom_model_importer" target="_blank" rel="noopener">http://xbox.create.msdn.com/en-us/education/catalog/sample/custom_model_importer</a>)</p>
<p>ObjImporter.cs的Import方法<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The importer's entry point.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Called by the framework when importing a game asset.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="filename"&gt;</span>Name of a game asset file.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="context"&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Contains information for importing a game asset, such as a logger interface.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Resulting game asset.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> NodeContent <span class="title">Import</span>(<span class="params"><span class="keyword">string</span> filename,</span></span></span><br><span class="line"><span class="function"><span class="params">    ContentImporterContext context</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Uncomment the following line to debug:</span></span><br><span class="line">    <span class="comment">//System.Diagnostics.Debugger.Launch();</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Store the context for use in other methods</span></span><br><span class="line">    importerContext = context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset all importer state</span></span><br><span class="line">    <span class="comment">// See field declarations for more information</span></span><br><span class="line">    rootNode = <span class="keyword">new</span> NodeContent();            </span><br><span class="line">    positions = <span class="keyword">new</span> List&lt;Vector3&gt;();</span><br><span class="line">    texCoords = <span class="keyword">new</span> List&lt;Vector2&gt;();</span><br><span class="line">    normals = <span class="keyword">new</span> List&lt;Vector3&gt;();</span><br><span class="line">    meshBuilder = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// StartMesh sets positionMap, textureCoordinateDataIndex, normalDataIndex</span></span><br><span class="line">    materials = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, MaterialContent&gt;();</span><br><span class="line">    <span class="comment">// ImportMaterials resets materialContent</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Model identity is tied to the file it is loaded from</span></span><br><span class="line">    rootNode.Identity = <span class="keyword">new</span> ContentIdentity(filename);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Loop over each tokenized line of the OBJ file</span></span><br><span class="line">        <span class="keyword">foreach</span> (String[] lineTokens <span class="keyword">in</span></span><br><span class="line">            GetLineTokens(filename, rootNode.Identity))</span><br><span class="line">        &#123;</span><br><span class="line">            ParseObjLine(lineTokens);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the file did not provide a model name (through an 'o' line),</span></span><br><span class="line">        <span class="comment">// then use the file name as a default</span></span><br><span class="line">        <span class="keyword">if</span> (rootNode.Name == <span class="literal">null</span>)</span><br><span class="line">            rootNode.Name = Path.GetFileNameWithoutExtension(filename);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Finish the last mesh</span></span><br><span class="line">        FinishMesh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Done with entire model!</span></span><br><span class="line">        <span class="keyword">return</span> rootNode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InvalidContentException)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// InvalidContentExceptions do not need further processing</span></span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Wrap exception with content identity (includes line number)</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidContentException(</span><br><span class="line">            <span class="string">"Unable to parse obj file. Exception:\n"</span> + e.Message,</span><br><span class="line">            rootNode.Identity, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2-Creating-Special-Purpose-Data-from-Standard-Objects"><a href="#2-Creating-Special-Purpose-Data-from-Standard-Objects" class="headerlink" title="2.Creating Special-Purpose Data from Standard Objects"></a>2.Creating Special-Purpose Data from Standard Objects</h4><p>For this example, a texture object that represents a map of normalized vectors derived from the original texture object is created<br><img src="/img/monogame-contentpipeline-custom2.png" alt=""></p>
<p>Since the texture is contained in a standard format for the game asset, a standard importer can be used to create the TextureContent object. A custom content processor (NormalMapProcessor) creates the special-purpose data, but uses the standard TextureContent class to contain the result so that it can be loaded by the standard content loader. </p>
<p>就是上一篇笔记中的扩展.<br>官方样例: Normal Mapping<br>(<a href="http://xbox.create.msdn.com/en-us/education/catalog/sample/normal_mapping" target="_blank" rel="noopener">http://xbox.create.msdn.com/en-us/education/catalog/sample/normal_mapping</a>)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The NormalMappingModelProcessor is used to change the material/effect applied</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> to a model. After going through this processor, the output model will be set</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> up to be rendered with NormalMapping.fx.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NormalMappingModelProcessor</span> : <span class="title">ModelProcessor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//override, 注意NormalMappingMaterialProcessor</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> MaterialContent <span class="title">ConvertMaterial</span>(<span class="params">MaterialContent material,</span></span></span><br><span class="line"><span class="function"><span class="params">            ContentProcessorContext context</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        EffectMaterialContent normalMappingMaterial = <span class="keyword">new</span> EffectMaterialContent();</span><br><span class="line">        normalMappingMaterial.Effect = <span class="keyword">new</span> ExternalReference&lt;EffectContent&gt;</span><br><span class="line">            (Path.Combine(directory, <span class="string">"NormalMapping.fx"</span>));</span><br><span class="line"></span><br><span class="line">        OpaqueDataDictionary processorParameters = <span class="keyword">new</span> OpaqueDataDictionary();</span><br><span class="line">        processorParameters[<span class="string">"ColorKeyColor"</span>] = <span class="keyword">this</span>.ColorKeyColor;</span><br><span class="line">        processorParameters[<span class="string">"ColorKeyEnabled"</span>] = <span class="keyword">this</span>.ColorKeyEnabled;</span><br><span class="line">        processorParameters[<span class="string">"TextureFormat"</span>] = <span class="keyword">this</span>.TextureFormat;</span><br><span class="line">        processorParameters[<span class="string">"GenerateMipmaps"</span>] = <span class="keyword">this</span>.GenerateMipmaps;</span><br><span class="line">        processorParameters[<span class="string">"ResizeTexturesToPowerOfTwo"</span>] =</span><br><span class="line">                                                    <span class="keyword">this</span>.ResizeTexturesToPowerOfTwo;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// copy the textures in the original material to the new normal mapping</span></span><br><span class="line">        <span class="comment">// material. this way the diffuse texture is preserved. The</span></span><br><span class="line">        <span class="comment">// PreprocessSceneHierarchy function has already added the normal map</span></span><br><span class="line">        <span class="comment">// texture to the Textures collection, so that will be copied as well.</span></span><br><span class="line">        <span class="keyword">foreach</span> (KeyValuePair&lt;String, ExternalReference&lt;TextureContent&gt;&gt; texture</span><br><span class="line">            <span class="keyword">in</span> material.Textures)</span><br><span class="line">        &#123;</span><br><span class="line">            normalMappingMaterial.Textures.Add(texture.Key, texture.Value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// and convert the material using the NormalMappingMaterialProcessor,</span></span><br><span class="line">        <span class="comment">// who has something special in store for the normal map.</span></span><br><span class="line">        <span class="keyword">return</span> context.Convert&lt;MaterialContent, MaterialContent&gt;</span><br><span class="line">            (normalMappingMaterial, <span class="keyword">typeof</span>(NormalMappingMaterialProcessor).Name,</span><br><span class="line">            processorParameters);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The NormalMappingMaterialProcessor is very simple.  It extends the regular</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MaterialProcessor, overriding BuildTexture so that normal maps can go through</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> the NormalMapTextureProcessor and be converted to a signed normalmap format.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ContentProcessor</span>]</span><br><span class="line">[<span class="meta">DesignTimeVisible(false)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NormalMappingMaterialProcessor</span> : <span class="title">MaterialProcessor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//注意NormalMapTextureProcessor</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">override</span> ExternalReference&lt;TextureContent&gt; BuildTexture</span><br><span class="line">        (<span class="keyword">string</span> textureName, ExternalReference&lt;TextureContent&gt; texture,</span><br><span class="line">        ContentProcessorContext context)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (textureName == NormalMappingModelProcessor.NormalMapKey)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// put the normal map through the special NormalMapTextureProcessor,</span></span><br><span class="line">            <span class="comment">// which will convert it to a signed format.</span></span><br><span class="line">            <span class="keyword">return</span> context.BuildAsset&lt;TextureContent, TextureContent&gt;(texture,</span><br><span class="line">                <span class="keyword">typeof</span>(NormalMapTextureProcessor).Name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Apply default processing to all other textures.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">base</span>.BuildTexture(textureName, texture, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NormalMappingModelProcessor内部引用了NormalMappingMaterialProcessor, 后者内部又引用NormalMapTextureProcessor. 这种依赖关系可以参见下图:<br><img src="/img/monogame-contentpipeline-processor-dependency.jpeg" alt=""></p>
<h4 id="3-Supporting-Custom-Data-from-a-Nonstandard-Game-Asset"><a href="#3-Supporting-Custom-Data-from-a-Nonstandard-Game-Asset" class="headerlink" title="3.Supporting Custom Data from a Nonstandard Game Asset"></a>3.Supporting Custom Data from a Nonstandard Game Asset</h4><p>Illustrated in this example is a nonstandard game asset file containing data that does not correspond to any standard data types.<br><img src="/img/monogame-contentpipeline-custom3.png" alt=""><br>To read the nonstandard game asset file, a custom importer is required that outputs a CustomContent object. Since the output of the importer is a custom class, a custom content processor also is needed, and the ContentManager.Load method must be extended to support the custom data object.</p>
<p>这个相对比较复杂一些.</p>
<p>官方样例: Creating a Custom Importer and Processor (<a href="https://msdn.microsoft.com/en-us/library/bb447754.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/bb447754.aspx</a>)</p>
<blockquote>
<p>The goal of the example in this tutorial is to import a pixel shader (in a file with the .psh extension), and to produce compiled effect data that can be assigned to an instance of Effect.</p>
</blockquote>
<p>这里就不贴代码了.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/20/MonoGame笔记(十三)扩展Content Pipeline/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/20/MonoGame笔记(十三)扩展Content Pipeline/" itemprop="url">MonoGame笔记(十三)扩展Content Pipeline</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-20T08:45:37+08:00">
                2017-12-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇笔记提到Content Pipeline可以自定义和扩展. 扩展相对简单一些. <strong>XNA 3.0 Game Programming Recipes-A Problem-Solution Approach</strong> 3.9和3.10两节介绍了对Texture2D Processor的扩展, 可以一窥究竟.<br>摘录如下:</p>
<h3 id="3-9-Extend-the-Image-Content-Processor"><a href="#3-9-Extend-the-Image-Content-Processor" class="headerlink" title="3-9. Extend the Image Content Processor"></a>3-9. Extend the Image Content Processor</h3><p><img src="/img/monogame-contentpipeline-process-another.png" alt=""></p>
<p>对Texture2D Processor进行扩展<br><img src="/img/monogame-contentpipeline-process-extend.png" alt=""></p>
<p>如果我们想要替换图像中的某种颜色, 可以这样做:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">MyImagePipeline</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ContentProcessor(DisplayName = <span class="meta-string">"ExtendedExample"</span>)</span>] </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExtentedTextureProcessor</span> : <span class="title">TextureProcessor</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> TextureContent <span class="title">Process</span>(<span class="params">TextureContent input, ContentProcessorContext context</span>) </span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            TextureContent texContent = <span class="keyword">base</span>.Process(input, context); </span><br><span class="line">            texContent.ConvertBitmapType(<span class="keyword">typeof</span>(PixelBitmapContent&lt;Color&gt;)); </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> face = <span class="number">0</span>; face &lt; texContent.Faces.Count; face++) </span><br><span class="line">            &#123; </span><br><span class="line">                MipmapChain mipChain = texContent.Faces[face]; </span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> mipLevel = <span class="number">0</span>; mipLevel &lt; mipChain.Count; mipLevel++) </span><br><span class="line">                &#123; </span><br><span class="line">                    PixelBitmapContent&lt;Color&gt; image = (PixelBitmapContent&lt;Color&gt;) input.Faces[face][mipLevel]; </span><br><span class="line">                    image.ReplaceColor(Color.Black, Color.White); </span><br><span class="line">                &#125;</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">return</span> texContent; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Faces属性的第一个索引是图像的face. 标准2D图像只有一个face，而立方纹理有六个face。第二个索引是mipmap level，不使用mipmap的图像只有一个level。上面这段代码对纹理的每个face的每个mipmap level中的黑色变成白色</p>
<p><img src="/img/monogame-contentpipeline-process-extend-panel.png" alt=""></p>
<h3 id="3-10-Extend-the-Image-Content-Processor-Grayscale-Conversion-and-Processor-Parameters"><a href="#3-10-Extend-the-Image-Content-Processor-Grayscale-Conversion-and-Processor-Parameters" class="headerlink" title="3-10. Extend the Image Content Processor: Grayscale Conversion and Processor Parameters"></a>3-10. Extend the Image Content Processor: Grayscale Conversion and Processor Parameters</h3><p>3-9简单地用新颜色值替换旧颜色值。对于很多图像处理技术来说，还需要获取像素的RGBA值进行计算,可能还会有外部输入参数. 下面这段代码对原图进行灰化, 并且提供了一个插值参数.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">GrayContentPipeline</span> </span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ContentProcessor(DisplayName = <span class="meta-string">"GrayScaleProcessor"</span>)</span>] </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExtentedTextureProcessor</span> : <span class="title">TextureProcessor</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> interpolation = <span class="number">0.8f</span>; </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">float</span> Interpolation </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> interpolation; &#125; </span><br><span class="line">            <span class="keyword">set</span> &#123; interpolation = <span class="keyword">value</span>; &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> TextureContent <span class="title">Process</span>(<span class="params">TextureContent input, ContentProcessorContext context</span>) </span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            TextureContent texContent = <span class="keyword">base</span>.Process(input, context); </span><br><span class="line">            texContent.ConvertBitmapType(<span class="keyword">typeof</span>(PixelBitmapContent&lt;Color&gt;)); </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> face = <span class="number">0</span>; face &lt; input.Faces.Count; face++) </span><br><span class="line">            &#123;</span><br><span class="line">                MipmapChain mipChain = input.Faces[face]; </span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> mipLevel = <span class="number">0</span>; mipLevel &lt; mipChain.Count; mipLevel++) </span><br><span class="line">                &#123;</span><br><span class="line">                    PixelBitmapContent&lt;Color&gt; oldImage = PixelBitmapContent&lt;Color&gt;)input.Faces[face][mipLevel]; </span><br><span class="line">                    PixelBitmapContent&lt;Vector4&gt; grayImage = <span class="keyword">new</span> PixelBitmapContent&lt;Vector4&gt; (oldImage.Width, oldImage.Height); </span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; oldImage.Width; x++) </span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; oldImage.Height; y++) </span><br><span class="line">                        &#123;</span><br><span class="line">                            Color oldColor = oldImage.GetPixel(x, y); </span><br><span class="line">                            <span class="keyword">float</span> grayValue = oldColor.R * <span class="number">0.299f</span> / <span class="number">255.0f</span>; </span><br><span class="line">                            grayValue += oldColor.G * <span class="number">0.596f</span> / <span class="number">255.0f</span>; </span><br><span class="line">                            grayValue += oldColor.B * <span class="number">0.211f</span> / <span class="number">255.0f</span>; </span><br><span class="line">                            <span class="keyword">float</span> alpha = oldColor.A / <span class="number">255.0f</span>; </span><br><span class="line">                            Vector4 grayColor = <span class="keyword">new</span> Vector4(grayValue,grayValue, grayValue, alpha); </span><br><span class="line">                            Vector4 origColor = oldColor.ToVector4(); </span><br><span class="line">                            Vector4 newColor = Vector4.Lerp(origColor, grayColor, interpolation);</span><br><span class="line">                            grayImage.SetPixel(x, y, newColor); </span><br><span class="line">                        &#125; </span><br><span class="line">                        input.Faces[face][mipLevel] = grayImage; </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> texContent; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Interpolation作为公共属性, 会显示在属性面板上<br><img src="/img/monogame-contentpipeline-process-extend-panel-2.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/19/MonoGame笔记(十二)Content Pipeline/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/19/MonoGame笔记(十二)Content Pipeline/" itemprop="url">MonoGame笔记(十二)Content Pipeline介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-19T13:29:37+08:00">
                2017-12-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>游戏中除了代码就是资源. 代码本身也是一种资源(Unity3D中代码和资源都被组织在Asset目录下). Unity3D属于All in One, Flash有强大的Flash CS编辑资源, 而XNA也有Content Pipeline, 集成在XNA Game Studio中, 通过属性面板的方式, 设置各个参数. 如下图所示:<br><img src="/img/monogame-contentpipeline-panel.png" alt=""><br>其中Mipmaps和Resize to Power of two在Unity3D中对Sprite进行设置时也有</p>
<p>使用Content Pipeline的好处是什么?官方介绍如下: <a href="https://msdn.microsoft.com/en-us/library/bb447756.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/bb447756.aspx</a></p>
<p>The <strong>chief</strong> reason XNA Game Studio uses a Content Pipeline is to help your game run fast. Without the content pipeline, your game would have to be built with its art assets in their original file format. When the game needs to load its art to draw it on the screen, it would have to determine its format and convert the data into a form it can use more directly. This would have to be performed at run time, for each asset, making the player wait to have fun.</p>
<p>The Content Pipeline remedies this by shifting this time-consuming work to when the game is built. At build time, each asset is imported from its original file format and processed into a managed code object. Those objects are then serialized to a file that is included in the game’s executable.</p>
<p>At run time, the game can then read the serialized data from the file directly into a managed code object for immediate use.</p>
<p>从分工上:</p>
<p>The Content Pipeline is designed to help you include such art assets in your game easily and automatically. An artist working on a a car model can add the resulting file to the XNA Game Studio Express game project, assign the model a name, and choose an importer and content processor for it. Then, a developer who wants to make the car drive can load it by name using a call to ContentManager.Load. This simple flow lets the artist focus on creating assets and the developer focus on using them, without either having to spend time worrying about content transformation.实际上程序员还是要花不少时间在处理资源上, 尤其是重新排列资源的组织方式</p>
<p>下图是Content Pipeline处理过程(<a href="https://msdn.microsoft.com/en-us/library/bb447745.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/bb447745.aspx</a>)<br><img src="/img/monogame-contentpipeline-process.png" alt=""><br>其中Importer和Content Processor属于Design-Time Components, Content Loader属于Runtime Components. </p>
<p>Importer将资源导入到XNA Game Studio中, 以Texture为例, 它的作用是对各类图像格式去差异化, 生成一个统一的Texture对象, 供Processor去处理.</p>
<p>Processor对Importer生成的资源对象进行处理, 以Texture为例, 生成Mipmap等等</p>
<p>Design-Time是指在属性面板中选择合适的Content Importer和Content Processor, 然后build, 生成xnb二进制文件.该文件可以在运行时被加载. 资源源文件不需要和游戏一起发布.Runtime是指游戏运行时. 上图中的Intermediate Format是指.xnb文件. </p>
<p>上图还缺少两个东西: 序列化和反序列化. 前者用于将Content Processor输出的内容序列化成xnb二进制文件, 后者将xnb文件反序列化成相应的对象. 序列化器属于Design-Time, 反序列化器属于RunTime, 体现在代码上就是二者所属的命名空间不同, 前者是namespace Microsoft.Xna.Framework.Content.Pipeline, 后者是namespace Microsoft.Xna.Framework</p>
<p>更详细的过程如下图所示:<a href="https://msdn.microsoft.com/zh-cn/library/bb447745(v=xnagamestudio.10)" target="_blank" rel="noopener">https://msdn.microsoft.com/zh-cn/library/bb447745(v=xnagamestudio.10)</a><br><img src="/img/monogame-contentpipeline-process-detail.png" alt=""></p>
<p>Content Pipeline还可以进行自定义和扩展, 以支持新的资源格式, 或者对原有的Content Processor进行增强. 关于自定义和扩展, 官方的一个概略性介绍如下:</p>
<ul>
<li>XNA Game Studio Express supplies standard importers and processors for a number of popular DCC file formats (see Standard Importers and Processors).</li>
<li>Third parties also create custom importers and processors for XNA Game Studio Express to support additional formats.</li>
<li>If you have enough information about a DCC file format, you can write your own custom importer and processor for it using classes provided by the Content Pipeline class library (see Writing a Custom Importer).</li>
<li>When you include an art asset file in your XNA Game Studio Express game project, you use its Properties sheet to specify the importer and processor that is appropriate to it. Thereafter, when you press F5 to build your game, the proper importer and processor for each asset is automatically invoked, and the asset is built into your game in a form that can be loaded at run time on Windows or the Xbox 360 by using <strong>ContentManager.Load</strong>. ContentManager.Load会寻找合适的ContentTypeReader, 将xnb文件反序列化成对象, 例如Texture2D, SpriteFont等</li>
</ul>
<p>进一步的自定义和扩展介绍, 见后面的笔记.</p>
<p>以最常用的Texture2D为例, 看看各个组成部分到底是什么样子.</p>
<h4 id="Importer"><a href="#Importer" class="headerlink" title="Importer"></a>Importer</h4><p>Importer加载各种图像原文件, 生成一个统一的TextureContent供Processor使用.<br>不同的图像格式, 有些是RGBA, 有些是BGRA等等, 去差异化<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MonoGame - Copyright (C) The MonoGame Team</span></span><br><span class="line"><span class="comment">// This file is subject to the terms and conditions defined in</span></span><br><span class="line"><span class="comment">// file 'LICENSE.txt', which is part of this source code package.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Graphics;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Content.Pipeline.Graphics;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Graphics.PackedVector;</span><br><span class="line"><span class="keyword">using</span> FreeImageAPI;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Microsoft.Xna.Framework.Content.Pipeline</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Provides methods for reading texture files for use in the Content Pipeline.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Texture支持大部分常用的图片格式</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">ContentImporter(<span class="meta-string">".bmp"</span>, // Bitmap Image File</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".cut"</span>, // Dr Halo CUT</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".dds"</span>, // Direct Draw Surface</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".g3"</span>, // Raw Fax G3</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".hdr"</span>, // RGBE</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".gif"</span>, // Graphcis Interchange Format</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".ico"</span>, // Microsoft Windows Icon</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".iff"</span>, // Interchange File Format</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".jbg"</span>, <span class="meta-string">".jbig"</span>, // JBIG</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".jng"</span>, <span class="meta-string">".jpg"</span>, <span class="meta-string">".jpeg"</span>, <span class="meta-string">".jpe"</span>, <span class="meta-string">".jif"</span>, <span class="meta-string">".jfif"</span>, <span class="meta-string">".jfi"</span>, // JPEG</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".jp2"</span>, <span class="meta-string">".j2k"</span>, <span class="meta-string">".jpf"</span>, <span class="meta-string">".jpx"</span>, <span class="meta-string">".jpm"</span>, <span class="meta-string">".mj2"</span>, // JPEG 2000</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".jxr"</span>, <span class="meta-string">".hdp"</span>, <span class="meta-string">".wdp"</span>, // JPEG XR</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".koa"</span>, <span class="meta-string">".gg"</span>, // Koala</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".pcd"</span>, // Kodak PhotoCD</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".mng"</span>, // Multiple-Image Network Graphics</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".pcx"</span>, //Personal Computer Exchange</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".pbm"</span>, <span class="meta-string">".pgm"</span>, <span class="meta-string">".ppm"</span>, <span class="meta-string">".pnm"</span>, // Netpbm</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".pfm"</span>, // Printer Font Metrics</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".png"</span>, //Portable Network Graphics</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".pict"</span>, <span class="meta-string">".pct"</span>, <span class="meta-string">".pic"</span>, // PICT</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".psd"</span>, // Photoshop</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".3fr"</span>, <span class="meta-string">".ari"</span>, <span class="meta-string">".arw"</span>, <span class="meta-string">".bay"</span>, <span class="meta-string">".crw"</span>, <span class="meta-string">".cr2"</span>, <span class="meta-string">".cap"</span>, <span class="meta-string">".dcs"</span>, // RAW</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".dcr"</span>, <span class="meta-string">".dng"</span>, <span class="meta-string">".drf"</span>, <span class="meta-string">".eip"</span>, <span class="meta-string">".erf"</span>, <span class="meta-string">".fff"</span>, <span class="meta-string">".iiq"</span>, <span class="meta-string">".k25"</span>, // RAW</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".kdc"</span>, <span class="meta-string">".mdc"</span>, <span class="meta-string">".mef"</span>, <span class="meta-string">".mos"</span>, <span class="meta-string">".mrw"</span>, <span class="meta-string">".nef"</span>, <span class="meta-string">".nrw"</span>, <span class="meta-string">".obm"</span>, // RAW</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".orf"</span>, <span class="meta-string">".pef"</span>, <span class="meta-string">".ptx"</span>, <span class="meta-string">".pxn"</span>, <span class="meta-string">".r3d"</span>, <span class="meta-string">".raf"</span>, <span class="meta-string">".raw"</span>, <span class="meta-string">".rwl"</span>, // RAW</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".rw2"</span>, <span class="meta-string">".rwz"</span>, <span class="meta-string">".sr2"</span>, <span class="meta-string">".srf"</span>, <span class="meta-string">".srw"</span>, <span class="meta-string">".x3f"</span>, // RAW</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".ras"</span>, <span class="meta-string">".sun"</span>, // Sun RAS</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".sgi"</span>, <span class="meta-string">".rgba"</span>, <span class="meta-string">".bw"</span>, <span class="meta-string">".int"</span>, <span class="meta-string">".inta"</span>, // Silicon Graphics Image</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".tga"</span>, // Truevision TGA/TARGA</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".tiff"</span>, <span class="meta-string">".tif"</span>, // Tagged Image File Format</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".wbmp"</span>, // Wireless Application Protocol Bitmap Format</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".webp"</span>, // WebP</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".xbm"</span>, // X BitMap</span></span><br><span class="line"><span class="meta">                        <span class="meta-string">".xpm"</span>, // X PixMap</span></span><br><span class="line"><span class="meta">                    DisplayName = <span class="meta-string">"Texture Importer - MonoGame"</span>, DefaultProcessor = <span class="meta-string">"TextureProcessor"</span>)</span>]</span><br><span class="line">    public class TextureImporter : ContentImporter&lt;TextureContent&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Initializes a new instance of TextureImporter.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TextureImporter</span>(<span class="params"> </span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Called by the XNA Framework when importing a texture file to be used as a game asset. This is the method called by the XNA Framework when an asset is to be imported into an object that can be recognized by the Content Pipeline.该方法是被XNA Framework调用的. FreeImage是一个第三方图像库</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="filename"&gt;</span>Name of a game asset file.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="context"&gt;</span>Contains information for importing a game asset, such as a logger interface.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Resulting game asset.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> TextureContent <span class="title">Import</span>(<span class="params"><span class="keyword">string</span> filename, ContentImporterContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Special case for loading DDS</span></span><br><span class="line">            <span class="keyword">if</span> (filename.ToLower().EndsWith(<span class="string">".dds"</span>))</span><br><span class="line">                <span class="keyword">return</span> DdsLoader.Import(filename, context);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> output = <span class="keyword">new</span> Texture2DContent &#123; Identity = <span class="keyword">new</span> ContentIdentity(filename) &#125;;</span><br><span class="line"></span><br><span class="line">            FREE_IMAGE_FORMAT format = FREE_IMAGE_FORMAT.FIF_UNKNOWN;</span><br><span class="line">            <span class="keyword">var</span> fBitmap = FreeImage.LoadEx(filename, FREE_IMAGE_LOAD_FLAGS.DEFAULT, <span class="keyword">ref</span> format);</span><br><span class="line">            <span class="comment">//if freeimage can not recognize the image type</span></span><br><span class="line">            <span class="keyword">if</span>(format == FREE_IMAGE_FORMAT.FIF_UNKNOWN)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ContentLoadException(<span class="string">"TextureImporter failed to load '"</span> + filename + <span class="string">"'"</span>);</span><br><span class="line">            <span class="comment">//if freeimage can recognize the file headers but can't read its contents</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(fBitmap.IsNull)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidContentException(<span class="string">"TextureImporter couldn't understand the contents of '"</span> + filename + <span class="string">"'"</span>, output.Identity);</span><br><span class="line">            BitmapContent face = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">var</span> height = (<span class="keyword">int</span>) FreeImage.GetHeight(fBitmap);</span><br><span class="line">            <span class="keyword">var</span> width = (<span class="keyword">int</span>) FreeImage.GetWidth(fBitmap);</span><br><span class="line">            <span class="comment">//uint bpp = FreeImage.GetBPP(fBitmap);</span></span><br><span class="line">            <span class="keyword">var</span> imageType = FreeImage.GetImageType(fBitmap);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Swizzle channels and expand to include an alpha channel</span></span><br><span class="line">            fBitmap = ConvertAndSwapChannels(fBitmap, imageType);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The bits per pixel and image type may have changed</span></span><br><span class="line">            <span class="keyword">uint</span> bpp = FreeImage.GetBPP(fBitmap);</span><br><span class="line">            imageType = FreeImage.GetImageType(fBitmap);</span><br><span class="line">            <span class="keyword">var</span> pitch = (<span class="keyword">int</span>) FreeImage.GetPitch(fBitmap);</span><br><span class="line">            <span class="keyword">var</span> redMask = FreeImage.GetRedMask(fBitmap);</span><br><span class="line">            <span class="keyword">var</span> greenMask = FreeImage.GetGreenMask(fBitmap);</span><br><span class="line">            <span class="keyword">var</span> blueMask = FreeImage.GetBlueMask(fBitmap);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create the byte array for the data</span></span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[((width * height * bpp - <span class="number">1</span>) / <span class="number">8</span>) + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Converts the pixel data to bytes, do not try to use this call to switch the color channels because that only works for 16bpp bitmaps</span></span><br><span class="line">            FreeImage.ConvertToRawBits(bytes, fBitmap, pitch, bpp, redMask, greenMask, blueMask, <span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// Create the Pixel bitmap content depending on the image type</span></span><br><span class="line">            <span class="keyword">switch</span>(imageType)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//case FREE_IMAGE_TYPE.FIT_BITMAP:</span></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    face = <span class="keyword">new</span> PixelBitmapContent&lt;Color&gt;(width, height);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> FREE_IMAGE_TYPE.FIT_RGBA16:</span><br><span class="line">                    face = <span class="keyword">new</span> PixelBitmapContent&lt;Rgba64&gt;(width, height);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> FREE_IMAGE_TYPE.FIT_RGBAF:</span><br><span class="line">                    face = <span class="keyword">new</span> PixelBitmapContent&lt;Vector4&gt;(width, height);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            FreeImage.UnloadEx(<span class="keyword">ref</span> fBitmap);</span><br><span class="line"></span><br><span class="line">            face.SetPixelData(bytes);</span><br><span class="line">            output.Faces[<span class="number">0</span>].Add(face);</span><br><span class="line">            <span class="keyword">return</span> output;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Expands images to have an alpha channel and swaps red and blue channels</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="fBitmap"&gt;</span>Image to process<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="imageType"&gt;</span>Type of the image for the procedure<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> FIBITMAP <span class="title">ConvertAndSwapChannels</span>(<span class="params">FIBITMAP fBitmap, FREE_IMAGE_TYPE imageType</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            FIBITMAP bgra;</span><br><span class="line">            <span class="keyword">switch</span>(imageType)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// RGBF are switched before adding an alpha channel.</span></span><br><span class="line">                <span class="keyword">case</span> FREE_IMAGE_TYPE.FIT_RGBF:</span><br><span class="line">                    <span class="comment">// Swap R and B channels to make it BGR, then add an alpha channel</span></span><br><span class="line">                    SwitchRedAndBlueChannels(fBitmap);</span><br><span class="line">                    bgra = FreeImage.ConvertToType(fBitmap, FREE_IMAGE_TYPE.FIT_RGBAF, <span class="literal">true</span>);</span><br><span class="line">                    FreeImage.UnloadEx(<span class="keyword">ref</span> fBitmap);</span><br><span class="line">                    fBitmap = bgra;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> FREE_IMAGE_TYPE.FIT_RGB16:</span><br><span class="line">                    <span class="comment">// Swap R and B channels to make it BGR, then add an alpha channel</span></span><br><span class="line">                    SwitchRedAndBlueChannels(fBitmap);</span><br><span class="line">                    bgra = FreeImage.ConvertToType(fBitmap, FREE_IMAGE_TYPE.FIT_RGBA16, <span class="literal">true</span>);</span><br><span class="line">                    FreeImage.UnloadEx(<span class="keyword">ref</span> fBitmap);</span><br><span class="line">                    fBitmap = bgra;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> FREE_IMAGE_TYPE.FIT_RGBAF:</span><br><span class="line">                <span class="keyword">case</span> FREE_IMAGE_TYPE.FIT_RGBA16:</span><br><span class="line">                    <span class="comment">//Don't switch channels in this case or colors will be shown wrong</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="comment">// Bitmap and other formats are converted to 32-bit by default</span></span><br><span class="line">                    bgra = FreeImage.ConvertTo32Bits(fBitmap);</span><br><span class="line">                    SwitchRedAndBlueChannels(bgra);</span><br><span class="line">                    FreeImage.UnloadEx(<span class="keyword">ref</span> fBitmap);</span><br><span class="line">                    fBitmap = bgra;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> fBitmap;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Switches the red and blue channels</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="fBitmap"&gt;</span>image<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SwitchRedAndBlueChannels</span>(<span class="params">FIBITMAP fBitmap</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> r = FreeImage.GetChannel(fBitmap, FREE_IMAGE_COLOR_CHANNEL.FICC_RED);</span><br><span class="line">            <span class="keyword">var</span> b = FreeImage.GetChannel(fBitmap, FREE_IMAGE_COLOR_CHANNEL.FICC_BLUE);</span><br><span class="line">            FreeImage.SetChannel(fBitmap, b, FREE_IMAGE_COLOR_CHANNEL.FICC_RED);</span><br><span class="line">            FreeImage.SetChannel(fBitmap, r, FREE_IMAGE_COLOR_CHANNEL.FICC_BLUE);</span><br><span class="line">            FreeImage.UnloadEx(<span class="keyword">ref</span> r);</span><br><span class="line">            FreeImage.UnloadEx(<span class="keyword">ref</span> b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="TextureProcessor"><a href="#TextureProcessor" class="headerlink" title="TextureProcessor"></a>TextureProcessor</h4><p>Processor中的Public属性会显示在属性面板上<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MonoGame - Copyright (C) The MonoGame Team</span></span><br><span class="line"><span class="comment">// This file is subject to the terms and conditions defined in</span></span><br><span class="line"><span class="comment">// file 'LICENSE.txt', which is part of this source code package.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Content.Pipeline.Graphics;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Graphics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Microsoft.Xna.Framework.Content.Pipeline.Processors</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ContentProcessor(DisplayName=<span class="meta-string">"Texture - MonoGame"</span>)</span>]</span><br><span class="line">    public class TextureProcessor : ContentProcessor&lt;TextureContent, TextureContent&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TextureProcessor</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            ColorKeyColor = <span class="keyword">new</span> Color(<span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>);</span><br><span class="line">            ColorKeyEnabled = <span class="literal">true</span>;</span><br><span class="line">            PremultiplyAlpha = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">DefaultValueAttribute(typeof(Color), <span class="meta-string">"255,0,255,255"</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">virtual</span> Color ColorKeyColor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">DefaultValueAttribute(true)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">bool</span> ColorKeyEnabled &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">bool</span> GenerateMipmaps &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">DefaultValueAttribute(true)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">bool</span> PremultiplyAlpha &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">bool</span> ResizeToPowerOfTwo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">bool</span> MakeSquare &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">virtual</span> TextureProcessorOutputFormat TextureFormat &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> TextureContent <span class="title">Process</span>(<span class="params">TextureContent input, ContentProcessorContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            SurfaceFormat format;</span><br><span class="line">            <span class="keyword">if</span> (input.Faces[<span class="number">0</span>][<span class="number">0</span>].TryGetFormat(<span class="keyword">out</span> format))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// If it is already a compressed format, we cannot do anything else so just return it</span></span><br><span class="line">                <span class="keyword">if</span> (format.IsCompressedFormat())</span><br><span class="line">                    <span class="keyword">return</span> input;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ColorKeyEnabled || ResizeToPowerOfTwo || MakeSquare || PremultiplyAlpha)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Convert to floating point format for modifications. Keep the original format for conversion back later on if required.</span></span><br><span class="line">                <span class="keyword">var</span> originalType = input.Faces[<span class="number">0</span>][<span class="number">0</span>].GetType();</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    input.ConvertBitmapType(<span class="keyword">typeof</span>(PixelBitmapContent&lt;Vector4&gt;));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    context.Logger.LogImportantMessage(<span class="string">"Could not convert input texture for processing. "</span> + ex.ToString());</span><br><span class="line">                    <span class="keyword">throw</span> ex; </span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> f = <span class="number">0</span>; f &lt; input.Faces.Count; ++f)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> face = input.Faces[f];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> m = <span class="number">0</span>; m &lt; face.Count; ++m)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">var</span> bmp = (PixelBitmapContent&lt;Vector4&gt;)face[m];</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (ColorKeyEnabled)</span><br><span class="line">                        &#123;</span><br><span class="line">                            bmp.ReplaceColor(ColorKeyColor.ToVector4(), Vector4.Zero);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (ResizeToPowerOfTwo)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!GraphicsUtil.IsPowerOfTwo(bmp.Width) || !GraphicsUtil.IsPowerOfTwo(bmp.Height) || (MakeSquare &amp;&amp; bmp.Height != bmp.Width))</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">var</span> newWidth = GraphicsUtil.GetNextPowerOfTwo(bmp.Width);</span><br><span class="line">                                <span class="keyword">var</span> newHeight = GraphicsUtil.GetNextPowerOfTwo(bmp.Height);</span><br><span class="line">                                <span class="keyword">if</span> (MakeSquare)</span><br><span class="line">                                    newWidth = newHeight = Math.Max(newWidth, newHeight);</span><br><span class="line">                                <span class="keyword">var</span> resized = <span class="keyword">new</span> PixelBitmapContent&lt;Vector4&gt;(newWidth, newHeight);</span><br><span class="line">                                BitmapContent.Copy(bmp, resized);</span><br><span class="line">                                bmp = resized;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (MakeSquare &amp;&amp; bmp.Height != bmp.Width)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">var</span> newSize = Math.Max(bmp.Width, bmp.Height);</span><br><span class="line">                            <span class="keyword">var</span> resized = <span class="keyword">new</span> PixelBitmapContent&lt;Vector4&gt;(newSize, newSize);</span><br><span class="line">                            BitmapContent.Copy(bmp, resized);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (PremultiplyAlpha)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; bmp.Height; ++y)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">var</span> row = bmp.GetRow(y);</span><br><span class="line">                                <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; bmp.Width; ++x)</span><br><span class="line">                                    row[x] = Color.FromNonPremultiplied(row[x]).ToVector4();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        face[m] = bmp;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If no change to the surface format was desired, change it back now before it early outs</span></span><br><span class="line">                <span class="keyword">if</span> (TextureFormat == TextureProcessorOutputFormat.NoChange)</span><br><span class="line">                    input.ConvertBitmapType(originalType);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get the texture profile for the platform and let it convert the texture.</span></span><br><span class="line">            <span class="keyword">var</span> texProfile = TextureProfile.ForPlatform(context.TargetPlatform);</span><br><span class="line">            texProfile.ConvertTexture(context, input, TextureFormat, GenerateMipmaps, <span class="literal">false</span>);	</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> input;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h4><p>注意它所属的命名空间. Serialization下面除了Compiler, 还有一个Serializer, 二者之间的差异见后面的笔记<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MonoGame - Copyright (C) The MonoGame Team</span></span><br><span class="line"><span class="comment">// This file is subject to the terms and conditions defined in</span></span><br><span class="line"><span class="comment">// file 'LICENSE.txt', which is part of this source code package.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Content.Pipeline.Graphics;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Graphics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Microsoft.Xna.Framework.Content.Pipeline.Serialization.Compiler</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ContentTypeWriter</span>]</span><br><span class="line">    class Texture2DWriter : BuiltInContentWriter&lt;Texture2DContent&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">internal</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Write</span>(<span class="params">ContentWriter output, Texture2DContent <span class="keyword">value</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> mipmaps = <span class="keyword">value</span>.Faces[<span class="number">0</span>];   <span class="comment">// Mipmap chain.</span></span><br><span class="line">            <span class="keyword">var</span> level0 = mipmaps[<span class="number">0</span>];        <span class="comment">// Most detailed mipmap level.</span></span><br><span class="line"></span><br><span class="line">            SurfaceFormat format;</span><br><span class="line">            <span class="keyword">if</span> (!level0.TryGetFormat(<span class="keyword">out</span> format))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Couldn't get Format for TextureContent."</span>);</span><br><span class="line"></span><br><span class="line">            output.Write((<span class="keyword">int</span>)format);</span><br><span class="line">            output.Write(level0.Width);</span><br><span class="line">            output.Write(level0.Height);</span><br><span class="line">            output.Write(mipmaps.Count);    <span class="comment">// Number of mipmap levels.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> level <span class="keyword">in</span> mipmaps)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> pixelData = level.GetPixelData();</span><br><span class="line">                output.Write(pixelData.Length);</span><br><span class="line">                output.Write(pixelData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h4><p>注意该类的位置是在framework中, 不在content pipeline中,<br>因为该类是运行时用到的<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MonoGame - Copyright (C) The MonoGame Team</span></span><br><span class="line"><span class="comment">// This file is subject to the terms and conditions defined in</span></span><br><span class="line"><span class="comment">// file 'LICENSE.txt', which is part of this source code package.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Content;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Graphics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Microsoft.Xna.Framework.Content</span></span><br><span class="line">&#123;</span><br><span class="line">    internal class Texture2DReader : ContentTypeReader&lt;Texture2D&gt;</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="function"><span class="keyword">internal</span> <span class="title">Texture2DReader</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			<span class="comment">// Do nothing</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">internal</span> <span class="keyword">override</span> Texture2D <span class="title">Read</span>(<span class="params">ContentReader reader, Texture2D existingInstance</span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			Texture2D texture = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> surfaceFormat = (SurfaceFormat)reader.ReadInt32();</span><br><span class="line">            <span class="keyword">int</span> width = reader.ReadInt32();</span><br><span class="line">            <span class="keyword">int</span> height = reader.ReadInt32();</span><br><span class="line">            <span class="keyword">int</span> levelCount = reader.ReadInt32();</span><br><span class="line">            <span class="keyword">int</span> levelCountOutput = levelCount;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the system does not fully support Power of Two textures,</span></span><br><span class="line">            <span class="comment">// skip any mip maps supplied with any non PoT textures.</span></span><br><span class="line">            <span class="keyword">if</span> (levelCount &gt; <span class="number">1</span> &amp;&amp; !reader.GraphicsDevice.GraphicsCapabilities.SupportsNonPowerOfTwo &amp;&amp;</span><br><span class="line">                (!MathHelper.IsPowerOfTwo(width) || !MathHelper.IsPowerOfTwo(height)))</span><br><span class="line">            &#123;</span><br><span class="line">                levelCountOutput = <span class="number">1</span>;</span><br><span class="line">                System.Diagnostics.Debug.WriteLine(</span><br><span class="line">                    <span class="string">"Device does not support non Power of Two textures. Skipping mipmaps."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">			SurfaceFormat convertedFormat = surfaceFormat;</span><br><span class="line">			<span class="keyword">switch</span> (surfaceFormat)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">case</span> SurfaceFormat.Dxt1:</span><br><span class="line">				<span class="keyword">case</span> SurfaceFormat.Dxt1a:</span><br><span class="line">					<span class="keyword">if</span> (!reader.GraphicsDevice.GraphicsCapabilities.SupportsDxt1)</span><br><span class="line">						convertedFormat = SurfaceFormat.Color;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> SurfaceFormat.Dxt1SRgb:</span><br><span class="line">					<span class="keyword">if</span> (!reader.GraphicsDevice.GraphicsCapabilities.SupportsDxt1)</span><br><span class="line">						convertedFormat = SurfaceFormat.ColorSRgb;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> SurfaceFormat.Dxt3:</span><br><span class="line">				<span class="keyword">case</span> SurfaceFormat.Dxt5:</span><br><span class="line">					<span class="keyword">if</span> (!reader.GraphicsDevice.GraphicsCapabilities.SupportsS3tc)</span><br><span class="line">						convertedFormat = SurfaceFormat.Color;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> SurfaceFormat.Dxt3SRgb:</span><br><span class="line">				<span class="keyword">case</span> SurfaceFormat.Dxt5SRgb:</span><br><span class="line">					<span class="keyword">if</span> (!reader.GraphicsDevice.GraphicsCapabilities.SupportsS3tc)</span><br><span class="line">						convertedFormat = SurfaceFormat.ColorSRgb;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> SurfaceFormat.NormalizedByte4:</span><br><span class="line">					convertedFormat = SurfaceFormat.Color;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">            texture = existingInstance ?? <span class="keyword">new</span> Texture2D(reader.GraphicsDevice, width, height, levelCountOutput &gt; <span class="number">1</span>, convertedFormat);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OPENGL</span></span><br><span class="line">            Threading.BlockOnUIThread(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> level = <span class="number">0</span>; level &lt; levelCount; level++)</span><br><span class="line">			    &#123;</span><br><span class="line">				    <span class="keyword">var</span> levelDataSizeInBytes = reader.ReadInt32();</span><br><span class="line">                    <span class="keyword">var</span> levelData = reader.ContentManager.GetScratchBuffer(levelDataSizeInBytes);</span><br><span class="line">                    reader.Read(levelData, <span class="number">0</span>, levelDataSizeInBytes);</span><br><span class="line">                    <span class="keyword">int</span> levelWidth = width &gt;&gt; level;</span><br><span class="line">                    <span class="keyword">int</span> levelHeight = height &gt;&gt; level;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (level &gt;= levelCountOutput)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">				    <span class="comment">//Convert the image data if required</span></span><br><span class="line">				    <span class="keyword">switch</span> (surfaceFormat)</span><br><span class="line">				    &#123;</span><br><span class="line">					    <span class="keyword">case</span> SurfaceFormat.Dxt1:</span><br><span class="line">                        <span class="keyword">case</span> SurfaceFormat.Dxt1SRgb:</span><br><span class="line">                        <span class="keyword">case</span> SurfaceFormat.Dxt1a:</span><br><span class="line">                            <span class="keyword">if</span> (!reader.GraphicsDevice.GraphicsCapabilities.SupportsDxt1 &amp;&amp; convertedFormat == SurfaceFormat.Color)</span><br><span class="line">						        levelData = DxtUtil.DecompressDxt1(levelData, levelWidth, levelHeight);</span><br><span class="line">						    <span class="keyword">break</span>;</span><br><span class="line">					    <span class="keyword">case</span> SurfaceFormat.Dxt3:</span><br><span class="line">					    <span class="keyword">case</span> SurfaceFormat.Dxt3SRgb:</span><br><span class="line">                            <span class="keyword">if</span> (!reader.GraphicsDevice.GraphicsCapabilities.SupportsS3tc)</span><br><span class="line">                            <span class="keyword">if</span> (!reader.GraphicsDevice.GraphicsCapabilities.SupportsS3tc &amp;&amp; convertedFormat == SurfaceFormat.Color)</span><br><span class="line">						        levelData = DxtUtil.DecompressDxt3(levelData, levelWidth, levelHeight);</span><br><span class="line">						    <span class="keyword">break</span>;</span><br><span class="line">					    <span class="keyword">case</span> SurfaceFormat.Dxt5:</span><br><span class="line">					    <span class="keyword">case</span> SurfaceFormat.Dxt5SRgb:</span><br><span class="line">                            <span class="keyword">if</span> (!reader.GraphicsDevice.GraphicsCapabilities.SupportsS3tc)</span><br><span class="line">                            <span class="keyword">if</span> (!reader.GraphicsDevice.GraphicsCapabilities.SupportsS3tc &amp;&amp; convertedFormat == SurfaceFormat.Color)</span><br><span class="line">    						    levelData = DxtUtil.DecompressDxt5(levelData, levelWidth, levelHeight);</span><br><span class="line">						    <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> SurfaceFormat.Bgra5551:</span><br><span class="line">                            &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OPENGL</span></span><br><span class="line">                                <span class="comment">// Shift the channels to suit OpenGL</span></span><br><span class="line">                                <span class="keyword">int</span> offset = <span class="number">0</span>;</span><br><span class="line">                                <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; levelHeight; y++)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; levelWidth; x++)</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        <span class="keyword">ushort</span> pixel = BitConverter.ToUInt16(levelData, offset);</span><br><span class="line">                                        pixel = (<span class="keyword">ushort</span>)(((pixel &amp; <span class="number">0x7FFF</span>) &lt;&lt; <span class="number">1</span>) | ((pixel &amp; <span class="number">0x8000</span>) &gt;&gt; <span class="number">15</span>));</span><br><span class="line">                                        levelData[offset] = (<span class="keyword">byte</span>)(pixel);</span><br><span class="line">                                        levelData[offset + <span class="number">1</span>] = (<span class="keyword">byte</span>)(pixel &gt;&gt; <span class="number">8</span>);</span><br><span class="line">                                        offset += <span class="number">2</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">					    <span class="keyword">case</span> SurfaceFormat.Bgra4444:</span><br><span class="line">						    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OPENGL</span></span><br><span class="line">                                <span class="comment">// Shift the channels to suit OpenGL</span></span><br><span class="line">							    <span class="keyword">int</span> offset = <span class="number">0</span>;</span><br><span class="line">							    <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; levelHeight; y++)</span><br><span class="line">							    &#123;</span><br><span class="line">								    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; levelWidth; x++)</span><br><span class="line">								    &#123;</span><br><span class="line">									    <span class="keyword">ushort</span> pixel = BitConverter.ToUInt16(levelData, offset);</span><br><span class="line">									    pixel = (<span class="keyword">ushort</span>)(((pixel &amp; <span class="number">0x0FFF</span>) &lt;&lt; <span class="number">4</span>) | ((pixel &amp; <span class="number">0xF000</span>) &gt;&gt; <span class="number">12</span>));</span><br><span class="line">									    levelData[offset] = (<span class="keyword">byte</span>)(pixel);</span><br><span class="line">									    levelData[offset + <span class="number">1</span>] = (<span class="keyword">byte</span>)(pixel &gt;&gt; <span class="number">8</span>);</span><br><span class="line">									    offset += <span class="number">2</span>;</span><br><span class="line">								    &#125;</span><br><span class="line">							    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">						    &#125;</span><br><span class="line">						    <span class="keyword">break</span>;</span><br><span class="line">					    <span class="keyword">case</span> SurfaceFormat.NormalizedByte4:</span><br><span class="line">						    &#123;</span><br><span class="line">							    <span class="keyword">int</span> bytesPerPixel = surfaceFormat.GetSize();</span><br><span class="line">							    <span class="keyword">int</span> pitch = levelWidth * bytesPerPixel;</span><br><span class="line">							    <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; levelHeight; y++)</span><br><span class="line">							    &#123;</span><br><span class="line">								    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; levelWidth; x++)</span><br><span class="line">								    &#123;</span><br><span class="line">									    <span class="keyword">int</span> color = BitConverter.ToInt32(levelData, y * pitch + x * bytesPerPixel);</span><br><span class="line">									    levelData[y * pitch + x * <span class="number">4</span>] = (<span class="keyword">byte</span>)(((color &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>)); <span class="comment">//R:=W</span></span><br><span class="line">									    levelData[y * pitch + x * <span class="number">4</span> + <span class="number">1</span>] = (<span class="keyword">byte</span>)(((color &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>)); <span class="comment">//G:=V</span></span><br><span class="line">									    levelData[y * pitch + x * <span class="number">4</span> + <span class="number">2</span>] = (<span class="keyword">byte</span>)(((color) &amp; <span class="number">0xff</span>)); <span class="comment">//B:=U</span></span><br><span class="line">									    levelData[y * pitch + x * <span class="number">4</span> + <span class="number">3</span>] = (<span class="keyword">byte</span>)(((color &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>)); <span class="comment">//A:=Q</span></span><br><span class="line">								    &#125;</span><br><span class="line">							    &#125;</span><br><span class="line">						    &#125;</span><br><span class="line">						    <span class="keyword">break</span>;</span><br><span class="line">				    &#125;</span><br><span class="line">				</span><br><span class="line">                    texture.SetData(level, <span class="literal">null</span>, levelData, <span class="number">0</span>, levelDataSizeInBytes);</span><br><span class="line">			    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OPENGL</span></span><br><span class="line">            &#125;);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        			</span><br><span class="line">			<span class="keyword">return</span> texture;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="TextureContent"><a href="#TextureContent" class="headerlink" title="TextureContent"></a>TextureContent</h4><p>XNA Game Studio Content Document Object Model (DOM) 这个统一各个图像格式的TextureContent是什么样子, 里面的Faces用于mipmap<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MonoGame - Copyright (C) The MonoGame Team</span></span><br><span class="line"><span class="comment">// This file is subject to the terms and conditions defined in</span></span><br><span class="line"><span class="comment">// file 'LICENSE.txt', which is part of this source code package.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Graphics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Microsoft.Xna.Framework.Content.Pipeline.Graphics</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Provides a base class for all texture objects.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">TextureContent</span> : <span class="title">ContentItem</span></span><br><span class="line">    &#123;</span><br><span class="line">        MipmapChainCollection faces;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Collection of image faces that hold a single mipmap chain for a regular 2D texture, six chains for a cube map, or an arbitrary number for volume and array textures.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> MipmapChainCollection Faces</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> faces;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Initializes a new instance of TextureContent with the specified face collection.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="faces"&gt;</span>Mipmap chain containing the face collection.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">TextureContent</span>(<span class="params">MipmapChainCollection faces</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.faces = faces;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Converts all bitmaps for this texture to a different format.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="newBitmapType"&gt;</span>Type being converted to. The new type must be a subclass of BitmapContent, such as PixelBitmapContent or DxtBitmapContent.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConvertBitmapType</span>(<span class="params">Type newBitmapType</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (newBitmapType == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"newBitmapType"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!newBitmapType.IsSubclassOf(<span class="keyword">typeof</span> (BitmapContent)))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="keyword">string</span>.Format(<span class="string">"Type '&#123;0&#125;' is not a subclass of BitmapContent."</span>, newBitmapType));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (newBitmapType.IsAbstract)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="keyword">string</span>.Format(<span class="string">"Type '&#123;0&#125;' is abstract and cannot be allocated."</span>, newBitmapType));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (newBitmapType.ContainsGenericParameters)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="keyword">string</span>.Format(<span class="string">"Type '&#123;0&#125;' contains generic parameters and cannot be allocated."</span>, newBitmapType));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (newBitmapType.GetConstructor(<span class="keyword">new</span> Type[<span class="number">2</span>] &#123;<span class="keyword">typeof</span> (<span class="keyword">int</span>), <span class="keyword">typeof</span> (<span class="keyword">int</span>)&#125;) == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="keyword">string</span>.Format(<span class="string">"Type '&#123;0&#125; does not have a constructor with signature (int, int) and cannot be allocated."</span>,</span><br><span class="line">                                                          newBitmapType));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> mipChain <span class="keyword">in</span> faces)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; mipChain.Count; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> src = mipChain[i];</span><br><span class="line">                    <span class="keyword">if</span> (src.GetType() != newBitmapType)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">var</span> dst = (BitmapContent)Activator.CreateInstance(newBitmapType, <span class="keyword">new</span> <span class="keyword">object</span>[] &#123; src.Width,src.Height &#125;);</span><br><span class="line">                        BitmapContent.Copy(src, dst);</span><br><span class="line">                        mipChain[i] = dst;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;        </span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Generates a full set of mipmaps for the texture.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="overwriteExistingMipmaps"&gt;</span>true if the existing mipmap set is replaced with the new set; false otherwise.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GenerateMipmaps</span>(<span class="params"><span class="keyword">bool</span> overwriteExistingMipmaps</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// If we already have mipmaps and we're not supposed to overwrite</span></span><br><span class="line">            <span class="comment">// them then return without any generation.</span></span><br><span class="line">            <span class="keyword">if</span> (!overwriteExistingMipmaps &amp;&amp; faces.Any(f =&gt; f.Count &gt; <span class="number">1</span>))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Generate the mips for each face.</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> face <span class="keyword">in</span> faces)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Remove any existing mipmaps.</span></span><br><span class="line">                <span class="keyword">var</span> faceBitmap = face[<span class="number">0</span>];</span><br><span class="line">                face.Clear();</span><br><span class="line">                face.Add(faceBitmap);</span><br><span class="line">                <span class="keyword">var</span> faceType = faceBitmap.GetType();</span><br><span class="line">                <span class="keyword">int</span> width = faceBitmap.Width;</span><br><span class="line">                <span class="keyword">int</span> height = faceBitmap.Height;</span><br><span class="line">                <span class="keyword">while</span> (width &gt; <span class="number">1</span> &amp;&amp; height &gt; <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    width /= <span class="number">2</span>;</span><br><span class="line">                    height /= <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> mip = (BitmapContent)Activator.CreateInstance(faceType, <span class="keyword">new</span> <span class="keyword">object</span>[] &#123; width, height &#125;);</span><br><span class="line">                    BitmapContent.Copy(faceBitmap, mip);</span><br><span class="line">                    face.Add(mip);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Verifies that all contents of this texture are present, correct and match the capabilities of the device.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="targetProfile"&gt;</span>The profile identifier that defines the capabilities of the device.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Validate</span>(<span class="params">GraphicsProfile? targetProfile</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/17/MonoGame笔记(十一)GameServices/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/17/MonoGame笔记(十一)GameServices/" itemprop="url">MonoGame笔记(十一)GameService</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-17T18:54:37+08:00">
                2017-12-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://gameprogrammingpatterns.com/component.html" target="_blank" rel="noopener">http://gameprogrammingpatterns.com/component.html</a> 中将Component模式归类于Decouple Pattern, 用来解耦. 那Component之间如何交互呢. MonoGame提供了GameService.<br>官方的介绍如下:<a href="https://msdn.microsoft.com/en-us/library/bb203873.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/bb203873.aspx</a></p>
<h4 id="Game-services"><a href="#Game-services" class="headerlink" title="Game services"></a>Game services</h4><p>Game services are a mechanism for maintaining loose coupling between objects that need to interact with each other. Services work through a mediator—in this case, <strong>Game.Services</strong>. Service providers register with Game.Services, and service consumers request services from Game.Services. This arrangement allows an object that requires a service to request the service without knowing the name of the service provider.</p>
<p>Game services are defined by an interface. <strong>A class specifies the services it provides by implementing interfaces and registering the services with Game.Services</strong>. A service is registered by calling Game.Services.AddService specifying the type of service being implemented and a reference to the object providing the service. For example, to register an object that provides a service represented by the interface IMyService, you would use the following code.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Services.AddService( <span class="keyword">typeof</span>( IMyService ), myobject );</span><br></pre></td></tr></table></figure></p>
<p>Once a service is registered, the object providing the service can be retrieved by <strong>Game.Services.GetService</strong> and specifying the desired service. For example, to retrieve IGraphicsDeviceService, you would use the following code.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IGraphicsDeviceService graphicsservice = (IGraphicsDeviceService)Services.GetService( <span class="keyword">typeof</span>(IGraphicsDeviceService) );</span><br></pre></td></tr></table></figure></p>
<h4 id="Game-Components-Consuming-Game-Services"><a href="#Game-Components-Consuming-Game-Services" class="headerlink" title="Game Components Consuming Game Services"></a>Game Components Consuming Game Services</h4><p>The GameComponent class provides the Game property so a GameComponent can determine what Game it is attached to. With the Game property, a GameComponent can call Game.Services.GetService to find a provider of a particular service. For example, a GameComponent would find the IGraphicsDeviceService provider by using the following code.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IGraphicsDeviceService graphicsservice = (IGraphicsDeviceService)Game.Services.GetService( <span class="keyword">typeof</span>( IGraphicsDeviceService ) );</span><br></pre></td></tr></table></figure></p>
<p>上面的介绍已经很清楚了, 可以追加一点的是, 提供Service的可以是GameComponent, 也可以不是GameComponent. </p>
<p>对于Game services, 我看过解释得最好的是下面这个链接（非常棒）<a href="http://zacharysnow.net/2010/02/18/creating-and-consuming-services-in-your-xna-game.html" target="_blank" rel="noopener">http://zacharysnow.net/2010/02/18/creating-and-consuming-services-in-your-xna-game.html</a></p>
<p>全文摘录如下:</p>
<h4 id="Creating-and-consuming-services-in-your-XNA-Game"><a href="#Creating-and-consuming-services-in-your-XNA-Game" class="headerlink" title="Creating and consuming services in your XNA Game"></a>Creating and consuming services in your XNA Game</h4><p>February 18, 2010  .NET  0 Comments</p>
<p>The <strong>GameServiceContainer</strong> implements the <strong>IServiceProvider</strong> interface and the MSDN documentation says about the IServiceProvider interface:<br><em>Defines a mechanism for retrieving a service object; that is, an object that provides custom support to other objects.</em></p>
<p>This article will <strong>attemp</strong> to describe how can you use the GameServiceContainer in your XNA game, in both your GameComponent(s) and your game’s entity objects.&lt; !—more—&gt;The most obvious place to use the GameServiceContainer is in your GameComponent(s). But first, lets talk about <strong>Coupling</strong>(耦合). Let’s assume you have the following components:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">FooComponent</span> : <span class="title">GameComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FooComponent</span>(<span class="params">Game game</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">game</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">DoFoo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Do something and return an int.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">BarComponent</span> : <span class="title">GameComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    FooComponent foo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BarComponent</span>(<span class="params">Game game</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">game</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.foo = <span class="keyword">new</span> FooComponent(game);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoBar</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="keyword">this</span>.foo.DoFoo();</span><br><span class="line">        <span class="comment">// Do something based on result.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>There’s nothing wrong with the code, but BarComponent has a <strong>dependency</strong> on FooComponent(BarComponent直接依赖FooComponent). BarComponent directly interacts with FooComponent and therefore any change made to FooComponent indirectly affects BarComponent(任何对FooComponent的改动都会间接影响BarComponent). For instance, let’s assume the constructor for FooComponent needs to be modified. That means we now have to update not only the FooComponent class but as well the BarComponent class(例如修改了FooComponent的构造方法, 则BarComponent也需要做相应修改). Throw in a few more components with dependencies on FooComponent and you could start to get headache really fast. This design is <strong>highly coupled</strong>(高耦合).</p>
<p>Let’s try a slight redesign:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">FooComponent</span> : <span class="title">GameComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FooComponent</span>(<span class="params">Game game</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">game</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">DoFoo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Do something and return an int.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">BarComponent</span> : <span class="title">GameComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    FooComponent foo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BarComponent</span>(<span class="params">Game game, FooComponent foo</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">game</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.foo = foo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoBar</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="keyword">this</span>.foo.DoFoo();</span><br><span class="line">        <span class="comment">// Do something based on result.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>We’ve now eliminated the construction of the FooComponent from within the BarComponent. The design is better but still not that great. BarComponent is still directly relying on and communicating with FooComponent. We want to change BarComponent so that it has no direct dependency on a concrete implementation of FooComponent. 这也是一种依赖注入, 但还不彻底</p>
<p>We’ll create an interface(面向接口编程):<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title">IFooService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">DoFoo</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">FooComponent</span> : <span class="title">GameComponent</span>, <span class="title">IFooService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FooComponent</span>(<span class="params">Game game</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">game</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">DoFoo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Do something and return an int.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">BarComponent</span> : <span class="title">GameComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    IFooService foo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BarComponent</span>(<span class="params">Game game, IFooService foo</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">game</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.foo = foo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoBar</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="keyword">this</span>.foo.DoFoo();</span><br><span class="line">        <span class="comment">// Do something based on result.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>We can now change FooComponent as much as we want and BarComponent will be unaffected. BarComponent now communicates with FooComponent through the IFooService interface(接口隔离). This also allows us to have multiple implementations of DoFoo():<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">SimpleFooComponent</span> : <span class="title">GameComponent</span>, <span class="title">IFooService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleFooComponent</span>(<span class="params">Game game</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">game</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">DoFoo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">5</span>; <span class="comment">// The class says “Simple”</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">ComplexFooComponent</span> : <span class="title">GameComponent</span>, <span class="title">IFooService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ComplexFooComponent</span>(<span class="params">Game game</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">game</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">DoFoo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// Do some very complex calculationreturn result;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>We can pass BarComponent an instance of SimpleFooComponent or ComplexFooComponent. Whatever the situation may call for.<br>Where does GameServiceContainer fit into all of this? You can use the GameServiceContainer to hold all your “Services”. Add whatever class will implement the IFooService and then from within your BarComponent you can query for it:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">BarComponent</span> : <span class="title">GameComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    IFooService foo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BarComponent</span>(<span class="params">Game game</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">game</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Initialize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.foo = <span class="keyword">this</span>.Game.Services.GetService(<span class="keyword">typeof</span>(IFooService)) <span class="keyword">as</span> IFooService;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.foo == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(“IFooService not found.”);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoBar</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="keyword">this</span>.foo.DoFoo();</span><br><span class="line">        <span class="comment">// Do something based on result.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// In your Game’s constructor</span></span><br><span class="line"><span class="keyword">this</span>.Services.AddService(<span class="keyword">typeof</span>(IFooService), <span class="keyword">new</span> SimpleFooComponent(<span class="keyword">this</span>));</span><br></pre></td></tr></table></figure></p>
<p>Not only does BarComponent no longer require an instance of IFooService in its constructor, it also no longer matters if the instance of IFooService is constructed before or after the BarComponent. So long as all the services BarComponent requires are in the GameServiceContainer before Initialize() is called, it doesn’t matter what order your components are constructed in. Now, suppose that BarComponent didn’t necessarily depend on IFooService and instead the behavior of DoBar() is changed based on whether or not IFooService is available:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">BarComponent</span> : <span class="title">GameComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    IFooService foo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BarComponent</span>(<span class="params">Game game</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">game</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Initialize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.foo = <span class="keyword">this</span>.Game.Services.GetService(<span class="keyword">typeof</span>(IFooService)) <span class="keyword">as</span> IFooService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">intDoBar</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// If the IFooService is available, delegate to the DoFoo() method.if(this.foo != null)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.foo.DoFoo();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// Otherwise do some other calculation.return result;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这一点是很微妙的, Initialize对BarComponent是全局的, DoBar对BarComponent是局部的, 从Initialize移到DoBar, 进一步降低耦合性</p>
<p>Service providers don’t always have to be GameComponent(s). Our BarComponent needs a Camera class now:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title">ICamera</span></span><br><span class="line">&#123;</span><br><span class="line">    Matrix Transform &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">IdentityCamera</span> : <span class="title">ICamera</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Matrix Transform</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> Matrix.Identity; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">MovingCamera</span> : <span class="title">ICamera</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Matrix Transform</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">BarComponent</span> : <span class="title">DrawableGameComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    ICamera camera;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BarComponent</span>(<span class="params">Game game</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">game</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Initialize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.camera = <span class="keyword">this</span>.Game.Services.GetService(<span class="keyword">typeof</span>(ICamera)) <span class="keyword">as</span> ICamera;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Draw</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Matrix transform = <span class="keyword">this</span>.camera.Transform;</span><br><span class="line">        <span class="comment">// Draw based on the transform matrix</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// In your Game’s constructor.</span></span><br><span class="line"><span class="keyword">this</span>.Services.AddService(<span class="keyword">typeof</span>(ICamera), <span class="keyword">new</span> MovingCamera());</span><br></pre></td></tr></table></figure></p>
<p>BarComponent uses the camera’s Transform matrix and doesn’t care how it is calculated. It’s completely decoupled from the camera’s implementation.</p>
<p>In closing, using the GameServiceContainer and interfaces makes your classes more loosely coupled. This makes it easier to make changes to the way your game works. Your classes also become more reusable as you can now mix and match service providers and consumers as needed. If you need a specific implementation of a camera for your game, you can still use the BarComponent so long as your camera class implements the ICamera interface.</p>
<p>Loosely coupling your classes has the added benefit of making them more testable. That’s another blog post though.</p>
<p>GameServiceContainer和IServiceProvider在Monogame中的实现如下:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MIT License - Copyright (C) The Mono.Xna Team</span></span><br><span class="line"><span class="comment">// This file is subject to the terms and conditions defined in</span></span><br><span class="line"><span class="comment">// file 'LICENSE.txt', which is part of this source code package.</span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Xna.Framework.Utilities;</span><br><span class="line">​</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Microsoft.Xna.Framework</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameServiceContainer</span> : <span class="title">IServiceProvider</span></span><br><span class="line">    &#123;</span><br><span class="line">        Dictionary&lt;Type, <span class="keyword">object</span>&gt; services;</span><br><span class="line">​</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">GameServiceContainer</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            services = <span class="keyword">new</span> Dictionary&lt;Type, <span class="keyword">object</span>&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">​</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddService</span>(<span class="params">Type type, <span class="keyword">object</span> provider</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"type"</span>);</span><br><span class="line">            <span class="keyword">if</span> (provider == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"provider"</span>);</span><br><span class="line">            <span class="keyword">if</span> (!ReflectionHelpers.IsAssignableFrom(type, provider))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">"The provider does not match the specified service type!"</span>);</span><br><span class="line">​</span><br><span class="line">            services.Add(type, provider);</span><br><span class="line">        &#125;</span><br><span class="line">​</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">object</span> <span class="title">GetService</span>(<span class="params">Type type</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"type"</span>);</span><br><span class="line">                        </span><br><span class="line">            <span class="keyword">object</span> service;</span><br><span class="line">            <span class="keyword">if</span> (services.TryGetValue(type, <span class="keyword">out</span> service))</span><br><span class="line">                <span class="keyword">return</span> service;</span><br><span class="line">​</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">​</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveService</span>(<span class="params">Type type</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"type"</span>);</span><br><span class="line">​</span><br><span class="line">            services.Remove(type);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> AddService&lt;T&gt;(T provider)</span><br><span class="line">        &#123;</span><br><span class="line">            AddService(<span class="keyword">typeof</span>(T), provider);</span><br><span class="line">        &#125;</span><br><span class="line">​</span><br><span class="line">        <span class="keyword">public</span> T GetService&lt;T&gt;() <span class="keyword">where</span> T : <span class="keyword">class</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> service = GetService(<span class="keyword">typeof</span>(T));</span><br><span class="line">​</span><br><span class="line">            <span class="keyword">if</span> (service == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">​</span><br><span class="line">            <span class="keyword">return</span> (T)service;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IServiceProvider</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">Object <span class="title">GetService</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        Type serviceType</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>这种设计方法也是一种设计模式: Service Locator(<a href="http://gameprogrammingpatterns.com/service-locator.html" target="_blank" rel="noopener">http://gameprogrammingpatterns.com/service-locator.html</a>)</p>
<blockquote>
<p>The Service Locator pattern is a sibling to Singleton in many ways, so it’s worth looking at both to see which is most appropriate for your needs.</p>
</blockquote>
<blockquote>
<p>The Unity framework uses this pattern in concert with the Component pattern in its GetComponent() method.在Unity3D中, GameObject.GetComponent/GetComponentInParent也是同样的方式.</p>
</blockquote>
<blockquote>
<p>Microsoft’s XNA framework for game development has this pattern built into its core Game class. Each instance has a GameServices object that can be used to register and locate services of any type.</p>
</blockquote>
<p>如同前一篇Component模式在Unity3D和XNA中的异同,  Service Locator模式在Unity3D和XNA中的异同是一样的. 区别在于Unity3D中是在Entity的level, 而XNA是在Game的level.</p>
<p>这种模式并非游戏专用, 在MSDN中有更一般化的介绍<a href="https://msdn.microsoft.com/en-us/library/ee413842.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/ee413842.aspx</a></p>
<p>You have classes with dependencies on services whose concrete types are specified at compile time. In the following example, ClassA has compile time dependencies on ServiceA and ServiceB. The following diagram illustrates this.<br>Classes with dependencies on services<br><img src="/img/monogame-servicelocator-1.png" alt=""></p>
<p>This situation has the following drawbacks:</p>
<ul>
<li>To replace or update the dependencies, you must change your classes’ source code and recompile the solution.</li>
<li>The concrete implementation of the dependencies must be available at compile time.</li>
<li>Your classes are difficult to test in isolation because they have a direct reference to their dependencies. This means that these dependencies cannot be replaced with stubs or mock objects.</li>
<li>Your classes contain repetitive code for creating, locating, and managing their dependencies.</li>
</ul>
<p>The next section describes how to address these issues.</p>
<p>Objectives<br>Use the Service Locator pattern to achieve any of the following objectives:</p>
<ul>
<li>You want to decouple your classes from their dependencies so that these dependencies can be replaced or updated with little or no change to the classes.</li>
<li>You want to write logic that depends on classes whose concrete implementation is not known at compile time.</li>
<li>You want to be able to test your classes in isolation, without the dependencies.</li>
<li>You do not want the logic that locates and manages the dependencies to be in your classes.</li>
<li>You want to divide your application into loosely coupled modules that can be independently developed, tested, versioned, and deployed.</li>
</ul>
<p>Solution<br>Create a service locator that contains references to the services and that encapsulates the logic that locates them. In your classes, use the service locator to obtain service instances. The following diagram illustrates how classes use a service locator.</p>
<p>How classes use a service locator<br><img src="/img/monogame-servicelocator-2.png" alt=""></p>
<p>The Service Locator pattern does not describe how to instantiate the services. It describes a way to register services and locate them. Typically, the Service Locator pattern is combined with the Factory pattern and/or the Dependency Injection pattern. This combination allows a service locator to create instances of services.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/17/MonoGame笔记(十)GameComponent/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/17/MonoGame笔记(十)GameComponent/" itemprop="url">MonoGame笔记(十)GameComponent</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-17T17:22:37+08:00">
                2017-12-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇笔记中TimerComponent, FrameRateCounter分别继承于GameComponent, DrawableGameComponent.关于GameComponent和DrawableGameComponent, 官方的介绍如下:</p>
<blockquote>
<p>Game components provide a modular way of adding functionality to a game. You create a game component by deriving the new component either from the <strong>GameComponent</strong> class, or, if the component loads and draws graphics content, from the <strong>DrawableGameComponent</strong> class. You then add game logic and rendering code to the game component by overriding <strong>GameComponent.Update</strong>,<strong>DrawableGameComponent.Draw</strong> and <strong>GameComponent.Initialize</strong>. A game component is registered with a game by passing the component to <strong>Game.Components.Add</strong>. A registered component will have its draw, update, and initialize methods called from the <strong>Game.Initialize</strong>, <strong>Game.Update</strong>, and <strong>Game.Draw</strong> methods.<br><a href="https://msdn.microsoft.com/en-us/library/bb203873.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/bb203873.aspx</a></p>
</blockquote>
<p>游戏组件提供了一种模块化的开发方式, 使得程序结构更加清晰. 除了上面提到的TimerComponent, FrameRateCounter, 包括像Input, SpriteManager, ScreenManager等等都可以用游戏组件的方式来提供.</p>
<p>Learn XNA 4.0中介绍的SpriteManager<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">public class SpriteManager : Microsoft.Xna.Framework.DrawableGameComponent</span><br><span class="line">&#123;</span><br><span class="line">    SpriteBatch spriteBatch;</span><br><span class="line">    UserControlledSprite player;</span><br><span class="line">    List&lt;Sprite&gt; spriteList = <span class="keyword">new</span> List&lt;Sprite&gt;( );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">LoadContent</span>(<span class="params"> </span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        spriteBatch = <span class="keyword">new</span> SpriteBatch(Game.GraphicsDevice);</span><br><span class="line"></span><br><span class="line">        player = <span class="keyword">new</span> UserControlledSprite(</span><br><span class="line">        Game.Content.Load&lt;Texture2D&gt;(<span class="string">@"Images/threerings"</span>),</span><br><span class="line">        Vector2.Zero, <span class="keyword">new</span> Point(<span class="number">75</span>, <span class="number">75</span>), <span class="number">10</span>, <span class="keyword">new</span> Point(<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="keyword">new</span> Point(<span class="number">6</span>, <span class="number">8</span>), <span class="keyword">new</span> Vector2(<span class="number">6</span>, <span class="number">6</span>));</span><br><span class="line"></span><br><span class="line">        spriteList.Add(<span class="keyword">new</span> AutomatedSprite(</span><br><span class="line">        Game.Content.Load&lt;Texture2D&gt;(<span class="string">@"Images/skullball"</span>),</span><br><span class="line">        <span class="keyword">new</span> Vector2(<span class="number">150</span>, <span class="number">150</span>), <span class="keyword">new</span> Point(<span class="number">75</span>, <span class="number">75</span>), <span class="number">10</span>, <span class="keyword">new</span> Point(<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="keyword">new</span> Point(<span class="number">6</span>, <span class="number">8</span>), Vector2.Zero));</span><br><span class="line"></span><br><span class="line">        spriteList.Add(<span class="keyword">new</span> AutomatedSprite(</span><br><span class="line">        Game.Content.Load&lt;Texture2D&gt;(<span class="string">@"Images/skullball"</span>),</span><br><span class="line">        <span class="keyword">new</span> Vector2(<span class="number">300</span>, <span class="number">150</span>), <span class="keyword">new</span> Point(<span class="number">75</span>, <span class="number">75</span>), <span class="number">10</span>, <span class="keyword">new</span> Point(<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">        <span class="keyword">new</span> Point(<span class="number">6</span>, <span class="number">8</span>), Vector2.Zero));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">base</span>.LoadContent( );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Update player</span></span><br><span class="line">        player.Update(gameTime, Game.Window.ClientBounds);</span><br><span class="line">        <span class="comment">// Update all sprites</span></span><br><span class="line">        <span class="keyword">foreach</span> (Sprite s <span class="keyword">in</span> spriteList)</span><br><span class="line">        &#123;</span><br><span class="line">            s.Update(gameTime, Game.Window.ClientBounds);</span><br><span class="line">            <span class="comment">// Check for collisions and exit game if there is one</span></span><br><span class="line">            <span class="keyword">if</span> (s.collisionRect.Intersects(player.collisionRect))</span><br><span class="line">                Game.Exit();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">base</span>.Update(gameTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Draw</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        spriteBatch.Begin(SpriteBlendMode.AlphaBlend,</span><br><span class="line">        SpriteSortMode.FrontToBack, SaveStateMode.None);</span><br><span class="line">        <span class="comment">// Draw the player</span></span><br><span class="line">        player.Draw(gameTime, spriteBatch);</span><br><span class="line">        <span class="comment">// Draw all sprites</span></span><br><span class="line">        <span class="keyword">foreach</span> (Sprite s <span class="keyword">in</span> spriteList)</span><br><span class="line">            s.Draw(gameTime, spriteBatch);</span><br><span class="line">        spriteBatch.End( );</span><br><span class="line">        <span class="keyword">base</span>.Draw(gameTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//使用方式</span></span><br><span class="line">spriteManger = <span class="keyword">new</span> SpriteManager(<span class="keyword">this</span>);</span><br><span class="line">Components.Add(spriteManger);</span><br></pre></td></tr></table></figure></p>
<p>注意<strong>Sprite</strong>自身不是GameComponent或者DrawableGameComponent, 虽然也有Update和Draw方法</p>
<p>RolePlayingGameStarterKit中使用的ScreenManager, 做法和SpriteManager一样, 也是继承DrawableGameComponent. 各种GameScreen, 就类似Sprite, 通过ScreenManager的draw方法进行绘制. GameScreen自己有draw方法, 用的是ScreenManager的spriteBatch. </p>
<p>除了上面介绍的游戏系统可以作为组件, 下面的这种方式也可以提供一种思路<br><a href="http://blogs.microsoft.co.il/pavely/2010/11/06/xna-2d-game-tutorial-part-4/" target="_blank" rel="noopener">http://blogs.microsoft.co.il/pavely/2010/11/06/xna-2d-game-tutorial-part-4/</a><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//星空, 游戏背景</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StarfieldComponent</span> : <span class="title">DrawableGameComponent</span> &#123;</span><br><span class="line">    Star[] _stars = <span class="keyword">new</span> Star[<span class="number">128</span>];</span><br><span class="line">    Random _rnd = <span class="keyword">new</span> Random();</span><br><span class="line">    Texture2D _starTexture;</span><br><span class="line">    SpriteBatch _batch;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StarfieldComponent</span>(<span class="params">Game game</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">game</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Construct any child components here</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Initialize</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; _stars.Length; i++) &#123;</span><br><span class="line">            Star star = <span class="keyword">new</span> Star();</span><br><span class="line">            star.Color = <span class="keyword">new</span> Color(_rnd.Next(<span class="number">256</span>), _rnd.Next(<span class="number">256</span>), _rnd.Next(<span class="number">256</span>), <span class="number">128</span>);</span><br><span class="line">            star.Position = <span class="keyword">new</span> Vector2(_rnd.Next(Game.Window.ClientBounds.Width), _rnd.Next(Game.Window.ClientBounds.Height));</span><br><span class="line">            star.Speed = (<span class="keyword">float</span>)_rnd.NextDouble() * <span class="number">5</span> + <span class="number">2</span>;</span><br><span class="line">            _stars[i] = star;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">base</span>.Initialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">LoadContent</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        _starTexture = Game.Content.Load&lt;Texture2D&gt;(<span class="string">"Images/star"</span>);</span><br><span class="line">        _batch = <span class="keyword">new</span> SpriteBatch(Game.GraphicsDevice);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">base</span>.LoadContent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> height = Game.Window.ClientBounds.Height;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; _stars.Length; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> star = _stars[i];</span><br><span class="line">            <span class="keyword">if</span>((star.Position.Y += star.Speed) &gt; height) &#123;</span><br><span class="line">                <span class="comment">// "generate" a new star</span></span><br><span class="line">                star.Position = <span class="keyword">new</span> Vector2(_rnd.Next(Game.Window.ClientBounds.Width), -_rnd.Next(<span class="number">20</span>));</span><br><span class="line">                star.Speed = (<span class="keyword">float</span>)_rnd.NextDouble() * <span class="number">5</span> + <span class="number">2</span>;</span><br><span class="line">                star.Color = <span class="keyword">new</span> Color(_rnd.Next(<span class="number">256</span>), _rnd.Next(<span class="number">256</span>), _rnd.Next(<span class="number">256</span>), <span class="number">128</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">base</span>.Update(gameTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Draw</span>(<span class="params">GameTime gameTime</span>)</span> &#123;</span><br><span class="line">        _batch.Begin(SpriteSortMode.Deferred, BlendState.NonPremultiplied);</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> star <span class="keyword">in</span> _stars)</span><br><span class="line">            _batch.Draw(_starTexture, star.Position, <span class="literal">null</span>, star.Color, <span class="number">0</span>, Vector2.Zero, <span class="number">1.0f</span>, SpriteEffects.None, <span class="number">1.0f</span>);</span><br><span class="line">        _batch.End();</span><br><span class="line">        <span class="keyword">base</span>.Draw(gameTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>GameComponent和DrawableGameComponent的类图如下:<br><img src="/img/monogame-gamecomponents.png" alt=""><br>值得一提的是IUpdateable中有一个UpdateOrder, IDrawable中有一个DrawOrder, 这两个Order对于组件来说是不可或缺的. 例如寻路组件, 碰撞组件, 网络组件等之间会有一个先后顺序, 绘制的时候则有特效层, UI层, 场景中又细分为前景层, 中间层, 背景层.</p>
<p>GameComponent其实是一种设计模式(<a href="http://gameprogrammingpatterns.com/component.html)" target="_blank" rel="noopener">http://gameprogrammingpatterns.com/component.html)</a>, Unity3D中则更进一步, 每一个物体都是GameObject, 通过”挂”上各种GameComponent, 在游戏中运行. 另外还有一种ECS(Entity-Component-System 实体组件系统, 参考守望先锋), 则比Unity3D更加彻底(Entity就是Unity3D中的GameObject), 关于ECS还有待进一步学习.</p>
<p><a href="http://gameprogrammingpatterns.com/component.html" target="_blank" rel="noopener">http://gameprogrammingpatterns.com/component.html</a> 最后提到了Unity3D和XNA中运用Component模式的区别: 二者之间的level不一样, XNA的level是在Game级别, 而Unity3D是在Entity级别.</p>
<blockquote>
<p>The Unity framework’s core GameObject class is designed entirely around components.</p>
</blockquote>
<blockquote>
<p>Microsoft’s XNA game framework comes with a core Game class. It owns a collection of GameComponent objects. Where our example uses components at the individual game entity level, XNA implements the pattern at the level of the main game object itself, but the purpose is the same.</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/08/MonoGame笔记(九)其他几个时间相关程序设计/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/08/MonoGame笔记(九)其他几个时间相关程序设计/" itemprop="url">MonoGame笔记(九)其他几个时间相关程序设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-08T12:13:37+08:00">
                2017-12-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这里介绍其他几个和时间相关的程序设计: 1. 调整单个动画的速度 2.显示帧率(FPS) 3.定时器</p>
<h4 id="调整单个动画的速度"><a href="#调整单个动画的速度" class="headerlink" title="调整单个动画的速度"></a>调整单个动画的速度</h4><p>调整游戏本身的帧率可以影响动画的速度, 但这样的影响是全局的. 不同动画之间的速度是不一样的, 所以需要单个调节. 以下是Learn XNA 4.0中的相关代码:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> timeSinceLastFrame = <span class="number">0</span>; <span class="comment">//自上一帧之后经过了多少时间。</span></span><br><span class="line"><span class="keyword">int</span> millisecondsPerFrame = <span class="number">50</span> <span class="comment">//动画播放的帧率</span></span><br><span class="line">timeSinceLastFrame += gameTime.ElapsedGameTime.Milliseconds; </span><br><span class="line"><span class="keyword">if</span> (timeSinceLastFrame &gt; millisecondsPerFrame) </span><br><span class="line">&#123; </span><br><span class="line">    timeSinceLastFrame-= millisecondsPerFrame; </span><br><span class="line">    ++currentFrame.X; </span><br><span class="line">    <span class="keyword">if</span> (currentFrame.X &gt;= sheetSize.X) <span class="comment">//spritesheet</span></span><br><span class="line">    &#123; </span><br><span class="line">        currentFrame.X = <span class="number">0</span>; </span><br><span class="line">        ++currentFrame.Y; </span><br><span class="line">        <span class="keyword">if</span> (currentFrame.Y &gt;= sheetSize.Y) </span><br><span class="line">            currentFrame.Y = <span class="number">0</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="显示帧率FPS"><a href="#显示帧率FPS" class="headerlink" title="显示帧率FPS"></a>显示帧率FPS</h4><p>来自上一篇笔记中提到作者的文章Displaying the framerate <a href="https://blogs.msdn.microsoft.com/shawnhar/2007/06/08/displaying-the-framerate/" target="_blank" rel="noopener">https://blogs.msdn.microsoft.com/shawnhar/2007/06/08/displaying-the-framerate/</a><br>技巧和<strong>调整单个动画的速度</strong>一样, 这里作者使用1秒钟Draw调用的次数来作为帧率</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FrameRateCounter</span> : <span class="title">DrawableGameComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    ContentManager content;</span><br><span class="line">    SpriteBatch spriteBatch;</span><br><span class="line">    SpriteFont spriteFont;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> frameRate = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> frameCounter = <span class="number">0</span>;</span><br><span class="line">    TimeSpan elapsedTime = TimeSpan.Zero;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FrameRateCounter</span>(<span class="params">Game game</span>): <span class="title">base</span>(<span class="params">game</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        content = <span class="keyword">new</span> ContentManager(game.Services);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">LoadGraphicsContent</span>(<span class="params"><span class="keyword">bool</span> loadAllContent</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (loadAllContent)</span><br><span class="line">        &#123;</span><br><span class="line">            spriteBatch = <span class="keyword">new</span> SpriteBatch(GraphicsDevice);</span><br><span class="line">            spriteFont = content.Load&lt;SpriteFont&gt;(<span class="string">"Font"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UnloadGraphicsContent</span>(<span class="params"><span class="keyword">bool</span> unloadAllContent</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (unloadAllContent)</span><br><span class="line">            content.Unload();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        elapsedTime += gameTime.ElapsedGameTime;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (elapsedTime &gt; TimeSpan.FromSeconds(<span class="number">1</span>))<span class="comment">//elapsedTime大于1秒</span></span><br><span class="line">        &#123;</span><br><span class="line">            elapsedTime -= TimeSpan.FromSeconds(<span class="number">1</span>);</span><br><span class="line">            frameRate = frameCounter;</span><br><span class="line">            frameCounter = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Draw</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        frameCounter++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">string</span> fps = <span class="keyword">string</span>.Format(<span class="string">"fps: &#123;0&#125;"</span>, frameRate);</span><br><span class="line"></span><br><span class="line">        spriteBatch.Begin();</span><br><span class="line"></span><br><span class="line">        spriteBatch.DrawString(spriteFont, fps, <span class="keyword">new</span> Vector2(<span class="number">33</span>, <span class="number">33</span>), Color.Black);</span><br><span class="line">        spriteBatch.DrawString(spriteFont, fps, <span class="keyword">new</span> Vector2(<span class="number">32</span>, <span class="number">32</span>), Color.White);</span><br><span class="line">        </span><br><span class="line">        spriteBatch.End();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用方式:在Game的构造方法中加入下面一行, 关于Component和SpriteFont见以后的笔记<br>Components.Add(new FrameRateCounter(this));</p>
<p>作者还使用了SpriteFont来显示:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">XnaContent</span> <span class="attr">xmlns:Graphics</span>=<span class="string">"Microsoft.Xna.Framework.Content.Pipeline.Graphics"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Asset</span> <span class="attr">Type</span>=<span class="string">"Graphics:FontDescription"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">FontName</span>&gt;</span>Arial<span class="tag">&lt;/<span class="name">FontName</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">Size</span>&gt;</span>14<span class="tag">&lt;/<span class="name">Size</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">Spacing</span>&gt;</span>2<span class="tag">&lt;/<span class="name">Spacing</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">Style</span>&gt;</span><span class="undefined">Regular</span><span class="tag">&lt;/<span class="name">Style</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">CharacterRegions</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">CharacterRegion</span>&gt;</span><span class="tag">&lt;<span class="name">Start</span>&gt;</span>f<span class="tag">&lt;/<span class="name">Start</span>&gt;</span><span class="tag">&lt;<span class="name">End</span>&gt;</span>f<span class="tag">&lt;/<span class="name">End</span>&gt;</span><span class="tag">&lt;/<span class="name">CharacterRegion</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">CharacterRegion</span>&gt;</span><span class="tag">&lt;<span class="name">Start</span>&gt;</span>p<span class="tag">&lt;/<span class="name">Start</span>&gt;</span><span class="tag">&lt;<span class="name">End</span>&gt;</span>p<span class="tag">&lt;/<span class="name">End</span>&gt;</span><span class="tag">&lt;/<span class="name">CharacterRegion</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">CharacterRegion</span>&gt;</span><span class="tag">&lt;<span class="name">Start</span>&gt;</span>s<span class="tag">&lt;/<span class="name">Start</span>&gt;</span><span class="tag">&lt;<span class="name">End</span>&gt;</span>s<span class="tag">&lt;/<span class="name">End</span>&gt;</span><span class="tag">&lt;/<span class="name">CharacterRegion</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">CharacterRegion</span>&gt;</span><span class="tag">&lt;<span class="name">Start</span>&gt;</span>:<span class="tag">&lt;/<span class="name">Start</span>&gt;</span><span class="tag">&lt;<span class="name">End</span>&gt;</span>:<span class="tag">&lt;/<span class="name">End</span>&gt;</span><span class="tag">&lt;/<span class="name">CharacterRegion</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">CharacterRegion</span>&gt;</span><span class="tag">&lt;<span class="name">Start</span>&gt;</span> <span class="tag">&lt;/<span class="name">Start</span>&gt;</span><span class="tag">&lt;<span class="name">End</span>&gt;</span> <span class="tag">&lt;/<span class="name">End</span>&gt;</span><span class="tag">&lt;/<span class="name">CharacterRegion</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">CharacterRegion</span>&gt;</span><span class="tag">&lt;<span class="name">Start</span>&gt;</span>0<span class="tag">&lt;/<span class="name">Start</span>&gt;</span><span class="tag">&lt;<span class="name">End</span>&gt;</span>9<span class="tag">&lt;/<span class="name">End</span>&gt;</span><span class="tag">&lt;/<span class="name">CharacterRegion</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">CharacterRegions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Asset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">XnaContent</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h4><p><a href="https://www.gamedev.net/forums/topic/473544-how-to-make-a-timer-using-xna/" target="_blank" rel="noopener">https://www.gamedev.net/forums/topic/473544-how-to-make-a-timer-using-xna/</a><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TimerComponent</span> : <span class="title">GameComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    TimeSpan interval = <span class="keyword">new</span> TimeSpan(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    TimeSpan lastTick = <span class="keyword">new</span> TimeSpan();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> EventHandler Tick;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> TimeSpan Interval</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> interval; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; interval = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TimerComponent</span>(<span class="params">Game game</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">game</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">GameTime gameTime</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (gameTime.TotalGameTime - lastTick &gt;= interval)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Tick != <span class="literal">null</span>)</span><br><span class="line">                Tick(<span class="keyword">this</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            lastTick = gameTime.TotalGameTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>或者可以试下.NET自带的Timer</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/07/MonoGame笔记(八)Fixed step or variable step/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/07/MonoGame笔记(八)Fixed step or variable step/" itemprop="url">MonoGame笔记(八)Fixed step or variable step</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-07T11:13:37+08:00">
                2017-12-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>用Fixed step还是variable step, XNA团队成员有如下解答<br>understanding-gametime <a href="https://blogs.msdn.microsoft.com/shawnhar/2007/07/25/understanding-gametime/" target="_blank" rel="noopener">https://blogs.msdn.microsoft.com/shawnhar/2007/07/25/understanding-gametime/</a></p>
<p>As a rule of thumb, console programmers prefer fixed timesteps, while PC programmers usually go for variable timing mode. There are two main reasons for this disparity:</p>
<ul>
<li><p>Consoles are usually connected to a 60 hz television, while PC monitors can be set to many different refresh rates.</p>
</li>
<li><p>The speed of a console is known ahead of time, so while games must handle single frames that take longer than expected, it is unlikely they will be consistently too slow for the machine they are running on. PC games must support a wider range of hardware, so it is more important for them to cope well with way-too-slow machines.</p>
</li>
</ul>
<p>主机程序员选择Fixed, PC程序员选择variable. 主机的性能是稳定的, 所以XNA默认是60帧; PC性能差异较大. 下面也说了, 并不绝对.</p>
<p>But there are no absolute rules. I’ve seen console games that worked well using variable timesteps, and I personally shipped a PC title that ran just fine with a 60 fps fixed timestep.</p>
<p>XNA defaults to fixed timestep mode because that is easier to program, but you are welcome to change this if you disagree with our choice.</p>
<h4 id="Multiple-Update-Frequencies"><a href="#Multiple-Update-Frequencies" class="headerlink" title="Multiple Update Frequencies"></a>Multiple Update Frequencies</h4><p>不同的Component还可以用不同的Update rate</p>
<p>There is no law saying all parts of a game must update at the same frequency. For instance MotoGP combined three different update rates:</p>
<ul>
<li><p>The main game logic ran at a fixed timestep 60 fps. This included input, sound, user interface logic, camera movement, rider animations, AI, and graphical effects.</p>
</li>
<li><p>The <strong>physics</strong> update ran at a fixed timestep 120 fps (we just called it twice in a row from our main Update method). This provided a more accurate simulation, which was important for simulating vehicles moving at extremely high speeds and right on the edge of loosing traction.</p>
</li>
<li><p>The <strong>network</strong> update ran at a fixed timestep anywhere between 4 and 30 fps, depending on how many players were in the game. The more players there were, the more data we had to send, so we adjusted by sending it less often to conserve bandwidth.</p>
</li>
</ul>
<p>Running some parts of your update logic less often than others is a great way to make games more efficient. For instance <strong>pathfinding and AI often only need to be updated a couple of times a second</strong>. Once you have found a good path or made the decision to attack, you can follow that decision without having to repeat the entire original calculation on each update.</p>
<p>作者的另外一篇文章 Game timing in XNA Game Studio 2.0<br><a href="https://blogs.msdn.microsoft.com/shawnhar/2007/11/23/game-timing-in-xna-game-studio-2-0/" target="_blank" rel="noopener">https://blogs.msdn.microsoft.com/shawnhar/2007/11/23/game-timing-in-xna-game-studio-2-0/</a><br>讲了XNA 2.0与XNA 1.0用了不同的game loop策略, 值得一读</p>
<p>In 1.0, things worked like this:</p>
<ul>
<li>Call Update as many times as needed to catch up to the current time</li>
<li>Call Draw repeatedly until it is time for the next Update</li>
</ul>
<p>In 2.0, the Draw behavior has changed:</p>
<ul>
<li>Call Update as many times as needed to catch up to the current time</li>
<li>Call Draw once</li>
<li>Wait until it is time for the next Update</li>
</ul>
<p>In other words, we no longer call Draw more than once without an Update in between. That was a pointless thing to do, as it would just render the exact same image a second time!</p>
<p>Here’s why the new behavior is an improvement:</p>
<ul>
<li>Consider a fixed timestep game running at 60 fps, with vsync enabled on a 75 hz monitor</li>
<li>Update completes in, let’s say, 3 milliseconds</li>
<li>Draw completes in, let’s say, 5 milliseconds</li>
<li>This has taken 8 milliseconds total</li>
<li>60 fps is 16.7 milliseconds, so it is not yet time for another Update</li>
<li>We call Draw again</li>
<li>Because <strong>vsync</strong> is enabled, the graphics driver waits 13 milliseconds for the next 75 hz retrace</li>
<li>Yikes! By the time this returns, we have taken 21 milliseconds in total, so we are late for the next Update</li>
</ul>
<p>In practice the effects of this were very minor, because the next Update would quickly catch up to the correct time, but it caused some unnecessary jitter in the rate of calls to Update.</p>
<p>In 2.0, we call Update at more precisely controlled times:</p>
<ul>
<li>Update completes in 3 milliseconds</li>
<li>Draw completes in 5 milliseconds</li>
<li>There are 8.7 milliseconds left over, so we wait exactly that long</li>
<li>Rinse, lather, repeat</li>
</ul>
<p>作者还有其他很多可以学习的文章.</p>
<p>另外以下关于GameLoop的4篇系列文章也值得一读<br>4 - The Game Loop <a href="http://rbwhitaker.wikidot.com/the-game-loop" target="_blank" rel="noopener">http://rbwhitaker.wikidot.com/the-game-loop</a><br>5 - GameTime: A Game’s Heart Beat <a href="http://rbwhitaker.wikidot.com/gametime" target="_blank" rel="noopener">http://rbwhitaker.wikidot.com/gametime</a><br>6 - Time Steps <a href="http://rbwhitaker.wikidot.com/time-steps" target="_blank" rel="noopener">http://rbwhitaker.wikidot.com/time-steps</a><br>7 - Cracking the Game Time Problem <a href="http://rbwhitaker.wikidot.com/cracking-the-game-time-problem" target="_blank" rel="noopener">http://rbwhitaker.wikidot.com/cracking-the-game-time-problem</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/05/MonoGame笔记(七)GameLoop/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/05/MonoGame笔记(七)GameLoop/" itemprop="url">MonoGame笔记(七)Game Loop Timing</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-05T11:17:37+08:00">
                2017-12-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前面2篇笔记提到Game.Tick是在系统Idle状态下被调用的, Idle状态比我们想象的要多的多的多, 而MonoGame默认的帧率是60FPS, 所以在Game.Tick内部还需要对时间进行精确控制. 看过不少资料, 在这方面介绍最好的, 还是XNA的官方文档, 简洁明了. <a href="https://msdn.microsoft.com/en-us/library/bb203873.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/bb203873.aspx</a>, </p>
<h4 id="Game-Loop-Timing"><a href="#Game-Loop-Timing" class="headerlink" title="Game Loop Timing"></a>Game Loop Timing</h4><p>A Game is either <strong>fixed step</strong> or <strong>variable step</strong>, <strong>defaulting</strong> to fixed step. The type of step determines how often <strong>Update</strong> will be called and affects how you need to represent time-based procedures such as <strong>movement</strong> and <strong>animation</strong>.</p>
<p>这一段话包含很多信息. 首先Game Loop Timing有两类: fixed step和variable step, 默认是fixed step(60FPS). 它影响的是<strong>Update</strong>方法被调用的频率, 而不是<strong>Draw</strong>. 在编写<strong>位置</strong>与<strong>动画</strong>相关的代码时, 需要注意. 一个小人往前走, 它既有行走的动画, 同时它的位置也在改变.</p>
<h4 id="Fixed-Step-Game-Loops"><a href="#Fixed-Step-Game-Loops" class="headerlink" title="Fixed-Step Game Loops"></a>Fixed-Step Game Loops</h4><p>A fixed-step Game tries to call its Update method on the fixed interval specified in <strong>TargetElapsedTime</strong>. Setting <strong>Game.IsFixedTimeStep</strong> to true causes aGame to use a fixed-step game loop. A new XNA project uses a fixed-step game loop with a default TargetElapsedTime of 1/60th of a second.</p>
<p>1.设置Game.IsFixedTimeStep为true<br>2.设置帧率TargetElapsedTime</p>
<p>In a fixed-step game loop, Game calls Update once the TargetElapsedTime has elapsed. After Update is called, if it is not time to call Update again,Game calls Draw. After Draw is called, if it is not time to call Update again, Game idles until it is time to call Update.</p>
<p>在fixed-step下, 每隔TargetElapsedTime(假设1/60秒)调用一次Update. 假如一次Update所用的时间小于1/60秒, 那么就继续调用Draw方法. 假如Update+Draw加起来的时间还是小于1/60秒, 那么就等在那里(wait/idle), 直到1/60秒用完, 开始下一个1/60秒. </p>
<p>If Update takes too long to process, Game sets <strong>IsRunningSlowly</strong> to true and calls Update again, without calling Draw in between. When an update runs longer than the TargetElapsedTime, Game responds by calling Update extra times and dropping the frames associated with those updates to catch up. This ensures that Update will have been called the expected number of times when the game loop catches up from a slowdown. You can check the value of IsRunningSlowly in your Update if you want to detect dropped frames and shorten your Update processing to compensate. You can reset the elapsed times by calling ResetElapsedTime.</p>
<p>如果调用Update方法用了很长时间, Game会将IsRunningSlowly设置为True, 并且再次调用Update方法(可能多次), 跳过Draw.每次Update方法调用所花的时间并不一样(有些地方要进行大量的物理碰撞和AI计算), 可以在Update方法内部对IsRunningSlowly进行判断, 如果为真, 则简化某些计算, 这样就可以缩短Update的调用时间. 这部分需要结合代码去理解.</p>
<p>When your game pauses in the debugger, Game will not make extra calls to Update when the game resumes.</p>
<h4 id="Variable-Step-Game-Loops-更推荐用这个"><a href="#Variable-Step-Game-Loops-更推荐用这个" class="headerlink" title="Variable-Step Game Loops(更推荐用这个)"></a>Variable-Step Game Loops(更推荐用这个)</h4><p>A variable-step game calls its Update and Draw methods in a continuous loop without regard to the TargetElapsedTime. Setting Game.IsFixedTimeStepto false causes a Game to use a variable-step game loop.</p>
<p>在variable-step方式下, 调用完Update就接着调用Draw, 之后又是Update, 往复循环, 和TargetElapsedTime无关.</p>
<h4 id="Animation-and-Timing"><a href="#Animation-and-Timing" class="headerlink" title="Animation and Timing"></a>Animation and Timing</h4><p>For operations that require precise timing, such as animation, the type of game loop your game uses (fixed-step or variable-step) is important.</p>
<p>Using a fixed step allows game logic to use the TargetElapsedTime as its basic unit of time and assume that Update will be called at that interval. Using a variable step requires the game logic and animation code to be based on ElapsedGameTime to ensure smooth gameplay. Because the Update method is called immediately after the previous frame is drawn, the time between calls to Update can vary. Without taking the time between calls into account, the game would seem to speed up and slow down. The time elapsed between calls to the Update method is available in the Update method’s gameTime parameter. You can reset the elapsed times by calling ResetElapsedTime.</p>
<p>在fixed step方式下, 可以使用TargetElapsedTime进行计算; 在variable step方式下, 则使用ElapsedGameTime, 这个值是变化的.</p>
<p>When using a variable-step game loop, you should express rates—such as the distance a sprite moves—in game units per millisecond (ms). The amount a sprite moves in any given update can then be calculated as the rate of the sprite times the elapsed time. Using this approach to calculate the distance the sprite moved ensures that the sprite will move consistently if the speed of the game or computer varies.</p>
<p>在variable step方式下, 应该使用速率(rate) * ElapsedGameTime来计算距离. 这样在性能好的与性能不好的机器上, 都能有流畅连续的移动</p>
<p>上面的介绍大致有了一些概念, 具体还是要看Game.Tick()代码实现</p>
<p>MSDN Game.Tick</p>
<ul>
<li>Updates the game’s clock and calls Update and Draw.</li>
<li>In a fixed-step game, Tick calls Update only after a target time interval has elapsed.</li>
<li>In a variable-step game, Update is called every time Tick is called.</li>
</ul>
<p>以下是MonoGame的实现<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Tick</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> This code is very sensitive and can break very badly</span></span><br><span class="line">    <span class="comment">// with even what looks like a safe change.  Be sure to test </span></span><br><span class="line">    <span class="comment">// any change fully in both the fixed and variable timestep </span></span><br><span class="line">    <span class="comment">// modes across multiple devices and platforms.</span></span><br><span class="line"></span><br><span class="line">RetryTick:</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Advance the accumulated elapsed time.</span></span><br><span class="line">    <span class="keyword">var</span> currentTicks = _gameTimer.Elapsed.Ticks;</span><br><span class="line">    _accumulatedElapsedTime += TimeSpan.FromTicks(currentTicks - _previousTicks);</span><br><span class="line">    _previousTicks = currentTicks;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we're in the fixed timestep mode and not enough time has elapsed</span></span><br><span class="line">    <span class="comment">// to perform an update we sleep off the the remaining time to save battery</span></span><br><span class="line">    <span class="comment">// life and/or release CPU time to other threads and processes.</span></span><br><span class="line">    <span class="keyword">if</span> (IsFixedTimeStep &amp;&amp; _accumulatedElapsedTime &lt; TargetElapsedTime)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> sleepTime = (<span class="keyword">int</span>)(TargetElapsedTime - _accumulatedElapsedTime).TotalMilliseconds;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> While sleep can be inaccurate in general it is </span></span><br><span class="line">        <span class="comment">// accurate enough for frame limiting purposes if some</span></span><br><span class="line">        <span class="comment">// fluctuation is an acceptable result.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WINRT</span></span><br><span class="line">        Task.Delay(sleepTime).Wait();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        System.Threading.Thread.Sleep(sleepTime);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">goto</span> RetryTick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not allow any update to take longer than our maximum.</span></span><br><span class="line">    <span class="keyword">if</span> (_accumulatedElapsedTime &gt; _maxElapsedTime)</span><br><span class="line">        _accumulatedElapsedTime = _maxElapsedTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IsFixedTimeStep)</span><br><span class="line">    &#123;</span><br><span class="line">        _gameTime.ElapsedGameTime = TargetElapsedTime;</span><br><span class="line">        <span class="keyword">var</span> stepCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Perform as many full fixed length time steps as we can.</span></span><br><span class="line">        <span class="keyword">while</span> (_accumulatedElapsedTime &gt;= TargetElapsedTime)</span><br><span class="line">        &#123;</span><br><span class="line">            _gameTime.TotalGameTime += TargetElapsedTime;</span><br><span class="line">            _accumulatedElapsedTime -= TargetElapsedTime;</span><br><span class="line">            ++stepCount;</span><br><span class="line"></span><br><span class="line">            DoUpdate(_gameTime);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Every update after the first accumulates lag</span></span><br><span class="line">        _updateFrameLag += Math.Max(<span class="number">0</span>, stepCount - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//If we think we are running slowly, wait until the lag clears before resetting it</span></span><br><span class="line">        <span class="keyword">if</span> (_gameTime.IsRunningSlowly)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_updateFrameLag == <span class="number">0</span>)</span><br><span class="line">                _gameTime.IsRunningSlowly = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (_updateFrameLag &gt;= <span class="number">5</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//If we lag more than 5 frames, start thinking we are running slowly</span></span><br><span class="line">            _gameTime.IsRunningSlowly = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Every time we just do one update and one draw, then we are not running slowly, so decrease the lag</span></span><br><span class="line">        <span class="keyword">if</span> (stepCount == <span class="number">1</span> &amp;&amp; _updateFrameLag &gt; <span class="number">0</span>)</span><br><span class="line">            _updateFrameLag--;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Draw needs to know the total elapsed time</span></span><br><span class="line">        <span class="comment">// that occured for the fixed length updates.</span></span><br><span class="line">        _gameTime.ElapsedGameTime = TimeSpan.FromTicks(TargetElapsedTime.Ticks * stepCount);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Perform a single variable length update.</span></span><br><span class="line">        _gameTime.ElapsedGameTime = _accumulatedElapsedTime;</span><br><span class="line">        _gameTime.TotalGameTime += _accumulatedElapsedTime;</span><br><span class="line">        _accumulatedElapsedTime = TimeSpan.Zero;</span><br><span class="line"></span><br><span class="line">        DoUpdate(_gameTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw unless the update suppressed it.</span></span><br><span class="line">    <span class="keyword">if</span> (_suppressDraw)</span><br><span class="line">        _suppressDraw = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        DoDraw(_gameTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Tick中的顺序是wait-&gt;Update-&gt;Draw, 在fixed-step模式下, 分为2种情况:</p>
<ol>
<li><p>流畅. _accumulatedElapsedTime为上一次执行Tick到这一次执行Tick的TimeSpan. _accumulatedElapsedTime小于TargetElapsedTime, 则用Sleep将剩下的时间补足. 回到Tick的第一行代码, 此时_accumulatedElapsedTime约等于TargetElapsedTime, 往下执行Update方法和Draw方法.</p>
</li>
<li><p>卡顿. _accumulatedElapsedTime为上一次执行Tick到这一次执行Tick的TimeSpan, _accumulatedElapsedTime大于TargetElapsedTime, _accumulatedElapsedTime最大可以为1秒2帧(_maxElapsedTime), 是默认1秒60帧的30倍. 此时不需要Sleep, 直接进入While循环</p>
</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Perform as many full fixed length time steps as we can.</span></span><br><span class="line"><span class="keyword">while</span> (_accumulatedElapsedTime &gt;= TargetElapsedTime)</span><br><span class="line">&#123;</span><br><span class="line">    _gameTime.TotalGameTime += TargetElapsedTime;</span><br><span class="line">    _accumulatedElapsedTime -= TargetElapsedTime;</span><br><span class="line">    ++stepCount;</span><br><span class="line"></span><br><span class="line">    DoUpdate(_gameTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DoUpdate会在While里面最多连续调用30次. 为什么要这么做, 它是怎么能Catch Up from slow down的? 我想, 这里有一个很重要的假设: 这一次Tick调用Update所花费的时间是正常的(假设1/60秒). 上一次Tick调用Update所花费的时间是不正常的(假设1/2秒). 对于Game来说, 上一次的Tick所花费的时间相当于正常情况下的30倍, 即相当于正常情况下的30个Update所需要的时间.30个Update可以做很多事情. 连续30个Update之后, 再调用Draw, 画面上就会出现跳跃. 这应该就是所谓的<em>跳帧</em>, 虽然画面不连续, 但还是赶上了其他人的步伐. </p>
<p>为什么有这样一个假设(这一次Tick的Update是正常开销). 因为如果这一次的Update依旧开销很大, 那么永远都无法catch up. </p>
<p>那正常开销, 就能赶上来吗? while循环中的30个Update()叠加所用的时间不也是很大的开销么?<br>可以这样想, 虽然默认是1/60帧, 这是为了和显示器的刷新频率对应, 本身Update所占的时间可能都在1/600秒(随便举个数字), 1/60帧中的大部分都在Idle. 只要将多次调用Update的时间, 挪到Idle里面, 少Sleep即可</p>
<p>注: 这里有一个疑惑点<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Draw unless the update suppressed it. 注释有问题</span></span><br><span class="line"><span class="keyword">if</span> (_suppressDraw)</span><br><span class="line">    _suppressDraw = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    DoDraw(_gameTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>_suppressDraw为true是在Exit中被调用设置, 并没有在其他地方看到. 所以一次Tick当中, Draw是一定会被调用的, 除非是Exit.</p>
<p>XNA 4.0 Refresh中的实现:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Microsoft.Xna.Framework.Game</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Tick</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.ShouldExit)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>.isActive)</span><br><span class="line">	&#123;</span><br><span class="line">		Thread.Sleep((<span class="keyword">int</span>)<span class="keyword">this</span>.inactiveSleepTime.TotalMilliseconds);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">this</span>.clock.Step();</span><br><span class="line">	<span class="keyword">bool</span> flag = <span class="literal">true</span>;</span><br><span class="line">	TimeSpan timeSpan = <span class="keyword">this</span>.clock.ElapsedAdjustedTime;</span><br><span class="line">	<span class="keyword">if</span> (timeSpan &lt; TimeSpan.Zero)</span><br><span class="line">	&#123;</span><br><span class="line">		timeSpan = TimeSpan.Zero;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.forceElapsedTimeToZero)</span><br><span class="line">	&#123;</span><br><span class="line">		timeSpan = TimeSpan.Zero;</span><br><span class="line">		<span class="keyword">this</span>.forceElapsedTimeToZero = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (timeSpan &gt; <span class="keyword">this</span>.maximumElapsedTime)</span><br><span class="line">	&#123;</span><br><span class="line">		timeSpan = <span class="keyword">this</span>.maximumElapsedTime;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.isFixedTimeStep)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Math.Abs(timeSpan.Ticks - <span class="keyword">this</span>.targetElapsedTime.Ticks) &lt; <span class="keyword">this</span>.targetElapsedTime.Ticks &gt;&gt; <span class="number">6</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			timeSpan = <span class="keyword">this</span>.targetElapsedTime;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.accumulatedElapsedGameTime += timeSpan;</span><br><span class="line">		<span class="keyword">long</span> num = <span class="keyword">this</span>.accumulatedElapsedGameTime.Ticks / <span class="keyword">this</span>.targetElapsedTime.Ticks;</span><br><span class="line">		<span class="keyword">this</span>.accumulatedElapsedGameTime = TimeSpan.FromTicks(<span class="keyword">this</span>.accumulatedElapsedGameTime.Ticks % <span class="keyword">this</span>.targetElapsedTime.Ticks);</span><br><span class="line">		<span class="keyword">this</span>.lastFrameElapsedGameTime = TimeSpan.Zero;</span><br><span class="line">		<span class="keyword">if</span> (num == <span class="number">0L</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		TimeSpan timeSpan2 = <span class="keyword">this</span>.targetElapsedTime;</span><br><span class="line">		<span class="keyword">if</span> (num &gt; <span class="number">1L</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">this</span>.updatesSinceRunningSlowly2 = <span class="keyword">this</span>.updatesSinceRunningSlowly1;</span><br><span class="line">			<span class="keyword">this</span>.updatesSinceRunningSlowly1 = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.updatesSinceRunningSlowly1 &lt; <span class="number">2147483647</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.updatesSinceRunningSlowly1++;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.updatesSinceRunningSlowly2 &lt; <span class="number">2147483647</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.updatesSinceRunningSlowly2++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.drawRunningSlowly = (<span class="keyword">this</span>.updatesSinceRunningSlowly2 &lt; <span class="number">20</span>);</span><br><span class="line">		<span class="keyword">while</span> (num &gt; <span class="number">0L</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.ShouldExit)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			num -= <span class="number">1L</span>;</span><br><span class="line">			<span class="keyword">try</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.gameTime.ElapsedGameTime = timeSpan2;</span><br><span class="line">				<span class="keyword">this</span>.gameTime.TotalGameTime = <span class="keyword">this</span>.totalGameTime;</span><br><span class="line">				<span class="keyword">this</span>.gameTime.IsRunningSlowly = <span class="keyword">this</span>.drawRunningSlowly;</span><br><span class="line">				<span class="keyword">this</span>.Update(<span class="keyword">this</span>.gameTime);</span><br><span class="line">				flag &amp;= <span class="keyword">this</span>.suppressDraw;</span><br><span class="line">				<span class="keyword">this</span>.suppressDraw = <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.lastFrameElapsedGameTime += timeSpan2;</span><br><span class="line">				<span class="keyword">this</span>.totalGameTime += timeSpan2;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		TimeSpan t = timeSpan;</span><br><span class="line">		<span class="keyword">this</span>.drawRunningSlowly = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">this</span>.updatesSinceRunningSlowly1 = <span class="number">2147483647</span>;</span><br><span class="line">		<span class="keyword">this</span>.updatesSinceRunningSlowly2 = <span class="number">2147483647</span>;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.ShouldExit)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">try</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.gameTime.ElapsedGameTime = (<span class="keyword">this</span>.lastFrameElapsedGameTime = t);</span><br><span class="line">				<span class="keyword">this</span>.gameTime.TotalGameTime = <span class="keyword">this</span>.totalGameTime;</span><br><span class="line">				<span class="keyword">this</span>.gameTime.IsRunningSlowly = <span class="literal">false</span>;</span><br><span class="line">				<span class="keyword">this</span>.Update(<span class="keyword">this</span>.gameTime);</span><br><span class="line">				flag &amp;= <span class="keyword">this</span>.suppressDraw;</span><br><span class="line">				<span class="keyword">this</span>.suppressDraw = <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">this</span>.totalGameTime += t;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!flag)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>.DrawFrame();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zmapleaf</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">67</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zmapleaf</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
