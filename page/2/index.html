<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="远">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="远">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="远">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/">





  <title>远</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">远</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/28/Paint.Net笔记(X3) Action & HistoryFunction/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/28/Paint.Net笔记(X3) Action & HistoryFunction/" itemprop="url">Paint.Net笔记(X3) Action 与 HistoryFunction</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-28T17:25:51+08:00">
                2018-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇介绍了ToolForm的操作机制, 这一篇看一下菜单项的操作.</p>
<p>看ImageMenus.cs会发现如下代码<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MenuImageCrop_Click</span>(<span class="params"><span class="keyword">object</span> sender, System.EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (AppWorkspace.ActiveDocumentWorkspace != <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!AppWorkspace.ActiveDocumentWorkspace.Selection.IsEmpty)</span><br><span class="line">		&#123;</span><br><span class="line">			AppWorkspace.ActiveDocumentWorkspace.ExecuteFunction(<span class="keyword">new</span> CropToSelectionFunction());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MenuImageResize_Click</span>(<span class="params"><span class="keyword">object</span> sender, System.EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (AppWorkspace.ActiveDocumentWorkspace != <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		AppWorkspace.ActiveDocumentWorkspace.PerformAction(<span class="keyword">new</span> ResizeAction());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>有些菜单项是ExecuteFunction, 有些菜单项是PerformAction. 各种Action和Function如下图所示<br><img src="/img/paintdotnet-actions.png" alt="">)<br><img src="/img/paintdotnet-functions.png" alt="">)<br>ResizeAction继承DocumentWorkspaceAction, CropToSelectionFunction继承HistoryFunctiont</p>
<p>另外AppWorkspace也能执行Action<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MenuFileOpen_Click</span>(<span class="params"><span class="keyword">object</span> sender, System.EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	AppWorkspace.PerformAction(<span class="keyword">new</span> OpenFileAction());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>OpenFileAction继承AppWorkspaceAction, 另外有些Action不继承其他类.</p>
<p>它们之间的区别是什么?</p>
<p>DocumentWorkspaceAction与AppWorkspaceAction的区别, 一个是作用的对象不同, 另一个是DocumentWorkspaceAction还能够撤销(命令模式+备忘录模式). 如下所示</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">internal</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">AppWorkspaceAction</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">PerformAction</span>(<span class="params">AppWorkspace appWorkspace</span>)</span>;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">AppWorkspaceAction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           SystemLayer.Tracing.LogFeature(<span class="string">"AWAction("</span> + GetType().Name + <span class="string">")"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> Provides a way to do a tool-less action that operates on the DocumentWorkspace.</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> DocumentActions must NOT touch directly the History -- they should return history </span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> actions that can undo what they have already done. These history actions will</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> then be placed in to the history by whomever invoked the DocumentAction.</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> If the action does not affect the Document, it should return null from its</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> PerformAction method.</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> DocumentActions should ONLY mutate the DocumentWorkspace and any contained</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> objects.</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="keyword">internal</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">DocumentWorkspaceAction</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">private</span> ActionFlags actionFlags;</span><br><span class="line">       <span class="keyword">public</span> ActionFlags ActionFlags</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">get</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">this</span>.actionFlags;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> Implement this to provide an action. You must return a HistoryMemento so that you</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> can be undone. However, you should return null if you didn't do anything that</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> affected the document.</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>A HistoryMemento object that will be placed onto the HistoryStack.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> HistoryMemento <span class="title">PerformAction</span>(<span class="params">DocumentWorkspace documentWorkspace</span>)</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> Initializes an instance of a class dervied from DocumentAction.</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="documentWorkspace"&gt;</span>The DocumentWorkspace to interact with.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="actionFlags"&gt;</span>Flags that describe action behavior or requirements.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">DocumentWorkspaceAction</span>(<span class="params">ActionFlags actionFlags</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           <span class="keyword">this</span>.actionFlags = actionFlags;</span><br><span class="line">           SystemLayer.Tracing.LogFeature(<span class="string">"DWAction("</span> + GetType().Name + <span class="string">")"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>那HistoryFunction呢? HistoryFunction与DocumentWorkspaceAction有什么不同<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> HistoryMemento <span class="title">Execute</span>(<span class="params">IHistoryWorkspace historyWorkspace</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> HistoryMemento <span class="title">OnExecute</span>(<span class="params">IHistoryWorkspace historyWorkspace</span>)</span>;</span><br></pre></td></tr></table></figure></p>
<p>从前面2张图片对比, 从名称上看, HistoryFunction貌似更多在和layer和selection打交道.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/28/Paint.Net笔记(X1) 基本结构/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/28/Paint.Net笔记(X1) 基本结构/" itemprop="url">Paint.Net笔记(X1) 基本结构</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-28T15:17:51+08:00">
                2018-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>源码版本：paint.net 3.36 (<a href="https://github.com/rivy/OpenPDN)" target="_blank" rel="noopener">https://github.com/rivy/OpenPDN)</a>, 后续的版本貌似不提供源码了<br>重要的几个工程目录：<br>Base: 基础数据结构, 和项目无关，例如Pair，Tuple，Set，EventArgs等<br>Core：和项目相关的数据结构，例如RendreArgs，Surface，Histogram，HsvColor<br>Data：项目文件类型，例如PdnFileType，JpegFileType等<br><strong>paintdotnet</strong>：主入口，主逻辑<br>Effect：滤镜<br>SystemLayer：和系统相关, 例如ThreadBackground, Memory等，不是图层的Layer<br>Resource：cursor，icon，image等 </p>
<p>启动入口：Startup类<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">StartPart2</span><br><span class="line">&#123;                 </span><br><span class="line">	Application.Run(<span class="keyword">this</span>.mainForm); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">MainForm</span>: <span class="title">PdnBaseForm</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">private</span> AppWorkspace appWorkspace;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitializeComponent</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="keyword">this</span>.components = <span class="keyword">new</span> System.ComponentModel.Container();</span><br><span class="line">		<span class="keyword">this</span>.defaultButton = <span class="keyword">new</span> System.Windows.Forms.Button();</span><br><span class="line">		<span class="comment">// 构造</span></span><br><span class="line">		<span class="keyword">this</span>.appWorkspace = <span class="keyword">new</span> PaintDotNet.AppWorkspace();</span><br><span class="line">		<span class="keyword">this</span>.floaterOpacityTimer = <span class="keyword">new</span> System.Windows.Forms.Timer(<span class="keyword">this</span>.components);</span><br><span class="line">		<span class="keyword">this</span>.deferredInitializationTimer = <span class="keyword">new</span> System.Windows.Forms.Timer(<span class="keyword">this</span>.components);</span><br><span class="line">		<span class="keyword">this</span>.SuspendLayout();</span><br><span class="line">		<span class="comment">// </span></span><br><span class="line">		<span class="comment">// appWorkspace</span></span><br><span class="line">		<span class="comment">// </span></span><br><span class="line">		<span class="keyword">this</span>.appWorkspace.Dock = System.Windows.Forms.DockStyle.Fill;</span><br><span class="line">		<span class="keyword">this</span>.appWorkspace.Location = <span class="keyword">new</span> System.Drawing.Point(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">this</span>.appWorkspace.Name = <span class="string">"appWorkspace"</span>;</span><br><span class="line">		<span class="keyword">this</span>.appWorkspace.Size = <span class="keyword">new</span> System.Drawing.Size(<span class="number">752</span>, <span class="number">648</span>);</span><br><span class="line">		<span class="keyword">this</span>.appWorkspace.TabIndex = <span class="number">2</span>;</span><br><span class="line">		<span class="keyword">this</span>.appWorkspace.ActiveDocumentWorkspaceChanging += <span class="keyword">new</span> EventHandler(AppWorkspace_ActiveDocumentWorkspaceChanging);</span><br><span class="line">		<span class="keyword">this</span>.appWorkspace.ActiveDocumentWorkspaceChanged += <span class="keyword">new</span> EventHandler(AppWorkspace_ActiveDocumentWorkspaceChanged);</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.AutoScaleDimensions = <span class="keyword">new</span> SizeF(<span class="number">96F</span>, <span class="number">96F</span>);</span><br><span class="line">		<span class="keyword">this</span>.AutoScaleMode = System.Windows.Forms.AutoScaleMode.Dpi;</span><br><span class="line">		<span class="keyword">this</span>.ClientSize = <span class="keyword">new</span> System.Drawing.Size(<span class="number">950</span>, <span class="number">738</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 添加appWorkspace</span></span><br><span class="line">		<span class="keyword">this</span>.Controls.Add(<span class="keyword">this</span>.appWorkspace);</span><br><span class="line">		<span class="keyword">this</span>.Controls.Add(<span class="keyword">this</span>.defaultButton);</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AppWorkspace非常关键, 代码如下<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">AppWorkspace</span>: <span class="title">UserControl</span>, <span class="title">ISnapObstacleHost</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">private</span> AppEnvironment appEnvironment; </span><br><span class="line">	<span class="keyword">private</span> DocumentWorkspace activeDocumentWorkspace;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if a new workspace is added, and this workspace is not dirty, then it will be removed. </span></span><br><span class="line">	<span class="comment">// This keeps track of the last workspace added via CreateBlankDocumentInNewWorkspace (if </span></span><br><span class="line">	<span class="comment">// true was passed for its 2nd parameter)</span></span><br><span class="line">	<span class="keyword">private</span> DocumentWorkspace initialWorkspace; </span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;DocumentWorkspace&gt; documentWorkspaces = <span class="keyword">new</span> List&lt;DocumentWorkspace&gt;();</span><br><span class="line">	<span class="keyword">private</span> WorkspaceWidgets widgets;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//状态栏, 工具条, 悬浮窗</span></span><br><span class="line">	<span class="keyword">private</span> Panel workspacePanel;</span><br><span class="line">	<span class="keyword">private</span> PdnToolBar toolBar;</span><br><span class="line">	<span class="keyword">private</span> PdnStatusBar statusBar;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ToolsForm mainToolBarForm;</span><br><span class="line">	<span class="keyword">private</span> LayerForm layerForm;</span><br><span class="line">	<span class="keyword">private</span> HistoryForm historyForm;</span><br><span class="line">	<span class="keyword">private</span> ColorsForm colorsForm;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AppWorkspace</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		SuspendLayout();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// initialize!</span></span><br><span class="line">		InitializeComponent();</span><br><span class="line">		InitializeFloatingForms();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.mainToolBarForm.ToolsControl.SetTools(DocumentWorkspace.ToolInfos);</span><br><span class="line">		<span class="keyword">this</span>.mainToolBarForm.ToolsControl.ToolClicked += <span class="keyword">new</span> ToolClickedEventHandler(<span class="keyword">this</span>.MainToolBar_ToolClicked);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolChooserStrip.SetTools(DocumentWorkspace.ToolInfos);</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolChooserStrip.ToolClicked += <span class="keyword">new</span> ToolClickedEventHandler(<span class="keyword">this</span>.MainToolBar_ToolClicked);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.toolBar.AppWorkspace = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// init the Widgets container</span></span><br><span class="line">		<span class="keyword">this</span>.widgets = <span class="keyword">new</span> WorkspaceWidgets(<span class="keyword">this</span>);</span><br><span class="line">		<span class="keyword">this</span>.widgets.ViewConfigStrip = <span class="keyword">this</span>.toolBar.ViewConfigStrip;</span><br><span class="line">		<span class="keyword">this</span>.widgets.CommonActionsStrip = <span class="keyword">this</span>.toolBar.CommonActionsStrip;</span><br><span class="line">		<span class="keyword">this</span>.widgets.ToolConfigStrip = <span class="keyword">this</span>.toolBar.ToolConfigStrip;</span><br><span class="line">		<span class="keyword">this</span>.widgets.ToolsForm = <span class="keyword">this</span>.mainToolBarForm;</span><br><span class="line">		<span class="keyword">this</span>.widgets.LayerForm = <span class="keyword">this</span>.layerForm;</span><br><span class="line">		<span class="keyword">this</span>.widgets.HistoryForm = <span class="keyword">this</span>.historyForm;</span><br><span class="line">		<span class="keyword">this</span>.widgets.ColorsForm = <span class="keyword">this</span>.colorsForm;</span><br><span class="line">		<span class="keyword">this</span>.widgets.StatusBarProgress = <span class="keyword">this</span>.statusBar;</span><br><span class="line">		<span class="keyword">this</span>.widgets.DocumentStrip = <span class="keyword">this</span>.toolBar.DocumentStrip;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Load our settings and initialize the AppEnvironment</span></span><br><span class="line">		LoadSettings();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// hook into Environment *Changed events</span></span><br><span class="line">		AppEnvironment.PrimaryColorChanged += PrimaryColorChangedHandler;</span><br><span class="line">		AppEnvironment.SecondaryColorChanged += SecondaryColorChangedHandler;</span><br><span class="line">		AppEnvironment.ShapeDrawTypeChanged += ShapeDrawTypeChangedHandler;</span><br><span class="line">		AppEnvironment.GradientInfoChanged += GradientInfoChangedHandler;</span><br><span class="line">		AppEnvironment.ToleranceChanged += OnEnvironmentToleranceChanged;</span><br><span class="line">		AppEnvironment.AlphaBlendingChanged += AlphaBlendingChangedHandler;</span><br><span class="line">		AppEnvironment.FontInfo = <span class="keyword">this</span>.toolBar.ToolConfigStrip.FontInfo;</span><br><span class="line">		AppEnvironment.TextAlignment = <span class="keyword">this</span>.toolBar.ToolConfigStrip.FontAlignment;</span><br><span class="line">		AppEnvironment.AntiAliasingChanged += Environment_AntiAliasingChanged;</span><br><span class="line">		AppEnvironment.FontInfoChanged += Environment_FontInfoChanged;</span><br><span class="line">		AppEnvironment.FontSmoothingChanged += Environment_FontSmoothingChanged;</span><br><span class="line">		AppEnvironment.TextAlignmentChanged += Environment_TextAlignmentChanged;</span><br><span class="line">		AppEnvironment.PenInfoChanged += Environment_PenInfoChanged;</span><br><span class="line">		AppEnvironment.BrushInfoChanged += Environment_BrushInfoChanged;</span><br><span class="line">		AppEnvironment.ColorPickerClickBehaviorChanged += Environment_ColorPickerClickBehaviorChanged;</span><br><span class="line">		AppEnvironment.ResamplingAlgorithmChanged += Environment_ResamplingAlgorithmChanged;</span><br><span class="line">		AppEnvironment.SelectionCombineModeChanged += Environment_SelectionCombineModeChanged;</span><br><span class="line">		AppEnvironment.FloodModeChanged += Environment_FloodModeChanged;</span><br><span class="line">		AppEnvironment.SelectionDrawModeInfoChanged += Environment_SelectionDrawModeInfoChanged;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.toolBar.DocumentStrip.RelinquishFocus += RelinquishFocusHandler;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.ToleranceChanged += OnToolBarToleranceChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.FontAlignmentChanged += ToolConfigStrip_TextAlignmentChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.FontInfoChanged += ToolConfigStrip_FontTextChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.FontSmoothingChanged += ToolConfigStrip_FontSmoothingChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.RelinquishFocus += RelinquishFocusHandler2;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.toolBar.CommonActionsStrip.RelinquishFocus += OnToolStripRelinquishFocus;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.CommonActionsStrip.MouseWheel += OnToolStripMouseWheel;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.CommonActionsStrip.ButtonClick += CommonActionsStrip_ButtonClick;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.toolBar.ViewConfigStrip.DrawGridChanged += ViewConfigStrip_DrawGridChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ViewConfigStrip.RulersEnabledChanged += ViewConfigStrip_RulersEnabledChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ViewConfigStrip.ZoomBasisChanged += ViewConfigStrip_ZoomBasisChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ViewConfigStrip.ZoomScaleChanged += ViewConfigStrip_ZoomScaleChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ViewConfigStrip.ZoomIn += ViewConfigStrip_ZoomIn;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ViewConfigStrip.ZoomOut += ViewConfigStrip_ZoomOut;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ViewConfigStrip.UnitsChanged += ViewConfigStrip_UnitsChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ViewConfigStrip.RelinquishFocus += OnToolStripRelinquishFocus;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ViewConfigStrip.MouseWheel += OnToolStripMouseWheel;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.BrushInfoChanged += DrawConfigStrip_BrushChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.ShapeDrawTypeChanged += DrawConfigStrip_ShapeDrawTypeChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.PenInfoChanged += DrawConfigStrip_PenChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.GradientInfoChanged += ToolConfigStrip_GradientInfoChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.AlphaBlendingChanged += OnDrawConfigStripAlphaBlendingChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.AntiAliasingChanged += DrawConfigStrip_AntiAliasingChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.RelinquishFocus += OnToolStripRelinquishFocus;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.ColorPickerClickBehaviorChanged += ToolConfigStrip_ColorPickerClickBehaviorChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.ResamplingAlgorithmChanged += ToolConfigStrip_ResamplingAlgorithmChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.SelectionCombineModeChanged += ToolConfigStrip_SelectionCombineModeChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.FloodModeChanged += ToolConfigStrip_FloodModeChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.SelectionDrawModeInfoChanged += ToolConfigStrip_SelectionDrawModeInfoChanged;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.SelectionDrawModeUnitsChanging += ToolConfigStrip_SelectionDrawModeUnitsChanging;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.MouseWheel += OnToolStripMouseWheel;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.toolBar.DocumentStrip.RelinquishFocus += OnToolStripRelinquishFocus;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.DocumentStrip.DocumentClicked += DocumentStrip_DocumentTabClicked;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.DocumentStrip.DocumentListChanged += DocumentStrip_DocumentListChanged;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Synchronize</span></span><br><span class="line">		AppEnvironment.PerformAllChanged();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.globalToolTypeChoice = <span class="keyword">this</span>.defaultToolTypeChoice;</span><br><span class="line">		<span class="keyword">this</span>.toolBar.ToolConfigStrip.ToolBarConfigItems = ToolBarConfigItems.None;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.layerForm.LayerControl.AppWorkspace = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">		ResumeLayout();</span><br><span class="line">		PerformLayout();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitializeFloatingForms</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="comment">// MainToolBarForm</span></span><br><span class="line">		mainToolBarForm = <span class="keyword">new</span> ToolsForm();</span><br><span class="line">		mainToolBarForm.RelinquishFocus += RelinquishFocusHandler;</span><br><span class="line">		mainToolBarForm.ProcessCmdKeyEvent += OnToolFormProcessCmdKeyEvent;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// LayerForm</span></span><br><span class="line">		layerForm = <span class="keyword">new</span> LayerForm();</span><br><span class="line">		layerForm.LayerControl.AppWorkspace = <span class="keyword">this</span>;</span><br><span class="line">		layerForm.LayerControl.ClickedOnLayer += LayerControl_ClickedOnLayer;</span><br><span class="line">		layerForm.NewLayerButtonClick += LayerForm_NewLayerButtonClicked;</span><br><span class="line">		layerForm.DeleteLayerButtonClick += LayerForm_DeleteLayerButtonClicked;</span><br><span class="line">		layerForm.DuplicateLayerButtonClick += LayerForm_DuplicateLayerButtonClick;</span><br><span class="line">		layerForm.MergeLayerDownClick += <span class="keyword">new</span> EventHandler(LayerForm_MergeLayerDownClick);</span><br><span class="line">		layerForm.MoveLayerUpButtonClick += LayerForm_MoveLayerUpButtonClicked;</span><br><span class="line">		layerForm.MoveLayerDownButtonClick += LayerForm_MoveLayerDownButtonClicked;</span><br><span class="line">		layerForm.PropertiesButtonClick += LayerForm_PropertiesButtonClick;</span><br><span class="line">		layerForm.RelinquishFocus += RelinquishFocusHandler;</span><br><span class="line">		layerForm.ProcessCmdKeyEvent += OnToolFormProcessCmdKeyEvent;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// HistoryForm</span></span><br><span class="line">		historyForm = <span class="keyword">new</span> HistoryForm();</span><br><span class="line">		historyForm.RewindButtonClicked += HistoryForm_RewindButtonClicked;</span><br><span class="line">		historyForm.UndoButtonClicked += HistoryForm_UndoButtonClicked;</span><br><span class="line">		historyForm.RedoButtonClicked += HistoryForm_RedoButtonClicked;</span><br><span class="line">		historyForm.FastForwardButtonClicked += HistoryForm_FastForwardButtonClicked;</span><br><span class="line">		historyForm.RelinquishFocus += RelinquishFocusHandler;</span><br><span class="line">		historyForm.ProcessCmdKeyEvent += OnToolFormProcessCmdKeyEvent;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ColorsForm</span></span><br><span class="line">		colorsForm = <span class="keyword">new</span> ColorsForm();</span><br><span class="line">		colorsForm.PaletteCollection = <span class="keyword">new</span> PaletteCollection();</span><br><span class="line">		colorsForm.WhichUserColor = WhichUserColor.Primary;</span><br><span class="line">		colorsForm.UserPrimaryColorChanged += ColorsForm_UserPrimaryColorChanged;</span><br><span class="line">		colorsForm.UserSecondaryColorChanged += ColorsForm_UserSecondaryColorChanged;</span><br><span class="line">		colorsForm.RelinquishFocus += RelinquishFocusHandler;</span><br><span class="line">		colorsForm.ProcessCmdKeyEvent += OnToolFormProcessCmdKeyEvent;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下图是Paint.Net的UI界面<br><img src="/img/paintdotnet-1.png" alt=""></p>
<p>是个悬浮窗分别是ToolsForm, LayerForm, HistoryForm, ColorsForm. 中间图像所在区域可以理解为DocumentWorkspace. 由于可以打开多张图像, 所以存在一个DocumentWorkspace列表. 当前正在处理的是activeDocumentWorkspace. 另外还有一个WorkspaceWidgets, 代码中将layerForm, historyForm, colorsForm, mainToolBarForm都赋值给了它</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/28/Paint.Net笔记(X2) ToolForm/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/28/Paint.Net笔记(X2) ToolForm/" itemprop="url">Paint.Net笔记(X2) ToolForm</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-28T15:17:51+08:00">
                2018-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇笔记整理了Paint.Net的基本结构. 这一篇整理一下Paint.Net中的Tool工具是如何对图形进行操作的.</p>
<p>首先是有一个toolsForm的悬浮窗<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">ToolsForm</span> </span><br><span class="line">	: <span class="title">FloatingToolForm</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">private</span> ToolsControl toolsControl = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在Paint.Net中窗口的继承结构如下图所示:<br><img src="/img/paintdotnet-2.png" alt=""></p>
<p>ToolsForm内部包含ToolsControl, 后者包含各种Tool的toolStripEx. 再在toolStripEx中添加各种工具的button<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">ToolsControl</span> </span><br><span class="line">       : <span class="title">UserControl</span>, </span><br><span class="line">         <span class="title">IToolChooser</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">private</span> ToolStripEx toolStripEx;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//添加tool button</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetTools</span>(<span class="params">ToolInfo[] toolInfos</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">this</span>.toolStripEx != <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">this</span>.toolStripEx.Items.Clear();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">this</span>.imageList = <span class="keyword">new</span> ImageList();</span><br><span class="line">           <span class="keyword">this</span>.imageList.ColorDepth = ColorDepth.Depth32Bit;</span><br><span class="line">           <span class="keyword">this</span>.imageList.TransparentColor = Utility.TransparentKey;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">this</span>.toolStripEx.ImageList = <span class="keyword">this</span>.imageList;</span><br><span class="line"></span><br><span class="line">           ToolStripItem[] buttons = <span class="keyword">new</span> ToolStripItem[toolInfos.Length];</span><br><span class="line">           <span class="keyword">string</span> toolTipFormat = PdnResources.GetString(<span class="string">"ToolsControl.ToolToolTip.Format"</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; toolInfos.Length; ++i)</span><br><span class="line">           &#123;</span><br><span class="line">               ToolInfo toolInfo = toolInfos[i];</span><br><span class="line">               ToolStripButton button = <span class="keyword">new</span> ToolStripButton();</span><br><span class="line"></span><br><span class="line">               <span class="keyword">int</span> imageIndex = imageList.Images.Add(</span><br><span class="line">                   toolInfo.Image.Reference,</span><br><span class="line">                   imageList.TransparentColor);</span><br><span class="line"></span><br><span class="line">               button.ImageIndex = imageIndex;</span><br><span class="line">               button.Tag = toolInfo.ToolType;</span><br><span class="line">               button.ToolTipText = <span class="keyword">string</span>.Format(toolTipFormat, toolInfo.Name, <span class="keyword">char</span>.ToUpperInvariant(toolInfo.HotKey).ToString());</span><br><span class="line">               buttons[i] = button;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">this</span>.toolStripEx.Items.AddRange(buttons);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 增加tool按钮的点击事件</span></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ToolStripEx_ItemClicked</span>(<span class="params"><span class="keyword">object</span> sender, ToolStripItemClickedEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           <span class="keyword">foreach</span> (ToolStripButton button <span class="keyword">in</span> <span class="keyword">this</span>.toolStripEx.Items)</span><br><span class="line">           &#123;</span><br><span class="line">               button.Checked = (button == e.ClickedItem);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           OnToolClicked((Type)e.ClickedItem.Tag);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">event</span> ToolClickedEventHandler ToolClicked;</span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnToolClicked</span>(<span class="params">Type toolType</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">this</span>.ignoreToolClicked &lt;= <span class="number">0</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">if</span> (ToolClicked != <span class="literal">null</span>)</span><br><span class="line">               &#123;</span><br><span class="line">                   ToolClicked(<span class="keyword">this</span>, <span class="keyword">new</span> ToolClickedEventArgs(toolType));</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">ToolInfo</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> name;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> helpText;</span><br><span class="line">       <span class="keyword">private</span> ImageResource image;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">bool</span> skipIfActiveOnHotKey;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">char</span> hotKey;</span><br><span class="line">       <span class="keyword">private</span> Type toolType; <span class="comment">//具体的工具类型</span></span><br><span class="line">       <span class="keyword">private</span> ToolBarConfigItems toolBarConfigItems;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>各种tool如下所示:<br><img src="/img/paintdotnet-tools.png" alt=""></p>
<p>ToolClicked事件是在AppWorkspace的构造方法中被监听的<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AppWorkspace</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SuspendLayout();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// initialize!</span></span><br><span class="line">	InitializeComponent();</span><br><span class="line">	InitializeFloatingForms();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.mainToolBarForm.ToolsControl.SetTools(DocumentWorkspace.ToolInfos);</span><br><span class="line">	<span class="keyword">this</span>.mainToolBarForm.ToolsControl.ToolClicked += <span class="keyword">new</span> ToolClickedEventHandler(<span class="keyword">this</span>.MainToolBar_ToolClicked);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MainToolBar_ToolClicked</span>(<span class="params"><span class="keyword">object</span> sender, ToolClickedEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (ActiveDocumentWorkspace != <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		ActiveDocumentWorkspace.Focus();</span><br><span class="line">		ActiveDocumentWorkspace.SetToolFromType(e.ToolType);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后转移到ActiveDocumentWorkspace<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetToolFromType</span>(<span class="params">Type toolType</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (toolType == GetToolType())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (toolType == <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		SetTool(<span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Tool newTool = CreateTool(toolType);</span><br><span class="line">		SetTool(newTool);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SetTool内部会调用Tool的PerformActivate方法, 并将该tool设为activeTool<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Methods to send messages to this class</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PerformActivate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Activate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Activate方法又会调用OnActivate方法, 后者是一个虚方法, 由子类去实现, 这里以PencilTool为例(看了一圈, PencilTool这个最简单)<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActivate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">base</span>.OnActivate();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.pencilToolCursor = <span class="keyword">new</span> Cursor(PdnResources.GetResourceStream(<span class="string">"Cursors.PencilToolCursor.cur"</span>));</span><br><span class="line">    <span class="keyword">this</span>.Cursor = <span class="keyword">this</span>.pencilToolCursor; <span class="comment">//改变鼠标形状</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.savedRects = <span class="keyword">new</span> List&lt;Rectangle&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ActiveLayer != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        bitmapLayer = (BitmapLayer)ActiveLayer;</span><br><span class="line">        renderArgs = <span class="keyword">new</span> RenderArgs(bitmapLayer.Surface);</span><br><span class="line">        tracePoints = <span class="keyword">new</span> List&lt;Point&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        bitmapLayer = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (renderArgs != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            renderArgs.Dispose();</span><br><span class="line">            renderArgs = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PencilTool被激活后, 用户用鼠标在activeDocumentWorkspace上绘图. 鼠标事件如何传递到PencilTool? 看下面的代码<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AppWorkspace.cs</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnActiveDocumentWorkspaceChanged</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.activeDocumentWorkspace.DocumentMouseEnter += <span class="keyword">this</span>.DocumentMouseEnterHandler;</span><br><span class="line">		<span class="keyword">this</span>.activeDocumentWorkspace.DocumentMouseLeave += <span class="keyword">this</span>.DocumentMouseLeaveHandler;</span><br><span class="line">		<span class="keyword">this</span>.activeDocumentWorkspace.DocumentMouseMove += <span class="keyword">this</span>.DocumentMouseMoveHandler;</span><br><span class="line">		<span class="keyword">this</span>.activeDocumentWorkspace.DocumentMouseDown += <span class="keyword">this</span>.DocumentMouseDownHandler;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DocumentMouseMoveHandler</span>(<span class="params"><span class="keyword">object</span> sender, MouseEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (ActiveDocumentWorkspace.Tool != <span class="literal">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		ActiveDocumentWorkspace.Tool.PerformMouseMove(e); <span class="comment">// ActiveDocumentWorkspace.Tool为activeTool</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再到Tool类<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PerformMouseMove</span>(<span class="params">MouseEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (IsOverflow(e)) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (e <span class="keyword">is</span> StylusEventArgs)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.SupportsInk) </span><br><span class="line">		&#123;</span><br><span class="line">			StylusMove(e <span class="keyword">as</span> StylusEventArgs);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if the tool does not claim ink support, discard</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		MouseMove(e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MouseMove被PencilTool重写, 内部调用DrawLines方法, 后者调用DrawPoint方法<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Draws a point, but first intersects it with the selection</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawPoint</span>(<span class="params">RenderArgs ra, Point p, ColorBgra color</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (ra.Surface.Bounds.Contains(p))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (ra.Graphics.IsVisible(p))</span><br><span class="line">		&#123;</span><br><span class="line">			BinaryPixelOp op = AppEnvironment.AlphaBlending ? blendOp : copyOp;</span><br><span class="line">			ra.Surface[p.X, p.Y] = op.Apply(ra.Surface[p.X, p.Y], color);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后在看一下DocumentWorkspace初始化ToolInfo<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DocumentWorkspace.cs</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitializeTools</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="comment">// add all the tools</span></span><br><span class="line">		tools = <span class="keyword">new</span> Type[] </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">typeof</span>(RectangleSelectTool),</span><br><span class="line">			<span class="keyword">typeof</span>(MoveTool),</span><br><span class="line">			<span class="keyword">typeof</span>(LassoSelectTool),</span><br><span class="line">			<span class="keyword">typeof</span>(MoveSelectionTool),</span><br><span class="line"></span><br><span class="line">			<span class="keyword">typeof</span>(EllipseSelectTool),</span><br><span class="line">			<span class="keyword">typeof</span>(ZoomTool),</span><br><span class="line"></span><br><span class="line">			<span class="keyword">typeof</span>(MagicWandTool),</span><br><span class="line">			<span class="keyword">typeof</span>(PanTool),</span><br><span class="line"></span><br><span class="line">			<span class="keyword">typeof</span>(PaintBucketTool),</span><br><span class="line">			<span class="keyword">typeof</span>(GradientTool),</span><br><span class="line"></span><br><span class="line">			<span class="keyword">typeof</span>(PaintBrushTool),</span><br><span class="line">			<span class="keyword">typeof</span>(EraserTool),</span><br><span class="line">			<span class="keyword">typeof</span>(PencilTool),</span><br><span class="line">			<span class="keyword">typeof</span>(ColorPickerTool),</span><br><span class="line">			<span class="keyword">typeof</span>(CloneStampTool), </span><br><span class="line">			<span class="keyword">typeof</span>(RecolorTool),</span><br><span class="line">			<span class="keyword">typeof</span>(TextTool),</span><br><span class="line"></span><br><span class="line">			<span class="keyword">typeof</span>(LineTool),</span><br><span class="line">			<span class="keyword">typeof</span>(RectangleTool),</span><br><span class="line">			<span class="keyword">typeof</span>(RoundedRectangleTool),</span><br><span class="line">			<span class="keyword">typeof</span>(EllipseTool),</span><br><span class="line">			<span class="keyword">typeof</span>(FreeformShapeTool),</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitializeToolInfos</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">		toolInfos = <span class="keyword">new</span> ToolInfo[tools.Length];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">foreach</span> (Type toolType <span class="keyword">in</span> tools)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">using</span> (Tool tool = DocumentWorkspace.CreateTool(toolType, <span class="literal">null</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				toolInfos[i] = tool.Info;</span><br><span class="line">				++i;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/28/2D Visualization笔记(X0) HueRing/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/28/2D Visualization笔记(X0) HueRing/" itemprop="url">2D Visualization笔记(X0) HueRing</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-28T09:03:51+08:00">
                2018-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>为油画生成色相轮<br><a href="https://github.com/zmapleaf/TypeScriptHTMLApp_HueRing-1" target="_blank" rel="noopener">https://github.com/zmapleaf/TypeScriptHTMLApp_HueRing-1</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/25/WPF笔记(X1) Threading Model (四)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/25/WPF笔记(X1) Threading Model (四)/" itemprop="url">WPF笔记(X1) Threading Model (四)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-25T10:21:37+08:00">
                2018-04-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这一篇整理一下DispatcherTimer. 看DispatcherTimer之前, 先看一下.Net中的其他Timer</p>
<p>Timer(C# in a nutshell 6th)<br>The .NET Framework provides four timers. Two of these are general-purpose <strong>multithreaded</strong> timers:</p>
<ul>
<li>System.Threading.Timer</li>
<li>System.Timers.Timer</li>
</ul>
<p>The other two are special-purpose <strong>single-threaded</strong> timers:</p>
<ul>
<li>System.Windows.Forms.Timer (Windows Forms timer)</li>
<li>System.Windows.Threading.DispatcherTimer (WPF timer)</li>
</ul>
<p>The multithreaded timers are more powerful, accurate, and flexible; the singlethreaded timers are safer and more convenient for running simple tasks that update Windows Forms controls or WPF elements.<br>System.Threading.Timer is the simplest multithreaded timer: it has just a constructor and two methods </p>
<p>The .NET Framework provides another timer class of the same name in the System.Timers namespace. This simply wraps the System.Threading.Timer (参考:<a href="https://www.gnu.org/software/dotgnu/pnetlib-doc/System/Threading/Timer.html" target="_blank" rel="noopener">https://www.gnu.org/software/dotgnu/pnetlib-doc/System/Threading/Timer.html</a>)</p>
<p>Multithreaded timers use the <strong>thread pool</strong> to allow a few threads to serve many timers. This means that the callback method or Elapsed event may fire on a different thread each time it is called. Furthermore, the Elapsed event always fires(approximately) on time—regardless of whether the previous Elapsed event finished executing. Hence, callbacks or event handlers must be thread-safe.</p>
<p>使用的是线程池, 回调函数有可能是在不同的线程中被调用. 不管前一个调用是否完成, 后一个调用会如期而至, 因此回调函数必须是线程安全的(可重入的)</p>
<p>定时器精度在10-20ms之间</p>
<p>而DispatcherTimer的时间精度就没那么准(参考:<a href="https://msdn.microsoft.com/en-us/library/system.windows.threading.dispatchertimer.interval(v=vs.110).aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/system.windows.threading.dispatchertimer.interval(v=vs.110).aspx</a>)</p>
<blockquote>
<p>Timers are not guaranteed to execute exactly when the time interval occurs, but they are guaranteed to not execute before the time interval occurs. This is because <strong>DispatcherTimer operations are placed on the Dispatcher queue like other operations</strong>. When the DispatcherTimer operation executes is dependent on the other jobs in the queue and their priorities.</p>
</blockquote>
<p>如果要计时的话, 用stopwatch, 参考<a href="https://stackoverflow.com/questions/4251644/getting-elapsed-time-with-dispatchtimer-to-1-millisecond-accuracy" target="_blank" rel="noopener">https://stackoverflow.com/questions/4251644/getting-elapsed-time-with-dispatchtimer-to-1-millisecond-accuracy</a><br>和<a href="https://social.msdn.microsoft.com/forums/windowsapps/en-us/058a755e-059b-45ee-b5ec-3d35f3b53515/dispatchertimer-accuracy" target="_blank" rel="noopener">https://social.msdn.microsoft.com/forums/windowsapps/en-us/058a755e-059b-45ee-b5ec-3d35f3b53515/dispatchertimer-accuracy</a></p>
<p>DispatcherTimer这个类不复杂, 阅读它的代码能学到不少东西, 可以进一步了解Dispatcher的运行方式. </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Windows;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> MS.Internal.WindowsBase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">System.Windows.Threading</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>     A timer that is integrated into the Dispatcher queues, and will</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>     be processed after a given amount of time at a specified priority.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DispatcherTimer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Creates a timer that uses the current thread's Dispatcher to</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     process the timer event at background priority.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DispatcherTimer</span>(<span class="params"></span>) : <span class="title">this</span>(<span class="params">DispatcherPriority.Background</span>)  <span class="comment">// <span class="doctag">NOTE:</span> should be Priority Dispatcher.BackgroundPriority</span></span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Creates a timer that uses the current thread's Dispatcher to</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     process the timer event at the specified priority.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="priority"&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     The priority to process the timer at.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DispatcherTimer</span>(<span class="params">DispatcherPriority priority</span>) <span class="comment">// <span class="doctag">NOTE:</span> should be Priority</span></span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Initialize(Dispatcher.CurrentDispatcher, priority, TimeSpan.FromMilliseconds(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Creates a timer that uses the specified Dispatcher to</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     process the timer event at the specified priority.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="priority"&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     The priority to process the timer at.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="dispatcher"&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     The dispatcher to use to process the timer.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DispatcherTimer</span>(<span class="params">DispatcherPriority priority, Dispatcher dispatcher</span>)  <span class="comment">// <span class="doctag">NOTE:</span> should be Priority</span></span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span>(dispatcher == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"dispatcher"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            Initialize(dispatcher, priority, TimeSpan.FromMilliseconds(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Creates a timer that is bound to the specified dispatcher and</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     will be processed at the specified priority, after the</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     specified timeout.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="interval"&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     The interval to tick the timer after.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="priority"&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     The priority to process the timer at.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="callback"&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     The callback to call when the timer ticks.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="dispatcher"&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     The dispatcher to use to process the timer.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DispatcherTimer</span>(<span class="params">TimeSpan interval, DispatcherPriority priority, EventHandler callback, Dispatcher dispatcher</span>) <span class="comment">// <span class="doctag">NOTE:</span> should be Priority</span></span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// </span></span><br><span class="line">            <span class="keyword">if</span>(callback == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"callback"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(dispatcher == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"dispatcher"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (interval.TotalMilliseconds &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">"interval"</span>, SR.Get(SRID.TimeSpanPeriodOutOfRange_TooSmall));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (interval.TotalMilliseconds &gt; Int32.MaxValue)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">"interval"</span>, SR.Get(SRID.TimeSpanPeriodOutOfRange_TooLarge));</span><br><span class="line"></span><br><span class="line">            Initialize(dispatcher, priority, interval);</span><br><span class="line">            </span><br><span class="line">            Tick += callback;</span><br><span class="line">            Start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Gets the dispatcher this timer is associated with.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> Dispatcher Dispatcher</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> _dispatcher;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Gets or sets whether the timer is running.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> IsEnabled</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> _isEnabled;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">lock</span>(_instanceLock)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(!<span class="keyword">value</span> &amp;&amp; _isEnabled)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Stop();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">value</span> &amp;&amp; !_isEnabled)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Start();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Gets or sets the time between timer ticks.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> TimeSpan Interval</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> _interval;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">bool</span> updateWin32Timer = <span class="literal">false</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">value</span>.TotalMilliseconds &lt; <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">"value"</span>, SR.Get(SRID.TimeSpanPeriodOutOfRange_TooSmall));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">value</span>.TotalMilliseconds &gt; Int32.MaxValue)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">"value"</span>, SR.Get(SRID.TimeSpanPeriodOutOfRange_TooLarge));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">lock</span>(_instanceLock)</span><br><span class="line">                &#123;</span><br><span class="line">                    _interval = <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(_isEnabled)</span><br><span class="line">                    &#123;</span><br><span class="line">                        _dueTimeInTicks = Environment.TickCount + (<span class="keyword">int</span>)_interval.TotalMilliseconds;</span><br><span class="line">                        updateWin32Timer = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(updateWin32Timer)</span><br><span class="line">                &#123;</span><br><span class="line">                    _dispatcher.UpdateWin32Timer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Starts the timer.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span>(_instanceLock)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(!_isEnabled)</span><br><span class="line">                &#123;</span><br><span class="line">                    _isEnabled = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                    Restart();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Stops the timer.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Stop</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">bool</span> updateWin32Timer = <span class="literal">false</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">lock</span>(_instanceLock)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(_isEnabled)</span><br><span class="line">                &#123;</span><br><span class="line">                    _isEnabled = <span class="literal">false</span>;</span><br><span class="line">                    updateWin32Timer = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// If the operation is in the queue, abort it.</span></span><br><span class="line">                    <span class="keyword">if</span>(_operation != <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        _operation.Abort();</span><br><span class="line">                        _operation = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(updateWin32Timer)</span><br><span class="line">            &#123;</span><br><span class="line">                _dispatcher.RemoveTimer(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Occurs when the specified timer interval has elapsed and the</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     timer is enabled.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">event</span> EventHandler Tick;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Any data that the caller wants to pass along with the timer.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">object</span> Tag</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> _tag;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                _tag = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Initialize</span>(<span class="params">Dispatcher dispatcher, DispatcherPriority priority, TimeSpan interval</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Note: all callers of this have a "priority" parameter.</span></span><br><span class="line">            Dispatcher.ValidatePriority(priority, <span class="string">"priority"</span>);</span><br><span class="line">            <span class="keyword">if</span>(priority == DispatcherPriority.Inactive)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(SR.Get(SRID.InvalidPriority), <span class="string">"priority"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _dispatcher = dispatcher;</span><br><span class="line">            _priority = priority;</span><br><span class="line">            _interval = interval;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Restart</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span>(_instanceLock)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (_operation != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// Timer has already been restarted, e.g. Start was called form the Tick handler.</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// BeginInvoke a new operation.</span></span><br><span class="line">                _operation = _dispatcher.BeginInvoke(</span><br><span class="line">                    DispatcherPriority.Inactive,</span><br><span class="line">                    <span class="keyword">new</span> DispatcherOperationCallback(FireTick),</span><br><span class="line">                    <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">                </span><br><span class="line">                _dueTimeInTicks = Environment.TickCount + (<span class="keyword">int</span>) _interval.TotalMilliseconds;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (_interval.TotalMilliseconds == <span class="number">0</span> &amp;&amp; _dispatcher.CheckAccess())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// shortcut - just promote the item now</span></span><br><span class="line">                    Promote();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    _dispatcher.AddTimer(<span class="keyword">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">Promote</span>(<span class="params"></span>) <span class="comment">// called from Dispatcher</span></span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span>(_instanceLock)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Simply promote the operation to it's desired priority.</span></span><br><span class="line">                <span class="keyword">if</span>(_operation != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    _operation.Priority = _priority;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">object</span> <span class="title">FireTick</span>(<span class="params"><span class="keyword">object</span> unused</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// The operation has been invoked, so forget about it.</span></span><br><span class="line">            _operation = <span class="literal">null</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// The dispatcher thread is calling us because item's priority</span></span><br><span class="line">            <span class="comment">// was changed from inactive to something else.</span></span><br><span class="line">            <span class="keyword">if</span>(Tick != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Tick(<span class="keyword">this</span>, EventArgs.Empty);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If we are still enabled, start the timer again.</span></span><br><span class="line">            <span class="keyword">if</span>(_isEnabled)</span><br><span class="line">            &#123;</span><br><span class="line">                Restart();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// This is the object we use to synchronize access.</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">object</span> _instanceLock = <span class="keyword">new</span> <span class="keyword">object</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Note: We cannot BE a dispatcher-affinity object because we can be</span></span><br><span class="line">        <span class="comment">// created by a worker thread.  We are still associated with a</span></span><br><span class="line">        <span class="comment">// dispatcher (where we post the item) but we can be accessed</span></span><br><span class="line">        <span class="comment">// by any thread.</span></span><br><span class="line">        <span class="keyword">private</span> Dispatcher _dispatcher;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> DispatcherPriority _priority;  <span class="comment">// <span class="doctag">NOTE:</span> should be Priority</span></span><br><span class="line">        <span class="keyword">private</span> TimeSpan _interval;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">object</span> _tag;</span><br><span class="line">        <span class="keyword">private</span> DispatcherOperation _operation;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _isEnabled;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">internal</span> <span class="keyword">int</span> _dueTimeInTicks; <span class="comment">// used by Dispatcher</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从DispatcherTimer的使用方式入手<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  DispatcherTimer setup</span></span><br><span class="line">dispatcherTimer = <span class="keyword">new</span> System.Windows.Threading.DispatcherTimer();</span><br><span class="line">dispatcherTimer.Tick += <span class="keyword">new</span> EventHandler(dispatcherTimer_Tick);</span><br><span class="line">dispatcherTimer.Interval = <span class="keyword">new</span> TimeSpan(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">dispatcherTimer.Start();</span><br></pre></td></tr></table></figure></p>
<p>无参构造方法DispatcherTimer()将DispatcherPriority设为Background<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     Creates a timer that uses the current thread's Dispatcher to</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     process the timer event at background priority.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DispatcherTimer</span>(<span class="params"></span>) : <span class="title">this</span>(<span class="params">DispatcherPriority.Background</span>)  <span class="comment">// <span class="doctag">NOTE:</span> should be Priority Dispatcher.BackgroundPriority</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Background优先级很低, 所以不一定能够按时执行.</p>
<p>再看Start方法<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     Starts the timer.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">lock</span>(_instanceLock)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!_isEnabled)</span><br><span class="line">        &#123;</span><br><span class="line">            _isEnabled = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            Restart();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用的是Restart()<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Restart</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">lock</span>(_instanceLock)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_operation != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Timer has already been restarted, e.g. Start was called form the Tick handler.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// BeginInvoke a new operation.</span></span><br><span class="line">        _operation = _dispatcher.BeginInvoke(</span><br><span class="line">            DispatcherPriority.Inactive,</span><br><span class="line">            <span class="keyword">new</span> DispatcherOperationCallback(FireTick),</span><br><span class="line">            <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        _dueTimeInTicks = Environment.TickCount + (<span class="keyword">int</span>) _interval.TotalMilliseconds;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (_interval.TotalMilliseconds == <span class="number">0</span> &amp;&amp; _dispatcher.CheckAccess())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// shortcut - just promote the item now</span></span><br><span class="line">            Promote();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            _dispatcher.AddTimer(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法比较关键</p>
<ol>
<li>它往Dispatcher Queue里面放了一个Operation, 但它的优先级是DispatcherPriority.Inactive. 顾名思义, 这个优先级表示该Operation是不激活状态. 它不会被执行<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     Operations at this priority are not processed.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">Inactive = <span class="number">0</span>,</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>因为时间间隔不到, Operation不能被执行. 只有时间间隔到了, Operation才会被激活. 如何激活? 且看下面</p>
<ol start="2">
<li>Promote()方法, 就是激活该Operation. Promote是提升的意思, 也就是提升Operation的优先级. <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">Promote</span>(<span class="params"></span>) <span class="comment">// called from Dispatcher</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">lock</span>(_instanceLock)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Simply promote the operation to it's desired priority.</span></span><br><span class="line">        <span class="keyword">if</span>(_operation != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            _operation.Priority = _priority;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>_priority构造的时候为DispatcherPriority.Background. 即从DispatcherPriority.Inactive提升(Promote)到<br>DispatcherPriority.Background. 如此, Operation就可以被执行了.</p>
<p>注意<strong>called from Dispatcher</strong>, 表示, 时间间隔到了, 提升Operation的优先级是由Dispatcher来完成的.<br>Dispatcher和DispatcherTimer有什么关系呢? 且看下面</p>
<ol start="3">
<li>_dispatcher.AddTimer(this);<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">AddTimer</span>(<span class="params">DispatcherTimer timer</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">lock</span>(_instanceLock)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!_hasShutdownFinished) <span class="comment">// Could be a non-dispatcher thread, lock to read</span></span><br><span class="line">        &#123;</span><br><span class="line">            _timers.Add(timer);</span><br><span class="line">            _timersVersion++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    UpdateWin32Timer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>添加了一个DispatcherTimer, 需要UpdateWin32Timer, 去操作系统设置定时器</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">UpdateWin32Timer</span>(<span class="params"></span>) <span class="comment">// Called from DispatcherTimer</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(CheckAccess())</span><br><span class="line">    &#123;</span><br><span class="line">        UpdateWin32TimerFromDispatcherThread(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        BeginInvoke(DispatcherPriority.Send,</span><br><span class="line">                    <span class="keyword">new</span> DispatcherOperationCallback(UpdateWin32TimerFromDispatcherThread),</span><br><span class="line">                    <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">object</span> <span class="title">UpdateWin32TimerFromDispatcherThread</span>(<span class="params"><span class="keyword">object</span> unused</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">lock</span>(_instanceLock)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!_hasShutdownFinished) <span class="comment">// Dispatcher thread, does not technically need the lock to read</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">bool</span> oldDueTimeFound = _dueTimeFound;</span><br><span class="line">            <span class="keyword">int</span> oldDueTimeInTicks = _dueTimeInTicks;</span><br><span class="line">            _dueTimeFound = <span class="literal">false</span>;</span><br><span class="line">            _dueTimeInTicks = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(_timers.Count &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// We could do better if we sorted the list of timers.</span></span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; _timers.Count; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    DispatcherTimer timer = _timers[i];</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(!_dueTimeFound || timer._dueTimeInTicks - _dueTimeInTicks &lt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        _dueTimeFound = <span class="literal">true</span>;</span><br><span class="line">                        _dueTimeInTicks = timer._dueTimeInTicks;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(_dueTimeFound)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(!_isWin32TimerSet || !oldDueTimeFound || (oldDueTimeInTicks != _dueTimeInTicks))</span><br><span class="line">                &#123;</span><br><span class="line">                    SetWin32Timer(_dueTimeInTicks);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(oldDueTimeFound)</span><br><span class="line">            &#123;</span><br><span class="line">                KillWin32Timer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;SecurityNote&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Critical - accesses critical data</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TreatAsSafe - we think it's ok to expose timers in the SEE.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>                      a denial-of-service attack may be possible - but these are low-pri and possible in many other ways.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>                      we can never bring down the iexplore process.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;/SecurityNote&gt;</span></span></span><br><span class="line">[<span class="meta">SecurityCritical, SecurityTreatAsSafe</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetWin32Timer</span>(<span class="params"><span class="keyword">int</span> dueTimeInTicks</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!IsWindowNull())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> delta = dueTimeInTicks - Environment.TickCount;</span><br><span class="line">        <span class="keyword">if</span>(delta &lt; <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            delta = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We are being called on the dispatcher thread so we can rely on</span></span><br><span class="line">        <span class="comment">// _window.Value being non-null without taking the instance lock.</span></span><br><span class="line"></span><br><span class="line">        SafeNativeMethods.SetTimer(</span><br><span class="line">            <span class="keyword">new</span> HandleRef(<span class="keyword">this</span>, _window.Value.Handle),</span><br><span class="line">            TIMERID_TIMERS,</span><br><span class="line">            delta);</span><br><span class="line"></span><br><span class="line">        _isWin32TimerSet = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样, 系统才会发WM_TIMER给窗口处理函数, Dispatcher才会从DispatcherQueue里面取出Operation, 看下面的代码<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> IntPtr <span class="title">WndProcHook</span>(<span class="params">IntPtr hwnd, <span class="keyword">int</span> msg, IntPtr wParam, IntPtr lParam, <span class="keyword">ref</span> <span class="keyword">bool</span> handled</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    else <span class="title">if</span>(<span class="params">message == WindowMessage.WM_TIMER &amp;&amp; (<span class="keyword">int</span></span>) wParam</span> == TIMERID_TIMERS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// We want 1-shot only timers.  So stop the timer</span></span><br><span class="line">        <span class="comment">// that just fired.</span></span><br><span class="line">        KillWin32Timer();</span><br><span class="line"></span><br><span class="line">        PromoteTimers(Environment.TickCount);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>PromoteTimers()判断时间间隔有没有到; 如果到了,调用的是timer.Promote()方法, 提升Operation的优先级<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">PromoteTimers</span>(<span class="params"><span class="keyword">int</span> currentTimeInTicks</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">                    <span class="title">while</span>(<span class="params">iTimer &lt; _timers.Count</span>)</span></span><br><span class="line"><span class="function"></span>                    &#123;</span><br><span class="line">                        <span class="comment">// WARNING: this is vulnerable to wrapping</span></span><br><span class="line">                        <span class="keyword">if</span>(timers[iTimer]._dueTimeInTicks - currentTimeInTicks &lt;= <span class="number">0</span>) <span class="comment">//判断时间有没有到</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// Remove this timer from our list.</span></span><br><span class="line">                            <span class="comment">// Do not increment the index.</span></span><br><span class="line">                            timer = timers[iTimer];</span><br><span class="line">                            timers.RemoveAt(iTimer);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            iTimer++;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Now that we are outside of the lock, promote the timer.</span></span><br><span class="line">                <span class="keyword">if</span>(timer != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    timer.Promote();</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure></p>
<ol start="4">
<li>时间间隔到了, 执行FireTick方法<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">object</span> <span class="title">FireTick</span>(<span class="params"><span class="keyword">object</span> unused</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// The operation has been invoked, so forget about it.</span></span><br><span class="line">    _operation = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// The dispatcher thread is calling us because item's priority</span></span><br><span class="line">    <span class="comment">// was changed from inactive to something else.</span></span><br><span class="line">    <span class="keyword">if</span>(Tick != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Tick(<span class="keyword">this</span>, EventArgs.Empty);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we are still enabled, start the timer again.</span></span><br><span class="line">    <span class="keyword">if</span>(_isEnabled)</span><br><span class="line">    &#123;</span><br><span class="line">        Restart();<span class="comment">//再把op放到queue中</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>前面由于DispatcherOperation已经从DispatcherQueue里面取出, 所以这里需要重新再向DispatcherQueue放入DispatcherOperation, 等下一个时间间隔来临时执行. 做法是, 再次调用Restart方法.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/25/WPF笔记(X1) Threading Model (三)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/25/WPF笔记(X1) Threading Model (三)/" itemprop="url">WPF笔记(X1) Threading Model (三)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-25T08:03:37+08:00">
                2018-04-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇整理了Dispatcher的消息循环和BeginInvoke机制, 这一篇继续深入窥探一下DispatcherFrame.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Dispatcher.cs</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PushFrameImpl</span>(<span class="params">DispatcherFrame frame</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="comment">//&lt;SecurityNote&gt;</span></span></span><br><span class="line"><span class="function">    <span class="comment">// Critical - as this calls critical methods (GetMessage, TranslateMessage, DispatchMessage).</span></span></span><br><span class="line"><span class="function">    <span class="comment">// TreatAsSafe - as the critical method is not leaked out, and not controlled by external inputs.</span></span></span><br><span class="line"><span class="function">    <span class="comment">//&lt;/SecurityNote&gt;</span></span></span><br><span class="line"><span class="function">    [SecurityCritical, SecurityTreatAsSafe ]</span></span><br><span class="line"><span class="function">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PushFrameImpl</span>(<span class="params">DispatcherFrame frame</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        SynchronizationContext oldSyncContext = <span class="literal">null</span>;</span><br><span class="line">        SynchronizationContext newSyncContext = <span class="literal">null</span>;</span><br><span class="line">        MSG msg = <span class="keyword">new</span> MSG();</span><br><span class="line"></span><br><span class="line">        _frameDepth++;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Change the CLR SynchronizationContext to be compatable with our Dispatcher.</span></span><br><span class="line">            oldSyncContext = SynchronizationContext.Current;</span><br><span class="line">            newSyncContext = <span class="keyword">new</span> DispatcherSynchronizationContext(<span class="keyword">this</span>);</span><br><span class="line">            SynchronizationContext.SetSynchronizationContext(newSyncContext);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span>(frame.Continue)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!GetMessage(<span class="keyword">ref</span> msg, IntPtr.Zero, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    TranslateAndDispatchMessage(<span class="keyword">ref</span> msg);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If this was the last frame to exit after a quit, we</span></span><br><span class="line">                <span class="comment">// can now dispose the dispatcher.</span></span><br><span class="line">                <span class="keyword">if</span>(_frameDepth == <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(_hasShutdownStarted)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ShutdownImpl();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Restore the old SynchronizationContext.</span></span><br><span class="line">                SynchronizationContext.SetSynchronizationContext(oldSyncContext);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            _frameDepth--;</span><br><span class="line">            <span class="keyword">if</span>(_frameDepth == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// We have exited all frames.</span></span><br><span class="line">                _exitAllFrames = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>DispatcherFrame的代码如下,<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Security; </span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">System.Windows.Threading</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>     Representation of Dispatcher frame.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DispatcherFrame</span> : <span class="title">DispatcherObject</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;SecurityNote&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Critical: This code exists to ensure that the static variables initialized</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     do not cause security violations.The reason this comes into existance is because</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     of the call to RegisterWindowMessage</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     TreatAsSafe:This is safe to call</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/SecurityNote&gt;</span></span></span><br><span class="line">        [<span class="meta">SecurityCritical,SecurityTreatAsSafe</span>]</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="title">DispatcherFrame</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Constructs a new instance of the DispatcherFrame class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DispatcherFrame</span>(<span class="params"></span>) : <span class="title">this</span>(<span class="params"><span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Constructs a new instance of the DispatcherFrame class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="exitWhenRequested"&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Indicates whether or not this frame will exit when all frames</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     are requested to exit.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     <span class="doctag">&lt;p/&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Dispatcher frames typically break down into two categories:</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     1) Long running, general purpose frames, that exit only when</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>        told to.  These frames should exit when requested.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     2) Short running, very specific frames that exit themselves</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>        when an important criteria is met.  These frames may</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>        consider not exiting when requested in favor of waiting</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>        for their important criteria to be met.  These frames</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>        should have a timeout associated with them.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DispatcherFrame</span>(<span class="params"><span class="keyword">bool</span> exitWhenRequested</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            _exitWhenRequested = exitWhenRequested;</span><br><span class="line">            _continue = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Indicates that this dispatcher frame should exit.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;SecurityNote&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     Critical - calls a critical method - postThreadMessage. </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     PublicOK - all we're doing is posting a current message to our thread. </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>                net effect is the dispatcher "wakes up"</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>                and uses the continue flag ( which may have just changed). </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/SecurityNote&gt;</span> </span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> Continue</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// This method is free-threaded.</span></span><br><span class="line">                    </span><br><span class="line">                <span class="comment">// First check if this frame wants to continue.</span></span><br><span class="line">                <span class="keyword">bool</span> shouldContinue = _continue;</span><br><span class="line">                <span class="keyword">if</span>(shouldContinue)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// This frame wants to continue, so next check if it will</span></span><br><span class="line">                    <span class="comment">// respect the "exit requests" from the dispatcher.</span></span><br><span class="line">                    <span class="keyword">if</span>(_exitWhenRequested)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Dispatcher dispatcher = Dispatcher;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// This frame is willing to respect the "exit requests" of</span></span><br><span class="line">                        <span class="comment">// the dispatcher, so check them.</span></span><br><span class="line">                        <span class="keyword">if</span>(dispatcher._exitAllFrames || dispatcher._hasShutdownStarted)</span><br><span class="line">                        &#123;</span><br><span class="line">                            shouldContinue = <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> shouldContinue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">SecurityCritical</span>] </span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// This method is free-threaded.</span></span><br><span class="line"></span><br><span class="line">                _continue = <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Post a message so that the message pump will wake up and</span></span><br><span class="line">                <span class="comment">// check our continue state.</span></span><br><span class="line">                Dispatcher.BeginInvoke(DispatcherPriority.Send, (DispatcherOperationCallback) <span class="keyword">delegate</span>(<span class="keyword">object</span> unused) &#123;<span class="keyword">return</span> <span class="literal">null</span>;&#125;, <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _exitWhenRequested;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> _continue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于DispatcherFrame, Threading Model中<a href="https://docs.microsoft.com/en-us/dotnet/framework/wpf/advanced/threading-model有一节提到**Nested" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/dotnet/framework/wpf/advanced/threading-model有一节提到**Nested</a> Pumping**</p>
<p>Sometimes it is not feasible to completely lock up the UI thread. Let’s consider the Show method of the MessageBox class. Show doesn’t return until the user clicks the OK button. It does, however, create a window that must have a message loop in order to be interactive. While we are waiting for the user to click OK, the original application window does not respond to user input. It does, however, continue to process paint messages. The original window redraws itself when covered and revealed.(移动MessageBox, 它后面的background window会重绘, 但又无法响应用户的输入)<br><img src="/img/wpf-threadingmodel-3-estedpumping.png" alt=""></p>
<p>Some thread must be in charge of the message box window. WPF could create a new thread just for the message box window, but this thread would be unable to paint the disabled elements in the original window (remember the earlier discussion of mutual exclusion.线程A无法修改线程B中的UI元素, 所以messageBox中启动了另一个线程的假设不成立). Instead, WPF uses a <strong>nested message processing system</strong>. The Dispatcher class includes a special method called <strong>PushFrame</strong>, which stores an application’s current execution point then begins a new message loop. When the nested message loop finishes, execution resumes after the original PushFrame call.</p>
<p>In this case, <strong>PushFrame maintains the program context at the call to MessageBox.Show, and it starts a new message loop to repaint the background window and handle input to the message box window</strong>(重绘background window, 是由new message loop负责的). When the user clicks OK and clears the pop-up window, the nested loop exits and control resumes after the call to Show.</p>
<p>除了上面的Nested Pumping, MSDN中还提到了DispatcherFrame的另一个作用, 模拟实现Winform中Application的DoEvents功能<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://msdn.microsoft.com/zh-cn/library/system.windows.threading.dispatcher.pushframe.aspx</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ApplicationExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> DoEvents using a DispatcherFrame</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoEvents</span>(<span class="params"><span class="keyword">this</span> Application application</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        DispatcherFrame frame = <span class="keyword">new</span> DispatcherFrame();</span><br><span class="line">        Dispatcher.CurrentDispatcher.BeginInvoke(DispatcherPriority.Background, <span class="keyword">new</span> ExitFrameHandler(frm =&gt; frm.Continue = <span class="literal">false</span>), frame);</span><br><span class="line">        Dispatcher.PushFrame(frame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">ExitFrameHandler</span>(<span class="params">DispatcherFrame frame</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Application.DoEvents方法有什么作用, 看如下代码:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">button1_Click</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++)  </span><br><span class="line">    &#123;  </span><br><span class="line">        label1.Text = i.ToString();  </span><br><span class="line">        Application.DoEvents();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该方法是想让label的文本从0更新到9999. 如果注释掉Application.DoEvents(), Label只会最后显示一个9999; 而加上Application.DoEvents(), label会有一个从0到9999的跳变过程. </p>
<p>label1.Text = i.ToString();  这一行需要更新lable1, 其实是有一个repaint消息. 但由于UI线程正在执行for循环,没有空闲去处理该消息. 所以在没有Application.DoEvents();  的情况下, 只有等UI线程执行完for循环后, UI线程才会去处理repaint消息, label才会更新.如果加了Application.DoEvents(), 该方法的功能就是强制UI线程去执行消息队列中的消息, 即使在for循环中. 于是label能够实时得到更新.</p>
<p>Dispatcher.PushFrame(frame);强制启动了一个新的loop. UI线程会保存PushFrame之前的context. 该loop会将dispatcher queue中的所有消息进行处理, 最后退出. repaint, mousemove等都是在dispatcher queue中<br>即每一次迭代, 都强制启动了一个loop, 去处理所有消息队列中的消息. 这样每一次迭代, label都可以得到更新. 如果不强制启动新loop, UI线程的dispatcher都在处理for循环, 没有空闲去处理消息队列中的其他消息.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dispatcher.CurrentDispatcher.BeginInvoke(DispatcherPriority.Background, <span class="keyword">new</span> ExitFrameHandler(frm =&gt; frm.Continue = <span class="literal">false</span>), frame);</span><br></pre></td></tr></table></figure></p>
<p>这一行的意思是在dispatcher queue中添加一个dispatchOperation, 该operation的作用是将DispatcherFrame的Continue属性设为false, 如此就能退出loop. 由于它的优先级是Background, 该dispatchOperation会在消息队列中的末端, 最后执行.<br>即处理完消息队列中的所有消息后退出loop.</p>
<p>下面是Winforms中对Application.DoEvents()的解释<a href="https://msdn.microsoft.com/en-us/library/system.windows.forms.application.doevents.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/system.windows.forms.application.doevents.aspx</a></p>
<blockquote>
<p>When you run a Windows Form, it creates the new form, which then waits for events to handle. Each time the form handles an event, it processes all the code associated with that event. All other events wait in the queue. While your code handles the event, your application does not respond. For example, the window does not repaint if another window is dragged on top.</p>
</blockquote>
<blockquote>
<p>If you call DoEvents in your code, your application can handle the other events. For example, if you have a form that adds data to a ListBox and add DoEvents to your code, your form repaints when another window is dragged over it. If you remove DoEvents from your code, your form will not repaint until the click event handler of the button is finished executing. For more information on messaging, see User Input in Windows Forms.</p>
</blockquote>
<blockquote>
<p>Unlike Visual Basic 6.0, the DoEvents method does not call the Thread.Sleep method.Typically, you use this method in a loop to process messages.</p>
</blockquote>
<p>不过用Application.DoEvents也会带来一些问题, 参考<a href="https://blogs.msdn.microsoft.com/jfoscoding/2005/08/06/keeping-your-ui-responsive-and-the-dangers-of-application-doevents/" target="_blank" rel="noopener">https://blogs.msdn.microsoft.com/jfoscoding/2005/08/06/keeping-your-ui-responsive-and-the-dangers-of-application-doevents/</a></p>
<p>其他参考:</p>
<ol>
<li><p><a href="https://www.codeproject.com/Articles/152137/DispatcherFrame-Look-in-Depth" target="_blank" rel="noopener">https://www.codeproject.com/Articles/152137/DispatcherFrame-Look-in-Depth</a></p>
</li>
<li><p><a href="https://kent-boogaart.com/blog/dispatcher-frames" target="_blank" rel="noopener">https://kent-boogaart.com/blog/dispatcher-frames</a></p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/24/WPF笔记(X1) Threading Model (二)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/24/WPF笔记(X1) Threading Model (二)/" itemprop="url">WPF笔记(X1) Threading Model (二)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-24T16:37:37+08:00">
                2018-04-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇整理了Dispatcher的使用方式, 这一篇窥探一下Dispatcher的内部机制.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://msdn.microsoft.com/en-us/library/system.windows.application(v=vs.110).aspx</span></span><br><span class="line"><span class="keyword">using</span> System; <span class="comment">// STAThread</span></span><br><span class="line"><span class="keyword">using</span> System.Windows; <span class="comment">// Application</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">SDKSample</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AppCode</span> : <span class="title">Application</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Entry point method</span></span><br><span class="line">        [<span class="meta">STAThread</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            AppCode app = <span class="keyword">new</span> AppCode();</span><br><span class="line">            app.Run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>app.Run()层层调用, 最后会到达Dispatcher.Run();</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Dispatcher.cs</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        PushFrame(<span class="keyword">new</span> DispatcherFrame());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PushFrame</span>(<span class="params">DispatcherFrame frame</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span>(frame == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"frame"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Dispatcher dispatcher = Dispatcher.CurrentDispatcher;</span><br><span class="line">        <span class="keyword">if</span>(dispatcher._hasShutdownFinished) <span class="comment">// Dispatcher thread - no lock needed for read</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(SR.Get(SRID.DispatcherHasShutdown));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(frame.Dispatcher != dispatcher)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(SR.Get(SRID.MismatchedDispatchers));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(dispatcher._disableProcessingCount &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(SR.Get(SRID.DispatcherProcessingDisabled));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dispatcher.PushFrameImpl(frame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//&lt;SecurityNote&gt;</span></span><br><span class="line">    <span class="comment">// Critical - as this calls critical methods (GetMessage, TranslateMessage, DispatchMessage).</span></span><br><span class="line">    <span class="comment">// TreatAsSafe - as the critical method is not leaked out, and not controlled by external inputs.</span></span><br><span class="line">    <span class="comment">//&lt;/SecurityNote&gt;</span></span><br><span class="line">    [<span class="meta">SecurityCritical, SecurityTreatAsSafe </span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PushFrameImpl</span>(<span class="params">DispatcherFrame frame</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        SynchronizationContext oldSyncContext = <span class="literal">null</span>;</span><br><span class="line">        SynchronizationContext newSyncContext = <span class="literal">null</span>;</span><br><span class="line">        MSG msg = <span class="keyword">new</span> MSG();</span><br><span class="line"></span><br><span class="line">        _frameDepth++;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Change the CLR SynchronizationContext to be compatable with our Dispatcher.</span></span><br><span class="line">            oldSyncContext = SynchronizationContext.Current;</span><br><span class="line">            newSyncContext = <span class="keyword">new</span> DispatcherSynchronizationContext(<span class="keyword">this</span>);</span><br><span class="line">            SynchronizationContext.SetSynchronizationContext(newSyncContext);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span>(frame.Continue)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!GetMessage(<span class="keyword">ref</span> msg, IntPtr.Zero, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    TranslateAndDispatchMessage(<span class="keyword">ref</span> msg);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If this was the last frame to exit after a quit, we</span></span><br><span class="line">                <span class="comment">// can now dispose the dispatcher.</span></span><br><span class="line">                <span class="keyword">if</span>(_frameDepth == <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(_hasShutdownStarted)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ShutdownImpl();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Restore the old SynchronizationContext.</span></span><br><span class="line">                SynchronizationContext.SetSynchronizationContext(oldSyncContext);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            _frameDepth--;</span><br><span class="line">            <span class="keyword">if</span>(_frameDepth == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// We have exited all frames.</span></span><br><span class="line">                _exitAllFrames = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>出现了GetMessage和TranslateAndDispatchMessage, 后者将消息派发到窗口的消息处理函数中(WndProcHook)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Dispatcher.cs</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> IntPtr <span class="title">WndProcHook</span>(<span class="params">IntPtr hwnd, <span class="keyword">int</span> msg, IntPtr wParam, IntPtr lParam, <span class="keyword">ref</span> <span class="keyword">bool</span> handled</span>)  </span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">if</span>(message == WindowMessage.WM_DESTROY)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!_hasShutdownStarted &amp;&amp; !_hasShutdownFinished) <span class="comment">// Dispatcher thread - no lock needed for read</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Aack!  We are being torn down rudely!  Try to</span></span><br><span class="line">                <span class="comment">// shut the dispatcher down as nicely as we can.</span></span><br><span class="line">                ShutdownImpl();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(message == _msgProcessQueue)</span><br><span class="line">        &#123;</span><br><span class="line">            ProcessQueue();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(message == WindowMessage.WM_TIMER &amp;&amp; (<span class="keyword">int</span>) wParam == TIMERID_BACKGROUND)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// This timer is just used to process background operations.</span></span><br><span class="line">            <span class="comment">// Stop the timer so that it doesn't fire again.</span></span><br><span class="line">            SafeNativeMethods.KillTimer(<span class="keyword">new</span> HandleRef(<span class="keyword">this</span>, hwnd), TIMERID_BACKGROUND);</span><br><span class="line"></span><br><span class="line">            ProcessQueue();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>当收到的消息为_msgProcessQueue时, 调用的是ProcessQueue方法. ProcessQueue方法从DispatcherQueue里面(PriorityQueue<dispatcheroperation>)取出DispatcherOperation执行.</dispatcheroperation></p>
<p>那么WndProcHook是在哪里被注册的呢? 看Dispatcher的构造方法<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Dispatcher</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _queue = <span class="keyword">new</span> PriorityQueue&lt;DispatcherOperation&gt;();</span><br><span class="line"></span><br><span class="line">    _tlsDispatcher = <span class="keyword">this</span>; <span class="comment">// use TLS for ownership only</span></span><br><span class="line">    _dispatcherThread = Thread.CurrentThread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add ourselves to the map of dispatchers to threads.</span></span><br><span class="line">    <span class="keyword">lock</span>(_globalLock)</span><br><span class="line">    &#123;</span><br><span class="line">        _dispatchers.Add(<span class="keyword">new</span> WeakReference(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _unhandledExceptionEventArgs = <span class="keyword">new</span> DispatcherUnhandledExceptionEventArgs(<span class="keyword">this</span>);</span><br><span class="line">    _exceptionFilterEventArgs = <span class="keyword">new</span> DispatcherUnhandledExceptionFilterEventArgs(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    _defaultDispatcherSynchronizationContext = <span class="keyword">new</span> DispatcherSynchronizationContext(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the message-only window we use to receive messages</span></span><br><span class="line">    <span class="comment">// that tell us to process the queue.</span></span><br><span class="line">    MessageOnlyHwndWrapper window = <span class="keyword">new</span> MessageOnlyHwndWrapper();</span><br><span class="line">    _window = <span class="keyword">new</span> SecurityCriticalData&lt;MessageOnlyHwndWrapper&gt;( window );</span><br><span class="line"></span><br><span class="line">    _hook = <span class="keyword">new</span> HwndWrapperHook(WndProcHook);</span><br><span class="line">    _window.Value.AddHook(_hook);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>_msgProcessQueue是什么时候被放入消息队列中的? 搜了一下代码, 只一处有:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">bool</span> <span class="title">RequestForegroundProcessing</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(_postedProcessingType &lt; PROCESS_FOREGROUND)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// If we have already set a timer to do background processing,</span></span><br><span class="line">        <span class="comment">// make sure we stop it before posting a message for foreground</span></span><br><span class="line">        <span class="comment">// processing.</span></span><br><span class="line">        <span class="keyword">if</span>(_postedProcessingType == PROCESS_BACKGROUND)</span><br><span class="line">        &#123;</span><br><span class="line">            SafeNativeMethods.KillTimer(<span class="keyword">new</span> HandleRef(<span class="keyword">this</span>, _window.Value.Handle), TIMERID_BACKGROUND);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _postedProcessingType = PROCESS_FOREGROUND;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We have foreground items to process.</span></span><br><span class="line">        <span class="comment">// By posting a message, Win32 will service us fairly promptly.</span></span><br><span class="line">        <span class="keyword">return</span> UnsafeNativeMethods.TryPostMessage(<span class="keyword">new</span> HandleRef(<span class="keyword">this</span>, _window.Value.Handle), _msgProcessQueue, IntPtr.Zero, IntPtr.Zero);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查找RequestForegroundProcessing被调用的过程为, InvokeAsyncImpl调用RequestProcessing, RequestProcessing调用CriticalRequestProcessing</p>
<p>看看InvokeAsyncImpl的实现<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;SecurityNote&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     Critical:This code causes arbitrary delegate to execute asynchronously, also calls critical code.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/SecurityNote&gt;</span></span></span><br><span class="line">[<span class="meta">SecurityCritical</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InvokeAsyncImpl</span>(<span class="params">DispatcherOperation operation, CancellationToken cancellationToken</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DispatcherHooks hooks = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">bool</span> succeeded = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Could be a non-dispatcher thread, lock to read</span></span><br><span class="line">    <span class="keyword">lock</span>(_instanceLock)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!cancellationToken.IsCancellationRequested &amp;&amp;</span><br><span class="line">            !_hasShutdownFinished &amp;&amp; </span><br><span class="line">            !Environment.HasShutdownStarted)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Add the operation to the work queue</span></span><br><span class="line">            operation._item = _queue.Enqueue(operation.Priority, operation);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Make sure we will wake up to process this operation.</span></span><br><span class="line">            succeeded = RequestProcessing();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (succeeded)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Grab the hooks to use inside the lock; but we will</span></span><br><span class="line">                <span class="comment">// call them below, outside of the lock.</span></span><br><span class="line">                hooks = _hooks;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Dequeue the item since we failed to request</span></span><br><span class="line">                <span class="comment">// processing for it.  Note we will mark it aborted</span></span><br><span class="line">                <span class="comment">// below.</span></span><br><span class="line">                _queue.RemoveItem(operation._item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (succeeded == <span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// We have enqueued the operation.  Register a callback</span></span><br><span class="line">        <span class="comment">// with the cancellation token to abort the operation</span></span><br><span class="line">        <span class="comment">// when cancellation is requested.</span></span><br><span class="line">        <span class="keyword">if</span>(cancellationToken.CanBeCanceled)</span><br><span class="line">        &#123;</span><br><span class="line">            CancellationTokenRegistration cancellationRegistration = cancellationToken.Register(s =&gt; ((DispatcherOperation)s).Abort(), operation);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// Revoke the cancellation when the operation is done. </span></span><br><span class="line">            operation.Aborted += (s,e) =&gt; cancellationRegistration.Dispose();</span><br><span class="line">            operation.Completed += (s,e) =&gt; cancellationRegistration.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(hooks != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            hooks.RaiseOperationPosted(<span class="keyword">this</span>, operation);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (EventTrace.IsEnabled(EventTrace.Keyword.KeywordDispatcher | EventTrace.Keyword.KeywordPerf, EventTrace.Level.Info))</span><br><span class="line">        &#123;</span><br><span class="line">            EventTrace.EventProvider.TraceEvent(EventTrace.Event.WClientUIContextPost, EventTrace.Keyword.KeywordDispatcher | EventTrace.Keyword.KeywordPerf, EventTrace.Level.Info, operation.Priority, operation.Name, operation.Id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// We failed to enqueue the operation, and the caller that</span></span><br><span class="line">        <span class="comment">// created the operation does not expose it before we return,</span></span><br><span class="line">        <span class="comment">// so it is safe to modify the operation outside of the lock.</span></span><br><span class="line">        <span class="comment">// Just mark the operation as aborted, which we can safely</span></span><br><span class="line">        <span class="comment">// return to the user.</span></span><br><span class="line">        operation._status = DispatcherOperationStatus.Aborted;</span><br><span class="line">        operation._taskSource.SetCanceled();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先将operation加入queue, 然后调用RequestProcessing, 发出_msgProcessQueue.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add the operation to the work queue</span></span><br><span class="line">operation._item = _queue.Enqueue(operation.Priority, operation);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Make sure we will wake up to process this operation.</span></span><br><span class="line">succeeded = RequestProcessing();</span><br></pre></td></tr></table></figure></p>
<p>另一处RequestProcessing是在processQueue中调用, 假如queue中还有其他operation<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If there is more to do, request processing for it.</span></span><br><span class="line">RequestProcessing();</span><br></pre></td></tr></table></figure></p>
<p>以上过程, 大致可以用下面这幅图联系起来<a href="http://www.cnblogs.com/powertoolsteam/archive/2010/12/31/1922794.html#2007193" target="_blank" rel="noopener">http://www.cnblogs.com/powertoolsteam/archive/2010/12/31/1922794.html#2007193</a><br><img src="/img/wpf-threadingmodel-2.png" alt=""></p>
<p>从上图可以看到Dispatcher在调用BeginInvoke之后所经历的流程.</p>
<ol>
<li><p>将调用的Delegate和优先级包装成一个DispatcherOperation放入Dispatcher维护的优先级队列当中, 这个Queue是按DispatcherPriority排序的, 高优先级的DispatcherOperation先被处理</p>
</li>
<li><p>往当前线程的消息队列中Post一个名为MsgProcessQueue的Message。这个消息是WPF自己定义的，见Dispatcher的静态构造函数当中的_msgProcessQueue = UnsafeNativeMethods.RegisterWindowMessage(“DispatcherProcessQueue”);   这个消息被Post到消息队列之前，还要设置MSG.Handle，这个Handle就是Window 1#的Handle. 指定Handle是为了在消息泵派发消息的时候，指定哪个窗口的WndProc（窗口过程）处理这个消息. 在这里所有BeginInvoke引起的消息都是Window1#的窗口过程来处理的.见return UnsafeNativeMethods.TryPostMessage(new HandleRef(this, _window.Value.Handle), _msgProcessQueue, IntPtr.Zero, IntPtr.Zero);</p>
</li>
<li><p>消息泵读取消息</p>
</li>
<li><p>系统根据消息的Handle, 发现跟Window1#的Handle相同，然后将这个消息派发到Window1#的窗口过程，让其处理</p>
</li>
<li><p>在窗口过程中，调用ProcessQueue方法, 从优先级队列中取出一个优先级最高的DispatcherOperation</p>
</li>
<li><p>执行DispatcherOperation.Invoke方法. Invoke方法的核心就是调用DispatcherOperation构造时传入的Delegate, 也就是Dispatcher.BeginInvoke传入的Delegate. 最终这个Foo()方法被执行了</p>
</li>
</ol>
<p>小结如下, 每Invoke或者BeginInvoke</p>
<ol>
<li><strong>放一个DispatcherOperation到PriorityQueue<dispatcheroperation>中</dispatcheroperation></strong></li>
<li><strong>放一个_msgProcessQueue到消息队列中</strong></li>
<li><strong>GetMessage从消息队列中取出_msgProcessQueue, 派发到窗口过程, 窗口过程调用ProcessQueue, 从PriorityQueue<dispatcheroperation>中取出DispatcherOperation, 然后执行</dispatcheroperation></strong></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/24/CSharp笔记(X1) IDisposable/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/24/CSharp笔记(X1) IDisposable/" itemprop="url">CSharp笔记(X1) IDisposable</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-24T09:37:37+08:00">
                2018-04-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>关于IDisposable, 官方有很多很好的资料, 例如Framework Design Guidelines中的Dispose Pattern一节(<a href="https://docs.microsoft.com/en-us/dotnet/standard/design-guidelines/dispose-pattern)" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/dotnet/standard/design-guidelines/dispose-pattern)</a>, 还有VS2015 Code Analysis for Managed Code Warnings中给出的使用示例CA1063: Implement IDisposable correctly(<a href="https://msdn.microsoft.com/en-us/library/ms244737.aspx)等等" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/ms244737.aspx)等等</a></p>
<p>相关细节很多, 这里简要记录两点 1. IDisposable用来做什么. 2. IDisposable的一般用法</p>
<h4 id="1-IDisposable用来做什么"><a href="#1-IDisposable用来做什么" class="headerlink" title="1.IDisposable用来做什么"></a>1.IDisposable用来做什么</h4><p>IDisposable提供了一种释放非托管资源的机制(Provides a mechanism for releasing unmanaged resources). 这里重点是两个1: 释放资源 2. 非托管资源</p>
<p>资源有托管和非托管之分, 非托管的资源包括 a file, a database connection, a socket, a mutex, a bitmap, an icon 等等<br>托管的资源由garbage collection 自动回收, 非托管的资源则需要手动释放.非托管资源一般会用一个托管类包装(wrap), 例如类FileStream, SqlConnection, Socket, Mutex, Bitmap. 对于这些包含非托管资源的托管类, C#提供了IDisposable接口, 表明在该类实例结束使用时, 需要手动调用它的Dispose方法来释放非托管资源.</p>
<p>手动意味着遗忘, 这里要引出C#中的析构方法(destructor 或者fnalizer). 析构方法会在实例被回收之前调用. 由于托管资源(内存)会被garbage collection自动回收,<br>一般不需要在类中定义析构方法. 如果托管类中包含非托管资源, 为了防止没有被手动释放, 可以将Dispose方法放在析构方法中. 于是在设计Dispose方法实现的时候, 需要考虑到这两种情况: 1. 手动释放 2. 由析构方法释放. 3. 如果已经手动释放过了, 要避免再被析构方法释放.<br>官方有标准实现, 具体见下面.</p>
<h4 id="2-IDisposable的一般用法"><a href="#2-IDisposable的一般用法" class="headerlink" title="2.IDisposable的一般用法"></a>2.IDisposable的一般用法</h4><p>这里分为3点: a 怎样使用实现IDisposable接口的类, b. 怎样设计实现IDisposable的类 c. 要不要实现IDisposable接口</p>
<p><strong>a.怎样使用实现IDisposable接口的类</strong><br>IDisposable和using搭配使用(标准用法)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (FileStream fs = <span class="keyword">new</span> FileStream (<span class="string">"myFile.txt"</span>, FileMode.Open))</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ... Write to the file ...</span></span><br><span class="line">&#125;</span><br><span class="line">等同于</span><br><span class="line">FileStream fs = <span class="keyword">new</span> FileStream (<span class="string">"myFile.txt"</span>, FileMode.Open);</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ... Write to the file ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span></span><br><span class="line">&#123;<span class="comment">//即使有异常, 也会执行</span></span><br><span class="line"><span class="keyword">if</span> (fs != <span class="literal">null</span>) ((IDisposable)fs).Dispose();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">不要嵌套使用<span class="keyword">using</span>(https:<span class="comment">//msdn.microsoft.com/en-us/library/ms182334.aspx)</span></span><br><span class="line"><span class="keyword">using</span> (Stream stream = <span class="keyword">new</span> FileStream(<span class="string">"file.txt"</span>, FileMode.OpenOrCreate))  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">using</span> (StreamWriter writer = <span class="keyword">new</span> StreamWriter(stream))  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="comment">// Use the writer object...  </span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">改为</span><br><span class="line">Stream stream = <span class="literal">null</span>;  </span><br><span class="line"><span class="keyword">try</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    stream = <span class="keyword">new</span> FileStream(<span class="string">"file.txt"</span>, FileMode.OpenOrCreate);  </span><br><span class="line">    <span class="keyword">using</span> (StreamWriter writer = <span class="keyword">new</span> StreamWriter(stream))  </span><br><span class="line">    &#123;  </span><br><span class="line">        stream = <span class="literal">null</span>;  </span><br><span class="line">        <span class="comment">// Use the writer object...  </span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">finally</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">if</span>(stream != <span class="literal">null</span>)  </span><br><span class="line">        stream.Dispose();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>b. 怎样实现IDisposable的Dispose方法</strong><br>流程图(C#图解教程):<br><img src="/img/csharp-idisposable.png" alt=""><br>官方标准实现(注释最为详尽)<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The following example demonstrates how to create</span></span><br><span class="line"><span class="comment">// a resource class that implements the IDisposable interface</span></span><br><span class="line"><span class="comment">// and the IDisposable.Dispose method.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DisposeExample</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// A base class that implements IDisposable.</span></span><br><span class="line">    <span class="comment">// By implementing IDisposable, you are announcing that</span></span><br><span class="line">    <span class="comment">// instances of this type allocate scarce resources.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyResource</span>: <span class="title">IDisposable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Pointer to an external unmanaged resource.</span></span><br><span class="line">        <span class="keyword">private</span> IntPtr handle;</span><br><span class="line">        <span class="comment">// Other managed resource this class uses.</span></span><br><span class="line">        <span class="keyword">private</span> Component component = <span class="keyword">new</span> Component();</span><br><span class="line">        <span class="comment">// Track whether Dispose has been called.</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">bool</span> disposed = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The class constructor.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyResource</span>(<span class="params">IntPtr handle</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.handle = handle;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Implement IDisposable.</span></span><br><span class="line">        <span class="comment">// Do not make this method virtual.</span></span><br><span class="line">        <span class="comment">// A derived class should not be able to override this method.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Dispose(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// This object will be cleaned up by the Dispose method.</span></span><br><span class="line">            <span class="comment">// Therefore, you should call GC.SupressFinalize to</span></span><br><span class="line">            <span class="comment">// take this object off the finalization queue</span></span><br><span class="line">            <span class="comment">// and prevent finalization code for this object</span></span><br><span class="line">            <span class="comment">// from executing a second time.</span></span><br><span class="line">            GC.SuppressFinalize(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Dispose(bool disposing) executes in two distinct scenarios.</span></span><br><span class="line">        <span class="comment">// If disposing equals true, the method has been called directly</span></span><br><span class="line">        <span class="comment">// or indirectly by a user's code. Managed and unmanaged resources</span></span><br><span class="line">        <span class="comment">// can be disposed.</span></span><br><span class="line">        <span class="comment">// If disposing equals false, the method has been called by the</span></span><br><span class="line">        <span class="comment">// runtime from inside the finalizer and you should not reference</span></span><br><span class="line">        <span class="comment">// other objects. Only unmanaged resources can be disposed.</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="keyword">bool</span> disposing</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Check to see if Dispose has already been called.</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">this</span>.disposed)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// If disposing equals true, dispose all managed</span></span><br><span class="line">                <span class="comment">// and unmanaged resources.</span></span><br><span class="line">                <span class="keyword">if</span>(disposing)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// Dispose managed resources.</span></span><br><span class="line">                    component.Dispose();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Call the appropriate methods to clean up</span></span><br><span class="line">                <span class="comment">// unmanaged resources here.</span></span><br><span class="line">                <span class="comment">// If disposing is false,</span></span><br><span class="line">                <span class="comment">// only the following code is executed.</span></span><br><span class="line">                CloseHandle(handle);</span><br><span class="line">                handle = IntPtr.Zero;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Note disposing has been done.</span></span><br><span class="line">                disposed = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use interop to call the method necessary</span></span><br><span class="line">        <span class="comment">// to clean up the unmanaged resource.</span></span><br><span class="line">        [<span class="meta">System.Runtime.InteropServices.DllImport(<span class="meta-string">"Kernel32"</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">extern</span> <span class="keyword">static</span> Boolean <span class="title">CloseHandle</span>(<span class="params">IntPtr handle</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use C# destructor syntax for finalization code.</span></span><br><span class="line">        <span class="comment">// This destructor will run only if the Dispose method</span></span><br><span class="line">        <span class="comment">// does not get called.</span></span><br><span class="line">        <span class="comment">// It gives your base class the opportunity to finalize.</span></span><br><span class="line">        <span class="comment">// Do not provide destructors in types derived from this class.</span></span><br><span class="line">        ~MyResource()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Do not re-create Dispose clean-up code here.</span></span><br><span class="line">            <span class="comment">// Calling Dispose(false) is optimal in terms of</span></span><br><span class="line">            <span class="comment">// readability and maintainability.</span></span><br><span class="line">            Dispose(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Insert code here to create</span></span><br><span class="line">        <span class="comment">// and use the MyResource object.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>另外可以再加一个字段:<br>public bool IsDisposed { get; private set; }<br>如果该类被Dispose后还被调用该类的其他方法, 则抛出异常</p>
<p>区别Close和Dispose, Close方法不一定等同于Dispose. 可以再定义一个Close方法</p>
<p><strong>c.要不要实现IDisposable接口</strong></p>
<p>1) 假如该类包含了Socket, Bitmap, FileStream等实现了IDisposable接口的类, 那么该类也需要实现IDisposable接口<br>2) 假如该类的子类有可能用到非托管资源, 那么该类也实现IDisposable接口. 例如Stream类. 需要注意的是, 它的其中一个子类MemoryStream没有用到非托管资源, 但也实现了Dispose方法. 这是网上讨论的IDisposable接口污染问题. 详见<a href="https://www.zhihu.com/question/51592470" target="_blank" rel="noopener">https://www.zhihu.com/question/51592470</a></p>
<p>另外: IDisposable最初是用来释放非托管资源的, 但现在也有其他的用法, 例如Reactive Extention中的用法 <a href="https://msdn.microsoft.com/en-us/library/dd782981(v=vs.110).aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/dd782981(v=vs.110).aspx</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/24/WPF笔记(X1) Threading Model (一)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/24/WPF笔记(X1) Threading Model (一)/" itemprop="url">WPF笔记(X1) Threading Model (一)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-24T08:23:37+08:00">
                2018-04-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>学习官方MSDN的文档<a href="https://docs.microsoft.com/en-us/dotnet/framework/wpf/advanced/threading-model" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/dotnet/framework/wpf/advanced/threading-model</a></p>
<p>wpf程序默认有2个线程:  Render线程和UI线程. Render线程运行在后台, 负责wpf的绘制. UI线程负责接收用户输入, 处理事件监听, 重绘屏幕(Repaint事件), 还有运行wpf程序的逻辑代码. 大多数wpf程序只需要一个UI线程即可, 少数应用场景需要多个UI线程.</p>
<p>UI线程将需要处理的任务以”work item”的方式放到队列中, 然后根据work item的优先级从队列中取出执行, 执行完毕后再取出下一个work item, 循环往复. 这部分功能是封装在一个叫 Dispatcher的对象中. 每个UI线程至少有一个Dispatcher, 每个Dispatcher只在一个线程中执行work item. 什么样的work item呢? 可以见下图左边部分</p>
<p><img src="/img/wpf-threadingmodel-1.png" alt=""></p>
<p>可以看到, 用户逻辑代码和系统消息处理都是在dispatcher queue当中. 为了保持UI的及时响应. 用户逻辑代码和系统消息处理都不应该是耗时的操作. 否则UI就会失去响应. 对于那些耗时的操作, 例如复杂计算(long runing)或者远程数据查询(blocking), 可以启动work Thread执行. 当耗时操作完成时,  再通知UI线程去更新显示.</p>
<p>而对于UI元素, Windows系统只允许构建该UI元素的线程才能访问, 其他线程不能访问(thread affinity) . 这样做是为了确保UI元素的完整性, 可以想象一个listbox, 绘制的同时, 它的内容也在被其他线程更改, 这样就会显得很奇怪.</p>
<p>那work Thread怎么将执行的结果告知给UI线程呢? 它是将”更新”的操作封装成一个work item, 放到dispatcher的队列中. dispatcher提供了2种放的方式: Invoke 和 BeginInvoke. 前者是同步的, 放了之后要执行完才能返回. 后者是异步的, 放了之后, 立马返回.</p>
<p>那么如何得知该对象是否只能由UI线程访问呢?  看它的基类. wpf中大部分类都继承自DispatcherObject. 例如 Brush和Geometry都是继承DispatcherObject,  其他线程不能访问. 而*Color类不是, 其他线程可以访问. DispatcherObject对象会保存创建它的线程的Dispatcher引用, 并且在每一个DispatcherObject的方法调用之前, 会通过VerifyAccess方法验证当前线程的Dispatcher对象与它保存的Dispatcher引用是否一致. 如果不一致,则抛出异常. </p>
<p>以上就是wpf线程模型的概要. 下面是几个样例(位于wpf-sample的Threading目录中)</p>
<ol>
<li>远程查询</li>
<li>利用UI程序的idle时间执行耗时操作</li>
<li>多个UI线程</li>
</ol>
<p><strong>1. 远程查询</strong><br>这个例子是使用dispatcher最常见的那种情况: 后台线程通过dispatcher.BeginInvoke将更新操作委托给UI线程</p>
<p>UsingDispatcher样例<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="comment">// Start fetching the weather forecast asynchronously.</span></span><br><span class="line">    <span class="keyword">var</span> fetcher = <span class="keyword">new</span> NoArgDelegate(</span><br><span class="line">        FetchWeatherFromServer);</span><br><span class="line"></span><br><span class="line">    fetcher.BeginInvoke(<span class="literal">null</span>, <span class="literal">null</span>);<span class="comment">//异步委托，实际是起一个线程</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">FetchWeatherFromServer</span>(<span class="params"></span>)<span class="comment">//该方法是在非UI线程中执行</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Simulate the delay from network access.</span></span><br><span class="line">    Thread.Sleep(<span class="number">4000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tried and true method for weather forecasting - random numbers.</span></span><br><span class="line">    <span class="keyword">var</span> rand = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">string</span> weather;</span><br><span class="line"></span><br><span class="line">    weather = rand.Next(<span class="number">2</span>) == <span class="number">0</span> ? <span class="string">"rainy"</span> : <span class="string">"sunny"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Schedule the update function in the UI thread. 注意这里用到Schedule</span></span><br><span class="line">    tomorrowsWeather.Dispatcher.BeginInvoke(<span class="comment">//wpf元素的Dispatcher可以在非UI线程中获取，但不能访问其他东西</span></span><br><span class="line">        DispatcherPriority.Normal,</span><br><span class="line">        <span class="keyword">new</span> OneArgDelegate(UpdateUserInterface),</span><br><span class="line">        weather);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>2. 利用UI程序的idle时间执行耗时操作</strong></p>
<p>这个例子演示了<strong>即使是单个UI线程, 也可以在保持UI响应的同时, 做一些耗时的操作. 关键是利用好UI线程idle的时间</strong>. 就是前面用到的图:<br><img src="/img/wpf-threadingmodel-1.png" alt=""></p>
<p>SingleThreadedApplication样例</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CheckNextNumber</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_continueCalculating)</span><br><span class="line">        &#123;</span><br><span class="line">            startStopButton.Dispatcher.BeginInvoke(</span><br><span class="line">                DispatcherPriority.SystemIdle,</span><br><span class="line">                <span class="keyword">new</span> NextPrimeDelegate(CheckNextNumber));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">通过这种方式，可以多次调度CheckNextNumber方法</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">StartOrStop</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_continueCalculating)</span><br><span class="line">        &#123;</span><br><span class="line">            _continueCalculating = <span class="literal">false</span>;</span><br><span class="line">            startStopButton.Content = <span class="string">"Resume"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            _continueCalculating = <span class="literal">true</span>;</span><br><span class="line">            startStopButton.Content = <span class="string">"Stop"</span>;</span><br><span class="line">            startStopButton.Dispatcher.BeginInvoke(</span><br><span class="line">                DispatcherPriority.Normal,</span><br><span class="line">                <span class="keyword">new</span> NextPrimeDelegate(CheckNextNumber));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CheckNextNumber</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> x = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">        x.Start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset flag.</span></span><br><span class="line">        _notAPrime = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> i = <span class="number">3</span>; i &lt;= Math.Sqrt(_num); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_num%i == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Set not a prime flag to ture.</span></span><br><span class="line">                _notAPrime = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If a prime number.</span></span><br><span class="line">        <span class="keyword">if</span> (!_notAPrime)</span><br><span class="line">        &#123;</span><br><span class="line">            x.Stop();</span><br><span class="line">            elapsed.Text = x.ElapsedMilliseconds.ToString();</span><br><span class="line">            bigPrime.Text = _num.ToString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _num += <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (_continueCalculating)</span><br><span class="line">        &#123;</span><br><span class="line">            startStopButton.Dispatcher.BeginInvoke(</span><br><span class="line">                DispatcherPriority.SystemIdle,</span><br><span class="line">                <span class="keyword">new</span> NextPrimeDelegate(CheckNextNumber));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>3. 多个UI线程</strong></p>
<p>MultiThreadingWebBrowser</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">NewWindowHandler</span>(<span class="params"><span class="keyword">object</span> sender, RoutedEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> newWindowThread = <span class="keyword">new</span> Thread(ThreadStartingPoint);</span><br><span class="line">        newWindowThread.SetApartmentState(ApartmentState.STA);</span><br><span class="line">        newWindowThread.IsBackground = <span class="literal">true</span>;</span><br><span class="line">        newWindowThread.Start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ThreadStartingPoint</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> tempWindow = <span class="keyword">new</span> MainWindow();</span><br><span class="line">        tempWindow.Show();</span><br><span class="line">        Dispatcher.Run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">这一样例在Multiple UI Threads and Dispatchers 一节中讲到（Programming WPF）</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Each thread that hosts UI objects needs a dispatcher in order for those UI objects to function. In a single-threaded application, you don’t need to do anything special to create a dispatcher. The Application class creates one for you at startup, and shuts it down automatically on exit.</p>
</blockquote>
<blockquote>
<p>However, <strong>if you create multiple user interface threads, you will need to start up and shut down the dispatcher for those manually</strong></p>
</blockquote>
<blockquote>
<p>The Dispatcher for a thread is created automatically the first time an object derived from the DispatcherObject base class is created. All WPF classes derive from this base class. So, the Dispatcher for the new thread will come into existence when the Window is created. All we have to do is call the static Dispatcher.Run method to ensure that messages are delivered to any UI objects created on the thread. </p>
</blockquote>
<p>大多数情况下，我们是不需要多UI线程的，所谓多UI线程，就是指有两个或者两个以上的线程创建了UI对象。这种做法的好处是两个UI线程会分别进入各自的GetMessage循环，如果是需要多个监视实时数据的UI，或者说使用了DirectShow一些事件密集的程序，可以考虑新创建一个UI线程（GetMessage循环）来减轻单一消息泵的压力。当然，这样做的坏处也很多，不同UI线程中的UI对象互相访问是需要进行Invoke通信的，为了解决这个问题，WPF提供了VisualTarget来用于跨线程将一个对象树连接到另一个对象树，如：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VisualHost</span> : <span class="title">FrameworkElement</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Visual Child</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> _child; &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_child != <span class="literal">null</span>)</span><br><span class="line">                RemoveVisualChild(_child);</span><br><span class="line">            _child = <span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">if</span> (_child != <span class="literal">null</span>)</span><br><span class="line">                AddVisualChild(_child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Visual <span class="title">GetVisualChild</span>(<span class="params"><span class="keyword">int</span> index</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_child != <span class="literal">null</span> &amp;&amp; index == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> _child;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">"index"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">int</span> VisualChildrenCount</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> _child != <span class="literal">null</span> ? <span class="number">1</span> : <span class="number">0</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Visual _child;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在另一个UI线程下的VisualTarget<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Window win = <span class="keyword">new</span> Window();</span><br><span class="line"></span><br><span class="line">win.Loaded += (s, ex) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        VisualHost vh = <span class="keyword">new</span> VisualHost();</span><br><span class="line">        HostVisual hostVisual = <span class="keyword">new</span> HostVisual();</span><br><span class="line">        vh.Child = hostVisual;</span><br><span class="line">        win.Content = vh;</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ThreadStart(() =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            VisualTarget visualTarget = <span class="keyword">new</span> VisualTarget(hostVisual);</span><br><span class="line">            DrawingVisual dv = <span class="keyword">new</span> DrawingVisual();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> dc = dv.RenderOpen())</span><br><span class="line">            &#123;</span><br><span class="line">                dc.DrawText(<span class="keyword">new</span> FormattedText(<span class="string">"UI from another UI thread"</span>,</span><br><span class="line">                    System.Globalization.CultureInfo.GetCultureInfo(<span class="string">"en-us"</span>),</span><br><span class="line">                    FlowDirection.LeftToRight,</span><br><span class="line">                    <span class="keyword">new</span> Typeface(<span class="string">"Verdana"</span>),</span><br><span class="line">                    <span class="number">32</span>,</span><br><span class="line">                    Brushes.Black), <span class="keyword">new</span> Point(<span class="number">10</span>, <span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            visualTarget.RootVisual = dv;</span><br><span class="line">            Dispatcher.Run();  <span class="comment">//启动Dispatcher</span></span><br><span class="line"> </span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        thread.SetApartmentState(ApartmentState.STA);</span><br><span class="line">        thread.IsBackground = <span class="literal">true</span>;</span><br><span class="line">        thread.Start();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">win.Show();</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/22/P&P笔记(X1) Exception Handle (三)/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zmapleaf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/22/P&P笔记(X1) Exception Handle (三)/" itemprop="url">P&P笔记(X1) Exception Handle (三)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-22T17:19:37+08:00">
                2018-04-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这一篇主要整理WPF中的异常处理.</p>
<h2 id="WPF中的异常处理"><a href="#WPF中的异常处理" class="headerlink" title="WPF中的异常处理"></a>WPF中的异常处理</h2><p>类似于Task中对unobserved exception的处理, WPF中有Application.DispatcherUnhandledException事件监听那些unhandled exception. 关于这点, 官方链接提供了最重要的信息<a href="https://msdn.microsoft.com/en-us/library/system.windows.application.dispatcherunhandledexception(v=vs.110).aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/system.windows.application.dispatcherunhandledexception(v=vs.110).aspx</a></p>
<blockquote>
<p>By default, Windows Presentation Foundation (WPF) catches unhandled exceptions, notifies users of the exception from a dialog box (from which they can report the exception), and automatically shuts down an application.</p>
</blockquote>
<blockquote>
<p>However, if an application needs to perform custom unhandled exception processing from a centralized location, you should handle DispatcherUnhandledException.</p>
</blockquote>
<blockquote>
<p><strong>DispatcherUnhandledException</strong> is raised by an Application for each exception that is unhandled by code running on the main UI thread.</p>
</blockquote>
<blockquote>
<p>If an exception is not handled on either a <strong>background user interface (UI) thread (a thread with its own Dispatcher)</strong> or a <strong>background worker thread (a thread without a Dispatcher)</strong>, the exception is not forwarded to the main UI thread. Consequently, DispatcherUnhandledException is <strong>not</strong> raised. In these circumstances, you will need to write code to do the following:</p>
</blockquote>
<ol>
<li><p>Handle exceptions on the background thread.</p>
</li>
<li><p>Dispatch those exceptions to the main UI thread.</p>
</li>
<li><p>Rethrow them on the main UI thread without handling them to allow DispatcherUnhandledException to be raised.</p>
</li>
</ol>
<p>先看background worker thread中抛出异常的捕获<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MainWindow</span> : <span class="title">Window</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainWindow</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        InitializeComponent();</span><br><span class="line"></span><br><span class="line">        Title = <span class="string">$"Running on Main UI Thread <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startSecondaryWorkerThreadButton_Click</span>(<span class="params"><span class="keyword">object</span> sender, RoutedEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Creates and starts a secondary thread in a single threaded apartment (STA)</span></span><br><span class="line">        <span class="keyword">var</span> thread = <span class="keyword">new</span> Thread(MethodRunningOnSecondaryWorkerThread);</span><br><span class="line">        thread.SetApartmentState(ApartmentState.STA);</span><br><span class="line">        thread.IsBackground = <span class="literal">true</span>;</span><br><span class="line">        thread.Start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// THIS METHOD RUNS ON A SECONDARY WORKER THREAD (THREAD WITHOUT A DISPATCHER)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MethodRunningOnSecondaryWorkerThread</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            WorkerMethod();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Dispatch the exception back to the main UI thread. Then, reraise</span></span><br><span class="line">            <span class="comment">// the exception on the main UI thread and handle it from the handler </span></span><br><span class="line">            <span class="comment">// the Application object's DispatcherUnhandledException event.</span></span><br><span class="line">            <span class="comment">// 注意这里是Invoke和Send, 表示同步执行</span></span><br><span class="line">            <span class="keyword">var</span> secondaryWorkerThreadId = Thread.CurrentThread.ManagedThreadId;</span><br><span class="line">            Application.Current.Dispatcher.Invoke(</span><br><span class="line">                DispatcherPriority.Send,</span><br><span class="line">                (DispatcherOperationCallback) <span class="keyword">delegate</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// THIS CODE RUNS BACK ON THE MAIN UI THREAD</span></span><br><span class="line">                    <span class="keyword">string</span> msg = <span class="string">$"Exception forwarded from secondary worker thread <span class="subst">&#123;secondaryWorkerThreadId&#125;</span>."</span>;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(msg, ex);</span><br><span class="line">                &#125;</span><br><span class="line">                , <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// NOTE - Application execution will only continue from this point</span></span><br><span class="line">            <span class="comment">//        onwards if the exception was handled on the main UI thread.</span></span><br><span class="line">            <span class="comment">//        by Application.DispatcherUnhandledException</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">WorkerMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// This method would do real processing on the secondary worker thread.</span></span><br><span class="line">        <span class="comment">// For the purposes of this sample, it throws an exception</span></span><br><span class="line">        <span class="keyword">string</span> msg =</span><br><span class="line">            <span class="string">$"Exception raised secondary on worker thread <span class="subst">&#123;Dispatcher.CurrentDispatcher.Thread.ManagedThreadId&#125;</span>."</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再来看看对background ui thread中抛出异常的捕获, 从中也可以学习如何启动一个ui thread<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MainWindow</span> : <span class="title">Window</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainWindow</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        InitializeComponent();</span><br><span class="line">        Title = <span class="string">$"Running on Main UI Thread <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// THIS EVENT HANDLER RUNS ON THE MAIN UI THREAD</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startSecondaryUIThreadButton_Click</span>(<span class="params"><span class="keyword">object</span> sender, RoutedEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Creates and starts a secondary thread in a single threaded apartment (STA)</span></span><br><span class="line">        <span class="keyword">var</span> thread = <span class="keyword">new</span> Thread(MethodRunningOnSecondaryUIThread);</span><br><span class="line">        thread.SetApartmentState(ApartmentState.STA);</span><br><span class="line">        thread.IsBackground = <span class="literal">true</span>;</span><br><span class="line">        thread.Start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// THIS METHOD RUNS ON A SECONDARY UI THREAD (THREAD WITH A DISPATCHER)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MethodRunningOnSecondaryUIThread</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> secondaryUiThreadId = Thread.CurrentThread.ManagedThreadId;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// On secondary thread, show a new Window before starting a new Dispatcher</span></span><br><span class="line">            <span class="comment">// ie turn secondary thread into a UI thread</span></span><br><span class="line">            <span class="keyword">var</span> window = <span class="keyword">new</span> SecondaryUIThreadWindow();</span><br><span class="line">            window.Show();</span><br><span class="line">            Dispatcher.Run();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Dispatch the exception back to the main ui thread and reraise it</span></span><br><span class="line">            Application.Current.Dispatcher.Invoke(</span><br><span class="line">                DispatcherPriority.Send,</span><br><span class="line">                (DispatcherOperationCallback) <span class="keyword">delegate</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// THIS CODE RUNS BACK ON THE MAIN UI THREAD</span></span><br><span class="line">                    <span class="keyword">string</span> msg = <span class="string">$"Exception forwarded from secondary UI thread <span class="subst">&#123;secondaryUiThreadId&#125;</span>."</span>;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(msg, ex);</span><br><span class="line">                &#125;</span><br><span class="line">                , <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// NOTE - Application execution will only continue from this point</span></span><br><span class="line">            <span class="comment">//        onwards if the exception was handled on the main UI thread</span></span><br><span class="line">            <span class="comment">//        by Application.DispatcherUnhandledException</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">SecondaryUIThreadWindow</span> : <span class="title">Window</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecondaryUIThreadWindow</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        InitializeComponent();</span><br><span class="line">        Title = <span class="string">$"Running on Secondary UI Thread <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">raiseExceptionOnSecondaryUIThreadButton_Click</span>(<span class="params"><span class="keyword">object</span> sender, RoutedEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Raise an exception on the secondary UI thread</span></span><br><span class="line">        <span class="keyword">string</span> msg = <span class="string">$"Exception raised on secondary UI thread <span class="subst">&#123;Dispatcher.Thread.ManagedThreadId&#125;</span>."</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SecondaryUiThreadWindow_Closed</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// End this thread of execution</span></span><br><span class="line">        Dispatcher.InvokeShutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>The DispatcherUnhandledException event handler is passed a DispatcherUnhandledExceptionEventArgs argument that contains contextual information regarding the exception, including: 1.The exception (Exception). 2.The Dispatcher from which it originated (Dispatcher).</p>
</blockquote>
<blockquote>
<p>You can use this information to determine whether an exception is recoverable or not. A recoverable exception might be a <strong>FileNotFoundException</strong>, for example, while an unrecoverable exception might be a <strong>StackOverflowException</strong>, for example.</p>
</blockquote>
<blockquote>
<p>When you process an unhandled exception from DispatcherUnhandledException, and you don’t want WPF to continue processing it, you need to set the <strong>Handled</strong> property to true.</p>
</blockquote>
<p>例如:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MainWindow</span> : <span class="title">Window</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainWindow</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        InitializeComponent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">raiseRecoverableException_Click</span>(<span class="params"><span class="keyword">object</span> sender, RoutedEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> DivideByZeroException(<span class="string">"Recoverable Exception"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">raiseUnecoverableException_Click</span>(<span class="params"><span class="keyword">object</span> sender, RoutedEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">@"Unrecoverable Exception"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">App</span> : <span class="title">Application</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">App_DispatcherUnhandledException</span>(<span class="params"><span class="keyword">object</span> sender, DispatcherUnhandledExceptionEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Process unhandled exception</span></span><br><span class="line">        <span class="keyword">var</span> shutdown = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process exception</span></span><br><span class="line">        <span class="keyword">if</span> (e.Exception <span class="keyword">is</span> DivideByZeroException)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Recoverable - continue processing</span></span><br><span class="line">            shutdown = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (e.Exception <span class="keyword">is</span> ArgumentNullException)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Unrecoverable - end processing</span></span><br><span class="line">            shutdown = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shutdown)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// If unrecoverable, attempt to save data</span></span><br><span class="line">            <span class="keyword">var</span> result =</span><br><span class="line">                MessageBox.Show(<span class="string">"Application must exit:\n\n"</span> + e.Exception.Message + <span class="string">"\n\nSave before exit?"</span>, <span class="string">"app"</span>,</span><br><span class="line">                    MessageBoxButton.YesNo, MessageBoxImage.Error);</span><br><span class="line">            <span class="keyword">if</span> (result == MessageBoxResult.Yes)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Save data</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add entry to event log</span></span><br><span class="line">            EventLog.WriteEntry(<span class="string">"app"</span>, <span class="string">"Unrecoverable Exception: "</span> + e.Exception.Message, EventLogEntryType.Error);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Return exit code</span></span><br><span class="line">            Shutdown(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Prevent default unhandled exception processing</span></span><br><span class="line">        e.Handled = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上示例代码来自WPFSample(<a href="https://github.com/Microsoft/WPF-Samples" target="_blank" rel="noopener">https://github.com/Microsoft/WPF-Samples</a>)</p>
<p>其他参考: </p>
<ol>
<li><p>Handling Unhandled Exceptions in WPF (The most complete collection of handlers)<br>(<a href="https://code.msdn.microsoft.com/windowsdesktop/Handling-Unhandled-47492d0b" target="_blank" rel="noopener">https://code.msdn.microsoft.com/windowsdesktop/Handling-Unhandled-47492d0b</a>)</p>
</li>
<li><p>Order in Chaos: Handling unhandled exceptions in a WPF application<br>(<a href="https://dzone.com/articles/order-chaos-handling-unhandled" target="_blank" rel="noopener">https://dzone.com/articles/order-chaos-handling-unhandled</a>)</p>
</li>
<li><p>Unhandled Exception Handler For WPF Applications(<a href="https://www.codeproject.com/articles/90866/unhandled-exception-handler-for-wpf-applications" target="_blank" rel="noopener">https://www.codeproject.com/articles/90866/unhandled-exception-handler-for-wpf-applications</a>)</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zmapleaf</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">67</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zmapleaf</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
